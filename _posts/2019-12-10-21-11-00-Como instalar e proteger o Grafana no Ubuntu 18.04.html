---
layout: post
title: Como instalar e proteger o Grafana no Ubuntu 18.04
network: digitalocean
date: December 10, 2019 at 09:11PM
url: https://www.digitalocean.com/community/tutorials/how-to-install-and-secure-grafana-on-ubuntu-18-04-pt
image: https://assets.digitalocean.com/articles/66778/Grafana_Login.png
tags: docker
feedtitle: DigitalOcean Community Tutorials
feedurl: https://www.digitalocean.com/community/tutorials
author: DigitalOcean
---
<p><em>O autor escolheu o <a href="https://www.brightfunds.org/organizations/dev-color">Dev Color</a> para receber uma doação como parte do programa <a href="https://do.co/w4do-cta">Write for DOnations</a>.</em></p>

<h3 id="introdução">Introdução</h3>

<p>O <a href="https://grafana.com/grafana">Grafana</a> é uma ferramenta open-source de monitoramento e visualização de dados que se integra a dados complexos de fontes como o <a href="https://prometheus.io/">Prometheus</a>, <a href="https://www.influxdata.com/">InfluxDB</a>, <a href="https://graphiteapp.org/">Graphite</a> e <a href="https://www.elastic.co/">ElasticSearch</a>. O Grafana permite a você criar alertas, notificações e filtros ad-hoc para seus dados, além de facilitar a colaboração com seus colegas de equipe por meio de recursos de compartilhamento embutidos.</p>

<p>Neste tutorial, você instalará o Grafana e o protegerá com um <a href="https://www.digitalocean.com/community/tutorials/openssl-essentials-working-with-ssl-certificates-private-keys-and-csrs">certificado SSL</a> e um <a href="https://www.digitalocean.com/community/tutorials/understanding-nginx-http-proxying-load-balancing-buffering-and-caching">proxy reverso Nginx</a>. Depois de configurar o Grafana, você terá a opção de configurar a autenticação do usuário através do GitHub, permitindo organizar melhor as permissões da sua equipe.</p>

<h2 id="pré-requisitos">Pré-requisitos</h2>

<p>Para seguir este tutorial, você precisará de:</p>

<ul>
<li>Um servidor Ubuntu 18.04 configurado seguindo o tutorial <a href="https://www.digitalocean.com/community/tutorials/configuracao-inicial-de-servidor-com-ubuntu-18-04-pt">Configuração Inicial de servidor com Ubuntu 18.04</a>, incluindo um usuário não-root com privilégios <code>sudo</code> e um firewall configurado com <code>ufw</code>.</li>
<li>Um nome de domínio totalmente qualificado. Por todo este tutorial usaremos <code><span class="highlight">seu_domínio</span></code>. Você pode comprar um nome de domínio no <a href="https://namecheap.com/">Namecheap</a>, obter um gratuitamente em <a href="http://www.freenom.com/en/index.html">Freenom</a>, ou usar o registrador de domínio de sua escolha. </li>
<li>Os seguintes registros DNS configurados para o seu servidor. Você pode seguir o tutorial <a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-a-host-name-with-digitalocean">How To Set Up a Host Name with DigitalOcean</a> para detalhes sobre como adicioná-los.

<ul>
<li>Um registro <strong>A</strong> com <code><span class="highlight">seu_domínio</span></code> apontando para o endereço IP público do seu servidor.</li>
<li>Um registro <strong>A</strong> com <code>www.<span class="highlight">seu_domínio</span></code> apontando para o endereço IP público do seu servidor.</li>
</ul></li>
<li>Nginx configurado seguindo o tutorial  <a href="https://www.digitalocean.com/community/tutorials/como-instalar-o-nginx-no-ubuntu-18-04-pt">Como Instalar o Nginx no Ubuntu 18.04</a>, incluindo um <a href="https://www.digitalocean.com/community/tutorials/how-to-install-nginx-on-ubuntu-18-04#step-5-%E2%80%93-setting-up-server-blocks-(recommended)">bloco de servidor</a> para o seu domínio.</li>
<li>Um bloco de servidor do Nginx com o Let&rsquo;s Encrypt configurado, o que pode ser feito seguindo o tutorial <a href="https://www.digitalocean.com/community/tutorials/como-proteger-o-nginx-com-o-let-s-encrypt-no-ubuntu-18-04-pt">Como Proteger o Nginx com o Let&rsquo;s Encrypt no Ubuntu 18.04</a>.</li>
<li>Opcionalmente, para configurar a autenticação via <a href="https://github.com">GitHub</a>, você vai precisar de uma <a href="https://github.com/business">Conta do GitHub associada a uma organização</a>.</li>
</ul>

<h2 id="passo-1-—-instalando-o-grafana">Passo 1 — Instalando o Grafana</h2>

<p>Neste primeiro passo, você instalará o Grafana no seu servidor Ubuntu 18.04. Você pode instalar o Grafana <a href="https://grafana.com/grafana/download">fazendo o download diretamente do site oficial</a> ou através de um <a href="https://www.digitalocean.com/community/tutorials/ubuntu-and-debian-package-management-essentials#debian-package-management-tools-overview">repositório APT</a>. Como um repositório APT facilita a instalação e o gerenciamento das atualizações do Grafana, você utilizará esse método neste tutorial.</p>

<p>Embora o Grafana esteja disponível no <a href="https://packages.ubuntu.com/bionic/">repositório oficial de pacotes do Ubuntu 18.04</a>, a versão do Grafana pode não ser a mais recente, portanto, use o repositório oficial do Grafana.</p>

<p>Faça o download da <a href="https://www.digitalocean.com/community/tutorials/how-to-use-gpg-to-encrypt-and-sign-messages">chave GPG</a> do Grafana com o <a href="https://www.gnu.org/software/wget/"><code>wget</code></a>, em seguida <a href="https://www.digitalocean.com/community/tutorials/an-introduction-to-linux-i-o-redirection#pipes">faça um pipe da saída</a> para o <code>apt-key</code>. Isso adicionará a chave à lista de chaves confiáveis da instalação do APT, o que permitirá que você baixe e verifique o pacote Grafana assinado pelo GPG.</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">wget -q -O - https://packages.grafana.com/gpg.key | sudo apt-key add -
</li></ul></code></pre>
<p>Neste comando, a opção <code>-q</code> desativa a mensagem de atualização de status para o <code>wget</code> e <code>-O</code> gera o arquivo que você baixou para o terminal. Essas duas opções garantem que apenas o conteúdo do arquivo baixado seja canalizado para o <code>apt-key</code>.</p>

<p>Em seguida, adicione o repositório do Grafana às suas origens de pacotes do APT:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo add-apt-repository "deb https://packages.grafana.com/oss/deb stable main"
</li></ul></code></pre>
<p>Atualize seu cache do APT para atualizar suas listas de pacotes:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo apt update
</li></ul></code></pre>
<p>Em seguida, verifique se o Grafana será instalado através do repositório real do Grafana:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">apt-cache policy grafana
</li></ul></code></pre>
<p>A saída do comando anterior informa a versão do Grafana que você está prestes a instalar e de onde você irá trazer o pacote. Verifique se o candidato à instalação no topo da lista virá do repositório oficial da Grafana em <code>https://packages.grafana.com/oss/deb</code>.</p>
<pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output of apt-cache policy grafana">Output of apt-cache policy grafana</div>grafana:
  Installed: (none)
  Candidate: 6.3.3
  Version table:
     6.3.3 500
        500 https://packages.grafana.com/oss/deb stable/main amd64 Packages
...
</code></pre>
<p>Agora você pode prosseguir com a instalação:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo apt install grafana
</li></ul></code></pre>
<p>Depois que o Grafana estiver instalado, use <code>systemctl</code> para iniciar o servidor Grafana:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo systemctl start grafana-server
</li></ul></code></pre>
<p>Em seguida, verifique se o Grafana está em execução, verificando o status do serviço:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo systemctl status grafana-server
</li></ul></code></pre>
<p>Você receberá uma saída semelhante a esta:</p>
<pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output of grafana-server status">Output of grafana-server status</div>● grafana-server.service - Grafana instance
   Loaded: loaded (/usr/lib/systemd/system/grafana-server.service; disabled; vendor preset: enabled)
   Active: <span class="highlight">active (running)</span> since Tue 2019-08-13 08:22:30 UTC; 11s ago
     Docs: http://docs.grafana.org
 Main PID: 13630 (grafana-server)
    Tasks: 7 (limit: 1152)
...
</code></pre>
<p>Esta saída contém informações sobre o processo do Grafana, incluindo seu status, Identificador do Processo Principal (PID) e muito mais. <code><span class="highlight">active (running)</span></code> mostra que o processo está sendo executado corretamente.</p>

<p>Por fim, ative o serviço para iniciar automaticamente o Grafana na inicialização:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo systemctl enable grafana-server
</li></ul></code></pre>
<p>Você receberá a seguinte saída:</p>
<pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output of systemctl enable grafana-server">Output of systemctl enable grafana-server</div>Synchronizing state of grafana-server.service with SysV service script with /lib/systemd/systemd-sysv-install.
Executing: /lib/systemd/systemd-sysv-install enable grafana-server
Created symlink /etc/systemd/system/multi-user.target.wants/grafana-server.service → /usr/lib/systemd/system/grafana-server.service.
</code></pre>
<p>Isso confirma que o <code>systemd</code> criou os links simbólicos necessários para iniciar automaticamente o Grafana.</p>

<p>O Grafana agora está instalado e pronto para uso. A seguir, você protegerá sua conexão com o Grafana com um proxy reverso e um certificado SSL.</p>

<h2 id="passo-2-—-configurando-o-proxy-reverso">Passo 2 — Configurando o Proxy Reverso</h2>

<p>O uso de um certificado SSL garantirá a segurança dos seus dados, criptografando a conexão de e para o Grafana. Mas, para usar essa conexão, primeiro você precisará reconfigurar o Nginx como um proxy reverso para o Grafana.</p>

<p>Abra o arquivo de configuração do Nginx que você criou ao configurar o bloco de servidor Nginx com o Let&rsquo;s Encrypt nos <a href="#prerequisites">Pré-requisitos</a>. Você pode usar qualquer editor de texto, mas para este tutorial, usaremos o <code>nano</code>:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo nano /etc/nginx/sites-available/<span class="highlight">seu_domínio</span>
</li></ul></code></pre>
<p>Localize o seguinte bloco:</p>
<div class="code-label " title="/etc/nginx/sites-available/seu_domínio">/etc/nginx/sites-available/seu_domínio</div><pre class="code-pre "><code class="code-highlight language-nginx">...
    location / {
        try_files $uri $uri/ =404;
    }
...
</code></pre>
<p>Como você já configurou o Nginx para se comunicar através de SSL e como todo o tráfego web em seu servidor já passa pelo Nginx, basta dizer ao Nginx para encaminhar todas as solicitações ao Grafana, que é executado na porta <code>3000</code> por padrão.</p>

<p>Exclua a linha <code>try_files</code> existente neste <code>bloco de location</code> e substitua-a pela seguinte opção <code>proxy_pass</code>.</p>
<div class="code-label " title="/etc/nginx/sites-available/your_domain">/etc/nginx/sites-available/your_domain</div><pre class="code-pre "><code class="code-highlight language-nginx">...
    location / {
        proxy_pass http://localhost:3000;
    }
...
</code></pre>
<p>Isso mapeará o proxy para a porta apropriada. Quando terminar, salve e feche o arquivo pressionando <code>CTRL+X</code>, seguido por <code>Y</code> e, em seguida, <code>ENTER</code> se estiver usando o <code>nano</code>.</p>

<p>Agora, teste as novas configurações para garantir que tudo esteja configurado corretamente:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo nginx -t
</li></ul></code></pre>
<p>Você receberá a seguinte saída:</p>
<pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
nginx: configuration file /etc/nginx/nginx.conf test is successful
</code></pre>
<p>Por fim, ative as alterações recarregando o Nginx:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo systemctl reload nginx
</li></ul></code></pre>
<p>Agora você pode acessar a tela de login padrão do Grafana apontando o navegador para <code>https://<span class="highlight">seu_domínio</span></code>. Se você não conseguir acessar a Grafana, verifique se o seu firewall está configurado para permitir o tráfego na porta <code>443</code> e, em seguida, siga novamente as instruções anteriores.</p>

<p>Com a conexão com o Grafana criptografada, agora você pode implementar medidas de segurança adicionais, começando com a alteração das credenciais administrativas padrão do Grafana.</p>

<h2 id="passo-3-—-atualizando-credenciais">Passo 3 — Atualizando Credenciais</h2>

<p>Como todas as instalações do Grafana usam as mesmas credenciais administrativas por padrão, é uma boa prática alterar suas informações de login o mais rápido possível. Neste passo, você atualizará as credenciais para melhorar a segurança.</p>

<p>Comece navegando até <code>https://<span class="highlight">seu_domínio</span></code> no seu navegador. Isso exibirá a tela de login padrão, na qual você verá o logotipo do Grafana, um formulário solicitando que você insira <strong>email or username</strong> e <strong>password</strong>, um botão <strong>Log in</strong> e um link <strong>Forgot your password?</strong></p>

<p><img src="https://assets.digitalocean.com/articles/66778/Grafana_Login.png" alt="Grafana Login"></p>

<p>Digite <code>admin</code> nos campos <strong>User</strong> e <strong>Password</strong> e clique no botão <strong>Log in</strong>.</p>

<p>Na próxima tela, você será solicitado a tornar sua conta mais segura alterando a senha padrão:</p>

<p><img src="https://assets.digitalocean.com/articles/66778/Change_Password.png" alt="Change Password"></p>

<p>Digite a senha que você deseja começar a usar nos campos <strong>New password</strong> e <strong>Confirm new password</strong>.</p>

<p>A partir daqui, você pode clicar em <strong>Save</strong> para salvar as novas informações ou pressionar <strong>Skip</strong> para pular esta etapa. Se você pular, você será solicitado a alterar a senha na próxima vez que fizer login.</p>

<p>Para aumentar a segurança da sua configuração do Grafana, clique em <strong>Save</strong>. Você retornará à página <strong>Home Dashboard</strong>:</p>

<p><img src="https://assets.digitalocean.com/articles/66778/Home_Dashboard.png" alt="Home Dashboard"></p>

<p>Agora você protegeu sua conta alterando as credenciais padrão. Em seguida, você fará alterações na configuração do Grafana para que ninguém possa criar uma nova conta do Grafana sem a sua permissão.</p>

<h2 id="passo-4-—-desativando-registros-no-grafana-e-o-acesso-anônimo">Passo 4 — Desativando Registros no Grafana e o Acesso Anônimo</h2>

<p>O Grafana fornece opções que permitem aos visitantes criar contas de usuário e visualizar dashboards sem se registrar. Quando o Grafana não estiver acessível via Internet ou quando estiver trabalhando com dados publicamente disponíveis, como status de serviço, convém permitir esses recursos. No entanto, ao usar o Grafana online para trabalhar com dados confidenciais, o acesso anônimo pode ser um problema de segurança. Para corrigir esse problema, faça algumas alterações na configuração do Grafana.</p>

<p>Comece abrindo o arquivo de configuração principal do Grafana para edição:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo nano /etc/grafana/grafana.ini
</li></ul></code></pre>
<p>Localize a seguinte diretiva <code>allow_sign_up</code> sob o cabeçalho <code>[users]</code>:</p>
<div class="code-label " title="/etc/grafana/grafana.ini">/etc/grafana/grafana.ini</div><pre class="code-pre "><code langs="">...
[users]
# disable user signup / registration
;allow_sign_up = true
...
</code></pre>
<p>A ativação dessa diretiva com <code>true</code> adiciona um botão <strong>Sign Up</strong> na tela de login, permitindo que os usuários se registrem e acessem o Grafana.</p>

<p>A desativação desta diretiva com <code>false</code> remove o botão <strong>Sign Up</strong> e fortalece a segurança e a privacidade do Grafana.</p>

<p>Remova o comentário desta diretiva removendo o <code>;</code> no início da linha e defina a opção como <code>false</code>:</p>
<div class="code-label " title="/etc/grafana/grafana.ini">/etc/grafana/grafana.ini</div><pre class="code-pre "><code langs="">...
[users]
# disable user signup / registration
allow_sign_up = <span class="highlight">false</span>
...
</code></pre>
<p>Em seguida, localize a seguinte diretiva <code>enabled</code> sob o cabeçalho <code>[auth.anonymous]</code>:</p>
<div class="code-label " title="/etc/grafana/grafana.ini">/etc/grafana/grafana.ini</div><pre class="code-pre "><code langs="">...
[auth.anonymous]
# enable anonymous access
;enabled = false
...
</code></pre>
<p>Definir <code>enabled</code> como <code>true</code> fornece aos usuários não registrados acesso aos seus dashboards; definir esta opção como <code>false</code> limita o acesso do dashboard apenas aos usuários registrados.</p>

<p>Remova o comentário desta diretiva removendo o <code>;</code> no início da linha e defina a opção como <code>false</code>:</p>
<div class="code-label " title="/etc/grafana/grafana.ini">/etc/grafana/grafana.ini</div><pre class="code-pre "><code langs="">...
[auth.anonymous]
enabled = <span class="highlight">false</span>
...
</code></pre>
<p>Salve o arquivo e saia do seu editor de texto.</p>

<p>Para ativar as alterações, reinicie o Grafana:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo systemctl restart grafana-server
</li></ul></code></pre>
<p>Verifique se tudo está funcionando, checando o status do serviço do Grafana:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo systemctl status grafana-server
</li></ul></code></pre>
<p>Como antes, a saída vai informar que o Grafana está <code>active (running)</code>.</p>

<p>Agora, aponte seu navegador para <code>https://<span class="highlight">seu_domínio</span></code>. Para retornar à tela  <strong>Sign Up</strong>, leve o cursor para o seu avatar no canto inferior esquerdo da tela e clique na opção <strong>Sign out</strong> que aparece.</p>

<p>Depois de sair, verifique se não há um botão <strong>Sign Up</strong> e se não é possível fazer login sem inserir as credenciais de login.</p>

<p>Nesse ponto, o Grafana está totalmente configurado e pronto para uso. Em seguida, você pode simplificar o processo de login para sua organização, usando a autenticação através do GitHub.</p>

<h2 id="opcional-passo-5-—-configurando-um-app-github-oauth">(Opcional) Passo 5 — Configurando um App GitHub OAuth</h2>

<p>Para uma abordagem alternativa ao fazer login, você pode configurar o Grafana para autenticação através do GitHub, que fornece acesso de login a todos os membros de organizações autorizadas do GitHub. Isso pode ser particularmente útil quando você deseja permitir que vários desenvolvedores colaborem e acessem métricas sem precisar criar credenciais específicas para o Grafana.</p>

<p>Comece fazendo login em uma conta do GitHub associada à sua organização e navegue até a página de perfil do GitHub em <a href="https://github.com/settings/profile"><code>https://github.com/settings/profile</code></a>.</p>

<p>Clique no nome da sua organização em <strong>Organization settings</strong> no menu de navegação no lado esquerdo da tela.</p>

<p><img src="https://assets.digitalocean.com/articles/66778/GitHub_Organization_Settings.png" alt="GitHub Organization settings"></p>

<p>Na próxima tela, você verá seu <strong>Organization profile</strong>, onde poderá alterar configurações como seu <strong>Organization display name</strong>, <strong>Email</strong> e <strong>URL</strong> da organização .</p>

<p>Como o Grafana usa <a href="https://oauth.net/">OAuth</a>, um padrão aberto para conceder acesso remoto de terceiros a recursos locais, para autenticar usuários através do GitHub, você precisará criar uma nova <a href="https://developer.github.com/apps/building-oauth-apps/creating-an-oauth-app/">aplicação OAuth no GitHub</a>.</p>

<p>Clique no link <strong>OAuth Apps</strong>  em <strong>Developer settings</strong> no lado inferior esquerdo da tela.</p>

<p>Se você ainda não possui aplicações OAuth associadas à sua organização no GitHub, será mostrado a você <strong>No Organization Owned Applications</strong>. Caso contrário, você verá uma lista dos aplicações OAuth já conectadas à sua conta.</p>

<p>Clique no botão <strong>Register an application</strong> para continuar.</p>

<p>Na próxima tela, preencha os seguintes detalhes sobre a sua instalação do Grafana:</p>

<ul>
<li><strong>Application name</strong> - Isso ajuda a distinguir suas diferentes aplicações OAuth.</li>
<li><strong>Homepage URL</strong> - Isso informa ao GitHub onde encontrar o Grafana. Digite <code>https://<span class="highlight">seu_domínio</span></code> nesse campo, substituindo <code><span class="highlight">seu_domínio</span></code> pelo seu domínio.</li>
<li><strong>Application Description</strong> - Isso fornece uma descrição do objetivo da sua aplicação OAuth.</li>
<li><strong>Application callback URL</strong> - Este é o endereço para o qual os usuários serão enviados uma vez autenticados com êxito. Para o Grafana, esse campo deve ser definido como <code>https://<span class="highlight">seu_domínio</span>/login/github</code>.</li>
</ul>

<p>Lembre-se de que os usuários do Grafana que efetuam login através do GitHub verão os valores inseridos nos três primeiros campos anteriores, portanto, insira algo significativo e apropriado.</p>

<p>Quando preenchido, o formulário será semelhante a:</p>

<p><img src="https://assets.digitalocean.com/articles/66778/GitHub_Register_OAuth_Application.png" alt="GitHub Register OAuth Application"></p>

<p>Clique no botão verde <strong>Register application</strong>.</p>

<p>Agora você será redirecionado para uma página que contém o <strong>Client ID</strong> e e o <strong>Client Secret</strong> associados à sua nova aplicação OAuth. Anote os dois valores, pois será necessário adicioná-los ao arquivo de configuração principal do Grafana para concluir a instalação.</p>

<p><span class='warning'><strong>Atenção:</strong> Certifique-se de manter seu <strong>Client ID</strong> e seu <strong>Client Secret</strong> em um local seguro e não público, pois eles podem ser usados como base para um ataque.<br></span></p>

<p>Com sua aplicação GitHub OAuth criada, agora você está pronto para reconfigurar o Grafana para usar o GitHub para autenticação.</p>

<h2 id="opcional-passo-6-—-configurando-o-grafana-como-um-app-oauth-no-github">(Opcional) Passo 6 — Configurando o Grafana como um App OAuth no GitHub</h2>

<p>Para concluir a autenticação do GitHub para sua configuração do Grafana, você fará algumas alterações nos arquivos de configuração do Grafana.</p>

<p>Para começar, abra o arquivo de configuração principal do Grafana.</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo nano /etc/grafana/grafana.ini
</li></ul></code></pre>
<p>Localize o cabeçalho <code>[auth.github]</code> e descomente esta seção removendo o <code>;</code> no início de cada linha exceto <code>;team_ids=</code>, que não será alterado neste tutorial.  </p>

<p>Em seguida, configure o Grafana para usar o GitHub com os valores de <code>client_id</code> e <code>client_secret</code> da sua aplicação OAuth.</p>

<ul>
<li>Defina <code>enabled</code> e <code>allow_sign_up</code> para <code>true</code>. Isso permitirá a autenticação via GitHub e permitirá que os membros da organização permitida criem contas. Observe que essa configuração é diferente da propriedade <code>allow_sign_up</code> em <code>[users]</code> que você alterou no <a href="#step-4-%E2%80%94-disabling-grafana-registrations-and-anonymous-access">Passo 4</a>.</li>
<li>Defina <code>client_id</code> e <code>client_secret</code> com os valores que você obteve ao criar sua aplicação GitHub OAuth.</li>
<li>Defina <code>allowed_organizations</code> como o nome da sua organização para garantir que apenas membros da sua organização possam se inscrever e fazer login no Grafana.</li>
</ul>

<p>A configuração completa será semelhante a:</p>
<div class="code-label " title="/etc/grafana/grafana.ini">/etc/grafana/grafana.ini</div><pre class="code-pre "><code langs="">...
[auth.github]
enabled = <span class="highlight">true</span>
allow_sign_up = <span class="highlight">true</span>
client_id = <span class="highlight">seu_client_id_do_github</span>
client_secret = <span class="highlight">seu_client_secret_do_github</span>
scopes = user:email,read:org
auth_url = https://github.com/login/oauth/authorize
token_url = https://github.com/login/oauth/access_token
api_url = https://api.github.com/user
;team_ids =
allowed_organizations = <span class="highlight">nome_da_sua_organização</span>
...
</code></pre>
<p>Agora você contou ao Grafana tudo o que ele precisava saber sobre o GitHub. Para concluir a instalação, você precisará habilitar os redirecionamentos por trás de um proxy reverso. Isso é feito configurando um valor <code>root_url</code> no cabeçalho <code>[server]</code>.</p>
<div class="code-label " title="/etc/grafana/grafana.ini">/etc/grafana/grafana.ini</div><pre class="code-pre "><code langs="">...
[server]
root_url = https://<span class="highlight">seu_domínio</span>
...
</code></pre>
<p>Salve sua configuração e feche o arquivo.</p>

<p>Em seguida, reinicie o Grafana para ativar as alterações:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo systemctl restart grafana-server
</li></ul></code></pre>
<p>Por fim, verifique se o serviço está funcionando.</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo systemctl status grafana-server
</li></ul></code></pre>
<p>A saída indicará que o serviço está <code>active (running)</code>.</p>

<p>Agora, teste seu novo sistema de autenticação navegando até <code>https://<span class="highlight">seu_domínio</span></code>. Se você já está logado no Grafana, passe o mouse sobre o log do avatar no canto inferior esquerdo da tela e clique em <strong>Sign out</strong> no menu secundário que aparece ao lado do seu nome.</p>

<p>Na página de login, você verá uma nova seção sob o botão original <strong>Log in</strong> , que inclui um botão <strong>Sign in with GitHub</strong> com o logotipo do GitHub.</p>

<p><img src="https://assets.digitalocean.com/articles/66778/Grafana_Login_Page_With_GitHub.png" alt="Grafana Login page with GitHub"></p>

<p>Clique no botão <strong>Sign in with GitHub</strong> para ser redirecionado para o GitHub, onde você entrará na sua conta GitHub e confirmará sua intenção de <strong>Authorize Grafana</strong> ou autorizar o Grafana.</p>

<p>Clique no botão verde, <strong>Authorize <span class="highlight">nome<em>da</em>sua_organização</span></strong>.</p>

<p><span class='note'><strong>Nota:</strong> Verifique se a sua conta do GitHub é membro da sua organização aprovada e se o seu endereço de e-mail do Grafana corresponde ao seu endereço de e-mail do GitHub. Se você tentar se autenticar com uma conta do GitHub que não seja membro de sua organização aprovada, receberá uma mensagem <strong>Login Failed</strong> informando: <strong>User not a member of one of the required organizations</strong>, ou seja, o usuário não é membro de uma das organizações necessárias.<br></span></p>

<p>Agora você estará logado com sua conta Grafana existente. Se uma conta Grafana ainda não existir para o usuário no qual você efetuou login, o Grafana criará uma nova conta de usuário com permissões de visualização, ou <strong>Viewer</strong>, garantindo que os novos usuários possam usar apenas os dashboards existentes.</p>

<p>Para alterar as permissões padrão para novos usuários, abra o arquivo de configuração principal do Grafana para edição.</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo nano /etc/grafana/grafana.ini
</li></ul></code></pre>
<p>Localize a diretiva <code>auto_assign_org_role</code> no cabeçalho <code>[users]</code>, e descomente a configuração removendo o <code>;</code> no início da linha.</p>

<p>Defina a diretiva para um dos seguintes valores:</p>

<ul>
<li><code>Viewer</code> — só pode usar dashboards existentes</li>
<li><code>Editor</code> — pode alterar o uso, modificar e adicionar dashboards</li>
<li><code>Admin</code> — tem permissão para fazer tudo</li>
</ul>

<p>Este tutorial definirá a atribuição automática como <code>Viewer</code>:</p>
<div class="code-label " title="/etc/grafana/grafana.ini">/etc/grafana/grafana.ini</div><pre class="code-pre "><code langs="">...
[users]
...
auto_assign_org_role = <span class="highlight">Viewer</span>
...
</code></pre>
<p>Depois de salvar as alterações, feche o arquivo e reinicie o Grafana:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo systemctl restart grafana-server
</li></ul></code></pre>
<p>Verifique o status do serviço:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo systemctl status grafana-server
</li></ul></code></pre>
<p>Como antes, o status apresentará <code>active (running)</code>.</p>

<p>Neste ponto, você configurou totalmente o Grafana para permitir que membros da sua organização GitHub registrem e usem sua instalação do Grafana.</p>

<h2 id="conclusão">Conclusão</h2>

<p>Neste tutorial, você instalou, configurou e protegeu o Grafana e também aprendeu como permitir que membros da sua organização se autentiquem através do GitHub.</p>

<p>Para estender sua instalação atual do Grafana, consulte a <a href="https://grafana.com/dashboards">lista de dashboards oficiais e criados pela comunidade</a>. Para saber mais sobre o uso do Grafana em geral, consulte a <a href="http://docs.grafana.org/">documentação oficial do Grafana</a>, ou confira nossos <a href="https://www.digitalocean.com/community/tags/monitoring?type=tutorials">tutoriais de monitoramento adicionais</a>.</p>
