---
layout: post
title: How to Use Ansible to Install and Set Up LAMP on Ubuntu 18.04
network: digitalocean
date: December 17, 2019 at 11:16AM
url: https://www.digitalocean.com/community/tutorials/how-to-use-ansible-to-install-and-set-up-lamp-on-ubuntu-18-04
image: https://assets.digitalocean.com/articles/automated_ansible/phpinfo.png
tags: docker
feedtitle: DigitalOcean Community Tutorials
feedurl: https://www.digitalocean.com/community/tutorials
author: DigitalOcean
---
<h3 id="introduction">Introduction</h3>

<p>Server automation now plays an essential role in systems administration, due to the disposable nature of modern application environments. <a href="https://www.digitalocean.com/community/tutorial_series/getting-started-with-configuration-management">Configuration management</a> tools such as <a href="https://ansible.com">Ansible</a> are typically used to streamline the process of automating server setup by establishing standard procedures for new servers while also reducing human error associated with manual setups.</p>

<p>Ansible offers a simple architecture that doesn&rsquo;t require special software to be installed on nodes. It also provides a robust set of features and built-in modules which facilitate writing automation scripts.</p>

<p>This guide explains how to use Ansible to automate the steps contained in our guide on <a href="https://www.digitalocean.com/community/tutorials/how-to-install-linux-apache-mysql-php-lamp-stack-ubuntu-18-04">How To Install Linux, Apache, MySQL and PHP (LAMP) on Ubuntu 18.04</a>. A “LAMP” stack is a group of open-source software that is typically installed together to enable a server to host dynamic websites and web apps. This term is actually an acronym which represents the <strong>L</strong>inux operating system, with the <strong>A</strong>pache web server. The site data is stored in a <strong>M</strong>ySQL database, and dynamic content is processed by <strong>P</strong>HP.</p>

<h2 id="prerequisites">Prerequisites</h2>

<p>In order to execute the automated setup provided by the playbook we&rsquo;re discussing in this guide, you&rsquo;ll need:</p>

<ul>
<li><strong>One Ansible control node</strong>: an Ubuntu 18.04 machine with Ansible installed and configured to connect to your Ansible hosts using SSH keys. Make sure the control node has a regular user with sudo permissions and a firewall enabled, as explained in our <a href="https://www.digitalocean.com/community/tutorials/initial-server-setup-with-ubuntu-18-04">Initial Server Setup</a> guide. To set up Ansible, please follow our guide on <a href="https://www.digitalocean.com/community/tutorials/how-to-install-and-configure-ansible-on-ubuntu-18-04">How to Install and Configure Ansible on Ubuntu 18.04</a>.</li>
<li><strong>One or more Ansible Hosts</strong>: one or more remote Ubuntu 18.04 servers previously set up following the guide on <a href="https://www.digitalocean.com/community/tutorials/how-to-use-ansible-to-automate-initial-server-setup-on-ubuntu-18-04">How to Use Ansible to Automate Initial Server Setup on Ubuntu 18.04</a>.</li>
</ul>

<p><span class='note'>Before proceeding, you first need to make sure your Ansible control node is able to connect and execute commands on your Ansible host(s). For a connection test, please check step 3 of <a href="https://www.digitalocean.com/community/tutorials/how-to-install-and-configure-ansible-on-ubuntu-18-04#step-3-%E2%80%94-testing-connection">How to Install and Configure Ansible on Ubuntu 18.04</a>.<br></span></p>

<h2 id="what-does-this-playbook-do">What Does this Playbook Do?</h2>

<p>This Ansible playbook provides an alternative to manually running through the procedure outlined in our guide on <a href="https://www.digitalocean.com/community/tutorials/how-to-install-linux-apache-mysql-php-lamp-stack-ubuntu-18-04">How To Install Linux, Apache, MySQL and PHP (LAMP) on Ubuntu 18.04</a>.</p>

<p>Running this playbook will perform the following actions on your Ansible hosts:</p>

<ol>
<li>Install <code>aptitude</code>, which is preferred by Ansible as an alternative to the <code>apt</code> package manager.</li>
<li>Install the required LAMP packages.</li>
<li>Create a new Apache <code>VirtualHost</code> and set up a dedicated document root for that.</li>
<li>Enable the new <code>VirtualHost</code>.</li>
<li>Disable the default Apache website, when the <strong>disable_default</strong> variable is set to <code>true</code>.</li>
<li>Set the password for the MySQL <strong>root</strong> user.</li>
<li>Remove anonymous MySQL accounts and the test database.</li>
<li>Set up UFW to allow HTTP traffic on the configured port (<code>80</code> by default).</li>
<li>Set up a PHP test script using the provided template.</li>
</ol>

<p>Once the playbook has finished running, you will have a web PHP environment running on top of Apache, based on the options you defined within your configuration variables.</p>

<h2 id="how-to-use-this-playbook">How to Use this Playbook</h2>

<p>The first thing we need to do is obtain the LAMP playbook and its dependencies from the <a href="https://github.com/do-community/ansible-playbooks">do-community/ansible-playbooks</a> repository. We need to clone this repository to a local folder inside the Ansible Control Node.</p>

<p>In case you have cloned this repository before while following a different guide, access your existing <code>ansible-playbooks</code> copy and run a <code>git pull</code> command to make sure you have updated contents:</p>
<pre class="code-pre command local-environment"><code langs=""><ul class="prefixed"><li class="line" prefix="$">cd ~/ansible-playbooks
</li><li class="line" prefix="$">git pull
</li></ul></code></pre>
<p>If this is your first time using the <code>do-community/ansible-playbooks</code> repository, you should start by cloning the repository to your home folder with:</p>
<pre class="code-pre command local-environment"><code langs=""><ul class="prefixed"><li class="line" prefix="$">cd ~
</li><li class="line" prefix="$">git clone https://github.com/do-community/ansible-playbooks.git
</li><li class="line" prefix="$">cd ansible-playbooks
</li></ul></code></pre>
<p>The files we&rsquo;re interested in are located inside the <code>lamp_ubuntu1804</code> folder, which has the following structure:</p>
<pre class="code-pre "><code langs="">lamp_ubuntu1804
├── files
│   ├── apache.conf.j2
│   └── info.php.j2
├── vars
│   └── default.yml
├── playbook.yml
└── readme.md
</code></pre>
<p>Here is what each of these files are:</p>

<ul>
<li><code>files/info.php.j2</code>: Template file for setting up a PHP test page on the web server&rsquo;s root </li>
<li><code>files/apache.conf.j2</code>: Template file for setting up the Apache VirtualHost.</li>
<li><code>vars/default.yml</code>: Variable file for customizing playbook settings.</li>
<li><code>playbook.yml</code>: The playbook file, containing the tasks to be executed on the remote server(s).</li>
<li><code>readme.md</code>: A text file containing information about this playbook.</li>
</ul>

<p>We&rsquo;ll edit the playbook&rsquo;s variable file to customize the configurations of both MySQL and Apache. Access the <code>lamp_ubuntu1804</code> directory and open the <code>vars/default.yml</code> file using your command line editor of choice:</p>
<pre class="code-pre command local-environment"><code langs=""><ul class="prefixed"><li class="line" prefix="$">cd lamp_ubuntu1804
</li><li class="line" prefix="$">nano vars/default.yml
</li></ul></code></pre>
<p>This file contains a few variables that require your attention:</p>
<div class="code-label " title="vars/default.yml">vars/default.yml</div><pre class="code-pre yaml local-environment"><code langs="">---
mysql_root_password: "<span class="highlight">mysql_root_password</span>"
app_user: "<span class="highlight">sammy</span>"
http_host: "<span class="highlight">your_domain</span>"
http_conf: "<span class="highlight">your_domain</span>.conf"
http_port: "<span class="highlight">80</span>"
disable_default: <span class="highlight">true</span>
</code></pre>
<p>The following list contains a brief explanation of each of these variables and how you might want to change them:</p>

<ul>
<li><code>mysql_root_password</code>: The desired password for the <strong>root</strong> MySQL account.</li>
<li><code>app_user</code>: A remote non-root user on the Ansible host that will be set as the owner of the application files. </li>
<li><code>http_host</code>: Your domain name.</li>
<li><code>http_conf</code>: The name of the configuration file that will be created within Apache.</li>
<li><code>http_port</code>: HTTP port for this virtual host, where <code>80</code> is the default. </li>
<li><code>disable_default</code>: Whether or not to disable the default website that comes with Apache.</li>
</ul>

<p>Once you&rsquo;re done updating the variables inside <code>vars/default.yml</code>, save and close this file. If you used <code>nano</code>, do so by pressing <code>CTRL + X</code>, <code>Y</code>, then <code>ENTER</code>.</p>

<p>You&rsquo;re now ready to run this playbook on one or more servers. Most playbooks are configured to be executed on every server in your inventory, by default. We can use the <code>-l</code> flag to make sure that only a subset of servers, or a single server, is affected by the playbook. We can also use the <code>-u</code> flag to specify which user on the remote server we&rsquo;re using to connect and execute the playbook commands on the remote hosts.</p>

<p>To execute the playbook only on <code><span class="highlight">server1</span></code>, connecting as <code><span class="highlight">sammy</span></code>, you can use the following command:</p>
<pre class="code-pre command local-environment"><code langs=""><ul class="prefixed"><li class="line" prefix="$">ansible-playbook playbook.yml -l <span class="highlight">server1</span> -u <span class="highlight">sammy</span>
</li></ul></code></pre>
<p>You will get output similar to this:</p>
<pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>
PLAY [all] *********************************************************************************************************
TASK [Gathering Facts] *********************************************************************************************************ok: [server1]

TASK [Install prerequisites] *********************************************************************************************************ok: [server1] =&gt; (item=aptitude)

...

TASK [UFW - Allow HTTP on port 80] *********************************************************************************************************
changed: [server1]

TASK [Sets Up PHP Info Page] *********************************************************************************************************
changed: [server1]

RUNNING HANDLER [Reload Apache] *********************************************************************************************************
changed: [server1]

RUNNING HANDLER [Restart Apache] *********************************************************************************************************
changed: [server1]

PLAY RECAP *********************************************************************************************************
server1             : ok=15   changed=11   unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   


</code></pre>
<p><span class='note'><strong>Note</strong>: For more information on how to run Ansible playbooks, check our <a href="https://www.digitalocean.com/community/tutorials/how-to-use-ansible-cheat-sheet-guide">Ansible Cheat Sheet Guide</a>.<br></span></p>

<p>When the playbook is finished running, go to your web browser and access the host or IP address of the server, as configured in the playbook variables, followed by <code>/info.php</code>:</p>
<pre class="code-pre "><code langs="">http://<span class="highlight">server_host_or_IP</span>/info.php
</code></pre>
<p>You will see a page like this:</p>

<p><img src="https://assets.digitalocean.com/articles/automated_ansible/phpinfo.png" alt="phpinfo page"></p>

<p>Because this page contains sensitive information about your PHP environment, it is recommended that you remove it from the server by running an <code>rm -f /var/www/info.php</code> command once you have finished setting it up. </p>

<h2 id="the-playbook-contents">The Playbook Contents</h2>

<p>You can find the LAMP server setup featured in this tutorial in the <a href="https://github.com/do-community/ansible-playbooks/tree/master/apache_ubuntu1804"><code>lamp_ubuntu1804</code></a> folder inside the <a href="https://github.com/do-community/ansible-playbooks">DigitalOcean Community Playbooks</a> repository. To copy or download the script contents directly, click the <strong>Raw</strong> button towards the top of each script.</p>

<p>The full contents of the playbook as well as its associated files are also included here for your convenience.</p>

<h3 id="vars-default-yml">vars/default.yml</h3>

<p>The <code>default.yml</code> variable file contains values that will be used within the playbook tasks, such as the password for the MySQL <strong>root</strong> account and the domain name to configure within Apache.</p>
<div class="code-label " title="vars/default.yml">vars/default.yml</div><pre class="code-pre yaml local-environment"><code langs="">---
mysql_root_password: "<span class="highlight">mysql_root_password</span>"
app_user: "<span class="highlight">sammy</span>"
http_host: "<span class="highlight">your_domain</span>"
http_conf: "<span class="highlight">your_domain</span>.conf"
http_port: "<span class="highlight">80</span>"
disable_default: <span class="highlight">true</span>
</code></pre>
<h3 id="files-apache-conf-j2">files/apache.conf.j2</h3>

<p>The <code>apache.conf.j2</code> file is a <a href="https://jinja.palletsprojects.com/en/2.10.x/">Jinja 2</a> template file that configures a new Apache VirtualHost. The variables used within this template are defined in the <code>vars/default.yml</code> variable file.</p>
<div class="code-label " title="files/apache.conf.j2">files/apache.conf.j2</div><pre class="code-pre  local-environment"><code langs="">&lt;VirtualHost *:{{ http_port }}&gt;
   ServerAdmin webmaster@localhost
   ServerName {{ http_host }}
   ServerAlias www.{{ http_host }}
   DocumentRoot /var/www/{{ http_host }}
   ErrorLog ${APACHE_LOG_DIR}/error.log
   CustomLog ${APACHE_LOG_DIR}/access.log combined

   &lt;Directory /var/www/{{ http_host }}&gt;
         Options -Indexes
   &lt;/Directory&gt;

   &lt;IfModule mod_dir.c&gt;
       DirectoryIndex index.php index.html index.cgi index.pl  index.xhtml index.htm
   &lt;/IfModule&gt;

&lt;/VirtualHost&gt;
</code></pre>
<h3 id="files-info-php-j2">files/info.php.j2</h3>

<p>The <code>info.php.j2</code> file is another Jinja template, used to set up a test PHP script in the document root of the newly configured LAMP server.</p>
<div class="code-label " title="files/info.php.j2">files/info.php.j2</div><pre class="code-pre  local-environment"><code langs="">&lt;?php
phpinfo();

</code></pre>
<h3 id="playbook-yml">playbook.yml</h3>

<p>The <code>playbook.yml</code> file is where all tasks from this setup are defined. It starts by defining the group of servers that should be the target of this setup (<code>all</code>), after which it uses <code>become: true</code> to define that tasks should be executed with privilege escalation (<code>sudo</code>) by default. Then, it includes the <code>vars/default.yml</code> variable file to load configuration options.</p>
<div class="code-label " title="playbook.yml">playbook.yml</div><pre class="code-pre yaml local-environment"><code langs="">
---
- hosts: all
  become: true
  vars_files:
    - vars/default.yml

  tasks:
    - name: Install prerequisites
      apt: name={{ item }} update_cache=yes state=latest force_apt_get=yes
      loop: [ 'aptitude' ]

  #Apache Configuration
    - name: Install LAMP Packages
      apt: name={{ item }} update_cache=yes state=latest
      loop: [ 'apache2', 'mysql-server', 'python3-pymysql', 'php', 'php-mysql', 'libapache2-mod-php' ]

    - name: Create document root
      file:
        path: "/var/www/{{ http_host }}"
        state: directory
        owner: "{{ app_user }}"
        mode: '0755'

    - name: Set up Apache virtualhost
      template:
        src: "files/apache.conf.j2"
        dest: "/etc/apache2/sites-available/{{ http_conf }}"
      notify: Reload Apache

    - name: Enable new site
      shell: /usr/sbin/a2ensite {{ http_conf }}
      notify: Reload Apache

    - name: Disable default Apache site
      shell: /usr/sbin/a2dissite 000-default.conf
      when: disable_default
      notify: Reload Apache

  # MySQL Configuration
    - name: Sets the root password
      mysql_user:
        name: root
        password: "{{ mysql_root_password }}"
        login_unix_socket: /var/run/mysqld/mysqld.sock

    - name: Removes all anonymous user accounts
      mysql_user:
        name: ''
        host_all: yes
        state: absent
        login_user: root
        login_password: "{{ mysql_root_password }}"

    - name: Removes the MySQL test database
      mysql_db:
        name: test
        state: absent
        login_user: root
        login_password: "{{ mysql_root_password }}"

  # UFW Configuration
    - name: "UFW - Allow HTTP on port {{ http_port }}"
      ufw:
        rule: allow
        port: "{{ http_port }}"
        proto: tcp

  # PHP Info Page
    - name: Sets Up PHP Info Page
      template:
        src: "files/info.php.j2"
        dest: "/var/www/{{ http_host }}/info.php"

  handlers:
    - name: Reload Apache
      service:
        name: apache2
        state: reloaded

    - name: Restart Apache
      service:
        name: apache2
        state: restarted
</code></pre>
<p>Feel free to modify these files to best suit your individual needs within your own workflow. </p>

<h2 id="conclusion">Conclusion</h2>

<p>In this guide, we used Ansible to automate the process of installing and setting up a LAMP environment on a remote server. Because each individual typically has different needs when working with MySQL databases and users, we encourage you to check out the <a href="https://docs.ansible.com/ansible/latest/modules/mysql_user_module.html#mysql-user-module">official Ansible documentation</a> for more information and use cases of the <code>mysql_user</code> Ansible module.</p>

<p>If you&rsquo;d like to include other tasks in this playbook to further customize your server setup, please refer to our introductory Ansible guide <a href="https://www.digitalocean.com/community/tutorials/configuration-management-101-writing-ansible-playbooks">Configuration Management 101: Writing Ansible Playbooks</a>. </p>
