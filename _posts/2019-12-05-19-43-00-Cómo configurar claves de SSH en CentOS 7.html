---
layout: post
title: Cómo configurar claves de SSH en CentOS 7
network: digitalocean
date: December 05, 2019 at 07:43PM
url: https://www.digitalocean.com/community/tutorials/como-configurar-claves-de-ssh-en-centos-7-es
image: http://ifttt.com/images/no_image_card.png
tags: docker
feedtitle: DigitalOcean Community Tutorials
feedurl: https://www.digitalocean.com/community/tutorials
author: DigitalOcean
---
<h3 id="introducción">Introducción</h3>

<p>SSH, o shell seguro, es un protocolo cifrado que se usa para administrar servidores y comunicarse con ellos. Al trabajar con un servidor de CentOS, es probable que pase la mayor parte de su tiempo en una sesión de terminal conectada a su servidor a través de SSH.</p>

<p>En esta guía, nos centraremos en la configuración de claves de SSH para una instalación de vanilla en CentOS 7. Las claves de SSH proporcionan una alternativa sencilla y segura de iniciar sesión en su servidor y se recomiendan para todos los usuarios.</p>

<h2 id="paso-1-crear-el-par-de-claves-rsa">Paso 1: Crear el par de claves RSA</h2>

<p>El primer paso es crear un par de claves en la máquina cliente (por lo general, su computadora):</p>
<pre class="code-pre command local-environment"><code langs=""><ul class="prefixed"><li class="line" prefix="$">ssh-keygen
</li></ul></code></pre>
<p>De forma predeterminada, <code>ssh-keygen</code> creará un par de claves RSA de 2048 bits, que ofrece suficiente seguridad para la mayoría de los casos de uso (como opción, puede pasar en el indicador <code>-b 4096</code> a crear una clave más grande de 4096 bits).</p>

<p>Después de ingresar el comando, verá el siguiente mensaje:</p>
<pre class="code-pre  local-environment"><code langs=""><div class="secondary-code-label " title="Output">Output</div>Generating public/private rsa key pair.
Enter file in which to save the key (/<span class="highlight">your_home</span>/.ssh/id_rsa):
</code></pre>
<p>Pulse <code>ENTER</code> para guardar el par de claves en el subdirectorio <code>.ssh/</code> de su directorio de inicio o especificar una ruta alternativa.</p>

<p>Si generó previamente un par de claves de SSH, puede ver el siguiente mensaje:</p>
<pre class="code-pre  local-environment"><code langs=""><div class="secondary-code-label " title="Output">Output</div>/home/<span class="highlight">your_home</span>/.ssh/id_rsa already exists.
Overwrite (y/n)?
</code></pre>
<p>Si elige sobrescribir la clave en el disco, ya *<em>no *</em>podrá realizar la autenticación usando la clave anterior. Tenga mucho cuidado al convalidar la operación, ya que este es un proceso destructivo que no puede revertirse.</p>

<p>Debería ver el siguiente mensaje:</p>
<pre class="code-pre  local-environment"><code langs=""><div class="secondary-code-label " title="Output">Output</div>Enter passphrase (empty for no passphrase):
</code></pre>
<p>Aquí, puede introducir una frase de contraseña segura, lo cual se recomienda mucho. Una frase de contraseña agrega una capa de seguridad adicional para evitar el inicio de sesión de usuarios no autorizados. Para obtener más información sobre seguridad, consulte nuestro tutorial <a href="https://www.digitalocean.com/community/tutorials/how-to-configure-ssh-key-based-authentication-on-a-linux-server">Cómo configurar la autenticación basada en claves de SSH en un servidor de Li</a>nux.</p>

<p>Debería ver el siguiente resultado:</p>
<pre class="code-pre  local-environment"><code langs=""><div class="secondary-code-label " title="Output">Output</div>Your identification has been saved in /<span class="highlight">your_home</span>/.ssh/id_rsa.
Your public key has been saved in /<span class="highlight">your_home</span>/.ssh/id_rsa.pub.
The key fingerprint is:
a9:49:2e:2a:5e:33:3e:a9:de:4e:77:11:58:b6:90:26 username@remote_host
The key's randomart image is:
+--[ RSA 2048]----+
|     ..o         |
|   E o= .        |
|    o. o         |
|        ..       |
|      ..S        |
|     o o.        |
|   =o.+.         |
|. =++..          |
|o=++.            |
+-----------------+
</code></pre>
<p>Ahora dispondrá de una clave pública y privada que puede usar para realizar la autenticación. El siguiente paso es ubicar la clave pública en su servidor a fin de poder usar la autenticación basada en claves de SSH para iniciar sesión.</p>

<h2 id="paso-2-copiar-la-clave-pública-al-servidor-de-centos">Paso 2: Copiar la clave pública al servidor de CentOS</h2>

<p>La alternativa más rápida para copiar su clave pública al host de CentOS es usar una utilidad llamada <code>ssh-copy-id</code>. Debido a su simplicidad, este método se recomienda mucho si está disponible. Si no tiene la utilidad <code>ssh-copy-id</code> disponible en su máquina cliente, puede usar uno de los dos métodos alternativos proporcionados en esta sección (copiar mediante SSH con contraseña o copiar manualmente la clave).</p>

<h3 id="copiar-su-clave-pública-usando-ssh-copy-id">Copiar su clave pública usando <code>ssh-copy-id</code></h3>

<p>La herramienta <code>ssh-copy-id</code> se incluye por defecto en muchos sistemas operativos. Por ello, es posible que tenga la posibilidad de disponer de ella en su sistema local. Para que este método funcione, ya debe disponer de acceso con SSH basado en contraseña en su servidor.</p>

<p>Para usar la utilidad, solo necesita especificar el host remoto al que desee conectarse y la cuenta de usuario a la que tenga acceso mediante SSH con contraseña. Esta es la cuenta a la que se copiará su clave de SSH pública.</p>

<p>La sintaxis es la siguiente:</p>
<pre class="code-pre command local-environment"><code langs=""><ul class="prefixed"><li class="line" prefix="$">ssh-copy-id <span class="highlight">username</span>@<span class="highlight">remote_host</span>
</li></ul></code></pre>
<p>Es posible que vea el siguiente mensaje:</p>
<pre class="code-pre  local-environment"><code langs=""><div class="secondary-code-label " title="Output">Output</div>The authenticity of host '<span class="highlight">203.0.113.1</span> (<span class="highlight">203.0.113.1</span>)' can't be established.
ECDSA key fingerprint is fd:fd:d4:f9:77:fe:73:84:e1:55:00:ad:d6:6d:22:fe.
Are you sure you want to continue connecting (yes/no)? <span class="highlight">yes</span>
</code></pre>
<p>Esto solo significa que su computadora local no reconoce el host remoto. Esta pasará la primera vez que establezca conexión con un nuevo host. Escriba “yes” y presione <code>ENTER</code> para continuar.</p>

<p>A continuación, la utilidad analizará su cuenta local en busca de la clave <code>id_rsa.pub</code> que creamos antes. Cuando la encuentre, le solicitará la contraseña de la cuenta del usuario remoto:</p>
<pre class="code-pre  local-environment"><code langs=""><div class="secondary-code-label " title="Output">Output</div>/usr/bin/ssh-copy-id: INFO: attempting to log in with the new key(s), to filter out any that are already installed
/usr/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed -- if you are prompted now it is to install the new keys
<span class="highlight">username</span>@<span class="highlight">203.0.113.1</span>'s password:
</code></pre>
<p>Escriba la contraseña (por motivos de seguridad, no se mostrará lo que escriba) y presione <code>ENTER</code>. La utilidad se conectará a la cuenta en el host remoto usando la contraseña que proporcionó. Luego, copie el contenido de su clave <code>~/.ssh/id_rsa.pub</code> a un archivo en el directorio principal de la cuenta remota <code>~/.ssh</code>, llamado <code>authorized_keys</code>.</p>

<p>Debería ver el siguiente resultado:</p>
<pre class="code-pre  local-environment"><code langs=""><div class="secondary-code-label " title="Output">Output</div>Number of key(s) added: 1

Now try logging into the machine, with:   "ssh '<span class="highlight">username</span>@<span class="highlight">203.0.113.1</span>'"
and check to make sure that only the key(s) you wanted were added.
</code></pre>
<p>En este punto, su clave <code>id_rsa.pub</code> se habrá cargado en la cuenta remota. |Puede continuar con el <a href="#step-3-%E2%80%94-authenticate-to-your-centos-server-using-ssh-keys">paso 3</a>.</p>

<h3 id="copiar-la-clave-pública-usando-ssh">Copiar la clave pública usando SSH</h3>

<p>Si no tiene <code>ssh-copy-id</code> disponible, pero tiene acceso de SSH basado en contraseña a una cuenta de su servidor, puede cargar sus claves usando un método de SSH convencional.</p>

<p>Podemos hacer esto usando el comando <code>cat</code> para leer el contenido de la clave de SSH pública en nuestra computadora local y canalizando esto a través de una conexión SSH al servidor remoto.</p>

<p>Por otra parte, podemos asegurarnos de que el directorio <code>~/.ssh</code> exista y tenga los permisos correctos conforme a la cuenta que usamos.</p>

<p>Luego podemos transformar el contenido que canalizamos a un archivo llamado <code>authorized_keys</code> dentro de este directorio. Usaremos el símbolo de redireccionamiento <code>&gt;&gt;</code> para anexar el contenido en lugar de sobrescribirlo. Esto nos permitirá agregar claves sin eliminar claves previamente agregadas.</p>

<p>El comando completo tiene este aspecto:</p>
<pre class="code-pre command local-environment"><code langs=""><ul class="prefixed"><li class="line" prefix="$">cat ~/.ssh/id_rsa.pub | ssh <span class="highlight">username</span>@<span class="highlight">remote_host</span> "mkdir -p ~/.ssh &amp;&amp; touch ~/.ssh/authorized_keys &amp;&amp; chmod -R go= ~/.ssh &amp;&amp; cat &gt;&gt; ~/.ssh/authorized_keys"
</li></ul></code></pre>
<p>Es posible que vea el siguiente mensaje:</p>
<pre class="code-pre  local-environment"><code langs=""><div class="secondary-code-label " title="Output">Output</div>The authenticity of host '<span class="highlight">203.0.113.1</span> (<span class="highlight">203.0.113.1</span>)' can't be established.
ECDSA key fingerprint is fd:fd:d4:f9:77:fe:73:84:e1:55:00:ad:d6:6d:22:fe.
Are you sure you want to continue connecting (yes/no)? <span class="highlight">yes</span>
</code></pre>
<p>Esto significa que su computadora local no reconoce el host remoto. Esto sucederá la primera vez que establezca conexión con un nuevo host. Escriba “yes” y presione <code>ENTER</code> para continuar.</p>

<p>Posteriormente, deberá recibir la solicitud de introducir la contraseña de la cuenta de usuario remota:</p>
<pre class="code-pre  local-environment"><code langs=""><div class="secondary-code-label " title="Output">Output</div><span class="highlight">username</span>@<span class="highlight">203.0.113.1</span>'s password:
</code></pre>
<p>Una vez que ingrese su contraseña, el contenido de su clave <code>id_rsa.pub</code> se copiará al final del archivo <code>authorized_keys</code> de la cuenta del usuario remoto. Continúe con el <a href="#step-3-%E2%80%94-authenticate-to-ubuntu-server-using-ssh-keys">paso 3</a>si el procedimiento se completó de forma correcta.</p>

<h3 id="copiar-la-clave-pública-de-forma-manual">Copiar la clave pública de forma manual</h3>

<p>Si no tiene disponibilidad de acceso de SSH basado en contraseña a su servidor, deberá completar el proceso anterior de forma manual.</p>

<p>Habilitaremos el contenido de su archivo <code>id_rsa.pub</code> para el archivo <code>~/.ssh/authorized_keys</code> en su máquina remota.</p>

<p>Para mostrar el contenido de su clave <code>id_rsa.pub</code>, escriba esto en su computadora local:</p>
<pre class="code-pre command local-environment"><code langs=""><ul class="prefixed"><li class="line" prefix="$">cat ~/.ssh/id_rsa.pub
</li></ul></code></pre>
<p>Verá el contenido de la clave, que debería tener un aspecto similar a este:</p>
<pre class="code-pre  local-environment"><code langs=""><div class="secondary-code-label " title="Output">Output</div>ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQCqql6MzstZYh1TmWWv11q5O3pISj2ZFl9HgH1JLknLLx44+tXfJ7mIrKNxOOwxIxvcBF8PXSYvobFYEZjGIVCEAjrUzLiIxbyCoxVyle7Q+bqgZ8SeeM8wzytsY+dVGcBxF6N4JS+zVk5eMcV385gG3Y6ON3EG112n6d+SMXY0OEBIcO6x+PnUSGHrSgpBgX7Ks1r7xqFa7heJLLt2wWwkARptX7udSq05paBhcpB0pHtA1Rfz3K2B+ZVIpSDfki9UVKzT8JUmwW6NNzSgxUfQHGwnW7kj4jp4AT0VZk3ADw497M2G/12N0PPB5CnhHf7ovgy6nL1ikrygTKRFmNZISvAcywB9GVqNAVE+ZHDSCuURNsAInVzgYo9xgJDW8wUw2o8U77+xiFxgI5QSZX3Iq7YLMgeksaO4rBJEa54k8m5wEiEE1nUhLuJ0X/vh2xPff6SQ1BL/zkOhvJCACK6Vb15mDOeCSq54Cr7kvS46itMosi/uS66+PujOO+xt/2FWYepz6ZlN70bRly57Q06J+ZJoc9FfBCbCyYH7U/ASsmY095ywPsBo1XQ9PqhnN1/YOorJ068foQDNVpm146mUpILVxmq41Cj55YKHEazXGsdBIbXWhcrRf4G2fJLRcGUr9q8/lERo9oxRm5JFX6TCmj6kmiFqv+Ow9gI0x8GvaQ== demo@test
</code></pre>
<p>Acceda a su host remoto usando el método que esté a su disposición.</p>

<p>Una vez que tenga acceso a su cuenta en el servidor remoto, debe asegurarse de que exista el directorio <code>~/.ssh</code>. Con este comando se creará el directorio, si es necesario. Si este último ya existe, no se creará:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">mkdir -p ~/.ssh
</li></ul></code></pre>
<p>Ahora, podrá crear o modificar el archivo <code>authorized_keys</code> dentro de este directorio. Puede agregar el contenido de su archivo <code>id_rsa.pub</code> al final del archivo <code>authorized_keys</code>  y, si es necesario, crear este último con el siguiente comando:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">echo <span class="highlight">public_key_string</span> &gt;&gt; ~/.ssh/authorized_keys
</li></ul></code></pre>
<p>En el comando anterior, reemplace <code><span class="highlight">public_key_string</span></code> por el resultado del comando <code>cat ~/.ssh/id_rsa.pub</code> que ejecutó en su sistema local. Debería comenzar con <code>ssh-rsa AAAA...</code>.</p>

<p>Por último, verificaremos que el directorio <code>~/.ssh</code> y el archivo <code>authorized_keys</code> tengan el conjunto de permisos apropiados:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">chmod -R go= ~/.ssh
</li></ul></code></pre>
<p>Con esto, se eliminan de forma recursiva todos los permisos “grupo” y “otros” del directorio <code>~/.ssh/</code>.</p>

<p>Si usa la cuenta <code>root</code> para configurar claves para una cuenta de usuario, también es importante que el directorio <code>~/.ssh</code> pertenezca al usuario y no sea <code>root</code>:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">chown -R <span class="highlight">sammy</span>:<span class="highlight">sammy</span> ~/.ssh
</li></ul></code></pre>
<p>En este tutorial, nuestro usuario recibe el nombre<span class="highlight"> samm</span>y, pero debe sustituir el nombre de usuario que corresponda en el comando anterior.</p>

<p>Ahora podemos intentar la autenticación sin contraseña con nuestro servidor de Ubuntu.</p>

<h2 id="paso-3-autenticar-su-servidor-de-centos-con-claves-de-ssh">Paso 3: Autenticar su servidor de CentOS con claves de SSH</h2>

<p>Si completó con éxito uno de los procedimientos anteriores, debería poder iniciar sesión en el host remoto <em>sin</em> la contraseña de la cuenta remota.</p>

<p>El proceso básico es el mismo:</p>
<pre class="code-pre command local-environment"><code langs=""><ul class="prefixed"><li class="line" prefix="$">ssh <span class="highlight">username</span>@<span class="highlight">remote_host</span>
</li></ul></code></pre>
<p>Si es la primera vez que establece conexión con este host (si empleó el último método anterior), es posible que vea algo como esto:</p>
<pre class="code-pre  local-environment"><code langs=""><div class="secondary-code-label " title="Output">Output</div>The authenticity of host '<span class="highlight">203.0.113.1</span> (<span class="highlight">203.0.113.1</span>)' can't be established.
ECDSA key fingerprint is fd:fd:d4:f9:77:fe:73:84:e1:55:00:ad:d6:6d:22:fe.
Are you sure you want to continue connecting (yes/no)? <span class="highlight">yes</span>
</code></pre>
<p>Esto significa que su computadora local no reconoce el host remoto. Escriba “yes” y luego presione <code>ENTER</code> para continuar.</p>

<p>Si no proporcionó una frase de contraseña para su clave privada, se iniciará sesión de inmediato. Si proporcionó una frase de contraseña para la clave privada al crearla, se solicitará que la introduzca ahora. Después de la autenticación, se debería abrir una nueva sesión de shell con la cuenta configurada en el servidor de CentOS.</p>

<p>Si la autenticación basada en claves se realizó con éxito, puede aprender a proteger más su sistema inhabilitando la autenticación con contraseña.</p>

<h2 id="paso-4-inhabilitar-la-autenticación-con-contraseña-en-su-servidor">Paso 4: Inhabilitar la autenticación con contraseña en su servidor</h2>

<p>Si pudo iniciar sesión en su cuenta usando SSH sin una contraseña, habrá configurado con éxito la autenticación basada en claves de SSH para su cuenta. Sin embargo, su mecanismo de autenticación basado en contraseña sigue activo. Esto significa que su servidor sigue expuesto a ataques de fuerza bruta.</p>

<p>Antes de completar los pasos de esta sección, asegúrese de tener configurada la autenticación basada en claves de SSH para la cuenta root en este servidor o, preferentemente, la autenticación basada en clave de SSH para una cuenta no root en este servidor con privilegios <code>sudo</code>. Con este paso, se bloquearán los registros basados en contraseñas. Por lo tanto, es fundamental que se asegure de seguir teniendo acceso administrativo.</p>

<p>Una vez que haya confirmado que su cuenta remota tiene privilegios administrativos, inicie sesión en su servidor remoto con claves de SSH, ya sea como root o con una cuenta con privilegios <code>sudo</code>. Luego, abra el archivo de configuración del demonio de SSH:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo vi /etc/ssh/sshd_config
</li></ul></code></pre>
<p>Dentro del archivo, busque una directiva llamada <code>PasswordAuthentication</code>. Se pueden eliminar los comentarios de esta. Presione <code>i</code> para insertar texto, elimine comentarios de la línea y fije el valor en “no”. Esto inhabilitará su capacidad de iniciar sesión a través de SSH usando contraseñas de cuenta:</p>
<div class="code-label " title="/etc/ssh/sshd_config">/etc/ssh/sshd_config</div><pre class="code-pre "><code langs="">...
PasswordAuthentication <span class="highlight">no</span>
...
</code></pre>
<p>Cuando termine de realizar cambios, presione <code>ESC</code> y luego <code>:wq</code> para ingrear los cambios en el archivo y cierre la directiva. Para implementar realmente estos cambios, debemos reiniciar el servicio <code>sshd</code>:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo systemctl restart sshd.service
</li></ul></code></pre>
<p>Como medida de precaución, abra una nueva ventana de terminal y compruebe que el servicio SSH funcione correctamente antes de cerrar esta sesión:</p>
<pre class="code-pre command local-environment"><code langs=""><ul class="prefixed"><li class="line" prefix="$">ssh <span class="highlight">username</span>@<span class="highlight">remote_host</span>
</li></ul></code></pre>
<p>Una vez que haya verificado su servicio SSH, podrá cerrar de forma segura todas las sesiones de servidores actuales.</p>

<p>El demonio de SSH de su servidor de CentOS ahora solo responderá a claves de SSH. La autenticación basada en contraseña se habrá desactivado con éxito.</p>

<h2 id="conclusión">Conclusión</h2>

<p>De esta manera, la autenticación basada en claves de SSH debería quedar configurada en su servidor. Esto le permitirá iniciar sesión sin proporcionar una contraseña de cuenta.</p>

<p>Si desea obtener más información sobre cómo trabajar con SSH, consulte nuestra <a href="https://www.digitalocean.com/community/tutorials/ssh-essentials-working-with-ssh-servers-clients-and-keys">Guía de aspectos básicos de SSH</a>.</p>
