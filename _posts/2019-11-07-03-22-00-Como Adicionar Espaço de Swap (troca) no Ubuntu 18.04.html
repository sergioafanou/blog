---
layout: post
title: Como Adicionar Espaço de Swap (troca) no Ubuntu 18.04
network: digitalocean
date: November 07, 2019 at 03:22AM
url: https://www.digitalocean.com/community/tutorials/como-adicionar-espaco-de-swap-troca-no-ubuntu-18-04-pt
image: http://ifttt.com/images/no_image_card.png
tags: docker
feedtitle: DigitalOcean Community Tutorials
feedurl: https://www.digitalocean.com/community/tutorials
author: DigitalOcean
---
<p><em><a href="https://www.digitalocean.com/community/users/jellingwood">Justin Ellingwood</a> escreveu uma versão anterior deste tutorial.</em></p>

<h3 id="introdução">Introdução</h3>

<p>Uma das formas mais fáceis de se proteger contra erros fora da memória em aplicativos é adicionar um pouco de espaço de swap no seu servidor. Neste guia, falaremos sobre como adicionar um arquivo swap a um servidor Ubuntu 18.04.</p>

<span class='warning'><p>
<strong>Aviso:</strong> Embora o swap seja geralmente recomendado para sistemas utilizando discos rígidos tradicionais, usar o swap com SSDs pode causar problemas de degradação de hardware ao longo do tempo. Devido a essa consideração, não recomendamos a habilitação do swap no DigitalOcean ou em qualquer outro provedor que utiliza armazenamento SSD. Fazer isso pode afetar a confiabilidade do hardware subjacente para você e seus vizinhos. Este guia é fornecido como referência para usuários que possam ter sistemas de disco rígido tradicional em outro lugar.</p>

<p>Se você precisa melhorar o desempenho do seu servidor na DigitalOcean, recomendamos que atualize seu Droplet. Isso resultará em melhores resultados no geral e diminuirá a probabilidade de contribuir para problemas de hardware que possam afetar seu serviço.<br></p></span>

<h2 id="o-que-é-o-swap">O que é o Swap?</h2>

<p><em>Swap</em> é uma área em um disco rígido que foi designada como um lugar onde o sistema operacional pode armazenar temporariamente dados que ele já não pode manter em RAM. Basicamente, isso dá a você a capacidade de aumentar a quantidade de informações que seu servidor pode manter em sua &ldquo;memória&rdquo; operacional, com algumas limitações. O espaço de swap no disco rígido será usado principalmente quando já não houver espaço suficiente em RAM para manter os dados do aplicativo em uso.</p>

<p>As informações gravadas no disco ficarão significativamente mais lentas do que as informações mantidas em RAM, mas o sistema operacional preferirá manter os dados do aplicativo em memória e usar o swap para os dados mais antigos. De maneira geral, ter espaço de swap como uma alternativa para quando a RAM do seu sistema estiver esgotada pode ser uma boa estratégia de segurança contra exceções de memória insuficiente nos sistemas com armazenamento disponível que não seja SSD.</p>

<h2 id="passo-1-–-verificando-o-sistema-em-relação-às-informações-de-swap-troca">Passo 1 – Verificando o Sistema em Relação às Informações de Swap (troca)</h2>

<p>Antes de começarmos, podemos verificar se o sistema já tem algum espaço de swap (troca) disponível. É possível ter vários arquivos de swap ou partições de swap, mas geralmente um deve ser o suficiente.</p>

<p>Podemos descobrir se o sistema tem algum swap configurado digitando:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo swapon --show
</li></ul></code></pre>
<p>Se você não receber nenhum resultado, isso significa que seu sistema não tem espaço de swap disponível atualmente.</p>

<p>Você pode verificar se não existe um swap ativo usando o utilitário <code>free</code>:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">free -h
</li></ul></code></pre><pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>              total        used        free      shared  buff/cache   available
Mem:           985M         84M        222M        680K        678M        721M
<span class="highlight">Swap:            0B          0B          0B</span>
</code></pre>
<p>Como você pode ver na linha <strong>Swap</strong> do resultado, nenhum swap está ativo no sistema.</p>

<h2 id="passo-2-–-verificando-o-espaço-disponível-na-partição-do-disco-rígido">Passo 2 – Verificando o Espaço Disponível na Partição do Disco Rígido</h2>

<p>Antes de criarmos nosso arquivo de swap, verificaremos o uso atual do disco para garantir que temos espaço suficiente. Faça isso digitando:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">df -h
</li></ul></code></pre><pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>Filesystem      Size  Used Avail Use% Mounted on
udev            481M     0  481M   0% /dev
tmpfs            99M  656K   98M   1% /run
<span class="highlight">/dev/vda1        25G  1.4G   23G   6% /</span>
tmpfs           493M     0  493M   0% /dev/shm
tmpfs           5.0M     0  5.0M   0% /run/lock
tmpfs           493M     0  493M   0% /sys/fs/cgroup
/dev/vda15      105M  3.4M  102M   4% /boot/efi
tmpfs            99M     0   99M   0% /run/user/1000
</code></pre>
<p>O dispositivo com <code>/</code> na coluna <code>Mounted on</code> é o nosso disco neste caso. Temos bastante espaço disponível neste exemplo (apenas 1,4 GB usado). Seu uso provavelmente será diferente.</p>

<p>Apesar da divergência de opiniões quanto ao tamanho adequado de um espaço de swap, isso realmente dependerá de suas preferências pessoais e das exigências da sua aplicação. Geralmente, um espaço igual ou duas vezes o tamanho do espaço da RAM no seu sistema é um bom ponto de partida. Outra boa regra de ouro é que qualquer coisa acima de 4 GB de swap é provavelmente desnecessária se você somente estiver usando-o como uma alternativa para a RAM.</p>

<h2 id="passo-3-–-criando-um-arquivo-de-swap">Passo 3 – Criando um Arquivo de Swap</h2>

<p>Agora que sabemos qual é o espaço disponível em nosso disco rígido, podemos criar um arquivo de swap no nosso sistema de arquivos. Alocaremos um arquivo do tamanho do swap que desejarmos chamar de <code>swapfile</code> no nosso diretório raiz (/).</p>

<p>A melhor maneira de criar um arquivo de swap é com o programa <code>fallocate</code>. Este comando cria instantaneamente um arquivo do tamanho especificado.</p>

<p>Uma vez que o servidor no nosso exemplo tem 1 GB de RAM, criaremos um arquivo de 1 GB neste guia. Ajuste isso para atender às necessidades do seu próprio servidor:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo fallocate -l <span class="highlight">1G</span> /swapfile
</li></ul></code></pre>
<p>Podemos verificar se a quantidade correta de espaço foi reservada digitando:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">ls -lh /swapfile
</li></ul></code></pre><pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">-rw-r--r-- 1 root root 1.0G Apr 25 11:14 /swapfile
</li></ul></code></pre>
<p>Nosso arquivo foi criado com a quantidade correta do espaço reservado.</p>

<h2 id="passo-4-–-habilitando-o-arquivo-de-swap">Passo 4 – Habilitando o Arquivo de Swap</h2>

<p>Agora que temos um arquivo do tamanho correto disponível, precisamos realmente transformar isso em espaço de swap.</p>

<p>Primeiro, precisamos bloquear as permissões do arquivo para que apenas os usuários com privilégios <strong>root</strong> possam ler o conteúdo. Isso impede que os usuários normais possam acessar o arquivo, o que teria implicações de segurança significativas.</p>

<p>Torne o arquivo acessível somente para <strong>root</strong> digitando:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo chmod 600 /swapfile
</li></ul></code></pre>
<p>Verifique a alteração de permissões digitando:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">ls -lh /swapfile
</li></ul></code></pre><pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div><span class="highlight">-rw-------</span> 1 root root 1.0G Apr 25 11:14 /swapfile
</code></pre>
<p>Como você pode ver, apenas o usuário <strong>root</strong> tem os sinalizadores de leitura e gravação habilitados.</p>

<p>Podemos agora marcar o arquivo como espaço de swap digitando:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo mkswap /swapfile
</li></ul></code></pre><pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>Setting up swapspace version 1, size = 1024 MiB (1073737728 bytes)
no label, UUID=6e965805-2ab9-450f-aed6-577e74089dbf
</code></pre>
<p>Depois de marcar o arquivo, podemos habilitar o arquivo de swap, permitindo que nosso sistema comece a usá-lo:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo swapon /swapfile
</li></ul></code></pre>
<p>Verifique se o swap está disponível digitando:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo swapon --show
</li></ul></code></pre><pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>NAME      TYPE  SIZE USED PRIO
/swapfile file 1024M   0B   -2
</code></pre>
<p>Podemos verificar a saída do utilitário <code>free</code> novamente para corroborar nossos resultados:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">free -h
</li></ul></code></pre><pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>              total        used        free      shared  buff/cache   available
Mem:           985M         84M        220M        680K        680M        722M
<span class="highlight">Swap:          1.0G          0B        1.0G</span>
</code></pre>
<p>Nosso swap foi configurado com sucesso e nosso sistema operacional começará a usá-lo conforme necessário.</p>

<h2 id="passo-5-–-tornando-o-arquivo-de-swap-permanente">Passo 5 – Tornando o Arquivo de Swap Permanente</h2>

<p>Nossas alterações recentes habilitaram o arquivo de swap para a sessão atual. No entanto, se reiniciarmos, o servidor não manterá as configurações de swap automaticamente. Podemos alterar isso adicionando o arquivo de swap ao nosso arquivo <code>/etc/fstab</code>.</p>

<p>Faça um backup do arquivo <code>/etc/fstab</code> para o caso de algo dar errado:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo cp /etc/fstab /etc/fstab.bak
</li></ul></code></pre>
<p>Adicione a informação do arquivo de swap no final do seu arquivo <code>/etc/fstab</code> digitando:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
</li></ul></code></pre>
<p>Em seguida, avaliaremos algumas configurações que podemos atualizar para ajustar nosso espaço de swap.</p>

<h2 id="passo-6-–-ajustando-as-configurações-de-swap">Passo 6 – Ajustando as Configurações de Swap</h2>

<p>Há algumas opções que você pode configurar que terão um impacto no desempenho do seu sistema quando estiver lidando com o swap.</p>

<h3 id="ajustando-a-propriedade-swappiness">Ajustando a propriedade Swappiness</h3>

<p>O parâmetro <code>swappiness</code> configura a frequência com que o seu sistema transfere dados da RAM para o espaço de swap. Esse é um valor entre 0 e 100 que representa uma porcentagem.</p>

<p>Com valores próximos de zero, o kernel não irá transferir dados para o disco a menos que seja absolutamente necessário. Lembre-se, as interações com o arquivo de swap são &ldquo;dispendiosas&rdquo;, no sentido de que demoram mais que as interações com a RAM e podem causar uma redução significativa no desempenho. Dizer ao sistema para não depender tanto do swap irá geralmente tornar o seu sistema mais rápido.</p>

<p>Valores que estão mais próximos de 100 irão tentar colocar mais dados no swap em um esforço para manter mais espaço da RAM livre. Dependendo do perfil de memória de seus aplicativos ou do motivo pelo qual você está usando o seu servidor, isso pode ser melhor em alguns casos.</p>

<p>Podemos ver o valor atual do parâmetro swappiness digitando:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">cat /proc/sys/vm/swappiness
</li></ul></code></pre><pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>60
</code></pre>
<p>Para um desktop, um valor de swappiness de 60 não é um valor ruim. Para um servidor, você pode deixá-lo mais próximo de 0.</p>

<p>Podemos definir o parâmetro swappiness para um valor diferente usando o comando <code>sysctl</code>.</p>

<p>Por exemplo, para definir o valor do parâmetro swappiness em 10, poderíamos digitar:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo sysctl vm.swappiness=10
</li></ul></code></pre><pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>vm.swappiness = 10
</code></pre>
<p>Este valor persistirá até a próxima reinicialização. Podemos definir este valor automaticamente na reinicialização, adicionando a linha no nosso arquivo <code>/etc/sysctl.conf</code>:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo nano /etc/sysctl.conf
</li></ul></code></pre>
<p>No final, você pode adicionar:</p>
<div class="code-label " title="/etc/sysctl.conf">/etc/sysctl.conf</div><pre class="code-pre "><code langs="">vm.swappiness=10
</code></pre>
<p>Salve e feche o arquivo quando você terminar.</p>

<h3 id="ajustando-a-configuração-da-pressão-por-cache">Ajustando a Configuração da Pressão por Cache</h3>

<p>Outro valor relacionado que você pode querer modificar é o <code>vfs_cache_pressure</code>. Este ajuste configura o quanto o sistema escolherá para as informações cache dos objetos <em>inode</em> e <em>dentry</em> em detrimento de outros dados.</p>

<p>Basicamente, tratam-se de dados de acesso sobre o sistema de arquivos. De maneira geral, isso é difícil de consultar e, com frequência, muito solicitado. Assim, é algo muito bom que o seu sistema armazene dados em cache. Você pode ver o valor atual questionando o sistema de arquivos <code>proc</code> novamente:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">cat /proc/sys/vm/vfs_cache_pressure
</li></ul></code></pre><pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>100
</code></pre>
<p>Uma vez que ele está atualmente configurado, o nosso sistema remove as informações de inode do cache muito rapidamente. Podemos definir isso em um valor mais conservador como 50, digitando:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo sysctl vm.vfs_cache_pressure=50
</li></ul></code></pre><pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>vm.vfs_cache_pressure = 50
</code></pre>
<p>Novamente, isso é apenas válido para a nossa sessão atual. Podemos alterar esse valor, adicionando-o ao nosso arquivo de configuração como fizemos com a nossa configuração do parâmetro swappiness:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo nano /etc/sysctl.conf
</li></ul></code></pre>
<p>No final, adicione a linha que especifica o seu novo valor:</p>
<div class="code-label " title="/etc/sysctl.conf">/etc/sysctl.conf</div><pre class="code-pre "><code langs="">vm.vfs_cache_pressure=50
</code></pre>
<p>Salve e feche o arquivo quando você terminar.</p>

<h2 id="conclusão">Conclusão</h2>

<p>Seguir as etapas deste guia lhe dará algum espaço para respirar em casos que de outra forma conduziriam a exceções de falta de memória. O espaço de swap pode ser incrivelmente útil para evitar alguns desses problemas comuns.</p>

<p>Se você está encontrando erros de OOM (out of memory - falta de memória), ou se você descobrir que o seu sistema não consegue usar os aplicativos de que você precisa, a melhor solução é otimizar as configurações do seu aplicativo ou atualizar o seu servidor.</p>
