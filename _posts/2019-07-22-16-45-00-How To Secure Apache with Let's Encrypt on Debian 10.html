---
layout: post
title: How To Secure Apache with Let's Encrypt on Debian 10
network: digitalocean
date: July 22, 2019 at 04:45PM
url: https://www.digitalocean.com/community/tutorials/how-to-secure-apache-with-let-s-encrypt-on-debian-10
image: http://ifttt.com/images/no_image_card.png
tags: docker
feedtitle: DigitalOcean Community Tutorials
feedurl: https://www.digitalocean.com/community/tutorials
author: DigitalOcean
---
<h3 id="introduction">Introduction</h3>

<p><a href="https://letsencrypt.org/">Let's Encrypt</a> is a Certificate Authority (CA) that provides an easy way to obtain and install free <a href="https://www.digitalocean.com/community/tutorials/openssl-essentials-working-with-ssl-certificates-private-keys-and-csrs">TLS/SSL certificates</a>, thereby enabling encrypted HTTPS on web servers. It simplifies the process by providing a software client, <a href="https://certbot.eff.org/">Certbot</a>, that attempts to automate most (if not all) of the required steps. Currently, the entire process of obtaining and installing a certificate is fully automated on both Apache and Nginx.</p>

<p>In this tutorial, you will use Certbot to obtain a free SSL certificate for Apache on Debian 10 and set up your certificate to renew automatically.</p>

<p>This tutorial will use a separate Apache virtual host file instead of the default configuration file. <a href="https://www.digitalocean.com/community/tutorials/how-to-install-the-apache-web-server-on-debian-10#step-5-%E2%80%94-setting-up-virtual-hosts-(recommended)">We recommend</a> creating new Apache virtual host files for each domain because it helps to avoid common mistakes and maintains the default files as a fallback configuration. </p>

<h2 id="prerequisites">Prerequisites</h2>

<p>To follow this tutorial, you will need:</p>

<ul>
<li><p>One Debian 10 server set up by following this <a href="https://www.digitalocean.com/community/tutorials/initial-server-setup-with-debian-10">initial server setup for Debian 10</a> tutorial, including a non-<strong>root</strong> user with <code>sudo</code> privileges and a firewall.</p></li>
<li><p>A fully registered domain name. This tutorial will use <strong>your_domain</strong> as an example throughout. You can purchase a domain name on <a href="https://namecheap.com">Namecheap</a>, get one for free on <a href="http://www.freenom.com/en/index.html">Freenom</a>, or use the domain registrar of your choice.</p></li>
<li><p>Both of the following DNS records set up for your server. To set these up, you can follow <a href="https://www.digitalocean.com/docs/networking/dns/how-to/add-domains/">these instructions for adding domains</a> and then <a href="https://www.digitalocean.com/docs/networking/dns/how-to/manage-records/">these instructions for creating DNS records</a>.</p>

<ul>
<li>An A record with <code><span class="highlight">your_domain</span></code> pointing to your server's public IP address.</li>
<li>An A record with <code>www.<span class="highlight">your_domain</span></code> pointing to your server's public IP address.</li>
</ul></li>
<li><p>Apache installed by following <a href="https://www.digitalocean.com/community/tutorials/how-to-install-the-apache-web-server-on-debian-10">How To Install Apache on Debian 10</a>. Be sure that you have a <a href="https://www.digitalocean.com/community/tutorials/how-to-install-the-apache-web-server-on-debian-10#step-5-%E2%80%94-setting-up-virtual-hosts-(recommended)">virtual host file</a> set up for your domain. This tutorial will use <code>/etc/apache2/sites-available/<span class="highlight">your_domain</span>.conf</code> as an example.</p></li>
</ul>

<h2 id="step-1-—-installing-certbot">Step 1 — Installing Certbot</h2>

<p>The first step to using Let's Encrypt to obtain an SSL certificate is to install the Certbot software on your server.</p>

<p>As of this writing, Certbot is not available from the Debian software repositories by default. In order to download the software using <code>apt</code>, you will need to add the backports repository to your <code>sources.list</code> file where <code>apt</code> looks for package sources. Backports are packages from Debian’s testing and unstable distributions that are recompiled so they will run without new libraries on stable Debian distributions. </p>

<p>To add the backports repository, open (or create) the <code>sources.list</code> file in your <code>/etc/apt/</code> directory:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo nano /etc/apt/sources.list
</li></ul></code></pre>
<p>At the bottom of the file, add the following line:</p>
<div class="code-label " title="/etc/apt/sources.list.d/sources.list">/etc/apt/sources.list.d/sources.list</div><pre class="code-pre "><code langs="">. . .
deb http://mirrors.digitalocean.com/debian buster-backports main
deb-src http://mirrors.digitalocean.com/debian buster-backports main
<span class="highlight">deb http://ftp.debian.org/debian buster-backports main</span>
</code></pre>
<p>This includes the <code>main</code> packages, which are <a href="https://www.debian.org/social_contract#guidelines">Debian Free Software Guidelines (DFSG)</a>-compliant, as well as the <code>non-free</code> and <code>contrib</code> components, which are either not DFSG-compliant themselves or include dependencies in this category.</p>

<p>Save and close the file by pressing <code>CTRL+X</code>, <code>Y</code>, then <code>ENTER</code>, then update your package lists:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo apt update
</li></ul></code></pre>
<p>Then install Certbot with the following command. Note that the <code>-t</code> option tells <code>apt</code> to search for the package by looking in the backports repository you just added:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo apt install python-certbot-apache -t buster-backports
</li></ul></code></pre>
<p>Certbot is now ready to use, but in order for it to configure SSL for Apache, we need to verify that Apache has been configured correctly.</p>

<h2 id="step-2-—-setting-up-the-ssl-certificate">Step 2 — Setting Up the SSL Certificate</h2>

<p>Certbot needs to be able to find the correct virtual host in your Apache configuration for it to automatically configure SSL. Specifically, it does this by looking for a <code>ServerName</code> directive that matches the domain you request a certificate for.</p>

<p>If you followed the <a href="https://www.digitalocean.com/community/tutorials/how-to-install-the-apache-web-server-on-debian-10#step-5-%E2%80%94-setting-up-virtual-hosts-(recommended)">virtual host setup step in the Apache installation tutorial</a>, you should have a <code>VirtualHost</code> block for your domain at <code>/etc/apache2/sites-available/<span class="highlight">your_domain</span>.conf</code> with the <code>ServerName</code> directive already set appropriately.</p>

<p>To check, open the virtual host file for your domain using <code>nano</code> or your favorite text editor:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo nano /etc/apache2/sites-available/<span class="highlight">your_domain</span>.conf
</li></ul></code></pre>
<p>Find the existing <code>ServerName</code> line. It should look like this, with your own domain name instead of <code><span class="highlight">your_domain</span></code>:</p>
<div class="code-label " title="/etc/apache2/sites-available/your_domain.conf">/etc/apache2/sites-available/your_domain.conf</div><pre class="code-pre "><code class="code-highlight language-apache">...
ServerName <span class="highlight">your_domain</span>;
...
</code></pre>
<p>If it doesn’t already, update the <code>ServerName</code> directive to point to your domain name. Then save the file, quit your editor, and verify the syntax of your configuration edits:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo apache2ctl configtest
</li></ul></code></pre>
<p>If there aren't any syntax errors, you will see this in your output:</p>
<pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>Syntax OK
</code></pre>
<p>If you get an error, reopen the virtual host file and check for any typos or missing characters. Once your configuration file's syntax is correct, reload Apache to load the new configuration:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo systemctl reload apache2
</li></ul></code></pre>
<p>Certbot can now find the correct <code>VirtualHost</code> block and update it.</p>

<p>Next, let's update the firewall to allow HTTPS traffic.</p>

<h2 id="step-3-—-allowing-https-through-the-firewall">Step 3 — Allowing HTTPS Through the Firewall</h2>

<p>If you have the <code>ufw</code> firewall enabled, as recommended by the prerequisite guides, you'll need to adjust the settings to allow for HTTPS traffic. Luckily, when installed on Debian, <code>ufw</code> comes packaged with a few profiles that help to simplify the process of changing firewall rules for HTTP and HTTPS traffic.</p>

<p>You can see the current setting by typing:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo ufw status
</li></ul></code></pre>
<p>If you followed the Step 2 of our guide on <a href="https://www.digitalocean.com/community/tutorials/how-to-install-the-apache-web-server-on-debian-10#step-2-%E2%80%94-adjusting-the-firewall">How to Install Apache on Debian 10</a>, the output of this command will look like this, showing that only HTTP traffic is allowed to the web server:</p>
<pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>Status: active

To                         Action      From
--                         ------      ----
OpenSSH                    ALLOW       Anywhere                  
WWW                        ALLOW       Anywhere                  
OpenSSH (v6)               ALLOW       Anywhere (v6)             
WWW (v6)                   ALLOW       Anywhere (v6)
</code></pre>
<p>To additionally let in HTTPS traffic, allow the “WWW Full” profile and delete the redundant “WWW” profile allowance:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo ufw allow 'WWW Full'
</li><li class="line" prefix="$">sudo ufw delete allow 'WWW'
</li></ul></code></pre>
<p>Your status should now look like this:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo ufw status
</li></ul></code></pre><pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>Status: active

To                         Action      From
--                         ------      ----
OpenSSH                    ALLOW       Anywhere                  
WWW Full                   ALLOW       Anywhere                  
OpenSSH (v6)               ALLOW       Anywhere (v6)             
WWW Full (v6)              ALLOW       Anywhere (v6)        
</code></pre>
<p>Next, let's run Certbot and fetch our certificates.</p>

<h2 id="step-4-—-obtaining-an-ssl-certificate">Step 4 — Obtaining an SSL Certificate</h2>

<p>Certbot provides a variety of ways to obtain SSL certificates through plugins. The Apache plugin will take care of reconfiguring Apache and reloading the config whenever necessary. To use this plugin, type the following:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo certbot --apache -d <span class="highlight">your_domain</span> -d <span class="highlight">www.your_domain</span>
</li></ul></code></pre>
<p>This runs <code>certbot</code> with the <code>--apache</code> plugin, using <code>-d</code> to specify the names for which you'd like the certificate to be valid.</p>

<p>If this is your first time running <code>certbot</code>, you will be prompted to enter an email address and agree to the terms of service. Additionally, it will ask if you're willing to share your email address with the <a href="https://www.eff.org/">Electronic Frontier Foundation</a>, a nonprofit organization that advocates for digital rights and is also the maker of Certbot. Feel free to enter <code>Y</code> to share your email address or <code>N</code> to decline.</p>

<p>After doing so, <code>certbot</code> will communicate with the Let's Encrypt server, then run a challenge to verify that you control the domain you're requesting a certificate for.</p>

<p>If that's successful, <code>certbot</code> will ask how you'd like to configure your HTTPS settings:</p>
<pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>Please choose whether or not to redirect HTTP traffic to HTTPS, removing HTTP access.
-------------------------------------------------------------------------------
1: No redirect - Make no further changes to the webserver configuration.
2: Redirect - Make all requests redirect to secure HTTPS access. Choose this for
new sites, or if you're confident your site works on HTTPS. You can undo this
change by editing your web server's configuration.
-------------------------------------------------------------------------------
Select the appropriate number [1-2] then [enter] (press 'c' to cancel):
</code></pre>
<p>Select your choice then hit <code>ENTER</code>. The configuration will be updated automatically, and Apache will reload to pick up the new settings. <code>certbot</code> will wrap up with a message telling you the process was successful and where your certificates are stored:</p>
<pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>IMPORTANT NOTES:
 - Congratulations! Your certificate and chain have been saved at:
   /etc/letsencrypt/live/<span class="highlight">your_domain</span>/fullchain.pem
   Your key file has been saved at:
   /etc/letsencrypt/live/<span class="highlight">your_domain</span>/privkey.pem
   Your cert will expire on 2019-10-20. To obtain a new or tweaked
   version of this certificate in the future, simply run certbot again
   with the "certonly" option. To non-interactively renew *all* of
   your certificates, run "certbot renew"
 - Your account credentials have been saved in your Certbot
   configuration directory at /etc/letsencrypt. You should make a
   secure backup of this folder now. This configuration directory will
   also contain certificates and private keys obtained by Certbot so
   making regular backups of this folder is ideal.
 - If you like Certbot, please consider supporting our work by:

   Donating to ISRG / Let's Encrypt:   https://letsencrypt.org/donate
   Donating to EFF:                    https://eff.org/donate-le

</code></pre>
<p>Your certificates are downloaded, installed, and loaded. Try reloading your website using <code>https://</code> and notice your browser's security indicator. It should indicate that the site is properly secured, usually with a green lock icon. If you test your server using the <a href="https://www.ssllabs.com/ssltest/">SSL Labs Server Test</a>, it will get an <strong>A</strong> grade.</p>

<p>Let's finish by testing the renewal process.</p>

<h2 id="step-5-—-verifying-certbot-auto-renewal">Step 5 — Verifying Certbot Auto-Renewal</h2>

<p>Let's Encrypt certificates are only valid for ninety days. This is to encourage users to automate their certificate renewal process. The <code>certbot</code> package we installed takes care of this for us by adding a renew script to <code>/etc/cron.d</code>. This script runs twice a day and will automatically renew any certificate that's within thirty days of expiration.</p>

<p>To test the renewal process, you can do a dry run with <code>certbot</code>:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo certbot renew --dry-run
</li></ul></code></pre>
<p>If you see no errors, you're all set. When necessary, Certbot will renew your certificates and reload Apache to pick up the changes. If the automated renewal process ever fails, Let’s Encrypt will send a message to the email you specified, warning you when your certificate is about to expire.</p>

<h2 id="conclusion">Conclusion</h2>

<p>In this tutorial, you installed the Let's Encrypt client <code>certbot</code>, downloaded SSL certificates for your domain, configured Apache to use these certificates, and set up automatic certificate renewal. If you have further questions about using Certbot, <a href="https://certbot.eff.org/docs/">their documentation</a> is a good place to start.</p>
