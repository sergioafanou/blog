---
layout: post
title: Como instalar e configurar o Ansible no Ubuntu 18.04
network: digitalocean
date: November 07, 2019 at 03:29AM
url: https://www.digitalocean.com/community/tutorials/como-instalar-e-configurar-o-ansible-no-ubuntu-18-04-pt
image: http://ifttt.com/images/no_image_card.png
tags: docker
feedtitle: DigitalOcean Community Tutorials
feedurl: https://www.digitalocean.com/community/tutorials
author: DigitalOcean
---
<h3 id="introdução">Introdução</h3>

<p>Sistemas de gerenciamento de configuração são projetados para facilitar o controle de um grande número de servidores aos administradores e equipes de operações. Isso permite que você controle sistemas diferentes de forma automática a partir de um local central.</p>

<p>Embora existam sistemas de gerenciamento de configuração populares disponíveis para sistemas Linux, como o Chef and Puppet, eles acabam sendo mais complexos do que aquilo que os usuários querem ou precisam. <a href="https://www.ansible.com/">O Ansible</a> é uma boa alternativa diante de tantas opções. Isso porque ele é muito mais barato para se começar.</p>

<p>Neste guia, falamos sobre como instalar o Ansible em um servidor Ubuntu 18.04 e sobre alguns dos princípios básicos do software.</p>

<h2 id="como-o-ansible-funciona">Como o Ansible funciona?</h2>

<p>O Ansible configura máquinas de clientes a partir de um computador que tenha componentes do Ansible instalados e configurados.</p>

<p>Ele se comunica por canais SSH normais para recuperar informações de máquinas remotas,executa comandos e copia arquivos. Por isso, o sistema Ansible não exige que nenhum software adicional seja instalado nos computadores do cliente.</p>

<p>É por isso que o Ansible simplifica a administração de servidores. Qualquer servidor que tenha uma porta SSH aberta pode ser gerenciado pela configuração do Ansible, independentemente do estágio do ciclo de vida. Isso quer dizer que qualquer computador que seja gerenciado por SSH também pode ser gerenciado pelo Ansible.</p>

<p>O Ansible usa uma abordagem modular, o que torna fácil a extensão do uso de funcionalidades do sistema principal para processar cenários específicos. Os módulos podem ser escritos em qualquer linguagem e se comunicam em JSON padrão.</p>

<p>Os arquivos de configuração são, em geral, escritos no formato de serialização de dados YAML devido à facilidade de uso e similaridade com outras linguagens de marcação conhecidas. O Ansible interage com hosts tanto por ferramentas de linha de comando como por scripts de configuração, conhecidos como Playbooks.</p>

<h2 id="pré-requisitos">Pré-requisitos</h2>

<p>Para seguir este tutorial, você precisará de:</p>

<ul>
<li><p>Dois ou mais servidores Ubuntu 18.04. Um deles será usado como <em>servidor Ansible</em>, e o outro como <em>hosts do Ansible</em>. Cada um deles precisará ter um usuário <strong>sem root</strong> com privilégios <code>sudo</code> e um firewall básico configurado. É possível configurar esses detalhes com o nosso <a href="https://www.digitalocean.com/community/tutorials/initial-server-setup-with-ubuntu-18-04">Guia de configuração inicial de servidor para Ubuntu 18.04</a>. Os exemplos neste guia especificam três hosts do Ansible, mas os comandos e configurações aqui presentes podem ser usados para qualquer número de clientes.</p></li>
<li><p>Chaves SSH geradas para o usuário <strong>sem root</strong> no seu servidor do Ansible. Para fazer isso, siga o passo 1 do nosso guia <a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-ssh-keys-on-ubuntu-1804">Como configurar chaves SSH no Ubuntu 18.04</a>. Para os fins deste tutorial, é possível salvar o par de chaves no local padrão <code>(~/.ssh/id_rsa)</code> e não é necessário protegê-lo com senha.</p></li>
</ul>

<h2 id="passo-1-—-como-instalar-o-ansible">Passo 1 — Como instalar o Ansible</h2>

<p>Para começar a usar o Ansible como gerenciador de vários servidores, é necessário instalar o software do Ansible em pelo menos uma máquina.</p>

<p>Para obter a versão mais recente do Ansible para Ubuntu, adicione o PPA (personal package archive) do projeto no seu sistema. No entanto, antes de fazer isso, verifique se você tem o pacote <code>software-properties-common</code> instalado. Esse software facilita o gerenciamento deste e de outros repositórios de software independentes.</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo apt update
</li><li class="line" prefix="$">sudo apt install software-properties-common
</li></ul></code></pre>
<p>Em seguida, adicione o PPA do Ansible com o comando a seguir:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo apt-add-repository ppa:ansible/ansible
</li></ul></code></pre>
<p>Pressione <code>ENTER</code> para aceitar.</p>

<p>A seguir, atualize o índice de pacotes do sistema. Desse modo, você garante que todos os pacotes estejam disponíveis no PPA.</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo apt update
</li></ul></code></pre>
<p>Após atualizar, instale o software do Ansible.</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo apt install ansible
</li></ul></code></pre>
<p>Seu servidor Ansible agora possui o software necessário para gerenciar hosts.</p>

<h2 id="passo-2-—-como-configurar-o-acesso-ssh-aos-hosts-do-ansible">Passo 2 — Como configurar o acesso SSH aos hosts do Ansible</h2>

<p>Como já mencionado, o Ansible se comunica principalmente com os computadores dos clientes por SSH. Ainda que ele possa processar uma autenticação SSH baseada em senhas, usar chaves SSH torna tudo mais simples.</p>

<p>No seu servidor Ansible, use o comando <code>cat</code> para imprimir o conteúdo do arquivo de chave pública SSH do usuário no terminal de saída.</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">cat ~/.ssh/id_rsa.pub
</li></ul></code></pre>
<p>Copie o resultado da saída, abra um novo terminal e conecte-se a um dos seus hosts do Ansible usando SSH.</p>
<pre class="code-pre command local-environment"><code langs=""><ul class="prefixed"><li class="line" prefix="$">ssh <span class="highlight">sammy</span>@<span class="highlight">ansible_host_ip</span>
</li></ul></code></pre>
<p>Altere o usuário para o <strong>root</strong> da máquina do cliente.</p>
<pre class="code-pre command second-environment"><code langs=""><ul class="prefixed"><li class="line" prefix="$">su -
</li></ul></code></pre>
<p>Como usuário <strong>root</strong>, abra <code>authorized_keys</code> na pasta <code>~/.ssh</code>:</p>
<pre class="code-pre super_user second-environment"><code langs=""><ul class="prefixed"><li class="line" prefix="#">nano ~/.ssh/authorized_keys
</li></ul></code></pre>
<p>Agora no arquivo, cole a chave SSH do cliente do seu servidor Ansible. Em seguida, salve o arquivo e feche o editor (pressione <code>CTRL + X</code>, <code>Y</code> e <code>ENTER</code>). Execute o comando <code>exit</code> para retornar como usuário <strong>sem root</strong> do host.</p>
<pre class="code-pre super_user second-environment"><code langs=""><ul class="prefixed"><li class="line" prefix="#">exit 
</li></ul></code></pre>
<p>Uma vez que o Ansible usa um interpretador de Python localizado em <code>/usr/bin/python</code> para executar seus respectivos módulos, será necessário instalar o Python 2 no host para que o Ansible consiga se comunicar com ele. Execute os comandos a seguir para atualizar o índice de pacotes do host e instalar o pacote <code>python</code>.</p>
<pre class="code-pre command second-environment"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo apt update
</li><li class="line" prefix="$">sudo apt install python
</li></ul></code></pre>
<p>Em seguida, execute novamente o comando <code>exit</code> para encerrar a conexão com o cliente:</p>
<pre class="code-pre command second-environment"><code langs=""><ul class="prefixed"><li class="line" prefix="$">exit
</li></ul></code></pre>
<p>Repita o processo para cada servidor que você deseja controlar com seu servidor Ansible. A seguir, vamos configurar um servidor Ansible que se conecte a esses hosts usando o arquivo de <code>hosts</code> do Ansible.</p>

<h2 id="passo-3-—-como-configurar-os-hosts-do-ansible">Passo 3 — Como configurar os hosts do Ansible</h2>

<p>O Ansible controla todos os servidores conhecidos por meio de um <code>arquivo de hosts</code>. Precisamos primeiro configurar o arquivo antes de começar a comunicação com outros computadores.</p>

<p>Abra o arquivo com privilégios <code>sudo</code>, desta forma:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo nano /etc/ansible/hosts
</li></ul></code></pre>
<p>Agora no arquivo, haverá configurações de exemplo comentadas (com um <code>#</code>antes de cada linha). Os exemplos não funcionarão no nosso caso porque os hosts listados aqui são inventados. No entanto, manteremos os exemplos no arquivo para nos ajudar na configuração, caso queiramos implementar cenários mais complexos posteriormente.</p>

<p>O arquivo <code>hosts</code> é bastante flexível, uma vez que pode ser configurado de várias maneiras. Porém, a sintaxe que usaremos será assim:</p>
<pre class="code-pre "><code langs="">[<span class="highlight">group_name</span>]
<span class="highlight">alias</span> ansible_host=<span class="highlight">your_server_ip</span>
</code></pre>
<p><span class='note'><strong>Nota</strong>: Com o lançamento do Ansible 2.0, a variável de configuração<code>ansible_host</code> foi substituída pela variável original <code>ansible_ssh_host</code>. Se você estiver usando uma versão mais antiga do Ansible, será necessário usar a variável mais antiga e mais longa.<br></span></p>

<p>Neste exemplo, <code>group_name</code>é uma tag organizacional que permite que você se refira a qualquer servidor listado abaixo dela com uma palavra, enquanto que <code>alias</code>é apenas o nome para o qual se referir, no caso de um servidor específico.</p>

<p>Desse modo, no cenário criado, imaginamos ter três servidores controláveis com o Ansible. A partir daqui, tais servidores estarão acessíveis do Ansible. Para acessá-los, basta digitar:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">ssh root@<span class="highlight">ansible_host_ip</span>
</li></ul></code></pre>
<p>Você não precisará entrar uma senha se tiver configurado tudo corretamente. Para efeitos de demonstração, suponhamos que os endereços IP de nossos hosts sejam <code>203.0.113.1</code>, <code>203.0.113.2</code> e <code>203.0.113</code>. Vamos configurá-los de modo que possamos nos referir a eles individualmente como <code>host1</code>, <code>host2</code> e <code>host3</code>, ou como um grupo com o <code>nome dos servidores</code>.</p>

<p>Este é o bloco que devemos adicionar no nosso <code>arquivo de hosts</code> para fazer isso:</p>
<div class="code-label " title="/etc/ansible/hosts">/etc/ansible/hosts</div><pre class="code-pre "><code langs="">[servers]
host1 ansible_host=<span class="highlight">203.0.113.1</span>
host2 ansible_host=<span class="highlight">203.0.113.2</span>
host3 ansible_host=<span class="highlight">203.0.113.3</span>
</code></pre>
<p>Os hosts podem estar em vários grupos e os grupos podem configurar parâmetros para todos os membros deles. Agora, vamos fazer um teste.</p>

<p>Com a configuração atual, caso tentemos nos conectar a qualquer um desses hosts com o Ansible, o comando para isso falhará (supondo que você não esteja usando um usuário root). Isso acontece porque sua chave SSH está incorporada no usuário <strong>root</strong> nos sistemas remotos e o Ansible tentará se conectar com o usuário atual por padrão. Uma tentativa de conexão gerará este erro:</p>
<pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>host1 | UNREACHABLE! =&gt; {
    "changed": false,
    "msg": "Failed to connect to the host via ssh.",
    "unreachable": true
}
</code></pre>
<p>No servidor Ansible, estamos usando um usuário chamado <strong>sammy</strong>. O Ansible tentará se conectar a cada host com <code>ssh sammy@server</code>. Isso não funcionará se o usuário <strong>sammy</strong> não estiver também em um sistema remoto.</p>

<p>Podemos criar um arquivos que informe a todos os servidores no grupo &ldquo;servers&rdquo; para se conectarem ao usuário <strong>root</strong>.</p>

<p>Para isso, criaremos uma pasta na estrutura de configuração do Ansible chamada <code>group_vars</code>. Dentro dessa pasta, criamos arquivos formatados em YAML para cada grupo que queremos configurar.</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo mkdir /etc/ansible/group_vars
</li><li class="line" prefix="$">sudo nano /etc/ansible/group_vars/servers
</li></ul></code></pre>
<p>Arquivos YAML devem começar com &ldquo;&mdash;&rdquo;. Não esqueça de começá-los assim.</p>
<div class="code-label " title="/etc/ansible/group_vars/servers">/etc/ansible/group_vars/servers</div><pre class="code-pre "><code langs="">---
ansible_user: root
</code></pre>
<p><span class='note'><strong>Nota:</strong> Similar à variável <code>ansible_host</code>, <code>ansible_user</code> substituiu <code>ansible_ssh_user</code> no lançamento da versão 2.0. Se você estiver usando uma versão mais antiga do que o Ansible 2.0, certifique-se de usar a variável mais antiga e mais longa.<br></span></p>

<p>Salve e feche o arquivo quando você terminar.</p>

<p>Se você quiser especificar os detalhes de configuração para cada servidor, independentemente da associação de grupo, insira esses detalhes em um arquivo em <code>/etc/ansible/group_vars/all</code>. Hosts individuais podem ser configurados a partir de arquivos com o nome de seu respectivo alias dentro de uma pasta em <code>/etc/ansible/host_vars</code>.</p>

<h2 id="passo-4-—-como-usar-comandos-simples-do-ansible">Passo 4 — Como usar comandos simples do Ansible</h2>

<p>Agora que temos nossos hosts prontos e informações de configuração suficientes para que nos conectemos a nossos hosts, podemos tentar usar nosso primeiro comando.</p>

<p>Faça um teste de ping em todos os servidores que você configurou. Digite:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">ansible -m ping all
</li></ul></code></pre><div class="code-label " title="Ping output">Ping output</div><pre class="code-pre "><code langs="">host1 | SUCCESS =&gt; {
    "changed": false,
    "ping": "pong"
}

host3 | SUCCESS =&gt; {
    "changed": false,
    "ping": "pong"
}

host2 | SUCCESS =&gt; {
    "changed": false,
    "ping": "pong"
}
</code></pre>
<p>Trata-se de um teste básico para verificar se o Ansible possui uma conexão com todos os hosts dele.</p>

<p>A parte do comando que diz <code>all</code> quer dizer todos os hosts. Podemos também especificar um grupo facilmente:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">ansible -m ping servers
</li></ul></code></pre>
<p>Ou então especificar um host individual:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">ansible -m ping host1
</li></ul></code></pre>
<p>Podemos especificar vários hosts separando-os com dois-pontos:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">ansible -m ping host1:host2
</li></ul></code></pre>
<p>A parte do comando que diz <code>-m ping</code> é uma instrução para que o Ansible use o módulo &ldquo;ping&rdquo;. Basicamente, são esses os comandos que você pode executar nos seus hosts remotos. O módulo ping funciona de maneira similar ao utilitário de <code>ping</code> padrão do Linux. A diferença é que, diferente deste, aquele verifica a conectividade do Ansible.</p>

<p>O módulo ping não recebe nenhum argumento, mas podemos usar outro comando para ver como isso funciona. Passamos argumentos para um script digitando <code>-a</code>.</p>

<p>O módulo &ldquo;shell&rdquo; permite que enviemos um comando de terminal para o host remoto e que recuperemos os resultados. Por exemplo, para conferir o uso de memória da nossa máquina host1, podemos usar:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">ansible -m shell -a 'free -m' host1
</li></ul></code></pre><div class="code-label " title="Shell output">Shell output</div><pre class="code-pre "><code langs="">host1 | SUCCESS | rc=0 &gt;&gt;
             total       used       free     shared    buffers     cached
Mem:          3954        227       3726          0         14         93
-/+ buffers/cache:        119       3834
Swap:            0          0          0
</code></pre>
<p>Com isso, seu servidor Ansible está configurado. Com ele, você poderá se comunicar e controlar seus hosts com sucesso.</p>

<h2 id="conclusão">Conclusão</h2>

<p>Neste tutorial, configuramos o Ansible e vimos como ele pode se comunicar com cada host. Usamos também o comando <code>ansible</code> para executar tarefas simples de modo remoto.</p>

<p>Embora isso seja útil, não cobrimos os recursos mais poderosos neste artigo: os Playbooks. Os Playbooks do Ansible são maneiras simples e poderosas de se gerenciar a configuração de servidores e implantações de várias máquinas. Para uma introdução sobre os Playbooks, confira <a href="https://www.digitalocean.com/community/tutorials/configuration-management-101-writing-ansible-playbooks">este</a>guia. Além disso, recomendamos que você confira a <a href="https://docs.ansible.com/ansible/latest/index.html">documentação oficial do Ansible</a>. Desse modo, você saberá mais sobre a ferramenta.</p>
