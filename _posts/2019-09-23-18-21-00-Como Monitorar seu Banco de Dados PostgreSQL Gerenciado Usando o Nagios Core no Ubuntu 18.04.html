---
layout: post
title: Como Monitorar seu Banco de Dados PostgreSQL Gerenciado Usando o Nagios Core no Ubuntu 18.04
network: digitalocean
date: September 23, 2019 at 06:21PM
url: https://www.digitalocean.com/community/tutorials/como-monitorar-seu-banco-de-dados-postgresql-gerenciado-usando-o-nagios-core-no-ubuntu-18-04-pt
image: https://assets.digitalocean.com/articles/postgres_managed_nagios/step3.png
tags: docker
feedtitle: DigitalOcean Community Tutorials
feedurl: https://www.digitalocean.com/community/tutorials
author: DigitalOcean
---
<p><em>O autor escolheu o <a href="https://www.brightfunds.org/funds/foss-nonprofits">Free and Open Source Fund</a> para receber uma doação como parte do programa <a href="https://do.co/w4do-cta">Write for DOnations</a>.</em></p>

<h3 id="introdução">Introdução</h3>

<p>O monitoramento do banco de dados é essencial para entender como o banco de dados se comporta ao longo do tempo. Ele pode ajudá-lo a descobrir problemas de utilização ocultos e gargalos que ocorrem no seu banco de dados. A implementação de sistemas de monitoramento de banco de dados pode rapidamente se tornar uma vantagem a longo prazo, o que influenciará positivamente seu processo de gerenciamento de infraestrutura. Você poderá reagir rapidamente às alterações de status do seu banco de dados e será notificado rapidamente quando os serviços monitorados retornarem ao funcionamento normal.</p>

<p>O <a href="https://www.nagios.org/projects/nagios-core/">Nagios Core</a> é um sistema de monitoramento popular que você pode usar para monitorar seu banco de dados gerenciado. Os benefícios de usar o Nagios para esta tarefa são sua versatilidade — é fácil de configurar e utiliza um grande repositório de <a href="https://www.nagios.org/projects/nagios-plugins/">plugins disponíveis</a>, e o mais importante, alerta integrado.</p>

<p>Neste tutorial, você configurará o monitoramento do banco de dados PostgreSQL no <a href="https://www.nagios.org/projects/nagios-core/">Nagios Core</a> utilizando o plugin <a href="https://exchange.nagios.org/directory/Plugins/Databases/PostgresQL/check_postgres/details"><code>check_postgres</code></a> e configurar alertas baseados no Slack. No final, você terá um sistema de monitoramento funcionando em seu banco de dados PostgreSQL gerenciado e será notificado imediatamente sobre alterações de status de várias funcionalidades.</p>

<h2 id="pré-requisitos">Pré-requisitos</h2>

<ul>
<li><p>Um servidor Ubuntu 18.04 com privilégios de root e uma conta secundária não-root. Você pode configurar isso seguindo este <a href="https://www.digitalocean.com/community/tutorials/initial-server-setup-with-ubuntu-18-04">guia de Configuração Inicial de servidor com Ubuntu 18.04</a>. Para este tutorial o usuário não-root é o <code><span class="highlight">sammy</span></code>.</p></li>
<li><p>Nagios Core instalado em seu servidor. Para conseguir isso, conclua os cinco primeiros passos do tutorial <a href="https://www.digitalocean.com/community/tutorials/how-to-install-nagios-4-and-monitor-your-servers-on-ubuntu-18-04">How To Install Nagios 4 and Monitor Your Servers on Ubuntu 18.04</a>.</p></li>
<li><p>Uma conta na DigitalOcean e um <a href="https://www.digitalocean.com/products/managed-databases/">banco de dados gerenciado PostgreSQL</a> provisionado pela DigitalOcean com informações de conexão disponíveis. Para saber mais sobre os bancos de dados gerenciados da DigitalOcean, visite a <a href="https://www.digitalocean.com/docs/databases/overview/">documentação de produto</a>.</p></li>
<li><p>Uma conta <a href="https://slack.com/">Slack</a> com acesso completo, adicionado a um workspace no qual você deseja receber atualizações de status.</p></li>
</ul>

<h2 id="passo-1-—-instalando-check_postgres">Passo 1 — Instalando check_postgres</h2>

<p>Nesta seção, você fará o download da versão mais recente do plug-in <code>check_postgres</code> no Github e disponibilizará para o Nagios Core. Você também instalará o cliente PostgreSQL (<code>psql</code>), para que <code>check_postgres</code> consiga se conectar ao seu banco de dados gerenciado.</p>

<p>Comece instalando o cliente PostgreSQL, executando o seguinte comando:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo apt install postgresql-client
</li></ul></code></pre>
<p>Em seguida, você baixará o <code>check_postgres</code> para o seu diretório home. Primeiro, navegue até ele:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">cd ~
</li></ul></code></pre>
<p>Vá para a página <a href="https://github.com/bucardo/check_postgres/releases">Github releases</a> e copie o link da versão mais recente do plug-in. No momento da redação deste artigo, a versão mais recente do <code>check_postgres</code> era a <code>2.24.0</code>; lembre-se de que isso será atualizado e, sempre que possível, a boa prática é usar a versão mais recente.</p>

<p>Agora faça o download usando curl:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">curl -LO https://github.com/bucardo/check_postgres/releases/download/2.24.0/check_postgres-<span class="highlight">2.24.0</span>.tar.gz
</li></ul></code></pre>
<p>Extraia-o usando o seguinte comando:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">tar xvf check_postgres-*.tar.gz
</li></ul></code></pre>
<p>Isso criará um diretório com o mesmo nome que o arquivo que você baixou. Essa pasta contém o executável <code>check_postgres</code>, que você precisará copiar para o diretório em que o Nagios armazena seus plugins (geralmente <code>/usr/local/nagios/libexec/</code>). Copie-o executando o seguinte comando:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo cp check_postgres-*/check_postgres.pl /usr/local/nagios/libexec/
</li></ul></code></pre>
<p>Em seguida, você precisará atribuir ao usuário <code>nagios</code> a propriedade sobre ele, para que ele possa ser executado a partir do Nagios:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo chown nagios:nagios /usr/local/nagios/libexec/check_postgres.pl
</li></ul></code></pre>
<p>O <code>check_postgres</code> está agora disponível para o Nagios e pode ser usado a partir dele. No entanto, ele fornece muitos comandos relativos a diferentes aspectos do PostgreSQL e, para uma melhor manutenção do serviço, é melhor dividi-los para que possam ser chamados separadamente. Você conseguirá isso criando um link simbólico para cada comando <code>check_postgres</code> no diretório do plugin.</p>

<p>Navegue para o diretório onde o Nagios armazena plugins executando o seguinte comando:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">cd /usr/local/nagios/libexec
</li></ul></code></pre>
<p>Em seguida, crie os links simbólicos com:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo perl check_postgres.pl --symlinks
</li></ul></code></pre>
<p>A saída será semelhante a esta:</p>
<pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>Created "check_postgres_archive_ready"
Created "check_postgres_autovac_freeze"
Created "check_postgres_backends"
Created "check_postgres_bloat"
Created "check_postgres_checkpoint"
Created "check_postgres_cluster_id"
Created "check_postgres_commitratio"
Created "check_postgres_connection"
Created "check_postgres_custom_query"
Created "check_postgres_database_size"
Created "check_postgres_dbstats"
Created "check_postgres_disabled_triggers"
Created "check_postgres_disk_space"
Created "check_postgres_fsm_pages"
Created "check_postgres_fsm_relations"
Created "check_postgres_hitratio"
Created "check_postgres_hot_standby_delay"
Created "check_postgres_index_size"
Created "check_postgres_indexes_size"
Created "check_postgres_last_analyze"
Created "check_postgres_last_autoanalyze"
Created "check_postgres_last_autovacuum"
Created "check_postgres_last_vacuum"
Created "check_postgres_listener"
Created "check_postgres_locks"
Created "check_postgres_logfile"
Created "check_postgres_new_version_bc"
Created "check_postgres_new_version_box"
Created "check_postgres_new_version_cp"
Created "check_postgres_new_version_pg"
Created "check_postgres_new_version_tnm"
Created "check_postgres_pgagent_jobs"
Created "check_postgres_pgb_pool_cl_active"
Created "check_postgres_pgb_pool_cl_waiting"
Created "check_postgres_pgb_pool_maxwait"
Created "check_postgres_pgb_pool_sv_active"
Created "check_postgres_pgb_pool_sv_idle"
Created "check_postgres_pgb_pool_sv_login"
Created "check_postgres_pgb_pool_sv_tested"
Created "check_postgres_pgb_pool_sv_used"
Created "check_postgres_pgbouncer_backends"
Created "check_postgres_pgbouncer_checksum"
Created "check_postgres_prepared_txns"
Created "check_postgres_query_runtime"
Created "check_postgres_query_time"
Created "check_postgres_relation_size"
Created "check_postgres_replicate_row"
Created "check_postgres_replication_slots"
Created "check_postgres_same_schema"
Created "check_postgres_sequence"
Created "check_postgres_settings_checksum"
Created "check_postgres_slony_status"
Created "check_postgres_table_size"
Created "check_postgres_timesync"
Created "check_postgres_total_relation_size"
Created "check_postgres_txn_idle"
Created "check_postgres_txn_time"
Created "check_postgres_txn_wraparound"
Created "check_postgres_version"
Created "check_postgres_wal_files"
</code></pre>
<p>O Perl listou todas as funções para as quais criou um link simbólico. Agora elas podem ser executadas na linha de comando, como de costume.</p>

<p>Você baixou e instalou o plug-in <code>check_postgres</code>. Você também criou links simbólicos para todos os comandos do plug-in, para que possam ser usados individualmente no Nagios. No próximo passo, você criará um arquivo de serviço de conexão, que o <code>check_postgres</code> utilizará para se conectar ao seu banco de dados gerenciado.</p>

<h2 id="passo-2-—-configurando-seu-banco-de-dados">Passo 2 — Configurando Seu Banco de Dados</h2>

<p>Nesta seção, você criará um arquivo de serviço de conexão do PostgreSQL contendo as informações de conexão do seu banco de dados. A seguir, você testará os dados de conexão invocando o <code>check_postgres</code> nele.</p>

<p>O arquivo do serviço de conexão é, por convenção, chamado <code>pg_service.conf</code> e deve estar localizado em  <code>/etc/postgresql-common/</code>. Crie este arquivo usando seu editor de textos favorito (por exemplo, o nano):</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo nano /etc/postgresql-common/pg_service.conf
</li></ul></code></pre>
<p>Adicione as seguintes linhas, substituindo os espaços reservados destacados pelos valores reais mostrados no Painel de Controle do Banco de Dados gerenciado na seção <strong>Connection Details</strong>:</p>
<div class="code-label " title="/etc/postgresql-common/pg_service.conf">/etc/postgresql-common/pg_service.conf</div><pre class="code-pre "><code langs="">[managed-db]
host=<span class="highlight">host</span>
port=<span class="highlight">porta</span>
user=<span class="highlight">nome_de_usuário</span>
password=<span class="highlight">senha</span>
dbname=defaultdb
sslmode=require
</code></pre>
<p>O arquivo do serviço de conexão pode abrigar vários grupos de informações de conexão com o banco de dados. O início de um grupo é sinalizado colocando seu nome entre colchetes. Depois disso vem os parâmetros de conexão (<code>host</code>, <code>port</code>, <code>user</code>, <code>password</code> e assim por diante), separados por novas linhas, que devem receber um valor.</p>

<p>Salve e feche o arquivo quando terminar.</p>

<p>Agora você testará a validade da configuração conectando-se ao banco de dados via <code>check_postgres</code> executando o seguinte comando:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">./check_postgres.pl --dbservice=managed-db --action=connection
</li></ul></code></pre>
<p>Aqui, você diz ao <code>check_postgres</code> qual grupo de informações de conexão com o banco de dados usar com o parâmetro <code>--dbservice</code>, e também especifica que ele deve apenas tentar se conectar a ele especificando <code>connection</code> como a ação.</p>

<p>Sua saída será semelhante a esta:</p>
<pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>POSTGRES_CONNECTION OK: service=managed-db version 11.4 | time=0.10s
</code></pre>
<p>Isto significa que o <code>check_postgres</code> conseguiu conectar-se ao banco de dados, de acordo com os parâmetros do <code>pg_service.conf</code>. Se você receber um erro, verifique novamente o que você acabou de inserir nesse arquivo de configuração.</p>

<p>Você criou e preencheu um arquivo de serviço de conexão do PostgreSQL, que funciona como uma <a href="https://en.wikipedia.org/wiki/Connection_string">string de conexão</a>. Você também testou os dados de conexão executando <code>check_postgres</code> e observando a saída. Na próxima etapa, você configurará o Nagios para monitorar várias partes do seu banco de dados.</p>

<h2 id="passo-3-—-criando-serviços-de-monitoramento-no-nagios">Passo 3 — Criando Serviços de Monitoramento no Nagios</h2>

<p>Agora você configurará o Nagios para monitorar várias métricas do seu banco de dados, definindo um host e vários serviços, que chamarão o plug-in <code>check_postgres</code> e seus links simbólicos.</p>

<p>O Nagios armazena seus arquivos de configuração personalizados em <code>/usr/local/nagios/etc/objects</code>. Os novos arquivos adicionados lá devem ser ativados manualmente no arquivo de configuração central do Nagios, localizado em <code>/usr/local/nagios/etc/nagios.cfg</code>. Agora você deverá definir comandos, um host e vários serviços, que serão usados para monitorar seu banco de dados gerenciado no Nagios.</p>

<p>Primeiro, crie uma pasta dentro de <code>/usr/local/nagios/etc/objects</code> para armazenar sua configuração relacionada ao PostgreSQL executando o seguinte comando:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo mkdir /usr/local/nagios/etc/objects/postgresql
</li></ul></code></pre>
<p>Você armazenará os comandos do Nagios para <code>check_nagios</code> em um arquivo chamado <code>commands.cfg</code>. Crie-o para edição:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo nano /usr/local/nagios/etc/objects/postgresql/commands.cfg
</li></ul></code></pre>
<p>Adicione as seguintes linhas:</p>
<div class="code-label " title="/usr/local/nagios/etc/objects/postgresql/commands.cfg">/usr/local/nagios/etc/objects/postgresql/commands.cfg</div><pre class="code-pre "><code langs="">define command {
    command_name           check_postgres_connection
    command_line           /usr/local/nagios/libexec/check_postgres_connection --dbservice=$ARG1$
}

define command {
    command_name           check_postgres_database_size
    command_line           /usr/local/nagios/libexec/check_postgres_database_size --dbservice=$ARG1$ --critical='$ARG2$'
}

define command {
    command_name           check_postgres_locks
    command_line           /usr/local/nagios/libexec/check_postgres_locks --dbservice=$ARG1$
}

define command {
    command_name           check_postgres_backends
    command_line           /usr/local/nagios/libexec/check_postgres_backends --dbservice=$ARG1$
}
</code></pre>
<p>Salve e feche o arquivo.</p>

<p>Neste arquivo, você define quatro comandos do Nagios que chamam partes diferentes do plugin <code>check_postgres</code> (checando a conectividade, obtendo o número de locks e conexões e o tamanho de todo o banco de dados). Todos eles aceitam um argumento que é passado para o parâmetro <code>--dbservice</code> e especificam a qual dos bancos de dados definidos em <code>pg_service.conf</code> se conectar.</p>

<p>O comando <code>check_postgres_database_size</code> aceita um segundo argumento que é passado para o parâmetro <code>--critical</code>, que especifica o ponto em que o armazenamento do banco de dados está ficando cheio. Os valores aceitos incluem <code>1 KB</code> para um kilobyte, <code>1 MB</code> para um megabyte e assim por diante, até exabytes (<code>EB</code>). Um número sem uma unidade de capacidade é tratado como sendo expresso em bytes.</p>

<p>Agora que os comandos necessários estão definidos, você definirá o host (essencialmente o banco de dados) e seus serviços de monitoramento em um arquivo chamado <code>services.cfg</code>. Crie-o usando seu editor favorito:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo nano /usr/local/nagios/etc/objects/postgresql/services.cfg
</li></ul></code></pre>
<p>Inclua as seguintes linhas, substituindo <code><span class="highlight">db_max_storage_size</span></code> por um valor referente ao armazenamento disponível do seu banco de dados. É recomendável configurá-lo para 90% do tamanho de armazenamento que você alocou para ele:</p>
<div class="code-label " title="/usr/local/nagios/etc/objects/postgresql/services.cfg">/usr/local/nagios/etc/objects/postgresql/services.cfg</div><pre class="code-pre "><code langs="">define host {
      use                    linux-server
      host_name              postgres
      check_command          check_postgres_connection!managed-db
}

define service {
      use                    generic-service
      host_name              postgres
      service_description    PostgreSQL Connection
      check_command          check_postgres_connection!managed-db
      notification_options   w,u,c,r,f,s
}

define service {
      use                    generic-service
      host_name              postgres
      service_description    PostgreSQL Database Size
      check_command          check_postgres_database_size!managed-db!<span class="highlight">db_max_storage_size</span>
      notification_options   w,u,c,r,f,s
}

define service {
      use                    generic-service
      host_name              postgres
      service_description    PostgreSQL Locks
      check_command          check_postgres_locks!managed-db
      notification_options   w,u,c,r,f,s
}

define service {
      use                    generic-service
      host_name              postgres
      service_description    PostgreSQL Backends
      check_command          check_postgres_backends!managed-db
      notification_options   w,u,c,r,f,s
}
</code></pre>
<p>Você primeiro define um host, para que o Nagios saiba a que entidade os serviços se relacionam. Em seguida, você cria quatro serviços, que chamam os comandos que você acabou de definir. Cada um deles passa <code>managed-db</code> como argumento, detalhando que o <code>managed-db</code> que você definiu no Passo 2 deve ser monitorado.</p>

<p>Em relação às opções de notificação, cada serviço especifica que as notificações devem ser enviadas quando o estado do serviço se tornar <code>WARNING</code>,<code>UNKNOWN</code>, <code>CRITICAL</code>,<code>OK</code> (quando se recuperar de uma parada), quando o serviço iniciar <a href="https://assets.nagios.com/downloads/nagioscore/docs/nagioscore/3/en/flapping.html">oscilando</a>, ou quando a parada programada iniciar ou terminar.  Sem atribuir explicitamente um valor a essa opção, nenhuma notificação seria enviada (para os contatos disponíveis), exceto se acionada manualmente.</p>

<p>Salve e feche o arquivo.</p>

<p>Em seguida, você precisará dizer explicitamente ao Nagios para ler os arquivos de configuração deste novo diretório, editando o arquivo de configuração geral do Nagios. Abra-o para edição executando o seguinte comando:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo nano /usr/local/nagios/etc/nagios.cfg
</li></ul></code></pre>
<p>Encontre esta linha destacada no arquivo:</p>
<div class="code-label " title="/usr/local/nagios/etc/nagios.cfg">/usr/local/nagios/etc/nagios.cfg</div><pre class="code-pre "><code langs="">...
# directive as shown below:

<span class="highlight">cfg_dir=/usr/local/nagios/etc/servers</span>
#cfg_dir=/usr/local/nagios/etc/printers
...
</code></pre>
<p>Acima dela, adicione a seguinte linha destacada:</p>
<div class="code-label " title="/usr/local/nagios/etc/nagios.cfg">/usr/local/nagios/etc/nagios.cfg</div><pre class="code-pre "><code langs="">...
<span class="highlight">cfg_dir=/usr/local/nagios/etc/objects/postgresql</span>
cfg_dir=/usr/local/nagios/etc/servers
...
</code></pre>
<p>Salve e feche o arquivo. Esta linha diz ao Nagios para carregar todos os arquivos de configuração a partir do diretório <code>/usr/local/nagios/etc/objects/postgresql</code>, onde seus arquivos de configuração estão localizados.</p>

<p>Antes de reiniciar o Nagios, verifique a validade da configuração executando o seguinte comando:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo /usr/local/nagios/bin/nagios -v /usr/local/nagios/etc/nagios.cfg
</li></ul></code></pre>
<p>O final da saída será semelhante a este:</p>
<pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>Total Warnings: 0
Total Errors:   0

Things look okay - No serious problems were detected during the pre-flight check
</code></pre>
<p>Isso significa que o Nagios não encontrou erros na configuração. Se ele lhe mostrar um erro, você também verá uma dica sobre o que deu errado, para poder corrigir o erro mais facilmente.</p>

<p>Para fazer com que o Nagios recarregue sua configuração, reinicie seu serviço executando o seguinte comando:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo systemctl restart nagios
</li></ul></code></pre>
<p>Agora você pode navegar até o Nagios no seu navegador. Depois de carregado, clique na opção <strong>Services</strong> no menu à esquerda. Você verá o host do <code>postgres</code> e uma lista de serviços, junto com seus status atuais:</p>

<p><img src="https://assets.digitalocean.com/articles/postgres_managed_nagios/step3.png" alt="PostgreSQL Monitoring Services - Pending"></p>

<p>Em breve, todos eles ficarão verdes e mostrarão o status <code>OK</code>. Você verá a saída do comando na coluna <strong>Status Information</strong>. Você pode clicar no nome do serviço e ver informações detalhadas sobre seu status e disponibilidade.</p>

<p>Você adicionou comandos <code>check_postgres</code>, um host e vários serviços à sua instalação do Nagios para monitorar seu banco de dados. Você também verificou que os serviços estão funcionando corretamente, examinando-os por meio da interface web do Nagios. Na próxima etapa, você configurará os alertas baseados no Slack.</p>

<h2 id="passo-4-—-configurando-alertas-para-o-slack">Passo 4 — Configurando Alertas para o Slack</h2>

<p>Nesta seção, você configurará o Nagios para alertá-lo sobre eventos via Slack, publicando-os nos canais desejados em seu workspace.</p>

<p>Antes de começar, efetue login no workspace desejado no Slack e crie dois canais nos quais você deseja receber mensagens de status do Nagios: um para host e outro para notificações de serviço. Se desejar, você pode criar apenas um canal em que receberá os dois tipos de alertas.</p>

<p>Em seguida, vá para o <a href="https://slack.com/apps/A0F81R747-nagios">app Nagios</a> no Diretório de apps do Slack e click em <strong>Add Configuration</strong>. Você verá uma página para adicionar a Integração Nagios.</p>

<p><img src="https://assets.digitalocean.com/articles/postgres_managed_nagios/step4a.png" alt="Slack - Add Nagios Integration"></p>

<p>Click em <strong>Add Nagios Integration</strong>. Quando a página carregar, role para baixo e tome nota do token, porque você precisará dele mais adiante.</p>

<p><img src="https://assets.digitalocean.com/articles/postgres_managed_nagios/step4bnew.png" alt="Slack - Integration Token"></p>

<p>Agora você instalará e configurará o plugin Slack (escrito em Perl) para o Nagios no seu servidor. Primeiro, instale os pré-requisitos necessários do Perl executando o seguinte comando:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo apt install libwww-perl libcrypt-ssleay-perl -y
</li></ul></code></pre>
<p>Em seguida, faça o download do plug-in para o diretório de plugins do Nagios:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo curl https://raw.githubusercontent.com/tinyspeck/services-examples/master/nagios.pl -o slack.pl
</li></ul></code></pre>
<p>Torne-o executável executando o seguinte comando:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo chmod +x slack.pl
</li></ul></code></pre>
<p>Agora, você precisará editá-lo para conectar-se ao seu workspace usando o token que você obteve do Slack. Abra-o para edição:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo nano slack.pl
</li></ul></code></pre>
<p>Localize as seguintes linhas no arquivo:</p>
<div class="code-label " title="/usr/local/nagios/libexec/slack.pl">/usr/local/nagios/libexec/slack.pl</div><pre class="code-pre "><code langs="">...
my $opt_domain = "<span class="highlight">foo</span>.slack.com"; # Your team's domain
my $opt_token = "<span class="highlight">your_token</span>"; # The token from your Nagios services page
...
</code></pre>
<p>Substitua <code><span class="highlight">foo</span>.slack.com</code> pelo domínio do seu workspace e <code><span class="highlight">your_token</span></code> pelo seu token de integração do app Nagios, salve e feche o arquivo. O script agora poderá enviar solicitações apropriadas ao Slack, que você testará executando o seguinte comando:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">./slack.pl -field slack_channel=#<span class="highlight">nome_do_seu_canal</span> -field HOSTALIAS="Test Host" -field HOSTSTATE="UP" -field HOSTOUTPUT="Host is UP" -field NOTIFICATIONTYPE="RECOVERY"
</li></ul></code></pre>
<p>Substitua <code><span class="highlight">nome_do_seu_canal</span></code> pelo nome do canal em que você deseja receber alertas de status. O script exibirá informações sobre a solicitação HTTP feita ao Slack e, se tudo for executado corretamente, a última linha da saída será <code>ok</code>. Se você receber um erro, verifique novamente se o canal do Slack especificado existe no workspace.</p>

<p>Agora você pode ir para o workspace do Slack e selecionar o canal que você  especificou. Você verá uma mensagem de teste vinda do Nagios.</p>

<p><img src="https://assets.digitalocean.com/articles/postgres_managed_nagios/step4c.png" alt="Slack - Nagios Test Message"></p>

<p>Isso confirma que você configurou corretamente o script para o Slack. Agora você passará a configurar o Nagios para alertá-lo via Slack usando este script.</p>

<p>Você precisará criar um contato para o Slack e dois comandos que enviarão mensagens para ele. Você armazenará essa configuração em um arquivo chamado <code>slack.cfg</code>, na mesma pasta que os arquivos de configuração anteriores. Crie-o para edição executando o seguinte comando:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo nano /usr/local/nagios/etc/objects/postgresql/slack.cfg
</li></ul></code></pre>
<p>Adicione as seguintes linhas:</p>
<div class="code-label " title="/usr/local/nagios/etc/objects/postgresql/slack.cfg">/usr/local/nagios/etc/objects/postgresql/slack.cfg</div><pre class="code-pre "><code langs="">define contact {
      contact_name                             slack
      alias                                    Slack
      service_notification_period              24x7
      host_notification_period                 24x7
      service_notification_options             w,u,c,f,s,r
      host_notification_options                d,u,r,f,s
      service_notification_commands            notify-service-by-slack
      host_notification_commands               notify-host-by-slack
}

define command {
      command_name     notify-service-by-slack
      command_line     /usr/local/nagios/libexec/slack.pl -field slack_channel=#<span class="highlight">service_alerts_channel</span>
}

define command {
      command_name     notify-host-by-slack
      command_line     /usr/local/nagios/libexec/slack.pl -field slack_channel=#<span class="highlight">host_alerts_channel</span>
}
</code></pre>
<p>Aqui você define um contato chamado <code>slack</code>, declara que ele pode ser contatado a qualquer momento e especifica quais comandos usar para notificar eventos relacionados ao serviço e ao host. Esses dois comandos são definidos depois e chamam o script que você acabou de configurar. Você precisará substituir <code><span class="highlight">service_alerts_channel</span></code> e <code><span class="highlight">host_alerts_channel</span></code> pelos nomes dos canais em que deseja receber mensagens de serviço e host, respectivamente. Se preferir, você pode usar os mesmos nomes de canais.</p>

<p>De maneira semelhante à criação do serviço no último passo, é crucial definir as opções de notificação de serviço e host no contato, pois ele determina que tipo de alerta o contato receberá. A omissão dessas opções resultaria no envio de notificações somente quando acionadas manualmente a partir da interface web.</p>

<p>Quando você terminar de editar, salve e feche o arquivo.</p>

<p>Para habilitar o alerta através do contato <code>slack</code> que você acabou de definir, você precisará adicioná-lo ao grupo de contatos <code>admin</code>, definido no arquivo de configuração <code>contacts.cfg</code>, localizado em <code>/usr/local/nagios/etc/objects/</code>. Abra-o para edição executando o seguinte comando:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo nano /usr/local/nagios/etc/objects/contacts.cfg
</li></ul></code></pre>
<p>Localize o bloco de configuração parecido com este:</p>
<div class="code-label " title="/usr/local/nagios/etc/objects/contacts.cfg">/usr/local/nagios/etc/objects/contacts.cfg</div><pre class="code-pre "><code langs="">define contactgroup {

    contactgroup_name       admins
    alias                   Nagios Administrators
    members                 nagiosadmin
}
</code></pre>
<p>Adicione <code>slack</code> à lista de membros, assim:</p>
<div class="code-label " title="/usr/local/nagios/etc/objects/contacts.cfg">/usr/local/nagios/etc/objects/contacts.cfg</div><pre class="code-pre "><code langs="">define contactgroup {

    contactgroup_name       admins
    alias                   Nagios Administrators
    members                 nagiosadmin<span class="highlight">,slack</span>
}
</code></pre>
<p>Salve e feche o arquivo.</p>

<p>Por padrão, ao executar scripts, o Nagios não disponibiliza informações de host e serviço por meio de variáveis de ambiente, que é o que o script Slack requer para enviar mensagens significativas. Para remediar isso, você precisará definir a configuração <code>enable_environment_macros</code> em <code>nagios.cfg</code> como <code>1</code>. Abra-o para edição executando o seguinte comando:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo nano /usr/local/nagios/etc/nagios.cfg
</li></ul></code></pre>
<p>Encontre a linha semelhante a essa:</p>
<div class="code-label " title="/usr/local/nagios/etc/nagios.cfg">/usr/local/nagios/etc/nagios.cfg</div><pre class="code-pre "><code langs="">enable_environment_macros=0
</code></pre>
<p>Altere o valor para <code>1</code>, assim:</p>
<div class="code-label " title="/usr/local/nagios/etc/nagios.cfg">/usr/local/nagios/etc/nagios.cfg</div><pre class="code-pre "><code langs="">enable_environment_macros=<span class="highlight">1</span>
</code></pre>
<p>Salve e feche o arquivo.</p>

<p>Teste a validade da configuração do Nagios executando o seguinte comando:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo /usr/local/nagios/bin/nagios -v /usr/local/nagios/etc/nagios.cfg
</li></ul></code></pre>
<p>O final da saída será semelhante a:</p>
<pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>Total Warnings: 0
Total Errors:   0

Things look okay - No serious problems were detected during the pre-flight check
</code></pre>
<p>Prossiga e reinicie o Nagios executando o seguinte comando:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo systemctl restart nagios
</li></ul></code></pre>
<p>Para testar a integração do Slack, você vai enviar uma notificação personalizada pela interface web. Recarregue a página de status <strong>Services</strong> do Nagios no seu navegador. Clique no serviço <strong>PostgreSQL Backends</strong> e clique em <strong>Send custom service notification</strong> à direita quando a página carregar.</p>

<p><img src="https://assets.digitalocean.com/articles/postgres_managed_nagios/step4d.png" alt="Nagios - Custom Service Notification"></p>

<p>Digite um comentário de sua escolha e clique em <strong>Commit</strong> e, em seguida, clique em <strong>Done</strong>. Você receberá imediatamente uma nova mensagem no Slack.</p>

<p><img src="https://assets.digitalocean.com/articles/postgres_managed_nagios/step4e.png" alt="Slack - Status Alert From Nagios"></p>

<p>Agora você integrou o Slack ao Nagios, para receber mensagens sobre eventos críticos e alterações de status imediatamente. Você também testou a integração acionando manualmente um evento no Nagios.</p>

<h2 id="conclusão">Conclusão</h2>

<p>Agora você tem o Nagios Core configurado para monitorar seu banco de dados PostgreSQL gerenciado e relatar quaisquer mudanças de status e eventos para o Slack, para estar sempre de olho no que está acontecendo com seu banco de dados. Isso permitirá que você reaja rapidamente em caso de emergência, porque você receberá o feed de status em tempo real.</p>

<p>Se você quiser saber mais sobre os recursos do <code>check_postgres</code>, consulte a <a href="https://bucardo.org/check_postgres/check_postgres.pl.html#actions">documentação</a>, onde você encontrará muito mais comandos que você pode eventualmente usar. </p>

<p>Para obter mais informações sobre o que você pode fazer com seu banco de dados PostgreSQL gerenciado, visite a <a href="https://www.digitalocean.com/docs/databases/">doumentação de produto</a>.</p>
