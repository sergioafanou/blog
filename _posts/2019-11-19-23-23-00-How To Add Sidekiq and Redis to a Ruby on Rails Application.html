---
layout: post
title: How To Add Sidekiq and Redis to a Ruby on Rails Application
network: digitalocean
date: November 19, 2019 at 11:23PM
url: https://www.digitalocean.com/community/tutorials/how-to-add-sidekiq-and-redis-to-a-ruby-on-rails-application
image: https://assets.digitalocean.com/articles/docker_node_image/landing_page.png
tags: docker
feedtitle: DigitalOcean Community Tutorials
feedurl: https://www.digitalocean.com/community/tutorials
author: DigitalOcean
---
<h3 id="introduction">Introduction</h3>

<p>When developing a <a href="https://rubyonrails.org/">Ruby on Rails</a> application, you may find you have application tasks that should be performed asynchronously. Processing data, sending batch emails, or interacting with external APIs are all examples of work that can be done asynchronously with <em>background jobs</em>. Using background jobs can improve your application&rsquo;s performance by offloading potentially time-intensive tasks to a background processing queue, freeing up the original request/response cycle.</p>

<p><a href="https://sidekiq.org/">Sidekiq</a> is one of the more widely used background job frameworks that you can implement in a Rails application. It is backed by <a href="https://redis.io/">Redis</a>, an in-memory key-value store known for its flexibility and performance. Sidekiq uses Redis as a job management store to process <a href="https://github.com/mperham/sidekiq/#performance">thousands of jobs per second</a>.</p>

<p>In this tutorial, you will add Redis and Sidekiq to an existing Rails application. You will create a set of Sidekiq worker classes and methods to handle:</p>

<ul>
<li>A batch upload of endangered shark information to the application database from a CSV file in the project repository.</li>
<li>The removal of this data. </li>
</ul>

<p>When you are finished, you will have a demo application that uses workers and jobs to process tasks asynchronously. This will be a good foundation for you to add workers and jobs to your own application, using this tutorial as a jumping off point.</p>

<h2 id="prerequisites">Prerequisites</h2>

<p>To follow this tutorial, you will need: </p>

<ul>
<li>A local machine or development server running Ubuntu 18.04. Your development machine should have a non-root user with administrative privileges and a firewall configured with <code>ufw</code>. For instructions on how to set this up, see our <a href="https://www.digitalocean.com/community/tutorials/initial-server-setup-with-ubuntu-18-04">Initial Server Setup with Ubuntu 18.04</a> tutorial.</li>
<li><a href="https://nodejs.org">Node.js</a> and <a href="https://www.npmjs.com/">npm</a> installed on your local machine or development server. This tutorial uses Node.js version <span class="highlight">10.17.0</span> and npm version <span class="highlight">6.11.3</span>. For guidance on installing Node.js and npm on Ubuntu 18.04, follow the instructions in the <strong>&ldquo;Installing Using a PPA&rdquo;</strong> section of <a href="https://www.digitalocean.com/community/tutorials/how-to-install-node-js-on-ubuntu-18-04#installing-using-a-ppa">How To Install Node.js on Ubuntu 18.04</a>. </li>
<li>The <a href="https://yarnpkg.com/">Yarn package manager</a> installed on your local machine or development server. You can following the installation <a href="https://yarnpkg.com/en/docs/install#debian-stable">instructions</a> in the official documentation.</li>
<li>Ruby, <a href="https://github.com/rbenv/rbenv">rbenv</a>, and Rails installed on your local machine or development server, following <strong>Steps 1-4</strong> in <a href="https://www.digitalocean.com/community/tutorials/how-to-install-ruby-on-rails-with-rbenv-on-ubuntu-18-04">How To Install Ruby on Rails with rbenv on Ubuntu 18.04</a>. This tutorial uses Ruby <span class="highlight">2.5.1</span>, rbenv <span class="highlight">1.1.2</span>, and Rails <span class="highlight">5.2.3</span>.</li>
<li>SQLite installed, following <strong>Step 1</strong> of <a href="https://www.digitalocean.com/community/tutorials/how-to-build-a-ruby-on-rails-application">How To Build a Ruby on Rails Application</a>. This tutorial uses SQLite 3 <span class="highlight">3.22.0</span>.</li>
<li>Redis installed, following <strong>Steps 1-3</strong> of <a href="https://www.digitalocean.com/community/tutorials/how-to-install-and-secure-redis-on-ubuntu-18-04">How To Install and Secure Redis on Ubuntu 18.04</a>. This tutorial uses Redis <span class="highlight">4.0.9</span>.</li>
</ul>

<h2 id="step-1-—-cloning-the-project-and-installing-dependencies">Step 1 — Cloning the Project and Installing Dependencies</h2>

<p>Our first step will be to clone the <a href="https://github.com/do-community/rails-bootstrap">rails-bootstrap</a> repository from the <a href="https://github.com/do-community">DigitalOcean Community GitHub account</a>. This repository includes the code from the setup described in <a href="https://www.digitalocean.com/community/tutorials/how-to-add-bootstrap-to-a-ruby-on-rails-application">How To Add Bootstrap to a Ruby on Rails Application</a>, which explains how to add <a href="https://getbootstrap.com/">Bootstrap</a> to an existing Rails 5 project. </p>

<p>Clone the repository into a directory called <code><span class="highlight">rails-sidekiq</span></code>:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">git clone https://github.com/do-community/rails-bootstrap.git <span class="highlight">rails-sidekiq</span>
</li></ul></code></pre>
<p>Navigate to the <code><span class="highlight">rails-sidekiq</span></code> directory:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">cd <span class="highlight">rails-sidekiq</span>
</li></ul></code></pre>
<p>In order to work with the code, you will first need to install the project&rsquo;s dependencies, which are listed in its Gemfile. You will also need to add the <a href="https://github.com/mperham/sidekiq">sidekiq gem</a> to the project to work with Sidekiq and Redis.</p>

<p>Open the project&rsquo;s Gemfile for editing, using <code>nano</code> or your favorite editor:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">nano Gemfile
</li></ul></code></pre>
<p>Add the gem anywhere in the main project dependencies (above development dependencies):</p>
<div class="code-label " title="~/rails-sidekiq/Gemfile">~/rails-sidekiq/Gemfile</div><pre class="code-pre "><code langs="">. . . 
# Reduces boot times through caching; required in config/boot.rb
gem 'bootsnap', '&gt;= 1.1.0', require: false
<span class="highlight">gem 'sidekiq', '~&gt;6.0.0'</span>

group :development, :test do
. . .
</code></pre>
<p>Save and close the file when you are finished adding the gem.</p>

<p>Use the following command to install the gems:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">bundle install
</li></ul></code></pre>
<p>You will see in the output that the <a href="https://github.com/redis/redis-rb"><code>redis</code> gem</a> is also installed as a requirement for <code>sidekiq</code>.</p>

<p>Next, you will install your <a href="https://yarnpkg.com">Yarn</a> dependencies. Because this Rails 5 project has been modified to serve assets with webpack, its JavaScript dependencies are now managed by Yarn. This means that it&rsquo;s necessary to install and verify the dependencies listed in the project&rsquo;s <code>package.json</code> file.</p>

<p>Run <code>yarn install</code> to install these dependencies:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">yarn install
</li></ul></code></pre>
<p>Next, run your database migrations:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">rails db:migrate
</li></ul></code></pre>
<p>Once your migrations have finished, you can test the application to ensure that it is working as expected. Start your server in the context of your local bundle with the following command if you are working locally:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">bundle exec rails s
</li></ul></code></pre>
<p>If you are working on a development server, you can start the application with:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">bundle exec rails s --binding=<span class="highlight">your_server_ip</span>
</li></ul></code></pre>
<p>Navigate to <code>localhost:3000</code> or <code>http://<span class="highlight">your_server_ip</span>:3000</code>. You will see the following landing page:</p>

<p><img src="https://assets.digitalocean.com/articles/docker_node_image/landing_page.png" alt="Application Landing Page"></p>

<p>To create a new shark, click on the <strong>Get Shark Info</strong> button, which will take you to the <code>sharks/index</code> route:</p>

<p><img src="https://assets.digitalocean.com/articles/rails-sidekiq/shark_index_sidekiq.png" alt="Sharks Index Route"></p>

<p>To verify that the application is working, we can add some demo information to it. Click on <strong>New Shark</strong>. You will be prompted for a username (<strong>sammy</strong>) and password (<strong>shark</strong>), thanks to the project&rsquo;s <a href="https://www.digitalocean.com/community/tutorials/how-to-build-a-ruby-on-rails-application#step-%E2%80%94-adding-authentication">authentication settings</a>. </p>

<p>On the <strong>New Shark</strong> page, input &ldquo;Great White&rdquo; into the <strong>Name</strong> field and &ldquo;Scary&rdquo; into the <strong>Facts</strong> field:</p>

<p><img src="https://assets.digitalocean.com/articles/rails-sidekiq/shark_create_sidekiq.png" alt="Shark Create"></p>

<p>Click on the <strong>Create Shark</strong> button to create the shark. Once you see that your shark has been created, you can kill the server with <code>CTRL+C</code>.</p>

<p>You have now installed the necessary dependencies for your project and tested its functionality. Next, you can make a few changes to the Rails application to work with your endangered sharks resources.</p>

<h2 id="step-2-—-generating-a-controller-for-endangered-shark-resources">Step 2 — Generating a Controller for Endangered Shark Resources</h2>

<p>To work with our endangered shark resources, we will add a new model to the application and a controller that will control how information about endangered sharks is presented to users. Our ultimate goal is to make it possible for users to upload a large batch of information about endangered sharks without blocking our application&rsquo;s overall functionality, and to delete that information when they no longer need it.</p>

<p>First, let&rsquo;s create an <code>Endangered</code> model for our endangered sharks. We&rsquo;ll include a string field in our database table for the shark name, and another string field for the <a href="https://www.iucn.org/">International Union for the Conservation of Nature (IUCN)</a> <a href="https://www.iucn.org/resources/conservation-tools/iucn-red-list-threatened-species#RL_categories">categories</a> that determine the degree to which each shark is at risk. </p>

<p>Ultimately, our model structure will match the columns in the CSV file that we will use to create our batch upload. This file is located in the <code>db</code> directory, and you can check its contents with the following command:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">cat db/sharks.csv
</li></ul></code></pre>
<p>The file contains a list of 73 endangered sharks and their IUCN statuses - <strong>vu</strong> for vulnerable, <strong>en</strong> for endangered, and <strong>cr</strong> for critically endangered.</p>

<p>Our <code>Endangered</code> model will correlate with this data, allowing us to create new <code>Endangered</code> instances from this CSV file. Create the model with the following command:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">rails generate model Endangered name:string iucn:string
</li></ul></code></pre>
<p>Next, generate an <code>Endangered</code> controller with an <code>index</code> action:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">rails generate controller endangered index
</li></ul></code></pre>
<p>This will give us a starting point to build out our application&rsquo;s functionality, though we will also need to add custom methods to the controller file that Rails has generated for us.</p>

<p>Open that file now:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">nano app/controllers/endangered_controller.rb
</li></ul></code></pre>
<p>Rails has provided us with a skeletal outline that we can begin to fill in.</p>

<p>First, we&rsquo;ll need to determine what routes we require to work with our data. Thanks to the <code>generate controller</code> command, we have an <code>index</code> method to begin with. This will correlate to an <code>index</code> view, where we will present users with the option to upload endangered sharks.</p>

<p>However, we will also want to deal with cases where users may have already uploaded the sharks; they will not need an upload option in this case. We will somehow need to assess how many instances of the <code>Endangered</code> class already exist, since more than one indicates that the batch upload has already occurred.</p>

<p>Let&rsquo;s start by creating a <code>set_endangered</code> <code>private</code> method that will grab each instance of our <code>Endangered</code> class from the database. Add the following code to the file:</p>
<div class="code-label " title="~/rails-sidekiq/app/controllers/endangered_controller.rb">~/rails-sidekiq/app/controllers/endangered_controller.rb</div><pre class="code-pre "><code langs="">class EndangeredController &lt; ApplicationController
  <span class="highlight">before_action :set_endangered, only: [:index, :data]</span>

  def index
  end

  <span class="highlight">private</span>

    <span class="highlight">def set_endangered</span>
      <span class="highlight">@endangered = Endangered.all</span> 
    <span class="highlight">end</span>

end
</code></pre>
<p>Note that the <code>before_action</code> filter will ensure that the value of <code>@endangered</code> is only set for the <code>index</code> and <code>data</code> routes, which will be where we handle the endangered shark data.</p>

<p>Next, add the following code to the <code>index</code> method to determine the correct path for users visiting this part of the application: </p>
<div class="code-label " title="~/rails-sidekiq/app/controllers/endangered_controller.rb">~/rails-sidekiq/app/controllers/endangered_controller.rb</div><pre class="code-pre "><code langs="">class EndangeredController &lt; ApplicationController
  before_action :set_endangered, only: [:index, :data]

  def index          
    <span class="highlight">if <a href="https://www.digitalocean.com/community/users/endangered-length" class="username-tag">@endangered.length</a> &gt; 0</span>
      <span class="highlight">redirect_to endangered_data_path</span>
    <span class="highlight">else</span>
      <span class="highlight">render 'index'</span>
    <span class="highlight">end</span>
  end
. . . 
</code></pre>
<p>If there are more than 0 instances of our <code>Endangered</code> class, we will redirect users to the <code>data</code> route, where they can view information about the sharks they&rsquo;ve created. Otherwise, they will see the <code>index</code> view.</p>

<p>Next, below the <code>index</code> method, add a <code>data</code> method, which will correlate to a <code>data</code> view:</p>
<div class="code-label " title="~/rails-sidekiq/app/controllers/endangered_controller.rb">~/rails-sidekiq/app/controllers/endangered_controller.rb</div><pre class="code-pre "><code langs="">. . . 
  def index          
    if <a href="https://www.digitalocean.com/community/users/endangered-length" class="username-tag">@endangered.length</a> &gt; 0
      redirect_to endangered_data_path
    else
      render 'index'
    end
  end

  <span class="highlight">def data</span> 
  <span class="highlight">end</span>
. . .
</code></pre>
<p>Next, we will add a method to handle the data upload itself. We&rsquo;ll call this method <code>upload</code>, and it will call a Sidekiq worker class and method to perform the data upload from the CSV file. We will create the definition for this worker class, <code>AddEndangeredWorker</code>, in the next step.</p>

<p>For now, add the following code to the file to call the Sidekiq worker to perform the upload:</p>
<div class="code-label " title="~/rails-sidekiq/app/controllers/endangered_controller.rb">~/rails-sidekiq/app/controllers/endangered_controller.rb</div><pre class="code-pre "><code langs="">. . . 
  def data 
  end

  <span class="highlight">def upload</span>
    <span class="highlight">csv_file = File.join Rails.root, 'db', 'sharks.csv'</span>   
    <span class="highlight">AddEndangeredWorker.perform_async(csv_file)</span>
    <span class="highlight">redirect_to endangered_data_path, notice: 'Endangered sharks have been uploaded!'</span>
  <span class="highlight">end</span>
. . .
</code></pre>
<p>By calling the <code>perform_async</code> method on the <code>AddEndangeredWorker</code> class, using the CSV file as an argument, this code ensures that the shark data and upload job get passed to Redis. The Sidekiq workers that we will set up monitor the job queue and will respond when new jobs arise.</p>

<p>After calling <code>perform_async</code>, our <code>upload</code> method redirects to the <code>data</code> path, where users will be able to see the uploaded sharks.</p>

<p>Next, we&rsquo;ll add a <code>destroy</code> method to destroy the data. Add the following code below the <code>upload</code> method:</p>
<div class="code-label " title="~/rails-sidekiq/app/controllers/endangered_controller.rb">~/rails-sidekiq/app/controllers/endangered_controller.rb</div><pre class="code-pre "><code langs="">. . . 
  def upload
    csv_file = File.join Rails.root, 'db', 'sharks.csv'   
    AddEndangeredWorker.perform_async(csv_file)
    redirect_to endangered_data_path, notice: 'Endangered sharks have been uploaded!'
  end

  <span class="highlight">def destroy</span>
    <span class="highlight">RemoveEndangeredWorker.perform_async</span>
    <span class="highlight">redirect_to root_path</span>
  <span class="highlight">end</span>
. . . 
</code></pre>
<p>Like our <code>upload</code> method, our <code>destroy</code> method includes a <code>perform_async</code> call on a <code>RemoveEndangeredWorker</code> class – the other Sidekiq worker that we will create. After calling this method, it redirects users to the root application path.</p>

<p>The finished file will look like this:</p>
<div class="code-label " title="~/rails-sidekiq/app/controllers/endangered_controller.rb">~/rails-sidekiq/app/controllers/endangered_controller.rb</div><pre class="code-pre "><code langs="">class EndangeredController &lt; ApplicationController
  before_action :set_endangered, only: [:index, :data]

  def index          
    if @endangered.length &gt; 0
      redirect_to endangered_data_path
    else
      render 'index'
    end
  end

  def data 
  end

  def upload
    csv_file = File.join Rails.root, 'db', 'sharks.csv'   
    AddEndangeredWorker.perform_async(csv_file)
    redirect_to endangered_data_path, notice: 'Endangered sharks have been uploaded!'
  end

  def destroy
    RemoveEndangeredWorker.perform_async
    redirect_to root_path
  end

  private

    def set_endangered
      @endangered = Endangered.all 
    end 

end
</code></pre>
<p>Save and close the file when you are finished editing.</p>

<p>As a final step in solidifying our application&rsquo;s routes, we will modify the code in <code>config/routes.rb</code>, the file where our route declarations live.</p>

<p>Open that file now:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">nano config/routes.rb
</li></ul></code></pre>
<p>The file currently looks like this:</p>
<div class="code-label " title="~/rails-sidekiq/config/routes.rb">~/rails-sidekiq/config/routes.rb</div><pre class="code-pre "><code langs="">Rails.application.routes.draw do
  get 'endangered/index'
  get 'home/index'
  resources :sharks do
          resources :posts
  end
  root 'home#index'
  # For details on the DSL available within this file, see http://guides.rubyonrails.org/routing.html
end
</code></pre>
<p>We will need to update the file to include the routes that we&rsquo;ve defined in our controller: <code>data</code>, <code>upload</code>, and <code>destroy</code>. Our <code>data</code> route will match with a GET request to retrieve the shark data, while our <code>upload</code> and <code>destroy</code> routes will map to POST requests that upload and destroy that data.</p>

<p>Add the following code to the file to define these routes:</p>
<div class="code-label " title="~/rails-sidekiq/config/routes.rb">~/rails-sidekiq/config/routes.rb</div><pre class="code-pre "><code langs="">Rails.application.routes.draw do
  get 'endangered/index'
  <span class="highlight">get 'endangered/data', to: 'endangered#data'</span>
  <span class="highlight">post 'endangered/upload', to: 'endangered#upload'</span>
  <span class="highlight">post 'endangered/destroy', to: 'endangered#destroy'</span>
  get 'home/index'
  resources :sharks do
          resources :posts
  end
  root 'home#index'
  # For details on the DSL available within this file, see http://guides.rubyonrails.org/routing.html
end
</code></pre>
<p>Save and close the file when you are finished editing.</p>

<p>With your <code>Endangered</code> model and controller in place, you can now move on to defining your Sidekiq worker classes.</p>

<h2 id="step-3-—-defining-sidekiq-workers">Step 3 — Defining Sidekiq Workers</h2>

<p>We have called <code>perform_async</code> methods on our Sidekiq workers in our controller, but we still need to create the workers themselves.</p>

<p>First, create a <code>workers</code> directory for the workers:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">mkdir app/workers
</li></ul></code></pre>
<p>Open a file for the <code>AddEndangeredWorker</code> worker:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">nano app/workers/add_endangered_worker.rb
</li></ul></code></pre>
<p>In this file, we will add code that will allow us to work with the data in our CSV file. First, add code to the file that will create the class, include the <a href="https://ruby-doc.org/stdlib-2.6.1/libdoc/csv/rdoc/CSV.html#method-c-foreach">Ruby CSV library</a>, and ensure that this class functions as a Sidekiq Worker:</p>
<div class="code-label " title="~/rails-sidekiq/app/workers/add_endangered_worker.rb">~/rails-sidekiq/app/workers/add_endangered_worker.rb</div><pre class="code-pre "><code langs="">class AddEndangeredWorker
  require 'csv'
  include Sidekiq::Worker
  sidekiq_options retry: false

end
</code></pre>
<p>We&rsquo;re also including the <code>retry: false</code> option to ensure that Sidekiq does not retry the upload in the case of failure.</p>

<p>Next, add the code for the <code>perform</code> function:</p>
<div class="code-label " title="~/rails-sidekiq/app/workers/add_endangered_worker.rb">~/rails-sidekiq/app/workers/add_endangered_worker.rb</div><pre class="code-pre "><code langs="">class AddEndangeredWorker
  require 'csv'
  include Sidekiq::Worker
  sidekiq_options retry: false

  <span class="highlight">def perform(csv_file)</span>
    <span class="highlight">CSV.foreach(csv_file, headers: true) do |shark|</span>
    <span class="highlight">Endangered.create(name: shark[0], iucn: shark[1])</span>
  <span class="highlight">end</span>
 <span class="highlight">end</span>

end
</code></pre>
<p>The <code>perform</code> method receives arguments from the <code>perform_async</code> method defined in the controller, so it&rsquo;s important that the argument values are aligned. Here, we pass in <code>csv_file</code>, the variable we defined in the controller, and we use the <code>foreach</code> method from the CSV library to read the values in the file. Setting <code>headers: true</code> for this loop ensures that the first row of the file is treated as a row of headers.</p>

<p>The block then reads the values from the file into the columns we set for our <code>Endangered</code> model: <code>name</code> and <code>iucn</code>. Running this loop will create <code>Endangered</code> instances for each of the entries in our CSV file.</p>

<p>Once you have finished editing, save and close the file.</p>

<p>Next, we will create a worker to handle deleting this data. Open a file for the <code>RemoveEndangeredWorker</code> class:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">nano app/workers/remove_endangered_worker.rb
</li></ul></code></pre>
<p>Add the code to define the class, and to ensure that it uses the CSV library and functions as a Sidekiq Worker:</p>
<div class="code-label " title="~/rails-sidekiq/app/workers/remove_endangered_worker.rb">~/rails-sidekiq/app/workers/remove_endangered_worker.rb</div><pre class="code-pre "><code langs="">class RemoveEndangeredWorker
  include Sidekiq::Worker
  sidekiq_options retry: false

end
</code></pre>
<p>Next, add a <code>perform</code> method to handle the destruction of the endangered shark data:</p>
<div class="code-label " title="~/rails-sidekiq/app/workers/remove_endangered_worker.rb">~/rails-sidekiq/app/workers/remove_endangered_worker.rb</div><pre class="code-pre "><code langs="">class RemoveEndangeredWorker
  include Sidekiq::Worker
  sidekiq_options retry: false

  <span class="highlight">def perform</span>
    <span class="highlight">Endangered.destroy_all</span>
  <span class="highlight">end</span>

end
</code></pre>
<p>The <code>perform</code> method calls <code>destroy_all</code> on the <code>Endangered</code> class, which will remove all instances of the class from the database.</p>

<p>Save and close the file when you are finished editing.</p>

<p>With your workers in place, you can move on to creating a layout for your <code>endangered</code> views, and templates for your <code>index</code> and <code>data</code> views, so that users can upload and view endangered sharks.</p>

<h2 id="step-4-—-adding-layouts-and-view-templates">Step 4 — Adding Layouts and View Templates</h2>

<p>In order for users to enjoy their endangered shark information, we will need to address two things: the layout for the views defined in our <code>endangered</code> controller, and the view templates for the <code>index</code> and <code>data</code> views.</p>

<p>Currently, our application makes use of an application-wide layout, located at <code>app/views/layouts/application.html.erb</code>, a navigation partial, and a layout for <code>sharks</code> views. The application layout checks for a content block, which allows us to load different layouts based on which part of the application our user is engaging with: for the <code>home</code> <code>index</code> page, they will see one layout, and for any views relating to individual sharks, they will see another.</p>

<p>We can repurpose the <code>sharks</code> layout for our <code>endangered</code> views since this format will also work for presenting shark data in bulk.</p>

<p>Copy the <code>sharks</code> layout file over to create an <code>endangered</code> layout:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">cp app/views/layouts/sharks.html.erb app/views/layouts/endangered.html.erb
</li></ul></code></pre>
<p>Next, we&rsquo;ll work on creating the view templates for our <code>index</code> and <code>data</code> views.</p>

<p>Open the <code>index</code> template first:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">nano app/views/endangered/index.html.erb
</li></ul></code></pre>
<p>Delete the boilerplate code and add the following code instead, which will give users some general information about the endangered categories and present them with the option to upload information about endangered sharks:</p>
<div class="code-label " title="~/rails-sidekiq/app/views/endangered/index.html.erb">~/rails-sidekiq/app/views/endangered/index.html.erb</div><pre class="code-pre "><code langs="">&lt;p id="notice"&gt;&lt;%= notice %&gt;&lt;/p&gt;

&lt;h1&gt;Endangered Sharks&lt;/h1&gt;

&lt;p&gt;International Union for Conservation of Nature (ICUN) statuses: &lt;b&gt;vu:&lt;/b&gt; Vulnerable, &lt;b&gt;en:&lt;/b&gt; Endangered, &lt;b&gt;cr:&lt;/b&gt; Critically Endangered &lt;/p&gt;

&lt;br&gt;

  &lt;%= form_tag endangered_upload_path do %&gt;
  &lt;%= submit_tag "Import Endangered Sharks" %&gt;
  &lt;% end %&gt;

  &lt;br&gt;

&lt;%= link_to 'New Shark', new_shark_path, :class =&gt; "btn btn-primary btn-sm" %&gt; &lt;%= link_to 'Home', home_index_path, :class =&gt; "btn btn-primary btn-sm" %&gt;
</code></pre>
<p>A <code>form_tag</code> makes the data upload possible by pointing a post action to the <code>endangered_upload_path</code> – the route we defined for our uploads. A submit button, created with the <code>submit_tag</code>, prompts users to <code>"Import Endangered Sharks"</code>.</p>

<p>In addition to this code, we&rsquo;ve included some general information about ICUN codes, so that users can interpret the data they will see.</p>

<p>Save and close the file when you are finished editing.</p>

<p>Next, open a file for the <code>data</code> view:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">nano app/views/endangered/data.html.erb
</li></ul></code></pre>
<p>Add the following code, which will add a table with the endangered shark data:</p>
<div class="code-label " title="~/rails-sidekiq/app/views/endangered/data.html.erb">~/rails-sidekiq/app/views/endangered/data.html.erb</div><pre class="code-pre "><code langs="">&lt;p id="notice"&gt;&lt;%= notice %&gt;&lt;/p&gt;

&lt;h1&gt;Endangered Sharks&lt;/h1&gt;

&lt;p&gt;International Union for Conservation of Nature (ICUN) statuses: &lt;b&gt;vu:&lt;/b&gt; Vulnerable, &lt;b&gt;en:&lt;/b&gt; Endangered, &lt;b&gt;cr:&lt;/b&gt; Critically Endangered &lt;/p&gt;

&lt;div class="table-responsive"&gt;
&lt;table class="table table-striped table-dark"&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;Name&lt;/th&gt;
      &lt;th&gt;IUCN Status&lt;/th&gt;
      &lt;th colspan="3"&gt;&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;

  &lt;tbody&gt;
    &lt;% @endangered.each do |shark| %&gt;
      &lt;tr&gt;
        &lt;td&gt;&lt;%= shark.name %&gt;&lt;/td&gt;
        &lt;td&gt;&lt;%= shark.iucn %&gt;&lt;/td&gt;
      &lt;/tr&gt;
    &lt;% end %&gt;
  &lt;/tbody&gt;
&lt;/table&gt;
&lt;/div&gt;

&lt;br&gt;

  &lt;%= form_tag endangered_destroy_path do %&gt;
  &lt;%= submit_tag "Delete Endangered Sharks" %&gt;
  &lt;% end %&gt;

  &lt;br&gt;

&lt;%= link_to 'New Shark', new_shark_path, :class =&gt; "btn btn-primary btn-sm" %&gt; &lt;%= link_to 'Home', home_index_path, :class =&gt; "btn btn-primary btn-sm" %&gt;
</code></pre>
<p>This code includes the ICUN status codes once again, and a Bootstrap table for the outputted data. By looping through our <code>@endangered</code> variable, we output the name and ICUN status of each shark to the table.</p>

<p>Below the table, we have another set of <code>form_tags</code> and <code>submit_tags</code>, which post to the <code>destroy</code> path by offering users the option to <code>"Delete Endangered Sharks"</code>.</p>

<p>Save and close the file when you are finished editing.</p>

<p>The last modification we&rsquo;ll make to our views will be in the <code>index</code> view associated with our <code>home</code> controller. You may recall that this view is set as the root of the application in <code>config/routes.rb</code>.</p>

<p>Open this file for editing:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">nano app/views/home/index.html.erb
</li></ul></code></pre>
<p>Find the column in the row that states <code>Sharks are ancient</code>:</p>
<div class="code-label " title="~/rails-sidekiq/app/views/home/index.html.erb">~/rails-sidekiq/app/views/home/index.html.erb</div><pre class="code-pre "><code langs="">. . . 
        &lt;div class="col-lg-6"&gt;
            &lt;h3&gt;Sharks are ancient&lt;/h3&gt;
            &lt;p&gt;There is evidence to suggest that sharks lived up to 400 million years ago.
            &lt;/p&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;
</code></pre>
<p>Add the following code to the file:</p>
<div class="code-label " title="~/rails-sidekiq/app/views/home/index.html.erb">~/rails-sidekiq/app/views/home/index.html.erb</div><pre class="code-pre "><code langs="">. . . 
        &lt;div class="col-lg-6"&gt;
            &lt;h3&gt;Sharks are ancient <span class="highlight">and SOME are in danger</span>&lt;/h3&gt;
            &lt;p&gt;There is evidence to suggest that sharks lived up to 400 million years ago. <span class="highlight">Without our help, some could disappear soon.&lt;/p&gt;</span>
            <span class="highlight">&lt;p&gt;&lt;%= button_to 'Which Sharks Are in Danger?', endangered_index_path, :method =&gt; :get,  :class =&gt; "btn btn-primary btn-sm"%&gt;</span>
            &lt;/p&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;
</code></pre>
<p>We&rsquo;ve included a call to action for users to learn more about endangered sharks, by first sharing a strong message, and then adding a <code>button_to</code> helper that submits a GET request to our <code>endangered</code> <code>index</code> route, giving users access to that part of the application. From there, they will be able to upload and view endangered shark information.</p>

<p>Save and close the file when you are finished editing.</p>

<p>With your code in place, you are ready to start the application and upload some sharks!</p>

<h2 id="step-5-—-starting-sidekiq-and-testing-the-application">Step 5 — Starting Sidekiq and Testing the Application</h2>

<p>Before we start the application, we&rsquo;ll need to run migrations on our database and start Sidekiq to enable our workers. Redis should already be running on the server, but we can check to be sure. With all of these things in place, we&rsquo;ll be ready to test the application.</p>

<p>First, check that Redis is running:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">systemctl status redis
</li></ul></code></pre>
<p>You should see output like the following:</p>
<pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>● redis-server.service - Advanced key-value store
   Loaded: loaded (/lib/systemd/system/redis-server.service; enabled; vendor preset: enabled)
   Active: <span class="highlight">active (running)</span> since Tue 2019-11-12 20:37:13 UTC; 1 weeks 0 days ago
</code></pre>
<p>Next, run your database migrations:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">rails db:migrate
</li></ul></code></pre>
<p>You can now start Sidekiq in the context of your current project bundle by using the <code>bundle exec sidekiq</code> command:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">bundle exec sidekiq
</li></ul></code></pre>
<p>You will see output like this, indicating that Sidekiq is ready to process jobs:</p>
<pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>

               m,
               `$b
          .ss,  $$:         .,d$
          `$$P,d$P'    .,md$P"'
           ,$$$$$b/md$$$P^'
         .d$$$$$$/$$$P'
         $$^' `"/$$$'       ____  _     _      _    _
         $:     ,$$:       / ___|(_) __| | ___| | _(_) __ _
         `b     :$$        \___ \| |/ _` |/ _ \ |/ / |/ _` |
                $$:         ___) | | (_| |  __/   &lt;| | (_| |
                $$         |____/|_|\__,_|\___|_|\_\_|\__, |
              .d$$                                       |_|


2019-11-19T21:43:00.540Z pid=17621 tid=gpiqiesdl INFO: Running in ruby 2.5.1p57 (2018-03-29 revision 63029) [x86_64-linux]
2019-11-19T21:43:00.540Z pid=17621 tid=gpiqiesdl INFO: See LICENSE and the LGPL-3.0 for licensing details.
2019-11-19T21:43:00.540Z pid=17621 tid=gpiqiesdl INFO: Upgrade to Sidekiq Pro for more features and support: http://sidekiq.org
2019-11-19T21:43:00.540Z pid=17621 tid=gpiqiesdl INFO: Booting Sidekiq 6.0.3 with redis options {:id=&gt;"Sidekiq-server-PID-17621", :url=&gt;nil}
2019-11-19T21:43:00.543Z pid=17621 tid=gpiqiesdl INFO: Starting processing, hit Ctrl-C to stop
</code></pre>
<p>Open a second terminal window, navigate to the <code><span class="highlight">rails-sidekiq</span></code> directory, and start your application server. </p>

<p>If you are running the application locally, use the following command:</p>
<pre class="code-pre command second-environment"><code langs=""><ul class="prefixed"><li class="line" prefix="$">bundle exec rails s
</li></ul></code></pre>
<p>If you are working with a development server, run the following:</p>
<pre class="code-pre command second-environment"><code langs=""><ul class="prefixed"><li class="line" prefix="$">bundle exec rails s --binding=<span class="highlight">your_server_ip</span>
</li></ul></code></pre>
<p>Navigate to <code>localhost:3000</code> or <code>http://<span class="highlight">your_server_ip</span>:3000</code> in the browser. You will see the following landing page:</p>

<p><img src="https://assets.digitalocean.com/articles/rails-sidekiq/sidekiq_home.png" alt="Sidekiq App Home"></p>

<p>Click on the <strong>Which Sharks Are in Danger?</strong> button. Since you have not uploaded any endangered sharks, this will take you to the <code>endangered</code> <code>index</code> view:</p>

<p><img src="https://assets.digitalocean.com/articles/rails-sidekiq/sidekiq_index.png" alt="Endangered Index View"></p>

<p>Click on <strong>Import Endangered Sharks</strong> to import the sharks. You will see a status message telling you that the sharks have been imported:</p>

<p><img src="https://assets.digitalocean.com/articles/rails-sidekiq/begin_import.png" alt="Begin Import"></p>

<p>You will also see the beginning of the import. Refresh your page to see the entire table:</p>

<p><img src="https://assets.digitalocean.com/articles/rails-sidekiq/refresh.png" alt="Refresh Table"></p>

<p>Thanks to Sidekiq, our large batch upload of endangered sharks has succeeded without locking up the browser or interfering with other application functionality.</p>

<p>Click on the <strong>Home</strong> button at the bottom of the page, which will bring you back to the application main page:</p>

<p><img src="https://assets.digitalocean.com/articles/rails-sidekiq/sidekiq_home.png" alt="Sidekiq App Home"></p>

<p>From here, click on <strong>Which Sharks Are in Danger?</strong> again. This will now take you directly to the <code>data</code> view, since you already uploaded the sharks.</p>

<p>To test the delete functionality, click on the <strong>Delete Endangered Sharks</strong> button below the table. You should be redirected to the home application page once again. Clicking on <strong>Which Sharks Are in Danger?</strong> one last time will take you back to the <code>index</code> view, where you will have the option to upload sharks again:</p>

<p><img src="https://assets.digitalocean.com/articles/rails-sidekiq/sidekiq_index.png" alt="Endangered Index View"></p>

<p>Your application is now running with Sidekiq workers in place, which are ready to process jobs and ensure that users have a good experience working with your application. </p>

<h2 id="conclusion">Conclusion</h2>

<p>You now have a working Rails application with Sidekiq enabled, which will allow you to offload costly operations to a job queue managed by Sidekiq and backed by Redis. This will allow you to improve your site&rsquo;s speed and functionality as you develop.</p>

<p>If you would like to learn more about Sidekiq, the <a href="https://github.com/mperham/sidekiq/wiki">docs</a> are a good place to start. </p>

<p>To learn more about Redis, check out our library of <a href="https://www.digitalocean.com/community/tags/redis?type=tutorials">Redis resources</a>. You can also learn more about running a managed Redis cluster on DigitalOcean by looking at the <a href="https://www.digitalocean.com/docs/databases/redis/">product documentation</a>.</p>
