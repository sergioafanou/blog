---
layout: post
title: Установка и настройка Nextcloud в Ubuntu 18.04
network: digitalocean
date: January 07, 2020 at 07:31PM
url: https://www.digitalocean.com/community/tutorials/how-to-install-and-configure-nextcloud-on-ubuntu-18-04-ru
image: https://assets.digitalocean.com/articles/nextcloud_1804/login_page.png
tags: docker
feedtitle: DigitalOcean Community Tutorials
feedurl: https://www.digitalocean.com/community/tutorials
author: DigitalOcean
---
<h3 id="Введение">Введение</h3>

<p><a href="https://nextcloud.com/">Nextcloud</a> (ответвление проекта ownCloud) — напоминающий Dropbox файлообменный сервер для централизованного хранения персонального контента, в том числе документов и изображений. Отличие Nextcloud в том, что весь его функционал реализован с открытым исходным кодом. Также Nextcloud возвращает вам возможность управления и защиты важных данных, не требуя использования стороннего облачного сервиса для хостинга.</p>

<p>В этом обучающем модуле мы научимся устанавливать и настраивать экземпляр Nextcloud на сервере Ubuntu 18.04.</p>

<h2 id="Предварительные-требования">Предварительные требования</h2>

<p>Чтобы выполнить перечисленные в настоящем руководстве шаги, вам потребуется следующее:</p>

<ul>
<li><strong>Пользователь sudo и настроенный брандмауэр на сервере.</strong> Вы можете создать пользователя с привилегиями <code>sudo</code> и настроить базовый брандмауэр в соответствии с указаниями руководства <a href="https://www.digitalocean.com/community/tutorials/initial-server-setup-with-ubuntu-18-04">«Начальная настройка сервера Ubuntu 18.04»</a>.</li>
<li><strong>(Необязательно) Доменное имя, указывающее на ваш сервер.</strong> Для защиты подключений к Nextcloud мы будем использовать TLS/SSL. Если у вашего сервера есть доменное имя, Nextcloud может настроить бесплатный защищенный сертификат SSL от <a href="https://letsencrypt.org/">Let&rsquo;s Encrypt</a> и обеспечить управление этим сертификатом. Также Nextcloud позволяет настроить сертификат SSL с собственной подписью, который сможет шифровать соединения, но которому браузеры не будут доверять по умолчанию. Если вы используете DigitalOcean и намереваетесь использовать Let&rsquo;s Encrypt, вы можете использовать наше руководство по настройке <a href="https://www.digitalocean.com/docs/networking/dns/how-to/add-domains/">доменного имени для вашего сервера.</a></li>
</ul>

<p>Выполнив вышеперечисленные шаги, изучите возможности настройки Nextcloud на своем сервере.</p>

<h2 id="Шаг-1-–-Установка-nextcloud">Шаг 1 – Установка Nextcloud</h2>

<p>Мы выполним установку Nextcloud с помощью системы пакетов <a href="https://en.wikipedia.org/wiki/Snappy_(package_manager)">snappy</a>. Эта система пакетов доступна в Ubuntu 18.04 по умолчанию. Она позволяет организациям поставлять программное обеспечение со всеми зависимостями и конфигурациями в самодостаточном блоке с автоматическими обновлениями. Это означает, что вместо установки и настройки веб-сервера и сервера базы данных и настройки приложения Nextcloud для работы с ними мы можем установить пакет <code>snap</code>, который автоматически настроит все системы.</p>

<p>Чтобы загрузить пакет Nextcloud <code>snap</code> и установить его в системе, введите:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo snap install nextcloud
</li></ul></code></pre>
<p>Пакет Nextcloud будет загружен и установлен на ваш сервер. Вы можете проверить успешность установки посредством вывода изменений, связанных с пакетом <code>snap</code>:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">snap changes nextcloud
</li></ul></code></pre><pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>ID   Status  Spawn               Ready               Summary
2    <span class="highlight">Done</span>    today at 16:12 UTC  today at 16:12 UTC  <span class="highlight">Install "nextcloud" snap</span>
</code></pre>
<p>Информация о состоянии и сводная информация показывают, что установка была выполнена без проблем.</p>

<h3 id="Получение-дополнительной-информации-о-nextcloud-snap">Получение дополнительной информации о Nextcloud Snap</h3>

<p>Если вам нужна дополнительная информация о Nextcloud <code>snap</code>, вам могут помочь несколько полезных команд.</p>

<p>Команда <code>snap info</code> показывает описание, доступные команды управления Nextcloud, установленную версию и отслеживаемый канал snap:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">snap info nextcloud
</li></ul></code></pre>
<p>Пакеты snap могут определять поддерживаемые ими интерфейсы, включающие элементы slot и plug, сочетание которых дает snap определенные уровни доступа. Например, если пакет snap требуется использовать в качестве сетевого клиента, у него должен быть <code>network</code> интерфейс. Чтобы увидеть, какие интерфейсы задает этот пакет snap, введите:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">snap interfaces nextcloud
</li></ul></code></pre><pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>Slot           Plug
:network       nextcloud
:network-bind  nextcloud
-              nextcloud:removable-media
</code></pre>
<p>Чтобы узнать обо всех конкретных службах и приложениях, предоставляемых этим пакетом snap, вы можете посмотреть файл определения snap, для чего нужно ввести следующее:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">cat /snap/nextcloud/current/meta/snap.yaml
</li></ul></code></pre>
<p>Это позволит вам увидеть отдельные компоненты, входящие в пакет snap, если вам потребуется помощь с отладкой.</p>

<h2 id="Настройка-административной-учетной-записи">Настройка административной учетной записи</h2>

<p>Существует несколько разных способов, которыми вы можете настроить Nextcloud snap. В этом руководстве мы не будем рассматривать создание пользователя с правами администратора через веб-интерфейс. Вместо этого мы создадим такого пользователя через командную строку, чтобы избежать появления небольшого окна, в котором страница регистрации администратора будет доступна любому посетителю IP-адреса или домена вашего сервера.</p>

<p>Чтобы настроить Nextcloud с новой учетной записью администратора, используйте команду <code>nextcloud.manual-install</code>. В качестве аргументов следует задать имя пользователя и пароль:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo nextcloud.manual-install <span class="highlight">sammy</span> <span class="highlight">password</span>
</li></ul></code></pre>
<p>Следующее сообщение указывает, что настройка Nextcloud выполнена правильно:</p>
<pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>Nextcloud is not installed - only a limited number of commands are available
<span class="highlight">Nextcloud was successfully installed</span>
</code></pre>
<p>После установки Nextcloud нам необходимо настроить доверенные домены, чтобы Nextcloud реагировал на запросы с использованием доменного имени или IP-адреса сервера.</p>

<h2 id="Настройка-доверенных-доменов">Настройка доверенных доменов</h2>

<p>При установке из командной строки Nextcloud ограничивает имена хостов, на которые будет реагировать устанавливаемый экземпляр. По умолчанию служба отвечает только на запросы, обращенные к хосту с именем localhost. Для доступа к Nextcloud мы будем использовать доменное имя сервера или IP-адрес, и поэтому нам нужно изменить эту настройку, чтобы можно было применять запросы этого типа.</p>

<p>Вы можете просмотреть текущие настройки, запросив значение массива <code>trusted_domains</code>:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo nextcloud.occ config:system:get trusted_domains
</li></ul></code></pre><pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div><span class="highlight">localhost</span>
</code></pre>
<p>В настоящее время в массиве содержится только первое значение <code>localhost</code>. Мы можем добавить запись для доменного имени или IP-адреса нашего сервера, введя следующее:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo nextcloud.occ config:system:set trusted_domains 1 --value=<span class="highlight">example.com</span>
</li></ul></code></pre><pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div><span class="highlight">System config value trusted_domains =&gt; 1 set to string example.com</span>
</code></pre>
<p>Если мы снова запросим значение trusted domains, мы увидим уже две записи:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo nextcloud.occ config:system:get trusted_domains
</li></ul></code></pre><pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div><span class="highlight">localhost</span>
<span class="highlight">example.com</span>
</code></pre>
<p>Если вам потребуется добавить другой способ доступа к экземпляру Nextcloud, вы можете добавить дополнительные домены или адреса посредством повторного запуска команды <code>config:system:set</code> с инкрементальным увеличением номера индекса (1 в первой команде) и изменением значения <code>--value</code>.</p>

<h2 id="Защита-веб-интерфейса-nextcloud-с-помощью-ssl">Защита веб-интерфейса Nextcloud с помощью SSL</h2>

<p>Прежде чем мы начнем использовать Nextcloud, нам нужно обеспечить защиту веб-интерфейса.</p>

<p>Если с вашим сервером Nextcloud связано доменное имя, пакет Nextcloud snap может помочь вам получить и настроить защищенный сертификат SSL от <a href="https://letsencrypt.org/">Let&rsquo;s Encrypt</a>. Если у вашего сервера Nextcloud <em>нет</em> доменного имени, Nextcloud может настроить сертификат с собственной подписью, который будет шифровать веб-трафик, но не будет подтверждать надежность вашего сервера.</p>

<p>Учитывая это, перейдите к разделу, который соответствует вашей ситуации.</p>

<h3 id="Вариант-1-настройка-ssl-с-помощью-let-39-s-encrypt">Вариант 1: настройка SSL с помощью Let&rsquo;s Encrypt</h3>

<p>Если с вашим сервером Nextcloud связано доменное имя, веб-интерфейс лучше всего защитить посредством сертификата SSL от Let&rsquo;s Encrypt.</p>

<p>Для начала откройте порты брандмауэра, которые Let&rsquo;s Encrypt использует для подтверждения владения доменом. При этом ваша страница входа Nextcloud станет общедоступной, но поскольку мы уже настроили учетную запись администратора, никто не сможет ее взломать:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo ufw allow 80,443/tcp
</li></ul></code></pre>
<p>Затем запросите сертификат Let&rsquo;s Encrypt с помощью следующей команды:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo nextcloud.enable-https lets-encrypt
</li></ul></code></pre>
<p>Вначале вам нужно будет подтвердить, что ваш сервер соответствует условиям запроса сертификата в службе Let&rsquo;s Encrypt:</p>
<pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>In order for Let's Encrypt to verify that you actually own the
domain(s) for which you're requesting a certificate, there are a
number of requirements of which you need to be aware:

1. In order to register with the Let's Encrypt ACME server, you must
   agree to the currently-in-effect Subscriber Agreement located
   here:

       https://letsencrypt.org/repository/

   By continuing to use this tool you agree to these terms. Please
   cancel now if otherwise.

2. You must have the domain name(s) for which you want certificates
   pointing at the external IP address of this machine.

3. Both ports 80 and 443 on the external IP address of this machine
   must point to this machine (e.g. port forwarding might need to be
   setup on your router).

Have you met these requirements? (y/n)
</code></pre>
<p>Введите <strong>y</strong>, чтобы продолжить.</p>

<p>Далее вам нужно будет указать адрес электронной почты, который будет использоваться для восстановления:</p>
<pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>Please enter an email address (for urgent notices or key recovery): <span class="highlight">your_email@domain.com</span>
</code></pre>
<p>На заключительном этапе вам нужно будет ввести доменное имя, привязанное к вашему серверу Nextcloud:</p>
<pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>Please enter your domain name(s) (space-separated): <span class="highlight">example.com</span>
</code></pre>
<p>Сервер запросит сертификат Let&rsquo;s Encrypt, и если все пройдет нормально, система перезапустит внутренний экземпляр Apache для немедленной активации SSL:</p>
<pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>Attempting to obtain certificates... done
Restarting apache... done
</code></pre>
<p>Теперь можно переходить <a href="#logging-in-to-the-nextcloud-web-interface">к первому входу в систему Nextcloud</a>.</p>

<h3 id="Вариант-2-Настройка-ssl-с-сертификатом-с-собственной-подписью">Вариант 2: Настройка SSL с сертификатом с собственной подписью</h3>

<p>Если у вашего сервера Nextcloud <em>нет</em> доменного имени, вы можете защитить веб-интерфейс, создав сертификат SSL с собственной подписью. Этот сертификат обеспечит доступ к веб-интерфейсу через шифрованное соединение, но не сможет подтверждать подлинность вашего сервера, и поэтому ваш браузер может вывести предупреждение при попытке открыть сервер.</p>

<p>Чтобы сгенерировать сертификат с собственной подписью и настроить Nextcloud для его использования, введите:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo nextcloud.enable-https self-signed
</li></ul></code></pre><pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>Generating key and self-signed certificate... done
Restarting apache... done
</code></pre>
<p>Показанный выше результат означает, что Nextcloud сгенерировал и активировал сертификат с собственной подписью.</p>

<p>Теперь, когда вы защитили интерфейс, откройте веб-порты брандмауэра, чтобы разрешить доступ к веб-интерфейсу:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo ufw allow 80,443/tcp
</li></ul></code></pre>
<p>Вы готовы к первому входу в Nextcloud.</p>

<h2 id="Вход-в-веб-интерфейс-nextcloud">Вход в веб-интерфейс Nextcloud</h2>

<p>Мы завершили настройку Nextcloud, и теперь вы можете открыть доменное имя или IP-адрес вашего сервера в браузере:</p>
<pre class="code-pre "><code langs="">https://<span class="highlight">example.com</span>
</code></pre>
<p><span class='note'><strong>Примечание.</strong> Если вы настроите сертификат SSL с собственной подписью, ваш браузер может выдать предупреждение о небезопасном подключении, поскольку сертификат сервера не подписан признанным центром сертификации. Это нормально для сертификатов с собственной подписью, так что вы можете игнорировать предупреждение и перейти на сайт.<br></span></p>

<p>Поскольку вы уже настроили учетную запись администратора из командной строки, вы перейдете на страницу входа Nextcloud. Введите учетные данные, которые вы создали для администратора:</p>

<p><img src="https://assets.digitalocean.com/articles/nextcloud_1804/login_page.png" alt="Страница входа в систему Nextcloud"></p>

<p>Нажмите кнопку <strong>Log in</strong> (Вход) для входа в веб-интерфейс Nextcloud.</p>

<p>При первом входе в систему откроется окно со ссылками на различные клиенты Nextcloud, которые можно использовать для взаимодействия с вашим экземпляром Nextcloud и управления им:</p>

<p><img src="https://assets.digitalocean.com/articles/nextcloud_1804/modal.png" alt="Типовые клиенты Nextcloud"></p>

<p>Загрузите любые клиенты, которые вам интересны, или закройте окно, нажав <strong>X</strong> в правом верхнем углу. Вы перейдете в главный интерфейс Nextcloud, где сможете выгружать файлы и управлять ими:</p>

<p><img src="https://assets.digitalocean.com/articles/nextcloud_1804/main_page.png" alt="Главная страница Nextcloud"></p>

<p>Установка завершена и защищена. Теперь вы можете изучить интерфейс, чтобы лучше узнать особенности и познакомиться с функционалом новой системы.</p>

<h2 id="Заключение">Заключение</h2>

<p>Nextcloud позволяет воспроизводить возможности популярных облачных сервисов хранения файлов. Контентом можно делиться с другими пользователями или делать его общедоступным через публичные URL. Преимущество Nextcloud заключается в том, что информация хранится в надежном месте, которое вы контролируете.</p>

<p>Изучите интерфейс и установите плагины из <a href="https://apps.nextcloud.com/">магазина приложений Nextcloud</a>, если вам требуются дополнительные возможности.</p>
