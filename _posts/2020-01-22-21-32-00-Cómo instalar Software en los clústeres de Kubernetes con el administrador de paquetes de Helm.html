---
layout: post
title: Cómo instalar Software en los clústeres de Kubernetes con el administrador de paquetes de Helm
network: digitalocean
date: January 22, 2020 at 09:32PM
url: https://www.digitalocean.com/community/tutorials/how-to-install-software-on-kubernetes-clusters-with-the-helm-package-manager-es
image: http://ifttt.com/images/no_image_card.png
tags: docker
feedtitle: DigitalOcean Community Tutorials
feedurl: https://www.digitalocean.com/community/tutorials
author: DigitalOcean
---
<h3 id="introducción">Introducción</h3>

<p><a href="https://www.helm.sh">Helm</a> es un administrador de paquetes para Kubernetes que permite a los desarrolladores y operadores configurar e implementar de forma más sencilla aplicaciones en los clústeres de Kubernetes.</p>

<p>En este tutorial, configuraremos Helm y lo utilizaremos para instalar, volver a configurar, restaurar y luego borrar una instancia de <a href="https://github.com/kubernetes/dashboard">la aplicación Kubernetes Dashboard</a>. El panel es una GUI de Kubernetes oficial basado en la web.</p>

<p>Para obtener una descripción general conceptual de Helm y su ecosistema de paquetes, lea nuestro artículo <a href="https://www.digitalocean.com/community/tutorials/an-introduction-to-helm-the-package-manager-for-kubernetes"><em>Introducción a Helm.</em></a></p>

<h2 id="requisitos-previos">Requisitos previos</h2>

<p>Para este tutorial, necesitará lo siguiente:</p>

<ul>
<li>Un clúster de Kubernetes 1.8, o versiones posteriores, con control de acceso basado en roles (RBAC) habilitado.</li>
<li>La herramienta de línea de comandos <code>kubectl</code> instalada en su equipo local, configurada para conectarse a su clúster. Puede leer más sobre la instalación de <code>kubectl</code> <a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/">en la documentación oficial</a>.</li>
</ul>

<p>Puede probar su conectividad con el siguiente comando:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">   kubectl cluster-info
</li></ul></code></pre>
<p>Si no ve errores, estará conectado al clúster. Si accede a varios clústeres con <code>kubectl</code>, asegúrese de verificar que haya seleccionado el contexto de clúster correcto:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">   kubectl config get-contexts
</li></ul></code></pre><pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>      CURRENT   NAME                    CLUSTER                      AUTHINFO                      NAMESPACE
   <span class="highlight">*</span>         do-nyc1-k8s-example     do-nyc1-k8s-example          do-nyc1-k8s-example-admin
             docker-for-desktop      docker-for-desktop-cluster   docker-for-desktop
</code></pre>
<p>En este ejemplo, el asterisco (<code>&lt;^&gt;*^&gt;</code>) indica que estamos conectados al clúster <code>do-nyc1-k8s-example</code>. Para cambiar de clústeres ejecute:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">   kubectl config use-context <span class="highlight">context-name</span>
</li></ul></code></pre>
<p>Cuando esté conectado al clúster correcto, continúe con el paso 1 para comenzar a instalar Helm.</p>

<h2 id="paso-1-instalar-helm">Paso 1: Instalar Helm</h2>

<p>Primero, instalaremos la utilidad de línea de comandos <code>helm</code> en nuestro equipo local. Helm proporciona una secuencia de comandos que gestiona el proceso de instalación en MacOS, Windows o Linux.</p>

<p>Pase a un directorio editable y descargue la secuencia de comandos del repositorio de GitHub de Helm:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">cd /tmp
</li><li class="line" prefix="$">curl https://raw.githubusercontent.com/kubernetes/helm/master/scripts/get &gt; install-helm.sh
</li></ul></code></pre>
<p>Haga que la secuencia de comandos sea ejecutable con <code>chmod</code>:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">chmod u+x install-helm.sh
</li></ul></code></pre>
<p>En este punto, puede utilizar su editor de texto favorito para abrir la secuencia de comandos e inspeccionarla a fin de asegurarse de que sea segura. Cuando esté satisfecho, ejecútela:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">./install-helm.sh
</li></ul></code></pre>
<p>Es posible que se le solicite la contraseña. Ingrésela y presione <code>ENTER</code>.</p>
<pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>helm installed into /usr/local/bin/helm
Run 'helm init' to configure helm.
</code></pre>
<p>A continuación, terminaremos la instalación agregando algunos componentes de Helm a nuestro clúster.</p>

<h2 id="paso-2-instalar-tiller">Paso 2: Instalar Tiller</h2>

<p>Tiller es un complemento del comando <code>helm</code> que se ejecuta en su clúster, recibe comandos de <code>helm</code> y se comunica directamente con la API de Kubernetes para hacer el verdadero trabajo de crear y eliminar recursos. A fin de proporcionar a Tiller los permisos que necesita para ejecutarse en el clúster, crearemos un recurso <code>serviceaccount</code> de Kubernetes.</p>

<span class='note'><p>
<strong>Nota:</strong> Vincularemos <code>serviceaccount</code> al rol de clúster de <strong>cluster-admin</strong>. Esto permitirá que el superusuario del servicio de <code>tiller</code> acceda al clúster e instale todos los tipos de recursos en todos los espacios de nombres. Esto es adecuado para explorar Helm, pero es posible que desee una configuración más restringida para un clúster de Kubernetes de producción.</p>

<p>Consulte <a href="https://docs.helm.sh/using_helm/#role-based-access-control">la documentación oficial del RBAC de Helm</a> para obtener más información sobre diferentes configuraciones del RBAC para Tiller.<br></p></span>

<p>Cree la <code>serviceaccount</code> de <strong>tiller</strong>:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">kubectl -n kube-system create serviceaccount tiller
</li></ul></code></pre>
<p>A continuación, vincule la <code>serviceaccount</code> de <strong>tiller</strong> al rol <strong>cluster-admin</strong>:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">kubectl create clusterrolebinding tiller --clusterrole cluster-admin --serviceaccount=kube-system:tiller
</li></ul></code></pre>
<p>Ahora podemos ejecutar <code>helm init</code>, que instala Tiller en nuestro clúster, junto con algunas tareas de mantenimiento locales, como la descarga de información del repositorio <strong>stable</strong>:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">helm init --service-account tiller
</li></ul></code></pre><pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>. . .

Tiller (the Helm server-side component) has been installed into your Kubernetes Cluster.

Please note: by default, Tiller is deployed with an insecure 'allow unauthenticated users' policy.
For more information on securing your installation see: https://docs.helm.sh/using_helm/#securing-your-helm-installation
Happy Helming!
</code></pre>
<p>Para verificar que Tiller esté en ejecución, enumere los pods en el espacio de nombres de** kube-system**:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">kubectl get pods --namespace kube-system
</li></ul></code></pre><pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>NAME                                    READY     STATUS    RESTARTS   AGE
. . .
kube-dns-64f766c69c-rm9tz               3/3       Running   0          22m
kube-proxy-worker-5884                  1/1       Running   1          21m
kube-proxy-worker-5885                  1/1       Running   1          21m
kubernetes-dashboard-7dd4fc69c8-c4gwk   1/1       Running   0          22m
<span class="highlight">tiller-deploy-5c688d5f9b-lccsk          1/1       Running   0          40s</span>
</code></pre>
<p>El nombre del pod de Tiller comienza con el prefijo <code>tiller-deploy-</code>.</p>

<p>Ahora que instalamos ambos componentes de Helm, estamos listos para usar <code>helm</code> en la instalación de nuestra primera aplicación.</p>

<h2 id="paso-3-instalar-un-chart-de-helm">Paso 3: Instalar un chart de Helm</h2>

<p>Los paquetes de software de Helm se llaman <em>charts</em>. Helm viene preconfigurado con un repositorio seleccionado de charts llamado <strong>stable</strong>. Puede explorar los charts disponibles en <a href="https://github.com/helm/charts/tree/master/stable">el repositorio de GitHub asignado a ellos</a>. Instalaremos <a href="https://github.com/kubernetes/dashboard">Kubernetes Dashboard</a> a modo de ejemplo.</p>

<p>Utilice <code>helm</code> para instalar el paquete <code>kubernetes-dashboard</code> desde el repositorio <code>stable</code>:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">helm install stable/kubernetes-dashboard --name dashboard-demo
</li></ul></code></pre><pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>NAME:   <span class="highlight">dashboard-demo</span>
LAST DEPLOYED: Wed Aug  8 20:11:07 2018
NAMESPACE: default
STATUS: DEPLOYED

. . .
</code></pre>
<p>Observe la línea de <code>NAME</code>, resaltada en el resultado del ejemplo anterior. En este caso, especificamos el nombre <code>dashboard-demo</code>. Este es el nombre de nuestra <em>versión</em>. Una <em>versión</em> de Helm es una única implementación de un chart con una configuración específica. Puede implementar varias versiones del mismo chart, cada una con su propia configuración.</p>

<p>Si no especifica su propio nombre de versión usando <code>--name</code>, Helm creará por usted un nombre al azar.</p>

<p>Podemos solicitar a Helm una lista de versiones en este clúster:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">helm list
</li></ul></code></pre><pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>NAME            REVISION    UPDATED                     STATUS      CHART                       NAMESPACE
<span class="highlight">dashboard-demo</span>    1           Wed Aug  8 20:11:11 2018    DEPLOYED    kubernetes-dashboard-0.7.1  default
</code></pre>
<p>Ahora podemos usar <code>kubectl</code> para verificar que se haya implementado un nuevo servicio en el clúster:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">kubectl get services
</li></ul></code></pre><pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>NAME                                   TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE
<span class="highlight">dashboard-demo-kubernetes-dashboard   ClusterIP   10.32.104.73   &lt;none&gt;        443/TCP   51s</span>
kubernetes                             ClusterIP   10.32.0.1      &lt;none&gt;        443/TCP   34m
</code></pre>
<p>Tenga en cuenta que por defecto el nombre de servicio correspondiente a nuestra versión es una combinación del nombre de versión de Helm y el nombre del chart.</p>

<p>Ahora que implementamos la aplicación, utilicemos Helm para cambiar su configuración y actualizar la implementación.</p>

<h2 id="paso-4-actualizar-una-versión">Paso 4: Actualizar una versión</h2>

<p>El comando <code>helm upgrade</code> puede utilizarse para actualizar una versión con un chart nuevo o actualizado, o para actualizar las opciones de configuración de este mismo.</p>

<p>Haremos un cambio sencillo en nuestra versión de <code>dashboard-demo</code> para demostrar el proceso de actualización y reversión: actualizaremos el nombre del servicio de panel simplemente a <code>dashboard</code>, en lugar de <code>dashboard-demo-kubernetes-dashboard</code>​​​​​​.</p>

<p>El chart <code>kubernetes-dashboard</code> proporciona una opción de configuración de <code>fullnameOverride</code> para controlar el nombre de servicio. Ejecutaremos <code>helm upgrade</code> con este conjunto de opciones:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">helm upgrade <span class="highlight">dashboard-demo</span> stable/kubernetes-dashboard <span class="highlight">--set fullnameOverride="dashboard"</span>
</li></ul></code></pre>
<p>Visualizará un resultado similar al del paso inicial de ​​​​​​<code>helm install</code>.</p>

<p>Verifique si sus servicios de Kubernetes reflejan los valores actualizados:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">kubectl get services
</li></ul></code></pre><pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>NAME                   TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE
kubernetes             ClusterIP   10.32.0.1       &lt;none&gt;        443/TCP   36m
<span class="highlight">dashboard</span>              ClusterIP   10.32.198.148   &lt;none&gt;        443/TCP   40s
</code></pre>
<p>Se actualizó nuestro nombre de servicio al nuevo valor.</p>

<span class='note'><p>
<strong>Nota:</strong> En este punto, es posible que desee cargar Kubernetes Dashboard en su navegador y revisarlo. Para hacerlo, primero ejecute el siguiente comando:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">kubectl proxy
</li></ul></code></pre>
<p>Esto crea un proxy que le permite acceder a recursos de clústeres remotos desde su computadora local. Conforme a las instrucciones anteriores, su servicio de panel se llama <code>kubernetes-dashboard</code> y se ejecuta en el espacio de nombres <code>default</code>. Ahora podrá acceder al panel en la siguiente URL:</p>
<pre class="code-pre "><code langs="">http://localhost:8001/api/v1/namespaces/<span class="highlight">default</span>/services/https:<span class="highlight">dashboard</span>:/proxy/
</code></pre>
<p>Si es necesario, sustituya su propio nombre de servicio y espacio de nombres por las partes resaltadas. Las instrucciones para el uso del panel quedan fuera del alcance de este tutorial, pero puede leer los <a href="https://github.com/kubernetes/dashboard/wiki">documentos oficiales de Kubernetes Dashboard</a> para obtener más información.<br></p></span>

<p>A continuación, veremos la capacidad de Helm para revertir las versiones.</p>

<h2 id="paso-5-realizar-una-reversión-de-una-versión">Paso 5: Realizar una reversión de una versión</h2>

<p>Cuando actualizamos nuestra versión <code><span class="highlight">dashboard-demo</span></code> en el paso anterior, creamos una segunda <em>revisión</em> de la versión. Helm conserva todos los detalles de las versiones anteriores en caso de que deba realizar una reversión a una configuración o un chart anterior.</p>

<p>Utilice <code>helm list</code> para inspeccionar la versión de nuevo:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">helm list
</li></ul></code></pre><pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>NAME            REVISION    UPDATED                     STATUS      CHART                       NAMESPACE
dashboard-demo  <span class="highlight">2</span>         Wed Aug  8 20:13:15 2018    DEPLOYED    kubernetes-dashboard-0.7.1  default
</code></pre>
<p>En la columna <code>REVISON</code> se indica que ésta es ahora la segunda revisión.</p>

<p>Utilice <code>helm rollback</code> para revertir la primera revisión:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">helm rollback <span class="highlight">dashboard-demo</span> 1
</li></ul></code></pre>
<p>Debería ver el siguiente resultado, lo cual indica que la reversión se realizó:</p>
<pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>Rollback was a success! Happy Helming!
</code></pre>
<p>En este punto, si ejecuta <code>kubectl get services</code> de nuevo, observará que el nombre de servicio se cambió de nuevo a su valor anterior. Helm volvió a implementar la aplicación con la configuración de la revisión 1.</p>

<p>A continuación, veremos la eliminación de versiones con Helm.</p>

<h2 id="paso-6-eliminar-una-versión">Paso 6: Eliminar una versión</h2>

<p>Es posible eliminar versiones de helm con el comando <code>helm delete</code>:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">helm delete <span class="highlight">dashboard-demo</span>
</li></ul></code></pre><pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>release "dashboard-demo" deleted
</code></pre>
<p>Aunque la versión se eliminó y la aplicación del panel ya no está en ejecución, Helm guarda toda la información de revisión en caso de que desee volver a  implementar la versión. Si intentara instalar una nueva versión de <code>dashboard-demo</code> con <code>helm install</code> en este momento, vería un mensaje de error:</p>
<pre class="code-pre "><code langs="">Error: a release named dashboard-demo already exists.
</code></pre>
<p>Si utiliza el indicador <code>--deleted</code> para enumerar sus versiones eliminadas, verá que la versión sigue vigente:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">helm list --deleted
</li></ul></code></pre><pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>NAME            REVISION    UPDATED                     STATUS  CHART                       NAMESPACE
dashboard-demo  3           Wed Aug  8 20:15:21 2018    DELETED kubernetes-dashboard-0.7.1  default
</code></pre>
<p>Para eliminar <em>realmente</em> la versión y purgar todas las revisiones antiguas, utilice el indicador<code>--purge</code>con el comando <code>helm delete</code>:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">helm delete dashboard-demo --purge
</li></ul></code></pre>
<p>Con esto, la versión se eliminó realmente y podrá reutilizar el nombre de versión.</p>

<h2 id="conclusión">Conclusión</h2>

<p>A través de este tutorial, instalamos la herramienta de línea de comandos <code>helm</code> y su servicio complementario <code>tiller</code>. También exploramos la instalación, la actualización, reversión y eliminación de charts y versiones de Helm.</p>

<p>Para obtener más información sobre Helm y sus charts, consulte <a href="https://docs.helm.sh/">la documentación oficial de Helm</a>.</p>
