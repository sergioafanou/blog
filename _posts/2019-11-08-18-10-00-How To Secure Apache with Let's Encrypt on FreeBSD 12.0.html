---
layout: post
title: How To Secure Apache with Let's Encrypt on FreeBSD 12.0
network: digitalocean
date: November 08, 2019 at 06:10PM
url: https://www.digitalocean.com/community/tutorials/how-to-secure-apache-with-let-s-encrypt-on-freebsd-12-0
image: http://ifttt.com/images/no_image_card.png
tags: docker
feedtitle: DigitalOcean Community Tutorials
feedurl: https://www.digitalocean.com/community/tutorials
author: DigitalOcean
---
<p><em>The author selected the <a href="https://www.brightfunds.org/funds/foss-nonprofits">Free and Open Source Fund</a> to receive a donation as part of the <a href="https://do.co/w4do-cta">Write for DOnations</a> program.</em></p>

<h3 id="introduction">Introduction</h3>

<p><a href="https://letsencrypt.org/">Let&rsquo;s Encrypt</a> is a Certificate Authority (CA) that provides an easy way to obtain and install free <a href="https://www.digitalocean.com/community/tutorials/openssl-essentials-working-with-ssl-certificates-private-keys-and-csrs">TLS/SSL certificates</a>, thereby enabling encrypted HTTPS on web servers. It simplifies the process by providing a software client, Certbot, that attempts to automate most (if not all) of the required steps.</p>

<p>In this tutorial, you will use Certbot to set up a TLS/SSL certificate from Let’s Encrypt on a FreeBSD 12.0 server running Apache as a web server. Additionally, you will automate the certificate renewal process using a cron job.</p>

<h2 id="prerequisites">Prerequisites</h2>

<p>Before you begin this guide you&rsquo;ll need the following:</p>

<ul>
<li><p>A FreeBSD 12.0 server that you can set up as you wish using this guide on <a href="https://www.digitalocean.com/community/tutorials/how-to-get-started-with-freebsd">How To Get Started with FreeBSD</a>.</p></li>
<li><p>Apache installed by completing Step 1 of this <a href="https://www.digitalocean.com/community/tutorials/how-to-install-an-apache-mysql-and-php-famp-stack-on-freebsd-12-0#step-1-%E2%80%94-installing-apache">FAMP stack tutorial</a>.</p></li>
<li><p>An enabled firewall by using the firewall configuration step in this <a href="https://www.digitalocean.com/community/tutorials/recommended-steps-for-new-freebsd-12-0-servers#how-to-configure-a-simple-ipfw-firewall">tutorial</a> instructions.</p></li>
<li><p>Two DNS <strong>A Records</strong> that point your domain to the public IP address of your server. Our setup will use <code><span class="highlight">your-domain</span></code> and <code>www.<span class="highlight">your-domain</span></code> as the domain names, both of which will require a valid DNS record. You can follow <a href="https://www.digitalocean.com/community/tutorials/an-introduction-to-digitalocean-dns">this introduction to DigitalOcean DNS</a> for details on how to add the DNS records with the DigitalOcean platform. DNS A records are required because of how Let’s Encrypt validates that you own the domain for which it is issuing a certificate. For example, if you want to obtain a certificate for <code>your-domain</code>, that domain must resolve to your server for the validation process to work.</p></li>
</ul>

<p>Once these prerequisites are fulfilled you can start installing Certbot, the tool that will allow you to install Let&rsquo;s Encrypt certificates.</p>

<h2 id="step-1-—-installing-the-certbot-tool-for-let-39-s-encrypt">Step 1 — Installing the Certbot Tool for Let&rsquo;s Encrypt</h2>

<p>A Let&rsquo;s Encrypt certificate ensures that users&rsquo; browsers can verify that the web server is secured by a trusted Certificate Authority. Communications with the web server are protected by encryption using HTTPS.</p>

<p>In this step you&rsquo;ll install the Certbot tool for your web server to make a request to the Let&rsquo;s Encrypt servers in order to issue a valid certificate and keys for your domain.</p>

<p>Run the following command to install the Certbot package and its Apache HTTP plugin:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo pkg install -y py36-certbot py36-certbot-apache
</li></ul></code></pre>
<p>Now that you&rsquo;ve installed the package, you can move on to enable TLS connections in the web server.</p>

<h2 id="step-2-—-enabling-ssl-tls-connections-in-apache-http">Step 2 — Enabling SSL/TLS connections in Apache HTTP</h2>

<p>By default any install of Apache HTTP will be serving content on port <code>80</code> (HTTP). The <code>Listen 80</code> entry in the main <code>httpd.conf</code> configuration file confirms this. In order to allow HTTPS connections, you&rsquo;ll need the default port to be <code>443</code>. To add port <code>443</code> and to establish SSL/TLS connections you&rsquo;ll enable the <code>mod_ssl</code> module in Apache HTTP.</p>

<p>To find this module in the <code>httpd.conf</code> file, you&rsquo;ll use <code>grep</code> with the <code>-n</code> flag to number the lines from the file in the specified path. Here you&rsquo;ll find <code>mod_ssl.so</code> by running the following command:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">grep -n 'mod_ssl.so' /usr/local/etc/apache24/httpd.conf
</li></ul></code></pre>
<p>As output you&rsquo;ll receive the number for the line you need:</p>
<div class="code-label " title="/usr/local/etc/apache24/httpd.conf">/usr/local/etc/apache24/httpd.conf</div><pre class="code-pre "><code langs=""><span class="highlight">148</span> #LoadModule ssl_module libexec/apache24/mod_ssl.so
</code></pre>
<p>To enable the module, you&rsquo;ll remove the hashtag symbol at the beginning of the line.</p>

<p>Using the line number from the previous command open the file with the following:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo vi +<span class="highlight">148</span> /usr/local/etc/apache24/httpd.conf
</li></ul></code></pre>
<p>This will take you directly to the correct line for editing.</p>

<p>Edit the line to look like the following by pressing <code>x</code>:</p>
<div class="code-label " title="/usr/local/etc/apache24/httpd.conf">/usr/local/etc/apache24/httpd.conf</div><pre class="code-pre "><code langs="">#LoadModule session_dbd_module libexec/apache24/mod_session_dbd.so
#LoadModule slotmem_shm_module libexec/apache24/mod_slotmem_shm.so
#LoadModule slotmem_plain_module libexec/apache24/mod_slotmem_plain.so
<span class="highlight">LoadModule ssl_module libexec/apache24/mod_ssl.so</span>
#LoadModule dialup_module libexec/apache24/mod_dialup.so
#LoadModule http2_module libexec/apache24/mod_http2.so
#LoadModule proxy_http2_module libexec/apache24/mod_proxy_http2.so
</code></pre>
<p>Once you&rsquo;ve removed the <code>#</code>, press <code>:wq</code> and then <code>ENTER</code> to close the file.</p>

<p>You&rsquo;ve enabled the SSL/TLS capabilities in Apache HTTP. In the next step you&rsquo;ll configure the virtual hosts in Apache HTTP.</p>

<h2 id="step-3-—-enabling-and-configuring-virtual-hosts">Step 3 — Enabling and Configuring Virtual Hosts</h2>

<p>A virtual host is a method by which several websites can concurrently and independently live in the same server using the same Apache HTTP installation. Certbot requires this setup to place specific rules within the configuration file (virtual host) for the Let&rsquo;s Encrypt certificates to work.</p>

<p>To begin, you’ll enable virtual hosts in Apache HTTP. Run the following command to locate the directive in the file:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">grep -n 'vhosts' /usr/local/etc/apache24/httpd.conf
</li></ul></code></pre>
<p>You&rsquo;ll see the line number in your output:</p>
<pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div><span class="highlight">508</span>  #Include etc/apache24/extra/httpd-vhosts.conf
</code></pre>
<p>Now use the following command to edit the file and remove <code>#</code> from the beginning of that line:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo vi +<span class="highlight">508</span> /usr/local/etc/apache24/httpd.conf
</li></ul></code></pre>
<p>As before, hit <code>x</code> to delete <code>#</code> from the beginning of the line to look like the following:</p>
<div class="code-label " title="/usr/local/etc/apache24/httpd.conf">/usr/local/etc/apache24/httpd.conf</div><pre class="code-pre "><code langs="">...
# User home directories
#Include etc/apache24/extra/httpd-userdir.conf

# Real-time info on requests and configuration
#Include etc/apache24/extra/httpd-info.conf

# Virtual hosts
<span class="highlight">Include etc/apache24/extra/httpd-vhosts.conf</span>

# Local access to the Apache HTTP Server Manual
#Include etc/apache24/extra/httpd-manual.conf

# Distributed authoring and versioning (WebDAV)
#Include etc/apache24/extra/httpd-dav.conf
...
</code></pre>
<p>Then press <code>:wq</code> and <code>ENTER</code> to save and quit the file.</p>

<p>Now that you&rsquo;ve enabled virtual hosts in Apache HTTP you&rsquo;ll modify the default virtual host configuration file to replace the example domains with your domain name.</p>

<p>You&rsquo;ll now add a virtual host block to the <code>httpd-vhosts.conf</code> file. You&rsquo;ll edit the file and remove the two existing <code>VirtualHost</code> blocks, after the comments block at line 23, with the following command:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo vi +23 /usr/local/etc/apache24/extra/httpd-vhosts.conf
</li></ul></code></pre>
<p>After opening the file remove the two existing <code>VirtualHost</code> configuration blocks, then add the following block with this specific configuration:</p>
<div class="code-label " title="/usr/local/etc/apache24/extra/httpd-vhosts.conf">/usr/local/etc/apache24/extra/httpd-vhosts.conf</div><pre class="code-pre "><code langs="">&lt;VirtualHost *:80&gt;
    ServerAdmin <span class="highlight">your_email</span>@<span class="highlight">your_domain</span>.com
    DocumentRoot "/usr/local/www/apache24/data/<span class="highlight">your_domain</span>.com"
    ServerName <span class="highlight">your_domain</span>.com
    ServerAlias www.<span class="highlight">your_domain</span>.com
    ErrorLog "/var/log/<span class="highlight">your_domain</span>.com-error_log"
    CustomLog "/var/log/<span class="highlight">your_domain</span>.com-access_log" common
&lt;/VirtualHost&gt;
</code></pre>
<p>In this block you&rsquo;re configuring the following:</p>

<ul>
<li><code>ServerAdmin</code>: This is where the email from the person in charge of that particular site is placed.</li>
<li><code>DocumentRoot</code>: This directive defines where the files for the specific site will be placed and be read from.</li>
<li><code>ServerName</code>: This is for the domain name of the site.</li>
<li><code>ServerAlias</code>: Similar to <code>ServerName</code> but placing <code>www.</code> before the domain name.</li>
<li><code>ErrorLog</code>: This is where the error log path is declared. All error messages will be written in the file specified in this directive.</li>
<li><code>CustomLog</code>: Similar to <code>ErrorLog</code> but this time the file is the one collecting all the access logs.</li>
</ul>

<p>Finally you&rsquo;ll create the directory where the site will be placed. This path has to match the one you&rsquo;ve declared in the <code>DocumentRoot</code> directive in the <code>httpd-vhosts.conf</code> file.</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo mkdir /usr/local/www/apache24/data/<span class="highlight">your_domain</span>.com
</li></ul></code></pre>
<p>Now change the permissions of the directory so the Apache HTTP process (running as the <code>www</code> user) can work with it:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo chown -R www:www /usr/local/www/apache24/data/<span class="highlight">your_domain</span>.com
</li></ul></code></pre>
<p>You&rsquo;ve used <code>chown</code> to change the ownership with the <code>-R</code> flag to make the action recursive. The user and group are set by the <code>www:www</code>.</p>

<p>You&rsquo;ve enabled virtual hosts in Apache HTTP. You&rsquo;ll now enable the rewrite module.</p>

<h2 id="step-4-—-enabling-the-rewrite-module">Step 4 — Enabling the Rewrite Module</h2>

<p>Enabling the rewrite module within Apache HTTP is necessary to make URLs change, for example when redirecting from HTTP to HTTPS.</p>

<p>Use the following command to find the rewrite module:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">grep -n 'rewrite' /usr/local/etc/apache24/httpd.conf
</li></ul></code></pre>
<p>You&rsquo;ll see output similar to:</p>
<pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div><span class="highlight">180</span>  #LoadModule rewrite_module libexec/apache24/mod_rewrite.so
</code></pre>
<p>To enable the module you will now remove <code>#</code> from the beginning of the line:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo vi +<span class="highlight">180</span> /usr/local/etc/apache24/httpd.conf
</li></ul></code></pre>
<p>Edit your file to look like the following by hitting <code>x</code> to delete <code>#</code> from the start of the line:</p>
<div class="code-label " title="/usr/local/etc/apache24/httpd.conf">/usr/local/etc/apache24/httpd.conf</div><pre class="code-pre "><code langs="">#LoadModule actions_module libexec/apache24/mod_actions.so
#LoadModule speling_module libexec/apache24/mod_speling.so
#LoadModule userdir_module libexec/apache24/mod_userdir.so
LoadModule alias_module libexec/apache24/mod_alias.so
<span class="highlight">LoadModule rewrite_module libexec/apache24/mod_rewrite.so</span>
LoadModule php7_module        libexec/apache24/libphp7.so

# Third party modules
IncludeOptional etc/apache24/modules.d/[0-9][0-9][0-9]_*.conf

&lt;IfModule unixd_module&gt;
</code></pre>
<p>Save and exit this file.</p>

<p>You&rsquo;ve now finished setting up the necessary configurations in Apache.</p>

<h2 id="step-5-—-obtaining-a-let-39-s-encrypt-certificate">Step 5 — Obtaining a Let&rsquo;s Encrypt Certificate</h2>

<p>Certbot provides a variety of ways to obtain SSL certificates through various plugins. The <code>apache</code> plugin will take care of reconfiguring Apache HTTP. To execute the interactive installation and obtain a certificate that covers only a single domain, run the following certbot command:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo certbot --apache -d <span class="highlight">your-domain</span> -d www.<span class="highlight">your-domain</span>
</li></ul></code></pre>
<p>If you want to install a single certificate that is valid for multiple domains or subdomains, you can pass them as additional parameters to the command, tagging each new domain or subdomain with the <code>-d</code> flag. The first domain name in the list of parameters will be the <strong>base</strong> domain used by Let’s Encrypt to create the certificate. For this reason, pass the base domain name first, followed by any additional subdomains or aliases.</p>

<p>If this is your first time running <code>certbot</code> on this server, the client will prompt you to enter an email address and agree to the Let’s Encrypt terms of service. After doing so, <code>certbot</code> will communicate with the Let&rsquo;s Encrypt server, then run a challenge to verify that you control the domain you&rsquo;re requesting a certificate for.</p>

<p>If the challenge is successful, Certbot will ask how you&rsquo;d like to configure your HTTPS settings:</p>
<pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>. . .
Please choose whether or not to redirect HTTP traffic to HTTPS, removing HTTP access.
-------------------------------------------------------------------------------
1: No redirect - Make no further changes to the webserver configuration.
2: Redirect - Make all requests redirect to secure HTTPS access. Choose this for
new sites, or if you're confident your site works on HTTPS. You can undo this
change by editing your web server's configuration.
-------------------------------------------------------------------------------
Select the appropriate number [1-2] then [enter] (press 'c' to cancel): <span class="highlight">2</span>
</code></pre>
<p>You will also be able to choose between enabling both <code>HTTP</code> and <code>HTTPS</code> access or forcing all requests to redirect to <code>HTTPS</code>. For better security, it is recommended to choose the option <code>2: Redirect</code> if you do not have any special need to allow unencrypted connections. Select your choice then hit <code>ENTER</code>.</p>

<p>This will update the configuration and reload Apache HTTP to pick up the new settings. <code>certbot</code> will wrap up with a message telling you the process was successful and where your certificates are stored:</p>
<pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>IMPORTANT NOTES:
- Congratulations! Your certificate and chain have been saved at:
 /usr/local/etc/letsencrypt/live/example.com/fullchain.pem
 Your key file has been saved at:
 /usr/local/etc/letsencrypt/live/example.com/privkey.pem
 Your cert will expire on yyyy-mm-dd. To obtain a new or tweaked
 version of this certificate in the future, simply run certbot
 again. To non-interactively renew *all* of your certificates, run
 "certbot renew"
- Your account credentials have been saved in your Certbot
 configuration directory at /usr/local/etc/letsencrypt. You should
 make a secure backup of this folder now. This configuration
 directory will also contain certificates and private keys obtained
 by Certbot so making regular backups of this folder is ideal.
- If you like Certbot, please consider supporting our work by:

 Donating to ISRG / Let's Encrypt:   https://letsencrypt.org/donate
 Donating to EFF:                    https://eff.org/donate-le
</code></pre>
<p>Your certificates are now downloaded, installed, and configured. Try reloading your website using <code>https://</code> and notice your browser&rsquo;s security indicator. It&rsquo;ll represent that the site is properly secured, usually with a green lock icon. If you test your server using the <a href="https://www.ssllabs.com/ssltest/">SSL Labs Server Test</a>, it will get an <strong>A</strong> grade.</p>

<p>Certbot has made some important configuration changes. When it installs the certificates in your web server it has to place them in specific paths. If you now read the content in the <code>httpd-vhosts.conf</code> file you&rsquo;ll observe a few changes made by the Certbot program.</p>

<p>For example in the <code>&lt;VirtualHost *:80&gt;</code> section the redirect rules (if chosen) are placed at the bottom of it.</p>
<div class="code-label " title="/usr/local/etc/apache24/extra/httpd-vhosts.conf">/usr/local/etc/apache24/extra/httpd-vhosts.conf</div><pre class="code-pre "><code langs="">RewriteEngine on
RewriteCond %{SERVER_NAME} =www.<span class="highlight">your_domain</span>.com [OR]
RewriteCond %{SERVER_NAME} =<span class="highlight">your_domain</span>.com
RewriteRule ^ https://%{SERVER_NAME}%{REQUEST_URI} [END,NE,R=permanent]
</code></pre>
<p>Certbot has also created a file called <code>httpd-vhosts-le-ssl.conf</code> where the configuration for the certificates on Apache has been placed:</p>
<div class="code-label " title="/usr/local/etc/apache24/extra/httpd-vhosts-le-ssl.conf">/usr/local/etc/apache24/extra/httpd-vhosts-le-ssl.conf</div><pre class="code-pre "><code langs="">&lt;IfModule mod_ssl.c&gt;
&lt;VirtualHost *:443&gt;
    ServerAdmin <span class="highlight">your_email</span>@<span class="highlight">your_domain</span>.com
    DocumentRoot "/usr/local/www/apache24/data/<span class="highlight">your_domain</span>.com"
    ServerName <span class="highlight">your_domain</span>.com
    ServerAlias www.<span class="highlight">your_domain</span>.com
    ErrorLog "/var/log/<span class="highlight">your_domain</span>.com-error_log"
    CustomLog "/var/log/<span class="highlight">your_domain</span>.com-access_log" common

Include /usr/local/etc/letsencrypt/options-ssl-apache.conf
SSLCertificateFile /usr/local/etc/letsencrypt/live/<span class="highlight">your_domain</span>.com/fullchain.pem
SSLCertificateKeyFile /usr/local/etc/letsencrypt/live/<span class="highlight">your_domain</span>.com/privkey.pem
&lt;/VirtualHost&gt;
&lt;/IfModule&gt;
</code></pre>
<p><span class='note'><strong>Note:</strong> If you would like to make changes to the use of <a href="https://en.wikipedia.org/wiki/Cipher_suite">cipher suites</a> on sites with Let&rsquo;s Encrypt certificates, you can do so in the <code>/usr/local/etc/letsencrypt/options-ssl-apache.conf</code> file.<br></span></p>

<p>Having obtained your Let&rsquo;s Encrypt certificate, you can now move on to set up automatic renewals.</p>

<h2 id="step-6-—-configuring-automatic-certificate-renewal">Step 6 — Configuring Automatic Certificate Renewal</h2>

<p>Let’s Encrypt certificates are valid for 90 days, but it’s recommended that you renew the certificates every 60 days to allow a margin of error. Because of this, it is best practice to automate this process to periodically check and renew the certificate.</p>

<p>First, let’s examine the command that you will use to renew the certificate. The <code>certbot</code> Let’s Encrypt client has a <code>renew</code> command that automatically checks the currently installed certificates and tries to renew them if they are less than 30 days away from the expiration date. By using the <code>--dry-run</code> option, you can run a simulation of this task to test how renew works:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo certbot renew --dry-run
</li></ul></code></pre>
<p>A practical way to ensure your certificates will not get outdated is to create a <a href="https://www.digitalocean.com/community/tutorials/how-to-use-cron-to-automate-tasks-on-a-vps">cron job</a> that will periodically execute the automatic renewal command for you. Since the renewal first checks for the expiration date and only executes the renewal if the certificate is less than 30 days away from expiration, it is safe to create a cron job that runs every week or even every day.</p>

<p>The <a href="https://certbot.eff.org/lets-encrypt/centosrhel7-apache">official Certbot documentation</a> recommends running <code>cron</code> twice per day. This will ensure that, in case Let&rsquo;s Encrypt initiates a certificate revocation, there will be no more than half a day before Certbot renews your certificate.</p>

<p>Edit the <code>crontab</code> to create a new job that will run the renewal twice per day. To edit the <code>crontab</code> for the <strong>root</strong> user, run:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo crontab -e
</li></ul></code></pre>
<p>Place the following configuration in the file so that, twice a day, the system will look for renewable certificates and will renew them if they need to:</p>
<pre class="code-pre "><code langs="">SHELL=/bin/sh
PATH=/etc:/bin:/sbin:/usr/bin:/usr/sbin
# Order of crontab fields
# minute    hour    mday    month   wday    command
  0         0,12    *       *       *       /usr/local/bin/certbot renew
</code></pre>
<p>In the first two lines you are declaring the environment variables, hence where the executable paths are found and what shell they&rsquo;re executing on. You then indicate the time frames you&rsquo;re interested in and the command to execute.</p>

<p>With this short set of instructions you&rsquo;ve configured the automatic renewal of certificates.</p>

<h2 id="conclusion">Conclusion</h2>

<p>In this tutorial, you&rsquo;ve installed the Let&rsquo;s Encrypt client <code>certbot</code>, downloaded SSL certificates for a domain, configured Apache to use these certificates, and set up automatic certificate renewal. For further information see Certbot&rsquo;s <a href="https://certbot.eff.org/docs/">documentation</a>.</p>
