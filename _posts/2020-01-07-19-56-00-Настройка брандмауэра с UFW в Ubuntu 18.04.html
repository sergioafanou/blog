---
layout: post
title: Настройка брандмауэра с UFW в Ubuntu 18.04
network: digitalocean
date: January 07, 2020 at 07:56PM
url: https://www.digitalocean.com/community/tutorials/how-to-set-up-a-firewall-with-ufw-on-ubuntu-18-04-ru
image: http://ifttt.com/images/no_image_card.png
tags: docker
feedtitle: DigitalOcean Community Tutorials
feedurl: https://www.digitalocean.com/community/tutorials
author: DigitalOcean
---
<p><em>Предыдущая версия настоящего обучающего модуля составлена <a href="https://www.digitalocean.com/community/users/hazelnut">Хейзел Вирдо</a></em></p>

<h3 id="Введение">Введение</h3>

<p>UFW (Uncomplicated Firewall или «простой брандмауэр») представляет собой интерфейс <code>iptables</code>, предназначенный для упрощения процесса настройки брандмауэра. Хотя <code>iptables</code> — надежный и гибкий инструмент, начинающим бывает сложно научиться использовать его для правильной настройки брандмауэра. Если вы ищете способ защитить вашу сеть и не знаете, какой инструмент для этого использовать, UFW может отлично вам подойти.</p>

<p>В этом обучающем модуле вы научитесь настраивать брандмауэр с помощью UFW в Ubuntu 18.04</p>

<h2 id="Предварительные-требования">Предварительные требования</h2>

<p>Для данного обучающего модуля вам потребуется следующее:</p>

<ul>
<li>Один сервер Ubuntu 18.04 с пользователем sudo без привилегий root, который можно настроить в соответствии указаниями шагов 1–3 обучающего модуля <a href="https://www.digitalocean.com/community/tutorials/initial-server-setup-with-ubuntu-18-04">Начальная настройка сервера Ubuntu 18.04</a>.</li>
</ul>

<p>UFW устанавливается в Ubuntu по умолчанию. Если вы удалили UFW, вы можете установить его с помощью команды <code>sudo apt install ufw</code>.</p>

<h2 id="Шаг-1-—-Использование-ipv6-с-ufw-опционально">Шаг 1 — Использование IPv6 с UFW (опционально)</h2>

<p>Этот обучающий модуль предусматривает использование протокола IPv4, но подходит и для IPv6, если вы активировали этот протокол. Если на вашем сервере Ubuntu активирован протокол IPv6, настройте UFW для поддержки IPv6, чтобы UFW управлял правилами брандмауэра и для IPv6, и для IPv4. Для этого откройте конфигурацию UFW с помощью <code>nano</code> или своего предпочитаемого редактора.</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo nano /etc/default/ufw
</li></ul></code></pre>
<p>Убедитесь, что параметр <code>IPV6</code> имеет значение <code>yes</code>. Конфигурация должна выглядеть следующим образом:</p>
<div class="code-label " title="/etc/default/ufw excerpt">/etc/default/ufw excerpt</div><pre class="code-pre "><code langs="">IPV6=<span class="highlight">yes</span>
</code></pre>
<p>Сохраните и закройте файл. После активации UFW будет настроен для записи правил брандмауэра для IPv4 и для IPv6. Однако перед включением UFW нужно убедиться, что ваш брандмауэр настроен для подключения через SSH. Для начала настроим политики по умолчанию.</p>

<h2 id="Шаг-2-—-Настройка-политик-по-умолчанию">Шаг 2 — Настройка политик по умолчанию</h2>

<p>Если вы только начинаете работать с брандмауэром, прежде всего нужно настроить политики по умолчанию. Эти правила определяют обработку трафика, который явно не соответствует каким-либо другим правилам. По умолчанию UFW настроен так, чтобы запрещать все входящие соединения и разрешать все исходящие соединения. Это означает, что любые попытки связаться с вашим сервером будут заблокированы, но любые приложения на вашем сервере будут иметь связь с внешним миром.</p>

<p>Восстановим правила UFW по умолчанию, чтобы продолжить выполнение этого обучающего модуля. Для восстановления настроек по умолчанию для UFW необходимо использовать следующие команды:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo ufw default deny incoming
</li><li class="line" prefix="$">sudo ufw default allow outgoing
</li></ul></code></pre>
<p>Эти команды задают значения по умолчанию, запрещая входящие соединения и разрешая исходящие. Такие параметры брандмауэра по умолчанию достаточны для персонального компьютера, но серверам обычно нужно отвечать на поступающие запросы внешних пользователей. Мы рассмотрим это чуть позже.</p>

<h2 id="Шаг-3-—-Разрешение-подключений-ssh">Шаг 3 — Разрешение подключений SSH</h2>

<p>Если мы сейчас активируем брандмауэр UFW, все входящие соединения будут запрещены. Это означает, что нам нужно создать правила, прямо разрешающие легитимные входящие соединения (например, SSH или HTTP), если мы хотим, чтобы сервер отвечал на такие запросы. Если вы используете облачный сервер, вы наверное хотите разрешить входящие соединения SSH, чтобы можно было подключаться к серверу и управлять им.</p>

<p>Чтобы разрешить на сервере входящие соединения SSH, вы можете использовать следующую команду:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo ufw allow ssh
</li></ul></code></pre>
<p>Эта команда создаст правила брандмауэра, которые разрешат все соединения на порту <code>22</code>, который демон SSH прослушивает по умолчанию. UFW знает, какой порт имеет в виду команда <code>allow ssh</code>, потому что он указан как услуга в файле <code>/etc/services</code>.</p>

<p>Однако мы можем записать эквивалентное правило, указав номер порта вместо имени службы. Например, эта команда работает так же, как показанная выше:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo ufw allow 22
</li></ul></code></pre>
<p>Если вы настроили демон SSH для использования другого порта, вам нужно будет указать соответствующий порт. Например, если ваш сервер SSH прослушивает порт <code>2222</code>, вы можете использовать эту команду, чтобы разрешить соединения с этим портом:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo ufw allow <span class="highlight">2222</span>
</li></ul></code></pre>
<p>Теперь ваш брандмауэр настроен, чтобы разрешать входящие соединения SSH, и мы можем его активировать.</p>

<h2 id="Шаг-4-—-Активация-ufw">Шаг 4 — Активация UFW</h2>

<p>Чтобы активировать UFW, используйте следующую команду:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo ufw enable
</li></ul></code></pre>
<p>Вы получите предупреждение о том, что команда может нарушить существующие соединения SSH. Мы уже установили правило брандмауэра, разрешающее соединения SSH, и теперь мы можем продолжить. Введите <code>y</code> в диалоговом окне и нажмите <code>ENTER</code>.</p>

<p>Теперь брандмауэр включен. Запустите команду <code>sudo ufw status verbose</code>, чтобы посмотреть заданные правила. В остальной части этого обучающего модуля более подробно рассказывается об использовании UFW, например, о запрете различных видов соединений.</p>

<h2 id="Шаг-5-—-Разрешение-других-соединений">Шаг 5 — Разрешение других соединений</h2>

<p>К этому моменту вы должны были разрешить все другие соединения, необходимые вашему серверу. Состав разрешаемых соединений должен соответствовать вашим конкретным потребностям. К счастью, вы уже знаете, как писать правила, разрешающие соединения по имени службы или номеру порта, поскольку мы уже делали это для SSH на порту <code>22</code>. Также вы можете использовать это для следующих соединений:</p>

<ul>
<li>соединения HTTP на порту 80, которые используются веб-серверами без шифрования, с помощью команды <code>sudo ufw allow http</code> или <code>sudo ufw allow 80</code></li>
<li>соединения HTTPS на порту 443, которые используются веб-серверами с шифрованием, с помощью команды <code>sudo ufw allow https</code> или <code>sudo ufw allow 443</code></li>
</ul>

<p>Помимо указания порта или службы есть другие способы разрешить другие соединения.</p>

<h3 id="Определенные-диапазоны-портов">Определенные диапазоны портов</h3>

<p>С помощью UFW вы можете указывать диапазоны портов. Некоторые приложения используют для соединений не один порт, а несколько.</p>

<p>Например, чтобы разрешить соединения X11, которые используют порты <code>6000</code>-<code>6007</code>, нужно использовать следующие команды:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo ufw allow <span class="highlight">6000</span>:<span class="highlight">6007</span>/tcp
</li><li class="line" prefix="$">sudo ufw allow <span class="highlight">6000</span>:<span class="highlight">6007</span>/udp
</li></ul></code></pre>
<p>Когда вы указываете диапазоны портов с помощью UFW, вы должны указать протокол (<code>tcp</code> или <code>udp)</code>, к которому должны применяться эти правила. Мы не упоминали этого ранее, поскольку если протокол не указать, оба протокола будут разрешены, что подходит для большинства случаев.</p>

<h3 id="Конкретные-ip-адреса">Конкретные IP-адреса</h3>

<p>При работе с UFW вы также можете указывать конкретные IP-адреса. Например, если вы хотите разрешить соединения с определенного IP-адреса, например с рабочего или домашнего адреса <code>203.0.113.4</code>, вам нужно использовать опцию <code>from</code>, а затем указать IP-адрес:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo ufw allow from <span class="highlight">203.0.113.4</span>
</li></ul></code></pre>
<p>Также вы можете указать определенный порт, к которому IP-адресу разрешено подключаться. Для этого нужно добавить опцию <code>to any port</code>, а затем указать номер порта. Например, если вы хотите разрешить IP-адресу <code>203.0.113.4</code> подключаться к порту <code>22</code> (SSH), нужно использовать следующую команду:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo ufw allow from <span class="highlight">203.0.113.4</span> to any port <span class="highlight">22</span>
</li></ul></code></pre>
<h3 id="Подсети">Подсети</h3>

<p>Если вы хотите разрешить подсеть IP-адресов, вы можете указать маску сети с помощью нотации CIDR. Например, если вы хотите разрешить все IP-адреса в диапазоне от <code>203.0.113.1</code> до <code>203.0.113.254</code>, вы можете использовать следующую команду:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo ufw allow from <span class="highlight">203.0.113.0</span>/<span class="highlight">24</span>
</li></ul></code></pre>
<p>Также вы можете указывать порт назначения, к которому разрешено подключаться подсети <code>203.0.113.0/24</code>. В качестве примера мы используем порт <code>22</code> (SSH):</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo ufw allow from <span class="highlight">203.0.113.0</span>/<span class="highlight">24</span> to any port 22
</li></ul></code></pre>
<h3 id="Подключения-к-определенному-сетевому-интерфейсу">Подключения к определенному сетевому интерфейсу</h3>

<p>Если вы хотите создать правило брандмауэра, применимое только к определенному сетевому интерфейсу, вы можете использовать для этого опцию «allow in on», а затем указать имя сетевого интерфейса.</p>

<p>Прежде чем продолжить, вам может понадобиться просмотреть сетевые интерфейсы. Для этого нужно использовать следующую команду:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">ip addr
</li></ul></code></pre><pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output Excerpt">Output Excerpt</div>2: <span class="highlight">eth0</span>: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state
. . .
3: <span class="highlight">eth1</span>: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc noop state DOWN group default
. . .
</code></pre>
<p>В выделенной части результатов показаны имена сетевых интерфейсов. Обычно они носят имена вида <code>eth0</code> или <code>enp3s2</code>.</p>

<p>Если на вашем сервере имеется публичный сетевой интерфейс под названием <code>eth0</code>, вы можете разрешить трафик HTTP (порт <code>80</code>) для этого интерфейса с помощью следующей команды:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo ufw allow in on <span class="highlight">eth0</span> to any port <span class="highlight">80</span>
</li></ul></code></pre>
<p>Это позволит вашему серверу принимать запросы HTTP из публичной части интернета.</p>

<p>Если вы хотите использовать сервер базы данных MySQL (порт <code>3306</code>) для прослушивания соединений на интерфейсе частной сети (например, <code>eth1</code>), вы можете использовать следующую команду:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo ufw allow in on <span class="highlight">eth1</span> to any port <span class="highlight">3306</span>
</li></ul></code></pre>
<p>Это позволит другим серверам в вашей частной сети подключаться к вашей базе данных MySQL.</p>

<h2 id="Шаг-6-—-Запрет-соединений">Шаг 6 — Запрет соединений</h2>

<p>Если вы не изменяли политику по умолчанию для входящих соединений, UFW настроен на запрет всех входящих соединений. Это упрощает процесс создания защищенной политики брандмауэра, поскольку вам нужно создавать правила, прямо разрешающие соединения через конкретные порты и IP-адреса.</p>

<p>Однако в некоторых случаях вам может понадобиться запретить определенные соединения по IP-адресу источника или подсети, например, в случае атаки с этого адреса. Если вы захотите изменить политику по умолчанию для входящих соединений на <strong>allow</strong> (что не рекомендуется), вам нужно будет создать правила <strong>deny</strong> для любых служб или IP-адресов, которым вы не хотите разрешать подключение.</p>

<p>Для записи правил <strong>deny</strong> можно использовать описанные выше команды, заменяя <strong>allow</strong> на <strong>deny</strong>.</p>

<p>Например, чтобы запретить соединения по протоколу HTTP, вы можете использовать следующую команду:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo ufw deny http
</li></ul></code></pre>
<p>Если вы захотите запретить все подключения с IP-адреса <code>203.0.113.4</code>, вы можете использовать следующую команду:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo ufw deny from <span class="highlight">203.0.113.4</span>
</li></ul></code></pre>
<p>Теперь посмотрим, как можно удалять правила.</p>

<h2 id="Шаг-7-—-Удаление-правил">Шаг 7 — Удаление правил</h2>

<p>Знать процедуру удаления правил брандмауэра так же важно, как и знать процедуру их создания. Существует два разных способа указывать правила для удаления: по номеру правила или по фактическому правилу (так же, как правила задавались при их создании). Начнем с метода <strong>удаления по номеру правила</strong>, поскольку этот метод проще.</p>

<h3 id="По-номеру-правила">По номеру правила</h3>

<p>Если вы используете номер правила для удаления правил брандмауэра, прежде всего нужно получить список правил брандмауэра. Команда UFW status имеет опцию отображение номеров рядом с каждым правилом, как показано здесь:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo ufw status numbered
</li></ul></code></pre><pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Numbered Output:">Numbered Output:</div>Status: active

     To                         Action      From
     --                         ------      ----
[ 1] 22                         ALLOW IN    15.15.15.0/24
[ 2] 80                         ALLOW IN    Anywhere
</code></pre>
<p>Если мы решим удалить правило 2, разрешающее соединения через порт 80 (HTTP), мы можем указать его в команде UFW delete, как показано здесь:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo ufw delete <span class="highlight">2</span>
</li></ul></code></pre>
<p>После этого откроется диалогового окна подтверждения удаления правила 2, разрешающего соединения HTTP. Если вы включили поддержку IPv6, вы можете также удалить соответствующее правило для IPv6.</p>

<h3 id="По-фактическому-имени-правила">По фактическому имени правила</h3>

<p>Вместо номеров правил можно указывать фактические имена удаляемых правил. Например, если вы хотите удалить правило <code>allow http</code>, вы можете использовать следующую команду:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo ufw delete <span class="highlight">allow http</span>
</li></ul></code></pre>
<p>Также вы можете указать это правило как <code>allow 80</code>, а не указывать имя службы:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo ufw delete <span class="highlight">allow 80</span>
</li></ul></code></pre>
<p>Этот метод удалит правила IPv4 и IPv6, если они существуют.</p>

<h2 id="Шаг-8-—-Проверка-состояния-и-правил-ufw">Шаг 8 — Проверка состояния и правил UFW</h2>

<p>Вы можете проверить состояние UFW в любое время с помощью следующей команды:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo ufw status verbose
</li></ul></code></pre>
<p>Если UFW отключен (по умолчанию), вы увидите примерно следующее:</p>
<pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>Status: inactive
</code></pre>
<p>Если UFW активен (т. е. вы выполнили шаг 3), в результатах будет показано, что он активен, и будет выведен список заданных правил. Например, если настройки брандмауэра разрешают соединения SSH (порт <code>22</code>) из любого источника, результат может выглядеть примерно так:</p>
<pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>Status: active
Logging: on (low)
Default: deny (incoming), allow (outgoing), disabled (routed)
New profiles: skip

To                         Action      From
--                         ------      ----
22/tcp                     ALLOW IN    Anywhere
</code></pre>
<p>Используйте команду <code>status,</code> если хотите проверить настройку брандмауэра UFW.</p>

<h2 id="Шаг-9-—-Отключение-или-сброс-ufw-необязательно">Шаг 9 — Отключение или сброс UFW (необязательно)</h2>

<p>Если вы решите прекратить использовать UFW, вы можете отключить его с помощью следующей команды:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo ufw disable
</li></ul></code></pre>
<p>Любые правила, созданные с помощью UFW, больше не будут активными. Если впоследствии вы захотите активировать UWF, вы всегда сможете использовать команду <code>sudo ufw enable</code>.</p>

<p>Если вы уже настроили правила UFW, но решите начать заново, вы можете использовать команду reset:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo ufw reset
</li></ul></code></pre>
<p>Эта команда отключит UFW и удалит все ранее заданные правила. Помните, что если вы изменяли политики по умолчанию, их первоначальные настройки не восстановятся. Это позволит заново начать настройку UFW.</p>

<h2 id="Заключение">Заключение</h2>

<p>Теперь ваш брандмауэр настроен так, чтобы разрешать (как минимум) соединения SSH. Обязательно разрешите другие входящие соединения для вашего сервера, но при этом ограничьте все ненужные соединения, чтобы сделать свой сервер функциональным и безопасным.</p>

<p>Чтобы узнать о других распространенных конфигурациях UFW, ознакомьтесь с обучающим модулем <a href="https://www.digitalocean.com/community/tutorials/ufw-essentials-common-firewall-rules-and-commands">Основы UFW: распространенные правила и команды брандмауэра</a>.</p>
