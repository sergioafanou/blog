---
layout: post
title: Como Criar e Exibir Imagens WebP para Acelerar Seu Website
network: digitalocean
date: December 12, 2019 at 07:37PM
url: https://www.digitalocean.com/community/tutorials/how-to-create-and-serve-webp-images-to-speed-up-your-website-pt
image: http://ifttt.com/images/no_image_card.png
tags: docker
feedtitle: DigitalOcean Community Tutorials
feedurl: https://www.digitalocean.com/community/tutorials
author: DigitalOcean
---
<p><em>O autor selecionou a <a href="https://www.brightfunds.org/organizations/apache-software-foundation">Apache Software Foundation</a>para receber uma doação como parte do programa <a href="https://do.co/w4do-cta">Write for DOnations</a>.</em></p>

<h3 id="introdução">Introdução</h3>

<p><a href="https://developers.google.com/speed/webp">WebP</a> é um formato aberto de imagem desenvolvido pelo Google em 2010, baseado no formato de vídeo VP8. Desde então, o número de sites e aplicativos móveis que usam o formato WebP cresceu rapidamente. Tanto o Google Chrome como o Opera suportam o formato WebP de forma nativa e, uma vez que esses navegadores representam cerca de 74% do tráfego da Web, os usuários podem acessar sites mais rapidamente se esses sites usarem imagens WebP. Também existem <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1294490">planos para implementar o WebP no Firefox</a>.</p>

<p>O formato WebP suporta tanto a compressão de imagens com perda, quanto sem perda de dados, incluindo animação. Sua princpal vantagem em comparação com outros formatos de imagem usados na Web é o tamanho bastante reduzido dos arquivos, o que permite que as páginas Web carreguem mais rapidamente e reduz o uso de largura de banda. Usar imagens WebP pode levar a <a href="https://blog.chromium.org/2014/03/webp-improves-while-rolling-out-across.html">aumentos consideráveis</a> na velocidade da página. Se o seu aplicativo ou site estiver passando por problemas de desempenho ou aumento de tráfego, converter suas imagens pode ajudar a otimizar o desempenho das páginas.</p>

<p>Neste tutorial, você usará a ferramenta de linha de comando <code>cwebp</code> para converter imagens para o formato WebP, criando scripts que irão ver e converter imagens em um diretório específico. Finalmente, você irá explorar duas maneiras de exibir imagens WebP aos seus visitantes.</p>

<h2 id="pré-requisitos">Pré-requisitos</h2>

<p>Trabalhar com imagens WebP não exige uma distribuição específica, mas vamos demonstrar como trabalhar com os software relevantes no Ubuntu 16.04 e CentOS 7. Para seguir este tutorial você precisará de:</p>

<ul>
<li><p>Um servidor configurado com um usuário não raiz (non-root) de comando sudo. Para configurar um servidor Ubuntu 16.04, você pode seguir nosso <a href="https://www.digitalocean.com/community/tutorials/initial-server-setup-with-ubuntu-16-04">Guia de configuração inicial de servidor Ubuntu 16.04</a>. Se você quiser usar o CentOS, você pode configurar um servidor CentOS 7 com nossa <a href="https://www.digitalocean.com/community/tutorials/initial-server-setup-with-centos-7">Configuração Inicial de Servidor com tutorial CentOS</a>.</p></li>
<li><p>O Apache instalado no seu servidor. Se você estiver usando o Ubuntu, você pode seguir o passo um do <a href="https://www.digitalocean.com/community/tutorials/how-to-install-linux-apache-mysql-php-lamp-stack-on-ubuntu-16-04">Como Instalar Linux, Apache, MySQL, pilha PHP (LAMP) no Ubuntu 16.04</a>. Se você estiver usando o CentOS, então você deve seguir o passo um <a href="https://www.digitalocean.com/community/tutorials/how-to-install-linux-apache-mysql-php-lamp-stack-on-centos-7">do Como Instalar Linux, Apache, MySQL, pilha PHP (LAMP) no CentOS 7</a>. Certifique-se de ajustar as configurações do seu firewall para permitir o tráfego HTTP e HTTPS.</p></li>
<li><p><code>mod_rewrite</code> instalado no seu servidor. Se você estiver usando o Ubuntu, você pode seguir nosso guia <a href="https://www.digitalocean.com/community/tutorials/how-to-rewrite-urls-with-mod_rewrite-for-apache-on-ubuntu-16-04">Como Manipular URLs com mod_rewrite para o Apache no Ubuntu 16.04</a>. No CentOS 7 <code>o mod_rewri</code>te é instalado e ativado por padrão.</p></li>
</ul>

<h2 id="passo-1-—-instalando-o-cwebp-e-preparando-o-diretório-de-imagens">Passo 1 — Instalando o cwebp e Preparando o Diretório de Imagens</h2>

<p>Nesta seção, instalaremos o software para converter imagens e criaremos um diretório com imagens para a finalidade de teste.</p>

<p>No Ubuntu 16.04, você pode instalar o <code>cwebp</code>, um utilitário que comprime imagens no formato <code>.webp</code>, digitando:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo apt-get update
</li><li class="line" prefix="$">sudo apt-get install webp 
</li></ul></code></pre>
<p>No CentOS 7, digite:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo yum install libwebp-tools
</li></ul></code></pre>
<p>Para criar um novo diretório de imagens chamado <code>webp</code> no diretório raiz do Apache Web (localizado por padrão em <code>/var/www/html)</code> digite:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo mkdir /var/www/html/webp
</li></ul></code></pre>
<p>Altere o proprietário deste diretório para o seu usuário <strong>sammy</strong> não raiz:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo chown <span class="highlight">sammy</span>: /var/www/html/webp
</li></ul></code></pre>
<p>Para testar comandos, você pode baixar imagens JPEG e PNG gratuitas usando o <code>wget</code>. Esta ferramenta é instalada por padrão no Ubuntu 16.04; se você estiver usando o CentOS 7, você pode instalá-la digitando:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo yum install wget
</li></ul></code></pre>
<p>A seguir, baixe as imagens teste usando os comandos seguintes:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">wget -c "https://upload.wikimedia.org/wikipedia/commons/2/24/Junonia_orithya-Thekkady-2016-12-03-001.jpg?download" -O /var/www/html/webp/image1.jpg
</li><li class="line" prefix="$">wget -c "https://upload.wikimedia.org/wikipedia/commons/5/54/Mycalesis_junonia-Thekkady.jpg" -O /var/www/html/webp/image2.jpg
</li><li class="line" prefix="$">wget -c "https://cdn.pixabay.com/photo/2017/07/18/15/39/dental-care-2516133_640.png" -O /var/www/html/webp/logo.png
</li></ul></code></pre>
<p><span class='note'><strong>Nota:</strong> estas imagens estão disponíveis para uso e redistribuição sob a licença Creative Commons <a href="https://creativecommons.org/licenses/by-sa/4.0/deed.en">Attribution-ShareAlike</a> e o <a href="https://creativecommons.org/publicdomain/zero/1.0/">Public Domain Dedication</a>.<br></span></p>

<p>A maior parte do seu trabalho no próximo passo estará no diretório <code>/var/www/html/webp</code>, para o qual você pode se mover digitando:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">cd /var/www/html/webp
</li></ul></code></pre>
<p>Com as imagens teste instaladas e o servidor Apache Web, <code>mod_rewrite</code> e <code>cwebp</code> instalados, você está pronto para ir para a conversão de imagens.</p>

<h2 id="passo-2-—-comprimindo-arquivos-de-imagem-com-o-cwebp">Passo 2 — Comprimindo Arquivos de Imagem com o cwebp</h2>

<p>Exibir imagens <code>.webp</code> para visitantes do site exige versões <code>.webp</code> de arquivos de imagem. Neste passo, você irá converter imagens JPEG e PNG para o formato <code>.webp</code> usando o <code>cwebp</code>. A sintaxe <strong>geral</strong> do comando se parece com essa:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">cwebp image.jpg -o image.webp
</li></ul></code></pre>
<p>A opção <code>-o</code> especifica o caminho até o arquivo WebP.</p>

<p>Uma vez que você ainda está no diretório <code>/var/www/html/webp</code>, você pode executar o comando a seguir para converter a <code>image1.jpg</code> em <code>image1.webp</code> e <code>image2.jpg</code> em <code>image2.webp</code>:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">cwebp -q 100 image1.jpg -o image1.webp
</li><li class="line" prefix="$">cwebp -q 100 image2.jpg -o image2.webp
</li></ul></code></pre>
<p>Definir o fator de qualidade <code>-q</code> em 100 retém 100% da qualidade da imagem; se não especificado, o valor padrão é 75.</p>

<p>A seguir, inspecione o tamanho das imagens JPEG e WebP usando o comando <code>ls</code>. A opção <code>-l</code> irá mostrar o formato de lista longa, que inclui o tamanho do arquivo e a opção <code>-h</code> irá garantir que <code>ls</code> imprima tamanhos legíveis para humanos:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">ls -lh image1.jpg image1.webp image2.jpg image2.webp
</li></ul></code></pre><pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>-rw-r--r-- 1 sammy sammy 7.4M Oct 28 23:36 image1.jpg
-rw-r--r-- 1 sammy sammy 3.9M Feb 18 16:46 <span class="highlight">image1.webp</span>
-rw-r--r-- 1 sammy sammy  16M Dec 18  2016 image2.jpg
-rw-r--r-- 1 sammy sammy 7.0M Feb 18 16:59 <span class="highlight">image2.webp</span>
</code></pre>
<p>O resultado do comando <code>ls</code> mostra que o tamanho da <code>image1.jpg</code> é de 7,4 MB, enquanto o tamanho da <code>image1.webp</code> é 3,9 MB. O mesmo se aplica à <code>image2.jpg</code> (16 MB) e <code>image2.webp</code> (7 MB). Estes arquivos têm quase metade do tamanho original.</p>

<p>Para salvar os dados das imagens completos e originais durante a compressão, você pode usar a opção <code>-lossless</code> no lugar de <code>-q</code>. Esta é a melhor opção para manter a qualidade de imagens PNG. Para converter a imagem PNG baixada do passo 1, digite:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">cwebp -lossless logo.png -o logo.webp
</li></ul></code></pre>
<p>O comando a seguir mostra que o tamanho sem perdas da imagem WebP (60 KB) é aproximadamente metade do tamanho da imagem PNG original (116 KB):</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">ls -lh logo.png logo.webp
</li></ul></code></pre><pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>-rw-r--r-- 1 sammy sammy 116K Jul 18  2017 logo.png
-rw-r--r-- 1 sammy sammy  60K Feb 18 16:42 <span class="highlight">logo.webp</span>
</code></pre>
<p>As imagens convertidas no diretório <code>/var/www/html/webp</code> são cerca de 50% menores do que suas equivalentes em JPEG e PNG. Na prática, as taxas de compressão podem ser diferentes, dependendo de certos fatores: a taxa de compressão da imagem original, o formato do arquivo, o tipo de conversão (com ou sem perdas), a porcentagem de qualidade e o seu sistema operacional. Conforme você for convertendo mais imagens, você poderá ver variações nas taxas de conversão relacionadas a esses fatores.</p>

<h2 id="passo-3-—-convertendo-imagens-jpeg-e-png-em-um-diretório">Passo 3 — Convertendo Imagens JPEG e PNG em um Diretório</h2>

<p>Escrever um script irá simplificar o processo de conversão, eliminando o trabalho da conversão manual. Agora, vamos escrever um script de conversão que encontre arquivos JPEG e os converta para o formato WebP com 90% da qualidade, enquanto também converte arquivos PNG em imagens WeP sem perdas.</p>

<p>Usando o <code>nano</code> ou seu editor favorito, crie o script <code>webp-convert.sh</code> no diretório home do seu usuário.</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">nano ~/webp-convert.sh
</li></ul></code></pre>
<p>A primeira linha do script se parecerá com esta:</p>
<div class="code-label " title="~/webp-convert.sh">~/webp-convert.sh</div><pre class="code-pre "><code class="code-highlight language-bash">find $1 -type f -and \( -iname "*.jpg" -o -iname "*.jpeg" \)
</code></pre>
<p>Esta linha tem os seguintes componentes:</p>

<ul>
<li><a href="https://www.digitalocean.com/community/tutorials/how-to-use-find-and-locate-to-search-for-files-on-a-linux-vps"><code>find</code></a>: este comando irá procurar por arquivos dentro de um diretório especificado.</li>
<li><code>$1</code>: este parâmetro posicional especifica o caminho do diretório de imagens, tirado da linha de comando. Em última análise, ele torna o local do diretório menos dependente do local do script.</li>
<li><code>-type f</code>: esta opção diz ao <code>find</code> para procurar apenas arquivos regulares.</li>
<li><code>-iname</code>: este teste compara os nomes dos arquivos com um padrão especificado. O teste <code>-iname</code> que não diferencia maiúsculas de minúsculas diz ao <code>find</code> para procurar qualquer nome de arquivo que termine com <code>.jpg</code> (<code>*.jpg</code>) ou <code>.jpeg</code> (<code>*.jpeg</code>).</li>
<li><code>-o</code>: Este operador lógico instrui o comando <code>find</code> para listar arquivos que correspondam ao primeiro teste <code>-iname</code> (<code>-iname ".jpg"**</code>) ou o segundo (<code>-iname "*.jpeg"**</code>).</li>
<li><code>()</code>: parênteses em volta desses testes, junto com o operador <code>-and</code>, garante que o primeiro teste (ou seja <code>-type f</code>) seja sempre executado.</li>
</ul>

<p>A segunda linha do script irá converter as imagens para WebP usando o parâmetro <code>-exec</code>. A sintaxe geral deste parâmetro é <code>-exec command {} \;</code>. Cada arquivo substitui uma string <code>{}</code>; o comando faz a iteração através desses arquivos, ao passo que a string <code>;</code> diz para o <code>find</code> onde o comando termina:</p>
<div class="code-label " title="~/webp-convert.sh">~/webp-convert.sh</div><pre class="code-pre "><code class="code-highlight language-bash">find $1 -type f -and \( -iname "*.jpg" -o -iname "*.jpeg" \) \
-exec bash -c 'commands' {} \;
</code></pre>
<p>Neste caso, o parâmetro <code>-exec</code> irá exigir mais de um comando para procurar e converter imagens:</p>

<ul>
<li><code>bash</code>: este comando irá executar um pequeno script que irá criar a versão <code>.webp</code> do arquivo se ele não existir. Este script será passado para o <code>bash</code> como uma string, graças à opção <code>-c</code>.</li>
<li><code>'commands'</code>: este espaço reservado é o script que irá fazer versões <code>.webp</code> dos seus arquivos.</li>
</ul>

<p>O script dentro de <code>'commands'</code> fará as seguintes coisas:</p>

<ul>
<li>Criar uma variável <code>webp_path</code>.</li>
<li>Testar se a versão <code>.webp</code> do arquivo existe ou não.</li>
<li>Criar o arquivo se ele não existir.</li>
</ul>

<p>O script menor se parece com este:</p>
<div class="code-label " title="~/webp-convert.sh">~/webp-convert.sh</div><pre class="code-pre "><code langs="">...
webp_path=$(sed 's/\.[^.]*$/.webp/' &lt;&lt;&lt; "$0");
if [ ! -f "$webp_path" ]; then 
  cwebp -quiet -q 90 "$0" -o "$webp_path";
fi;
</code></pre>
<p>Os elementos neste script menor incluem:</p>

<ul>
<li><code>webp_path</code>: esta variável será gerada usando o <a href="https://www.digitalocean.com/community/tutorials/the-basics-of-using-the-sed-stream-editor-to-manipulate-text-in-linux"><code>sed</code></a> e o nome do arquivo correspondente do comando <code>bash</code>, estipulado pelo pelo parâmetro posicional <code>$0</code>. Uma <code>_string here_</code> (​​​​​​<code>&lt;&lt;&lt;</code>) passará este nome para o <code>sed</code>.</li>
<li><code>if [ ! -f "$webp_path" ]</code>: este teste irá determinar se um arquivo chamado <code>"$webp_path"</code> já existe, usando o operador lógico <code>not</code> (<code>!</code>).</li>
<li><code>cwebp</code>: este comando irá criar o arquivo se ele não existir, usando a opção <code>-q</code> para não imprimir o resultado.</li>
</ul>

<p>Com este script menor no lugar do espaço reservado <code>'commands'</code>, o script completo para converter imagens JPEG se parecerá agora com este:</p>
<div class="code-label " title="~/webp-convert.sh">~/webp-convert.sh</div><pre class="code-pre "><code class="code-highlight language-bash"># converting JPEG images
find $1 -type f -and \( -iname "*.jpg" -o -iname "*.jpeg" \) \
-exec bash -c '
webp_path=$(sed 's/\.[^.]*$/.webp/' &lt;&lt;&lt; "$0");
if [ ! -f "$webp_path" ]; then 
  cwebp -quiet -q 90 "$0" -o "$webp_path";
fi;' {} \;
</code></pre>
<p>Para converter imagens PNG para WebP, vamos adotar a mesma abordagem, com duas diferenças: primeiro, o padrão <code>-iname</code> no comando <code>find</code> será <code>"*.png"</code>. Segundo, o comando de conversão usará a opção <code>-lossless</code> em vez da opção de qualidade <code>-q</code>.</p>

<p>O script final se parece com este:</p>
<div class="code-label " title="~/webp-convert.sh">~/webp-convert.sh</div><pre class="code-pre "><code class="code-highlight language-bash">#!/bin/bash

# converting JPEG images
find $1 -type f -and \( -iname "*.jpg" -o -iname "*.jpeg" \) \
-exec bash -c '
webp_path=$(sed 's/\.[^.]*$/.webp/' &lt;&lt;&lt; "$0");
if [ ! -f "$webp_path" ]; then 
  cwebp -quiet -q 90 "$0" -o "$webp_path";
fi;' {} \;

# converting PNG images
find $1 -type f -and -iname "*.png" \
-exec bash -c '
webp_path=$(sed 's/\.[^.]*$/.webp/' &lt;&lt;&lt; "$0");
if [ ! -f "$webp_path" ]; then 
  cwebp -quiet -lossless "$0" -o "$webp_path";
fi;' {} \;
</code></pre>
<p>Salve o arquivo e saia do editor.</p>

<p>Em seguida, vamos colocar o script <code>webp-convert.sh</code> em prática, usando os arquivos no diretório <code>/var/www/html/webp</code>. Certifique-se de que o arquivo script é executável, executando o comando a seguir:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">chmod a+x ~/webp-convert.sh
</li></ul></code></pre>
<p>Execute o script no diretório de imagens:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">./webp-convert.sh /var/www/html/webp
</li></ul></code></pre>
<p>Nada aconteceu! Isso se dá porque já convertemos essas imagens no passo 2. Avançando, o script <code>webp-convert</code> converterá imagens quando adicionarmos novos arquivos ou removermos as versões <code>.webp</code>. Para ver como isso funciona, exclua os arquivos <code>.webp</code> que criamos no passo 2:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">rm /var/www/html/webp/*.webp
</li></ul></code></pre>
<p>Após excluir todas as imagens <code>.webp</code>, execute o script novamente para garantir que ele funciona:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">./webp-convert.sh /var/www/html/webp
</li></ul></code></pre>
<p>O comando <code>ls</code> confirmará que o script converteu as imagens com sucesso:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">ls -lh /var/www/html/webp
</li></ul></code></pre><pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>-rw-r--r-- 1 sammy sammy 7.4M Oct 28 23:36 image1.jpg
-rw-r--r-- 1 sammy sammy 3.9M Feb 18 16:46 <span class="highlight">image1.webp</span>
-rw-r--r-- 1 sammy sammy  16M Dec 18  2016 image2.jpg
-rw-r--r-- 1 sammy sammy 7.0M Feb 18 16:59 <span class="highlight">image2.webp</span>
-rw-r--r-- 1 sammy sammy 116K Jul 18  2017 logo.png
-rw-r--r-- 1 sammy sammy  60K Feb 18 16:42 <span class="highlight">logo.webp</span>
</code></pre>
<p>O script neste passo é a base para usar imagens WebP no seu site, uma vez que você precisará de uma versão m funcionamento de todas as imagens no formato WebP para exibir aos visitantes. O próximo passo abordará como automatizar a conversão de novas imagens.</p>

<h2 id="passo-4-—-monitorando-arquivos-de-imagem-em-um-diretório">Passo 4 — Monitorando Arquivos de Imagem em um Diretório</h2>

<p>Neste passo, criaremos um novo script para monitorar nosso diretório de imagens quanto a alterações e para converter automaticamente as imagens recém-criadas.</p>

<p>Criar um script que monitora nosso diretório de imagens pode resolver certos problemas com o script <code>webp-convert.sh</code> da forma como ele está escrito. Por exemplo, este script não identificará se renomeamos uma imagem. Se tivéssemos uma imagem chamada <code>foo.jpg</code>, executássemos o <code>webp-convert.sh</code>, renomeássemos aquele arquivo para <code>bar.jpg</code> e, então, executássemos o <code>webp-convert.sh</code> novamente, teríamos arquivos duplicados de <code>.webp</code> (<code>foo.webp</code> e <code>bar.webp</code>). Para resolver este problema e para evitar executar o script manualmente, adicionaremos <em>observadores</em> a outro script. Os observadores monitoram os arquivos ou diretórios especificados quanto às alterações e executam comandos em resposta a essas alterações.</p>

<p>O comando <code>inotifywait</code> irá configurar observadores no nosso script. Este comando faz parte do pacote <code>inotify-tools</code>, um conjunto de ferramentas de linha de comando que fornecem uma interface simples ao subsistema do kernel inotify. Para instalá-lo no Ubuntu 16.04 digite:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo apt-get install inotify-tools
</li></ul></code></pre>
<p>Com o CentOS 7, o pacote <code>inotify-tools</code> está disponível no repositório EPEL. Instale o repositório EPEL e o pacote <code>inotify-tools</code> usando os comandos a seguir:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo yum install epel-release
</li><li class="line" prefix="$">sudo yum install inotify-tools
</li></ul></code></pre>
<p>Em seguida, crie o script <code>webp-watchers.sh</code> no diretório home do seu usuário usando o <code>nano</code>:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">nano ~/webp-watchers.sh
</li></ul></code></pre>
<p>A primeira linha do script se parecerá com esta:</p>
<div class="code-label " title="~/webp-watchers.sh">~/webp-watchers.sh</div><pre class="code-pre "><code class="code-highlight language-bash">inotifywait -q -m -r --format '%e %w%f' -e close_write -e moved_from -e moved_to -e delete $1
</code></pre>
<p>Esta linha inclui os seguintes elementos:</p>

<ul>
<li><code>inotifywait</code>: este comando monitora quanto às alterações em um certo diretório.</li>
<li><code>-q</code>: esta opção irá dizer ao <code>inotifywait</code> para ficar quieto e não produzir grande quantidade de resultados.</li>
<li><code>-m</code>: esta opção irá dizer ao <code>inotifywait</code> para executar indefinidamente e não sair após receber um único evento.</li>
<li><code>-r</code>: esta opção irá configurar observadores de maneira repetitiva, monitorando um diretório especificado e todos os seus subdiretórios.</li>
<li><code>--format</code>: esta opção diz ao <code>inotifywait</code> para monitorar alterações usando o nome do evento seguido do caminho do arquivo. Os eventos que queremos monitorar são <code>close_write</code> (acionado quando um arquivo é criado e completamente gravado no disco), <code>moved_from</code> e <code>moved_to</code> (acionados quando um arquivo é movido) e <code>delete</code> (acionado quando um arquivo é excluído).</li>
<li><code>$1</code>: este parâmetro posicional retém o caminho dos arquivos alterados.</li>
</ul>

<p>Na sequência, vamos adicionar um comando <code>grep</code> para determinar se nossos arquivos são imagens JPEG ou PNG. A opção <code>-i</code> irá dizer ao <code>grep</code> para ignorar a diferença entre maiúsculas e minúsculas; <code>-E</code> irá especificar que o <code>grep</code> deve usar expressões regulares estendidas e a -<code>-line-buffered</code> irá dizer ao <code>grep</code> para passar as linhas correspondentes para um loop <code>while</code>:</p>
<div class="code-label " title="~/webp-watchers.sh">~/webp-watchers.sh</div><pre class="code-pre "><code class="code-highlight language-bash">inotifywait -q -m -r --format '%e %w%f' -e close_write -e moved_from -e moved_to -e delete $1 | grep -i -E '\.(jpe?g|png)$' --line-buffered
</code></pre>
<p>A seguir, vamos construir um loop <code>while</code> com o comando <code>read</code>. O <code>read</code> irá processar o evento que o <code>inotifywait</code> detectou, atribuindo-o a uma variável chamada <code>$operation</code> e o caminho do arquivo processado para uma variável chamada <code>$path</code>:</p>
<div class="code-label " title="~/webp-watchers.sh">~/webp-watchers.sh</div><pre class="code-pre "><code class="code-highlight language-bash">...
| while read operation path; do
  # commands
done;
</code></pre>
<p>Vamos combinar este loop com o resto do nosso script:</p>
<div class="code-label " title="~/webp-watchers.sh">~/webp-watchers.sh</div><pre class="code-pre "><code class="code-highlight language-bash">inotifywait -q -m -r --format '%e %w%f' -e close_write -e moved_from -e moved_to -e delete $1 \
| grep -i -E '\.(jpe?g|png)$' --line-buffered \
| while read operation path; do
  # commands
done;
</code></pre>
<p>Após o loop <code>while</code> verificar o evento, os comandos dentro do loop tomarão as seguintes ações, dependendo do resultado:</p>

<ul>
<li>Criar um novo arquivo WebP se um novo arquivo de imagem for criado ou movido para o diretório de destino.</li>
<li>Excluir o arquivo WebP se o arquivo de imagem associado for excluído ou movido do diretório de destino.</li>
</ul>

<p>Há três seções principais dentro do loop. Uma variável chamada <code>webp_path</code> irá reter o caminho para a versão <code>.webp</code> da imagem em questão:</p>
<div class="code-label " title="~/webp-watchers.sh">~/webp-watchers.sh</div><pre class="code-pre "><code class="code-highlight language-bash">...
webp_path="$(sed 's/\.[^.]*$/.webp/' &lt;&lt;&lt; "$path")";
</code></pre>
<p>A seguir, o script irá testar qual evento aconteceu:</p>
<div class="code-label " title="~/webp-watchers.sh">~/webp-watchers.sh</div><pre class="code-pre "><code langs="">...
if [ $operation = "MOVED_FROM" ] || [ $operation = "DELETE" ]; then
  # commands to be executed if the file is moved or deleted
elif [ $operation = "CLOSE_WRITE,CLOSE" ] || [ $operation = "MOVED_TO" ]; then
  # commands to be executed if a new file is created
fi;
</code></pre>
<p>Se o arquivo foi movido ou excluído, o script irá verificar se a versão <code>.webp</code> existe. Se ela existe, o script irá removê-la usando o <code>rm</code>:</p>
<div class="code-label " title="~/webp-watchers.sh">~/webp-watchers.sh</div><pre class="code-pre "><code langs="">...
if [ -f "$webp_path" ]; then
  $(rm -f "$webp_path");
fi;
</code></pre>
<p>Para arquivos recém-criados, a compressão irá acontecer da seguinte forma:</p>

<ul>
<li>Se o arquivo correspondente for uma imagem PNG, o script irá usar a compressão sem perdas.</li>
<li>Se não for, o script usará uma compressão com perdas com a opção <code>-quality</code>.</li>
</ul>

<p>Vamos adicionar os comandos <code>cwebp</code> que irão fazer este trabalho no script:</p>
<div class="code-label " title="~/webp-watchers.sh">~/webp-watchers.sh</div><pre class="code-pre "><code class="code-highlight language-bash">...
if [ $(grep -i '\.png$' &lt;&lt;&lt; "$path") ]; then
  $(cwebp -quiet -lossless "$path" -o "$webp_path");
else
  $(cwebp -quiet -q 90 "$path" -o "$webp_path");
fi;
</code></pre>
<p>Na íntegra, o arquivo <code>webp-watchers.sh</code> se parecerá com este:</p>
<div class="code-label " title="~/webp-watchers.sh">~/webp-watchers.sh</div><pre class="code-pre "><code class="code-highlight language-bash">#!/bin/bash
echo "Setting up watches.";

# watch for any created, moved, or deleted image files
inotifywait -q -m -r --format '%e %w%f' -e close_write -e moved_from -e moved_to -e delete $1 \
| grep -i -E '\.(jpe?g|png)$' --line-buffered \
| while read operation path; do
  webp_path="$(sed 's/\.[^.]*$/.webp/' &lt;&lt;&lt; "$path")";
  if [ $operation = "MOVED_FROM" ] || [ $operation = "DELETE" ]; then # if the file is moved or deleted
    if [ -f "$webp_path" ]; then
      $(rm -f "$webp_path");
    fi;
  elif [ $operation = "CLOSE_WRITE,CLOSE" ] || [ $operation = "MOVED_TO" ]; then  # if new file is created
     if [ $(grep -i '\.png$' &lt;&lt;&lt; "$path") ]; then
       $(cwebp -quiet -lossless "$path" -o "$webp_path");
     else
       $(cwebp -quiet -q 90 "$path" -o "$webp_path");
     fi;
  fi;
done;
</code></pre>
<p>Salve e feche o arquivo. Não se esqueça de torná-lo executável:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">chmod a+x ~/webp-watchers.sh
</li></ul></code></pre>
<p>Vamos executar este script no diretório <code>/var/www/html/webp</code> em segundo plano, usando o <code>&amp;</code>. Vamos também redirecionar os resultados padrão e os erros padrão para um <code>~/output.log</code>, para armazenar os resultados em local prontamente disponível:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">./webp-watchers.sh /var/www/html/webp &gt; output.log 2&gt;&amp;1 &amp;
</li></ul></code></pre>
<p>Neste ponto, você converteu os arquivos JPEG e PNG em <code>/var/www/html/webp</code> para o formato WebP e configurou observadores para fazer esse trabalho, usando o script <code>webp-watchers.sh</code>. Agora é hora de explorar opções para entregar imagens WebP aos visitantes do seu site.</p>

<h2 id="passo-5-—-exibindo-imagens-webp-para-visitantes-usando-elementos-html">Passo 5 — Exibindo Imagens WebP para Visitantes Usando Elementos HTML</h2>

<p>Neste passo, vamos explicar como exibir imagens WebP com elementos HTML. Neste ponto, devem haver versões <code>.webp</code> de cada uma das imagens teste JPEG e PNG no diretório <code>/var/www/html/webp</code>. Agora, podemos exibi-las para os navegadores compatíveis, usando ou os elementos HTML5 (<code>&lt;picture&gt;</code>) ou o módulo Apache <code>mod_rewrite</code>. Vamos usar elementos HTML neste passo.</p>

<p>O elemento <code>&lt;picture&gt;</code> permite que você inclua imagens diretamente nas suas páginas Web e defina mais de uma fonte de imagens. Se seu navegador é compatível com o formato WebP, ele irá baixar a versão <code>.webp</code> do arquivo em vez da versão original, resultando em páginas Web sendo exibidas mais rapidamente. Vale dizer que o elemento <code>&lt;picture&gt;</code> é bem suportado em navegadores modernos compatíveis com o formato WebP.</p>

<p>O elemento <code>&lt;picture&gt;</code> é um container com elementos <code>&lt;source&gt;</code> que <code>&lt;image&gt;</code> apontam para arquivos específicos. Se usarmos <code>&lt;source&gt;</code> para apontar para uma imagem <code>.webp</code>, o navegador verá se ele pode lidar com ela; caso contrário, ele retrocederá para o arquivo de imagem especificado no atributo src do elemento <code>&lt;source&gt;</code>.</p>

<p>Vamos usar o arquivo <code>logo.png</code> do nosso diretório <code>/var/www/html/webp</code>, o qual convertemos para <code>logo.webp</code>, como um exemplo com <code>&lt;source&gt;</code>. Podemos usar o seguinte código HTML para exibir o <code>logo.webp</code> em qualquer navegador compatível com o formato WebP e o <code>logo.png</code> com navegadors não compatíveis com o WebP ou o elemento <code>&lt;picture&gt;</code>.</p>

<p>Crie um arquivo HTML localizado em <code>/var/www/html/webp/picture.html</code>:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">nano /var/www/html/webp/picture.html
</li></ul></code></pre>
<p>Adicione o código a seguir à página Web para exibir o <code>logo.webp</code> para navegadores compatíveis, usando o elemento <code>&lt;picture&gt;</code>:</p>
<div class="code-label " title="/var/www/html/webp/picture.html">/var/www/html/webp/picture.html</div><pre class="code-pre "><code class="code-highlight language-html">&lt;picture&gt;
  &lt;source srcset="logo.webp" type="image/webp"&gt;
  &lt;img src="logo.png" alt="Site Logo"&gt;
&lt;/picture&gt;
</code></pre>
<p>Salve e feche o arquivo.</p>

<p>Para testar se tudo está funcionando, navegue até a página <code>http://<span class="highlight">your_server_ip</span>/webp/picture.html</code>. Você deve ver a imagem teste PNG.</p>

<p>Agora que você sabe como exibir imagens <code>.webp</code> diretamente do código HTML, vamos ver como automatizar este processo usando o módulo <code>mod_rewrite</code> do Apache.</p>

<h2 id="passo-6-—-exibindo-imagens-webp-usando-o-mod_rewrite">Passo 6 — Exibindo Imagens WebP Usando o mod_rewrite</h2>

<p>Se queremos otimizar a velocidade do nosso site, mas temos um grande número de páginas ou muito pouco tempo para editar o código HTML, então o módulo <code>mod_rewrite</code> do Apache pode nos ajudar a automatizar o processo de exibição de imagens <code>.webp</code> em navegadores compatíveis.</p>

<p>Primeiramente, crie um arquivo <code>.htaccess</code> no diretório <code>/var/www/html/webp</code> usando o comando a seguir:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">nano /var/www/html/webp/.htaccess
</li></ul></code></pre>
<p>A diretiva <code>ifModule</code> irá testar se o <code>mod_rewrite</code> está disponível; se ele estiver, ele pode ser ativado usando o <code>RewriteEngine On</code>. Adicione essas diretivas ao <code>.htaccess</code>:</p>
<div class="code-label " title="/var/www/html/webp/.htaccess">/var/www/html/webp/.htaccess</div><pre class="code-pre "><code class="code-highlight language-apache">&lt;ifModule mod_rewrite.c&gt;
  RewriteEngine On 
  # further directives
&lt;/IfModule&gt;
</code></pre>
<p>O servidor Web fará vários testes para estabelecer quando exibir imagens <code>.webp</code> para o usuário. Quando um navegador faz um pedido, ele inclui um cabeçalho que indica ao servidor o que o navegador é capaz de manipular. No caso do WebP, o navegador irá enviar um cabeçalho <code>Accept</code> que contém <code>image/webp</code>. Vamos verificar se o navegador enviou aquele cabeçalho usando o <code>RewriteCond</code>, que especifica os critérios que devem ser correspondidos para executar o <code>RewriteRule</code>:</p>
<div class="code-label " title="/var/www/html/webp/.htaccess">/var/www/html/webp/.htaccess</div><pre class="code-pre "><code class="code-highlight language-apache">...
RewriteCond %{HTTP_ACCEPT} image/webp
</code></pre>
<p>Tudo deve ser filtrado, exceto as imagens JPEG e PNG. Usando o <code>RewriteCond</code> novamente, adicione uma expressão regular (similar ao que usamos nas seções anteriores) para corresponder ao URI solicitado:</p>
<div class="code-label " title="/var/www/html/webp/.htaccess">/var/www/html/webp/.htaccess</div><pre class="code-pre "><code class="code-highlight language-apache">...
RewriteCond %{REQUEST_URI}  (?i)(.*)(\.jpe?g|\.png)$ 
</code></pre>
<p>O modificador <code>(?i)</code> fará com que a correspondência não diferencie maiúsculas e minúsculas.</p>

<p>Para verificar se a versão <code>.webp</code> do arquivo existe, use o <code>RewriteCond</code> novamente do seguinte modo:</p>
<div class="code-label " title="/var/www/html/webp/.htaccess">/var/www/html/webp/.htaccess</div><pre class="code-pre "><code class="code-highlight language-apache">...
RewriteCond %{DOCUMENT_ROOT}%1.webp -f
</code></pre>
<p>Finalmente, se todas as condições anteriores forem cumpridas, o <code>RewriteRule</code> irá redirecionar o arquivo JPEG ou PNG solicitado para seu arquivo WebP associado. Observe que isso irá <em>redirecionar</em> usando o sinalizador <code>-R</code>, em vez de <em>reescrever</em> o URI. A diferença entre reescrever e redirecionar é que o servidor irá exibir o URI reescrito sem contar ao navegador. Por exemplo, o URI irá mostrar que a extensão de arquivo é <code>.png</code>, mas ele será na realidade um arquivo <code>.webp</code>. Adicione o <code>RewriteRule</code> ao arquivo:</p>
<div class="code-label " title="/var/www/html/webp/.htaccess">/var/www/html/webp/.htaccess</div><pre class="code-pre "><code class="code-highlight language-apache">...
RewriteRule (?i)(.*)(\.jpe?g|\.png)$ %1\.webp [L,T=image/webp,R] 
</code></pre>
<p>Neste ponto, a seção <code>mod_rewrite</code> no arquivo <code>.htaccess</code> está completa. Mas o que acontecerá se houver um servidor de cache intermediário entre seu servidor e o cliente? Ele pode exibir a versão errada ao usuário final. É por isso que vale a pena verificar se o <code>mod_headers</code> está habilitado, para enviar o cabeçalho <code>Vary: Accept</code>. O cabeçalho <code>Vary</code> indica aos servidores de cache (como servidores proxy) que o tipo de conteúdo do documento varia dependendo das capacidades do navegador que solicita o documento. Além disso, a resposta será gerada com base no cabeçalho <code>Accept</code> no pedido. Um pedido com um cabeçalho <code>Accept</code> diferente pode obter uma resposta diferente. Este cabeçalho é importante porque ele impede que imagens WebP em cache sejam exibidas para navegadores não compatíveis:</p>
<div class="code-label " title="/var/www/html/webp/.htaccess">/var/www/html/webp/.htaccess</div><pre class="code-pre "><code class="code-highlight language-apache">...
&lt;IfModule mod_headers.c&gt;
  Header append Vary Accept env=REDIRECT_accept
&lt;/IfModule&gt;
</code></pre>
<p>Enfim, no final do arquivo <code>.htaccess</code>, configure o tipo MIME das imagens <code>.webp</code> como <code>image/webp</code> usando a diretiva <code>AddType</code>. Isso irá exibir as imagens usando o tipo de MIME correto:</p>
<div class="code-label " title="/var/www/html/webp/.htaccess">/var/www/html/webp/.htaccess</div><pre class="code-pre "><code class="code-highlight language-apache">...
AddType image/webp .webp
</code></pre>
<p>Esta é a versão final do nosso arquivo <code>.htaccess</code>:</p>
<div class="code-label " title="/var/www/html/webp/.htaccess">/var/www/html/webp/.htaccess</div><pre class="code-pre "><code class="code-highlight language-apache">&lt;ifModule mod_rewrite.c&gt;
  RewriteEngine On 
  RewriteCond %{HTTP_ACCEPT} image/webp
  RewriteCond %{REQUEST_URI}  (?i)(.*)(\.jpe?g|\.png)$ 
  RewriteCond %{DOCUMENT_ROOT}%1.webp -f
  RewriteRule (?i)(.*)(\.jpe?g|\.png)$ %1\.webp [L,T=image/webp,R] 
&lt;/IfModule&gt;

&lt;IfModule mod_headers.c&gt;
  Header append Vary Accept env=REDIRECT_accept
&lt;/IfModule&gt;

AddType image/webp .webp
</code></pre>
<p><span class='note'><strong>Nota:</strong> você pode fundir este <code>.htaccess</code> com outro arquivo <code>.htaccess</code>, se ele existir. Se você está usando o WordPress, por exemplo, você deve copiar este arquivo <code>.htaccess</code> e colá-lo no <strong>topo</strong> do arquivo existente.<br></span></p>

<p>Vamos colocar o que fizemos neste passo em prática. Se você seguiu as instruções nos passos anteriores, você deve ter as imagens <code>logo.png</code> e <code>logo.webp</code> em <code>/var/www/html/webp</code>. Vamos usar uma tag simples <code>&lt;img&gt;</code> para incluir a <code>logo.png</code> em nossa página Web. Crie um novo arquivo HTML para testar a configuração:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">nano /var/www/html/webp/img.html
</li></ul></code></pre>
<p>Digite o código HTML a seguir no arquivo:</p>
<div class="code-label " title="/var/www/html/webp/img.html">/var/www/html/webp/img.html</div><pre class="code-pre "><code class="code-highlight language-html">&lt;img src="logo.png" alt="Site Logo"&gt;
</code></pre>
<p>Salve e feche o arquivo.</p>

<p>Quando você visitar a página Web usando o Chrome visitando <code>http://<span class="highlight">your_server_ip</span>/webp/img.html</code>, você irá notar que a imagem exibida é a versão <code>.webp</code> (tente abrir a imagem em uma nova aba). Se você usa o Firefox, você receberá uma imagem <code>.png</code> automaticamente.</p>

<h2 id="conclusão">Conclusão</h2>

<p>Neste tutorial, abordamos técnicas básicas para trabalhar com imagens WebP. Explicamos como usar o <code>cwebp</code> para converter arquivos, além de duas opções para exibir essas imagens aos usuários: o elemento <code>&lt;picture&gt;</code> do HTML5 e o <code>mod_rewrite</code> do Apache.</p>

<p>Para personalizar os scripts deste tutorial, você pode consultar alguns desses recursos:</p>

<ul>
<li>Para aprender mais sobre as características do formato WebP e como usar as ferramentas de conversão, consulte a <a href="https://developers.google.com/speed/webp/">documentação do WebP</a>.</li>
<li>Para ver mais detalhes sobre o uso do elemento <code>&lt;picture&gt;</code>, consulte sua <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/picture">documentação no MDN</a>.</li>
<li>Para entender completamente como usar o <code>mod_rewrite</code>, consulte sua <a href="https://httpd.apache.org/docs/current/mod/mod_rewrite.html">documentação</a>.</li>
</ul>

<p>Usar o formato WebP para suas imagens irá reduzir os tamanhos dos arquivos de maneira considerável. Isso pode reduzir o uso da largura de banda e fazer as páginas carregarem mais rapidamente, particularmente se seu site usar muitas imagens.</p>
