---
layout: post
title: Como Usar o Ansible para Instalar e Configurar o LEMP no Ubuntu 18.04
network: digitalocean
date: December 21, 2019 at 03:21AM
url: https://www.digitalocean.com/community/tutorials/como-usar-o-ansible-para-instalar-e-configurar-o-lemp-no-ubuntu-18-04-pt
image: https://assets.digitalocean.com/articles/automated_ansible/phpinfo.png
tags: docker
feedtitle: DigitalOcean Community Tutorials
feedurl: https://www.digitalocean.com/community/tutorials
author: DigitalOcean
---
<h3 id="introdução">Introdução</h3>

<p>A automação de servidores desempenha agora um papel essencial na administração de sistemas, devido à natureza descartável dos ambientes das aplicações modernas. Ferramentas de <a href="https://www.digitalocean.com/community/tutorial_series/getting-started-with-configuration-management">Gerenciamento de configuração</a> tais como o <a href="https://ansible.com">Ansible</a> são normalmente usadas para otimizar o processo de automatização da configuração do servidor, estabelecendo procedimentos padrão para novos servidores e reduzindo também o erro humano associado às configurações manuais.</p>

<p>O Ansible oferece uma arquitetura simples que não requer a instalação de software especial nos nodes. Ele também fornece um conjunto robusto de recursos e módulos internos que facilitam a criação de scripts de automação.</p>

<p>Este guia explica como usar o Ansible para automatizar os passos contidos em nosso guia <a href="https://www.digitalocean.com/community/tutorials/how-to-install-linux-nginx-mysql-php-lemp-stack-ubuntu-18-04-pt">Como instalar o Linux, o Nginx, o MySQL, o PHP (pilha LEMP) no Ubuntu 18.04</a>. A pilha de software LEMP é um grupo de software que pode ser usado para servir páginas web dinâmicas e aplicações web. Este é um acrônimo que descreve um sistema operacional <strong>L</strong>inux, com um servidor Nginx (pronunciado como &ldquo;<strong>E</strong>ngine-X&rdquo;). Os dados de back-end são armazenados no banco de dados <strong>M</strong>ySQL e o processamento dinâmico é tratado pelo <strong>P</strong>HP.</p>

<h2 id="pré-requisitos">Pré-requisitos</h2>

<p>Para executar a configuração automatizada fornecida pelo playbook que estamos discutindo neste guia, você precisará de:</p>

<ul>
<li><strong>Um node de controle Ansible</strong>: uma máquina Ubuntu 18.04 com o Ansible instalado e configurado para conectar aos seus hosts Ansible usando chaves SSH. Certifique-se de que o node de controle possui um usuário regular com permissões sudo e um firewall ativado, conforme explicado em nosso guia <a href="https://www.digitalocean.com/community/tutorials/configuracao-inicial-de-servidor-com-ubuntu-18-04-pt">Configuração Inicial de servidor</a>. Para configurar o Ansible, siga nosso guia <a href="https://www.digitalocean.com/community/tutorials/como-instalar-e-configurar-o-ansible-no-ubuntu-18-04-pt">Como instalar e configurar o Ansible no Ubuntu 18.04</a>.</li>
<li><strong>Um ou mais Hosts Ansible</strong>: um ou mais servidores remotos Ubuntu 18.04 previamente configurados, seguindo o guia em <a href="https://www.digitalocean.com/community/tutorials/how-to-use-ansible-to-automate-initial-server-setup-on-ubuntu-18-04">How to Use Ansible to Automate Initial Server Setup on Ubuntu 18.04</a>.</li>
</ul>

<p><span class='note'>Antes de continuar, primeiro você precisa garantir que o node de controle do Ansible possa conectar e executar comandos no(s) host(s) Ansible. Para um teste de conexão, verifique o passo 3 de <a href="https://www.digitalocean.com/community/tutorials/como-instalar-e-configurar-o-ansible-no-ubuntu-18-04-pt">Como instalar e configurar o Ansible no Ubuntu 18.04</a>.<br></span></p>

<h2 id="o-que-este-playbook-faz">O que Este Playbook Faz?</h2>

<p>Este Playbook Ansible fornece uma alternativa à execução manual do procedimento descrito em nosso guia sobre <a href="https://www.digitalocean.com/community/tutorials/how-to-install-linux-nginx-mysql-php-lemp-stack-ubuntu-18-04-pt">Como instalar o Linux, o Nginx, o MySQL, o PHP (pilha LEMP) no Ubuntu 18.04</a>.</p>

<p>A execução deste playbook executará as seguintes ações em seus hosts Ansible:</p>

<ol>
<li>Instalar o <code>aptitude</code>, que é preferido pelo Ansible como uma alternativa ao gerenciador de pacotes <code>apt</code>.</li>
<li>Instalar os pacotes necessários do LEMP.</li>
<li>Configurar o arquivo de configuração do Nginx usando o modelo fornecido.</li>
<li>Habilitar a nova configuração do Nginx e desabilitar a configuração padrão.</li>
<li>Definir a senha para o usuário <strong>root</strong> do MySQL.</li>
<li>Remover contas anônimas do MySQL e o banco de dados de teste.</li>
<li>Configurar o UFW para permitir o tráfego HTTP na porta configurada (<code>80</code> por padrão).</li>
<li>Configurar um script de teste PHP usando o modelo fornecido.</li>
</ol>

<p>Quando o playbook terminar de ser executado, você terá um ambiente web PHP em execução no Nginx, com base nas opções que você definiu nas variáveis de configuração.</p>

<h2 id="como-usar-este-playbook">Como Usar Este Playbook</h2>

<p>A primeira coisa que precisamos fazer é obter o playbook do LEMP e suas dependências no repositório <a href="https://github.com/do-community/ansible-playbooks">do-community/ansible-playbooks</a>. Precisamos clonar esse repositório em uma pasta local dentro do Node de Controle Ansible. </p>

<p>Caso você tenha clonado este repositório antes, enquanto seguia um guia diferente, acesse sua cópia existente do <code>ansible-playbooks</code> e execute um comando <code>git pull</code> para garantir que você tenha conteúdo atualizado:</p>
<pre class="code-pre command local-environment"><code langs=""><ul class="prefixed"><li class="line" prefix="$">cd ~/ansible-playbooks
</li><li class="line" prefix="$">git pull
</li></ul></code></pre>
<p>Se esta é sua primeira vez usando o repositório <code>do-community/ansible-playbooks</code>, você deve começar clonando o repositório na sua pasta home com:</p>
<pre class="code-pre command local-environment"><code langs=""><ul class="prefixed"><li class="line" prefix="$">cd ~
</li><li class="line" prefix="$">git clone https://github.com/do-community/ansible-playbooks.git
</li><li class="line" prefix="$">cd ansible-playbooks
</li></ul></code></pre>
<p>Os arquivos em que estamos interessados estão localizados dentro da pasta <code>lemp_ubuntu1804</code>, que possui a seguinte estrutura:</p>
<pre class="code-pre "><code langs="">lemp_ubuntu1804
├── files
│   ├── info.php.j2
│   └── nginx.conf.j2
├── vars
│   └── default.yml
├── playbook.yml
└── readme.md
</code></pre>
<p>Aqui está o que cada um desses arquivos representa:</p>

<ul>
<li><code>files/info.php.j2</code>: Arquivo de modelo para configurar uma página de teste PHP na raiz do servidor web.</li>
<li><code>files/nginx.conf.j2</code>: Arquivo de modelo para configurar o servidor Nginx.</li>
<li><code>vars/default.yml</code>: Arquivo de variáveis para personalizar as configurações do playbook.</li>
<li><code>playbook.yml</code>: O arquivo do playbook, contendo as tarefas a serem executadas nos servidores remotos.</li>
<li><code>readme.md</code>: Um arquivo de texto contendo informações sobre este playbook.</li>
</ul>

<p>Editaremos o arquivo de variáveis do playbook para personalizar as configurações do MySQL e do Nginx. Acesse o diretório <code>lemp_ubuntu1804</code> e abra o arquivo <code>vars/default.yml</code> usando o editor de linha de comando de sua escolha:</p>
<pre class="code-pre command local-environment"><code langs=""><ul class="prefixed"><li class="line" prefix="$">cd lemp_ubuntu1804
</li><li class="line" prefix="$">nano vars/default.yml
</li></ul></code></pre>
<p>Este arquivo contém algumas variáveis que requerem sua atenção:</p>
<div class="code-label " title="vars/default.yml">vars/default.yml</div><pre class="code-pre yaml local-environment"><code langs="">---
mysql_root_password: "<span class="highlight">mysql_root_password</span>"
http_host: "<span class="highlight">your_domain</span>"
http_conf: "<span class="highlight">your_domain</span>.conf"
http_port: "<span class="highlight">80</span>"
</code></pre>
<p>A lista a seguir contém uma breve explicação de cada uma dessas variáveis e como você pode alterá-las:</p>

<ul>
<li><code>mysql_root_password</code>: A senha desejada para a conta <strong>root</strong> do MySQL.</li>
<li><code>http_host</code>: O nome do host ou o endereço IP para o servidor web.</li>
<li><code>http_conf</code>: O nome do arquivo de configuração a ser criado dentro de <code>/etc/nginx/sites-available</code>, normalmente definido como o nome do host ou da aplicação para facilitar a identificação.</li>
<li><code>http_port</code>: A porta que o Nginx utilizará para servir este site. Esta é a porta <code>80</code> por padrão, mas se você deseja servir seu site ou aplicação em uma porta diferente, digite-a aqui.</li>
</ul>

<p>Quando terminar de atualizar as variáveis dentro de <code>vars/default.yml</code>, salve e feche este arquivo. Se você usou <code>nano</code>, faça isso pressionando <code>CTRL + X</code>, <code>Y</code>, e, em seguida, <code>ENTER</code>.</p>

<p>Agora você está pronto para executar este playbook em um ou mais servidores. A maioria dos playbooks está configurada para ser executada em todos os servidores do seu inventário, por padrão. Podemos usar a flag <code>-l</code> para garantir que apenas um subconjunto de servidores ou um único servidor seja afetado pelo playbook. Também podemos usar a flag <code>-u</code> para especificar qual usuário no servidor remoto que estamos usando para conectar e executar os comandos do playbook nos hosts remotos.</p>

<p>Para executar o playbook apenas no servidor <code><span class="highlight">server1</span></code>, conectando-se como <code><span class="highlight">sammy</span></code>, você pode usar o seguinte comando:</p>
<pre class="code-pre command local-environment"><code langs=""><ul class="prefixed"><li class="line" prefix="$">ansible-playbook playbook.yml -l <span class="highlight">server1</span> -u <span class="highlight">sammy</span>
</li></ul></code></pre>
<p>Você obterá uma saída semelhante a esta:</p>
<pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>
PLAY [all] *****************************************************************************************************************************

TASK [Gathering Facts] *****************************************************************************************************************
ok: [server1]

TASK [Install Prerequisites] ***********************************************************************************************************
changed: [server1] =&gt; (item=aptitude)

...

TASK [UFW - Allow HTTP on port 80] *****************************************************************************************************
changed: [server1]

TASK [Sets Up PHP Info Page] ***********************************************************************************************************
changed: [server1]

RUNNING HANDLER [Reload Nginx] *********************************************************************************************************
changed: [server1]

PLAY RECAP *****************************************************************************************************************************
server1         : ok=12   changed=9    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   

</code></pre>
<p><span class='note'><strong>Nota</strong>: Para obter mais informações sobre como executar os playbooks Ansible, consulte nosso guia de referência <a href="https://www.digitalocean.com/community/tutorials/how-to-use-ansible-cheat-sheet-guide">Ansible Cheat Sheet Guide</a>.<br></span></p>

<p>Quando o playbook terminar de ser executado, abra seu navegador web e acesse o host ou o endereço IP do servidor, conforme configurado nas variáveis do playbook, seguido de <code>/info.php</code>:</p>
<pre class="code-pre "><code langs="">http://<span class="highlight">host_ou_ip_do_servidor</span>/info.php
</code></pre>
<p>Você verá uma página como esta:</p>

<p><img src="https://assets.digitalocean.com/articles/automated_ansible/phpinfo.png" alt="phpinfo page"></p>

<p>Como esta página contém informações confidenciais sobre o seu ambiente PHP, é recomendável que você a remova do servidor executando um comando <code>rm -f /var/www/info.php</code> após concluir a configuração.</p>

<h2 id="o-conteúdo-do-playbook">O Conteúdo do Playbook</h2>

<p>Você pode encontrar a configuração do servidor LEMP apresentada neste tutorial na página <a href="https://github.com/do-community/ansible-playbooks/tree/master/lemp_ubuntu1804"><code>lemp_ubuntu1804</code></a> dentro do repositório <a href="https://github.com/do-community/ansible-playbooks">DigitalOcean Community Playbooks</a>. Para copiar ou baixar o conteúdo do script diretamente, clique no botão <strong>Raw</strong> na parte superior de cada script.</p>

<p>O conteúdo completo do playbook, bem como os arquivos associados, também estão incluídos aqui para sua conveniência.</p>

<h3 id="vars-default-yml">vars/default.yml</h3>

<p>O arquivo de variáveis <code>default.yml</code> contém valores que serão usados nas tarefas do playbook, como a senha da conta <strong>root</strong> do MySQL e o nome do domínio a ser configurado no Nginx.</p>
<div class="code-label " title="vars/default.yml">vars/default.yml</div><pre class="code-pre yaml local-environment"><code langs="">---
mysql_root_password: "<span class="highlight">mysql_root_password</span>"
http_host: "<span class="highlight">your_domain</span>"
http_conf: "<span class="highlight">your_domain</span>.conf"
http_port: "<span class="highlight">80</span>"
</code></pre>
<h3 id="files-nginx-conf-j2">files/nginx.conf.j2</h3>

<p>O arquivo <code>nginx.conf.j2</code> é um template ou modelo <a href="https://jinja.palletsprojects.com/en/2.10.x/">Jinja 2</a> que configura o servidor web Nginx. As variáveis usadas neste modelo são definidas no arquivo de variáveis <code>vars/default.yml</code>.</p>
<div class="code-label " title="files/nginx.conf.j2">files/nginx.conf.j2</div><pre class="code-pre  local-environment"><code langs="">server {
       listen {{ http_port }};
       root /var/www/html;
       index index.php index.html index.htm index.nginx-debian.html;
       server_name {{ http_host }};

       location / {
               try_files $uri $uri/ =404;
       }

       location ~ \.php$ {
               include snippets/fastcgi-php.conf;
               fastcgi_pass unix:/var/run/php/php7.2-fpm.sock;
       }

       location ~ /\.ht {
               deny all;
       }
}

</code></pre>
<h3 id="files-info-php-j2">files/info.php.j2</h3>

<p>O arquivo <code>info.php.j2</code> é outro modelo Jinja, usado para configurar um script PHP de teste na raiz de documentos do servidor LEMP recém-configurado.</p>
<div class="code-label " title="files/info.php.j2">files/info.php.j2</div><pre class="code-pre  local-environment"><code langs="">&lt;?php
phpinfo();

</code></pre>
<h3 id="playbook-yml">playbook.yml</h3>

<p>O arquivo <code>playbook.yml</code> é onde todas as tarefas desta configuração são definidas. Ele começa definindo o grupo de servidores que deve ser o alvo dessa configuração (<code>all</code>), após o qual ele usa <code>become: true</code> para definir que as tarefas devem ser executadas com escalação de privilégios (<code>sudo</code>) por padrão. Em seguida, inclui o arquivo de variáveis <code>vars/default.yml</code> para carregar as opções de configuração.</p>
<div class="code-label " title="playbook.yml">playbook.yml</div><pre class="code-pre yaml local-environment"><code langs="">---
- hosts: all
  become: true
  vars_files:
   - vars/default.yml

 tasks:
   - name: Install Prerequisites
     apt: name={{ item }} update_cache=yes state=latest force_apt_get=yes
     loop: [ 'aptitude' ]

   - name: Install LEMP Packages
     apt: name={{ item }} update_cache=yes state=latest
     loop: [ 'nginx', 'mysql-server', 'python3-pymysql', 'php-fpm', 'php-mysql' ]

# Nginx Configuration

   - name: Sets Nginx conf file
     template:
       src: "files/nginx.conf.j2"
       dest: "/etc/nginx/sites-available/{{ http_conf }}"

   - name: Enables new site
     file:
       src: "/etc/nginx/sites-available/{{ http_conf }}"
       dest: "/etc/nginx/sites-enabled/{{ http_conf }}"
       state: link
     notify: Reload Nginx

   - name: Removes "default" site
     file:
       path: "/etc/nginx/sites-enabled/default"
       state: absent
     notify: Reload Nginx

# MySQL Configuration

   - name: Sets the root password
     mysql_user:
       name: root
       password: "{{ mysql_root_password }}"
       login_unix_socket: /var/run/mysqld/mysqld.sock

   - name: Removes all anonymous user accounts
     mysql_user:
       name: ''
       host_all: yes
       state: absent
       login_user: root
       login_password: "{{ mysql_root_password }}"

   - name: Removes the MySQL test database
     mysql_db:
       name: test
       state: absent
       login_user: root
       login_password: "{{ mysql_root_password }}"

# UFW Configuration

   - name: "UFW - Allow HTTP on port {{ http_port }}"
     ufw:
       rule: allow
       port: "{{ http_port }}"
       proto: tcp

# Sets Up PHP Info Page

   - name: Sets Up PHP Info Page
     template:
       src: "files/info.php.j2"
       dest: "/var/www/html/info.php"

# Handlers

 handlers:
   - name: Reload Nginx
     service:
       name: nginx
       state: reloaded

   - name: Restart Nginx
     service:
       name: nginx
       state: restarted

</code></pre>
<p>Sinta-se à vontade para modificar este playbook para melhor atender às suas necessidades individuais dentro do seu próprio fluxo de trabalho.</p>

<h2 id="conclusão">Conclusão</h2>

<p>Neste guia, usamos o Ansible para automatizar o processo de instalação e configuração de um ambiente LEMP em um servidor remoto. Como cada pessoa normalmente tem necessidades diferentes ao trabalhar com bancos de dados e usuários do MySQL, recomendamos que você verifique a <a href="https://docs.ansible.com/ansible/latest/modules/mysql_user_module.html#mysql-%20user-module">documentação oficial do Ansible</a> para obter mais informações e casos de uso do módulo Ansible <code>mysql_user</code>.</p>

<p>Se você deseja incluir outras tarefas neste playbook para personalizar ainda mais sua configuração inicial de servidor, consulte nosso guia introdutório de Ansible em <a href="https://www.digitalocean.com/community/tutorials/configuration-management-101-writing-ansible-playbooks">Configuration Management 101: Writing Ansible Playbooks</a>.</p>
