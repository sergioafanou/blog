---
layout: post
title: Como gerenciar a infraestrutura DigitalOcean e o Kubernetes com o Pulumi
network: digitalocean
date: December 10, 2019 at 09:13PM
url: https://www.digitalocean.com/community/tutorials/how-to-manage-digitalocean-and-kubernetes-infrastructure-with-pulumi-pt
image: http://ifttt.com/images/no_image_card.png
tags: docker
feedtitle: DigitalOcean Community Tutorials
feedurl: https://www.digitalocean.com/community/tutorials
author: DigitalOcean
---
<p><em>O autor escolheu a <a href="https://www.brightfunds.org/funds/diversity-in-tech">Diversity in Tech Fund</a> para receber uma doação como parte do programa <a href="https://do.co/w4do-cta">Write for DOnations</a>.</em></p>

<h3 id="introdução">Introdução</h3>

<p>O <a href="https://www.pulumi.com/docs">Pulumi</a> é uma ferramenta para criar, implantar e gerenciar infraestrutura usando código escrito em linguagens de programação de uso geral. Ele suporta a automação de todos os serviços gerenciados da DigitalOcean, como Droplets, bancos de dados gerenciados, registros DNS e clusters Kubernetes, além da configuração de aplicações. Os deployments são realizados a partir de uma interface de linha de comando fácil de usar que também se integra a uma ampla variedade de sistemas populares de CI/CD.</p>

<p>O Pulumi suporta várias linguagens, mas neste tutorial você usará <a href="https://www.typescriptlang.org/">TypeScript</a>, uma versão de tipagem estática do <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript">JavaScript</a> que utiliza o runtime <a href="https://nodejs.org/">Node.js</a>. Isso significa que você obterá suporte a IDE e checagem em tempo de compilação que o ajudarão a garantir que você configurou os recursos certos, usou slugs corretos etc., enquanto continua podendo acessar qualquer módulo <a href="https://www.npmjs.com/">NPM</a> para tarefas utilitárias.</p>

<p>Neste tutorial, você provisionará um cluster <a href="https://kubernetes.io/">Kubernetes</a> na DigitalOcean, uma aplicação Kubernetes com balanceamento de carga e um domínio DNS da DigitalOcean que disponibiliza seu aplicativo em um nome de domínio estável de sua escolha. Tudo isso pode ser provisionado em 60 linhas de infraestrutura como código e em uma única execução de linha de comando <code>pulumi up</code>. Após este tutorial, você estará pronto para criar com produtividade, arquiteturas poderosas de nuvem usando a infraestrutura como código do Pulumi que aproveita toda a área de serviços DigitalOcean e Kubernetes.</p>

<h2 id="pré-requisitos">Pré-requisitos</h2>

<p>Para seguir este tutorial, você precisará de:</p>

<ul>
<li>Uma conta na DigitalOcean na qual fazer o deployment dos recursos. Se você ainda não possui uma, <a href="https://cloud.digitalocean.com/registrations/new">cadastre-se aqui</a>.</li>
<li>Um token de API da DigitalOcean para executar deployments automatizados. <a href="https://www.digitalocean.com/docs/api/create-personal-access-token/">Gere um token de acesso pessoal aqui</a> e mantenha-o à mão, pois você o usará no Passo 2.</li>
<li>Como você criará e usará um cluster Kubernetes, precisará <a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/">instalar o <code>kubectl</code></a>. Não se preocupe em configurá-lo ainda, pois você fará isso mais tarde.</li>
<li>Você escreverá sua infraestrutura como código no TypeScript e precisará do Node.js 8 ou posterior. <a href="https://nodejs.org/en/download/">Faça o download aqui</a> ou instale-o <a href="https://nodejs.org/en/download/package-manager/">usando o gerenciador de pacotes do seu sistema</a>.</li>
<li>Você usará o Pulumi para fazer o deploy da infraestrutura, por isso precisará <a href="https://www.pulumi.com/docs/reference/install/">instalar o SDK do Pulumi open source</a>.</li>
<li>Para executar o Passo 5 opcional, você precisará de um nome de domínio configurado para usar os servidores de nomes da DigitalOcean. <a href="https://www.digitalocean.com/community/tutorials/how-to-point-to-digitalocean-nameservers-from-common-domain-registrars">Este guia</a> explica como fazer isso para o registrador de sua escolha.</li>
</ul>

<h2 id="passo-1-—-estruturando-um-novo-projeto">Passo 1 — Estruturando um Novo Projeto</h2>

<p>O primeiro passo é criar um diretório que irá armazenar seu projeto Pulumi. Esse diretório conterá o código-fonte para suas definições de infraestrutura, além dos arquivos de metadados que descrevem o projeto e suas dependências NPM.</p>

<p>Primeiro, crie o diretório:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">mkdir do-k8s
</li></ul></code></pre>
<p>Em seguida, vá para o diretório recém-criado:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">cd do-k8s
</li></ul></code></pre>
<p>A partir de agora, execute comandos a partir do seu diretório <code>do-k8s</code> recém-criado.</p>

<p>Em seguida, crie um novo projeto Pulumi. Existem diferentes maneiras de fazer isso, mas a maneira mais fácil é usar o comando <code>pulumi new</code> com o modelo de projeto <code>typescript</code>. Este comando primeiro solicitará que você efetue login no Pulumi para que seu projeto e o estado do deployment sejam salvos e, em seguida, criará um projeto TypeScript simples no diretório atual:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">pulumi new typescript -y
</li></ul></code></pre>
<p>Aqui você passou a opção <code>-y</code> para o comando <code>new</code>, que diz a ele para aceitar as opções padrão do projeto. Por exemplo, o nome do projeto é retirado do nome do diretório atual e, portanto, será <code>do-k8s</code>. Se você quiser usar opções diferentes para o nome do seu projeto, simplesmente elimine o <code>-y</code>.</p>

<p>Após executar o comando, liste o conteúdo do diretório com <code>ls</code>:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">ls
</li></ul></code></pre>
<p>Os seguintes arquivos estarão agora presentes:</p>
<pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>Pulumi.yaml       index.ts          node_modules
package-lock.json package.json      tsconfig.json
</code></pre>
<p>O arquivo principal que você estará editando é <strong><code>index.ts</code></strong>. Embora este tutorial use apenas esse arquivo único, você pode organizar seu projeto da maneira que achar melhor usando os módulos Node.js. Este tutorial também descreve uma etapa de cada vez, aproveitando o fato de que o Pulumi pode detectar e <em>deployar</em> de forma incremental apenas o que mudou. Se preferir, você pode simplesmente preencher o programa inteiro e fazer o deploy de uma só vez usando o <code>pulumi up</code>.</p>

<p>Agora que você estruturou seu novo projeto, está pronto para adicionar as dependências necessárias para seguir o tutorial.</p>

<h2 id="passo-2-—-adicionando-dependências">Passo 2 — Adicionando Dependências</h2>

<p>O próximo passo é instalar e adicionar dependências nos pacotes DigitalOcean e Kubernetes. Primeiro, instale-os usando o NPM:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">npm install <a href="https://www.digitalocean.com/community/users/pulumi" class="username-tag">@pulumi</a>/digitalocean <a href="https://www.digitalocean.com/community/users/pulumi" class="username-tag">@pulumi</a>/kubernetes
</li></ul></code></pre>
<p>Isso fará o download dos pacotes NPM, plug-ins do Pulumi e os salvará como dependências.</p>

<p>Em seguida, abra o arquivo <code>index.ts</code> com seu editor favorito. Este tutorial usará o nano:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">nano index.ts
</li></ul></code></pre>
<p>Substitua o conteúdo do seu <code>index.ts</code> pelo seguinte:</p>
<div class="code-label " title="index.ts">index.ts</div><pre class="code-pre "><code class="code-highlight language-typescript">import * as digitalocean from "@pulumi/digitalocean";
import * as kubernetes from "@pulumi/kubernetes";
</code></pre>
<p>Isso disponibiliza todo o conteúdo desses pacotes para o seu programa. Se você digitar <code>"digitalocean."</code> usando um IDE que entenda TypeScript e Node.js, você deverá ver uma lista dos recursos da DigitalOcean suportados por este pacote, por exemplo.</p>

<p>Salve e feche o arquivo após adicionar o conteúdo.</p>

<p><span class='note'><strong>Nota:</strong> Usaremos um subconjunto do que está disponível nesses pacotes. Para obter a documentação completa dos recursos, propriedades e APIs associadas, consulte a documentação relevante da API para os pacotes <a href="https://www.pulumi.com/docs/reference/pkg/nodejs/pulumi/digitalocean/"><code>@pulumi/digitalocean</code></a> e <a href="https://www.pulumi.com/docs/reference/pkg/nodejs/pulumi/kubernetes/"><code>@pulumi/kubernetes</code></a>.<br></span></p>

<p>Em seguida, você configurará seu token DigitalOcean para que o Pulumi possa provisionar recursos em sua conta:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">pulumi config set digitalocean:token <span class="highlight">SEU_TOKEN_AQUI</span> --secret
</li></ul></code></pre>
<p>Observe a flag <code>--secret</code>, que usa o serviço de criptografia do Pulumi para criptografar seu token, garantindo que ele seja armazenado em texto cifrado. Se preferir, você pode usar a variável de ambiente <code>DIGITALOCEAN_TOKEN</code>, mas você vai precisar lembrar-se de defini-la sempre que atualizar seu programa, enquanto o uso da configuração armazena e o utiliza automaticamente para o seu projeto.</p>

<p>Nesta etapa, você adicionou as dependências necessárias e configurou seu token de API com o Pulumi para poder provisionar seu cluster Kubernetes.</p>

<h2 id="passo-3-—-provisionando-um-cluster-kubernetes">Passo 3 — Provisionando um Cluster Kubernetes</h2>

<p>Agora você está pronto para criar um cluster Kubernetes na DigitalOcean. Comece reabrindo o arquivo <code>index.ts</code>:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">nano index.ts
</li></ul></code></pre>
<p>Adicione estas linhas no final do seu arquivo <code>index.ts</code>:</p>
<div class="code-label " title="index.ts">index.ts</div><pre class="code-pre "><code class="code-highlight language-typescript">...
const cluster = new digitalocean.KubernetesCluster("do-cluster", {
    region: digitalocean.Regions.SFO2,
    version: "latest",
    nodePool: {
        name: "default",
        size: digitalocean.DropletSlugs.DropletS2VPCU2GB,
        nodeCount: 3,
    },
});

export const kubeconfig = cluster.kubeConfigs[0].rawConfig;
</code></pre>
<p>Este novo código aloca uma instância do <code>digitalocean.KubernetesCluster</code> e define várias propriedades nele. Isso inclui o uso da <code>sfo2</code> como <a href="https://www.digitalocean.com/docs/platform/availability-matrix/">slug da região</a>, a versão mais recente, <code>latest</code>, do Kubernetes, o <code>s-2vcpu-2gb</code> <a href="https://developers.digitalocean.com/documentation/changelog/api-v2/new-size-slugs-for-droplet-plan-changes/">slug de tamanho do Droplet</a>, e indica a contagem desejada de três instâncias do Droplet. Sinta-se à vontade para alterar qualquer uma dessas opções, mas lembre-se de que o Kubernetes da DigitalOcean está disponível apenas em determinadas regiões no momento em que este artigo foi escrito. Você pode consultar a <a href="https://www.digitalocean.com/docs/kubernetes/overview/">documentação do produto</a> para obter informações atualizadas sobre a disponibilidade da região.</p>

<p>Para obter uma lista completa das propriedades que você pode configurar no seu cluster, consulte a <a href="https://www.pulumi.com/docs/reference/pkg/nodejs/pulumi/digitalocean/#KubernetesCluster">documentação da API do <code>KubernetesCluster</code></a>.</p>

<p>A linha final nesse trecho de código exporta o <a href="https://kubernetes.io/docs/concepts/configuration/organize-cluster-access-kubeconfig/">aqruivo <code>kubeconfig</code></a> resultante do cluster Kubernetes para que seja fácil de usar. As variáveis exportadas são impressas no console e também acessíveis às ferramentas. Você usará isso momentaneamente para acessar nosso cluster a partir de ferramentas padrão como o <code>kubectl</code>.</p>

<p>Agora você está pronto para implantar seu cluster. Para fazer isso, execute <code>pulumi up</code>:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">pulumi up
</li></ul></code></pre>
<p>Este comando pega o programa, gera um plano para criar a infraestrutura descrita e executa uma série de etapas para <em>deployar</em> essas alterações. Isso funciona para a criação inicial da infraestrutura, além de poder diferenciar e atualizar sua infraestrutura quando as atualizações subsequentes são feitas. Nesse caso, a saída será mais ou menos assim:</p>
<pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>Previewing update (dev):

     Type                                     Name        Plan
 +   pulumi:pulumi:Stack                      do-k8s-dev  create
 +   └─ digitalocean:index:KubernetesCluster  do-cluster  create

Resources:
    + 2 to create

Do you want to perform this update?
  yes
&gt; no
  details
</code></pre>
<p>Isso indica que prosseguindo com a atualização será criado um único cluster Kubernetes chamado <code>do-cluster</code>. O prompt <code>yes/no/details</code> permite confirmar que este é o resultado desejado antes que quaisquer alterações sejam realmente feitas. Se você selecionar <code>details</code>, uma lista completa de recursos e suas propriedades serão mostrados. Escolha <code>yes</code> para iniciar o deployment:</p>
<pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>Updating (dev):

     Type                                     Name        Status
 +   pulumi:pulumi:Stack                      do-k8s-dev  created
 +   └─ digitalocean:index:KubernetesCluster  do-cluster  created

Outputs:
    kubeconfig: "..."

Resources:
    + 2 created

Duration: 6m5s

Permalink: https://app.pulumi.com/.../do-k8s/dev/updates/1
</code></pre>
<p>Leva alguns minutos para criar o cluster, mas depois ele estará em funcionamento e o <code>kubeconfig</code> completo será impresso no console. Salve o <code>kubeconfig</code> em um arquivo:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">pulumi stack output kubeconfig &gt; kubeconfig.yml
</li></ul></code></pre>
<p>E então use-o com o <code>kubectl</code> para executar qualquer comando do Kubernetes:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">KUBECONFIG=./kubeconfig.yml kubectl get nodes
</li></ul></code></pre>
<p>Você receberá uma saída semelhante à seguinte:</p>
<pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>NAME           STATUS    ROLES     AGE       VERSION
default-o4sj   Ready     &lt;none&gt;    4m5s      v1.14.2
default-o4so   Ready     &lt;none&gt;    4m3s      v1.14.2
default-o4sx   Ready     &lt;none&gt;    3m37s     v1.14.2
</code></pre>
<p>Nesse ponto, você configurou a infraestrutura como código e tem uma maneira repetível de ativar e configurar novos clusters Kubernetes na DigitalOcean . No próximo passo, você trabalhará em cima disso para definir a infraestrutura do Kubernetes no código e aprender como fazer o deploy e gerenciá-la da mesma forma.</p>

<h2 id="passo-4-—-fazendo-o-deploy-de-uma-aplicação-no-seu-cluster">Passo 4 — Fazendo o Deploy de uma Aplicação no seu Cluster</h2>

<p>A seguir, você descreverá a configuração de uma aplicação Kubernetes usando infraestrutura como código. Isso consistirá em três partes:</p>

<ol>
<li>Um objeto <code>Provider</code>, que diz ao Pulumi para <em>deployar</em> recursos do Kubernetes no cluster da DigitalOcean, em vez do padrão que qualquer <code>kubectl</code> esteja configurado para usar.</li>
<li>Um <a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/">Deployment de Kubernetes</a>, que é a maneira padrão do Kubernetes de <em>deployar</em> uma imagem de container Docker que é replicada em qualquer número de Pods.</li>
<li>Um <a href="https://kubernetes.io/docs/concepts/services-networking/service/">Serviço Kubernetes</a>, que é a maneira padrão para dizer ao Kubernetes para balancear o acesso entre um conjunto alvo de Pods (neste caso, o Deployment acima).</li>
</ol>

<p>Essa é uma <em>arquitetura de referência</em> razoavelmente padrão para iniciar e executar um serviço com balanceamento de carga no Kubernetes.</p>

<p>Para implantar todos os três, abra o arquivo <code>index.ts</code> novamente:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">nano index.ts
</li></ul></code></pre>
<p>Depois de abrir o arquivo, acrescente este código ao final dele:</p>
<div class="code-label " title="index.ts">index.ts</div><pre class="code-pre "><code class="code-highlight language-typescript">...
const provider = new kubernetes.Provider("do-k8s", { kubeconfig })

const appLabels = { "app": "app-nginx" };
const app = new kubernetes.apps.v1.Deployment("do-app-dep", {
    spec: {
        selector: { matchLabels: appLabels },
        replicas: 5,
        template: {
            metadata: { labels: appLabels },
            spec: {
                containers: [{
                    name: "nginx",
                    image: "nginx",
                }],
            },
        },
    },
}, { provider });
const appService = new kubernetes.core.v1.Service("do-app-svc", {
    spec: {
        type: "LoadBalancer",
        selector: app.spec.template.metadata.labels,
        ports: [{ port: 80 }],
    },
}, { provider });

export const ingressIp = appService.status.loadBalancer.ingress[0].ip;
</code></pre>
<p>Esse código é semelhante à configuração padrão do Kubernetes, e o comportamento dos objetos e suas propriedades é equivalente, exceto que ele está escrito em TypeScript ao lado de suas outras declarações de infraestrutura.</p>

<p>Salve e feche o arquivo depois de fazer as alterações.</p>

<p>Assim como antes, execute <code>pulumi up</code> para visualizar e <em>deployar</em> as alterações:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">pulumi up
</li></ul></code></pre>
<p>Depois de selecionar <code>yes</code> para prosseguir, a CLI imprimirá atualizações de status detalhadas, incluindo diagnósticos sobre disponibilidade de Pod, alocação de endereço IP e muito mais. Isso ajudará você a entender por que seu deployment pode levar algum tempo para ser concluído ou ficar travado.</p>

<p>A saída completa será mais ou menos assim:</p>
<pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>Updating (dev):

     Type                            Name        Status
     pulumi:pulumi:Stack             do-k8s-dev
 +   ├─ pulumi:providers:kubernetes  do-k8s      created
 +   ├─ kubernetes:apps:Deployment   do-app-dep  created
 +   └─ kubernetes:core:Service      do-app-svc  created

Outputs:
  + ingressIp : "157.230.199.202"

Resources:
    + 3 created
    2 unchanged

Duration: 2m52s

Permalink: https://app.pulumi.com/.../do-k8s/dev/updates/2
</code></pre>
<p>Após a conclusão, observe que o número desejado de Pods está em execução:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">KUBECONFIG=./kubeconfig.yml kubectl get pods
</li></ul></code></pre><pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>NAME                                   READY     STATUS    RESTARTS   AGE
do-app-dep-vyf8k78z-758486ff68-5z8hk   1/1       Running   0          1m
do-app-dep-vyf8k78z-758486ff68-8982s   1/1       Running   0          1m
do-app-dep-vyf8k78z-758486ff68-94k7b   1/1       Running   0          1m
do-app-dep-vyf8k78z-758486ff68-cqm4c   1/1       Running   0          1m
do-app-dep-vyf8k78z-758486ff68-lx2d7   1/1       Running   0          1m
</code></pre>
<p>Similar à maneira como o programa exporta o arquivo <code>kubeconfig</code> do cluster, este programa também exporta o endereço IP do balanceador de carga resultante do serviço Kubernetes. Use isto para fazer um <code>curl</code> no endpoint e verifique se ele está funcionando:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">curl $(pulumi stack output ingressIp)
</li></ul></code></pre><pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;title&gt;Welcome to nginx!&lt;/title&gt;
&lt;style&gt;
    body {
        width: 35em;
        margin: 0 auto;
        font-family: Tahoma, Verdana, Arial, sans-serif;
    }
&lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;
&lt;p&gt;If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.&lt;/p&gt;

&lt;p&gt;For online documentation and support please refer to
&lt;a href="http://nginx.org/"&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;
Commercial support is available at
&lt;a href="http://nginx.com/"&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<p>A partir daqui, você pode editar e <em>re-deployar</em> facilmente sua infraestrutura de aplicações. Por exemplo, tente alterar a linha <code>replicas: 5</code> para digamos <code>replicas: 7</code> e, em seguida, execute novamente <code>pulumi up</code>:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">pulumi up
</li></ul></code></pre>
<p>Observe que ele apenas mostra o que mudou e que ao selecionar detalhes, exibe a diferença precisa:</p>
<pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>Previewing update (dev):

     Type                           Name        Plan       Info
     pulumi:pulumi:Stack            do-k8s-dev
 ~   └─ kubernetes:apps:Deployment  do-app-dep  update     [diff: ~spec]

Resources:
    ~ 1 to update
    4 unchanged

Do you want to perform this update? details
  pulumi:pulumi:Stack: (same)
    [urn=urn:pulumi:dev::do-k8s::pulumi:pulumi:Stack::do-k8s-dev]
    ~ kubernetes:apps/v1:Deployment: (update)
        [id=default/do-app-dep-vyf8k78z]
        [urn=urn:pulumi:dev::do-k8s::kubernetes:apps/v1:Deployment::do-app-dep]
        [provider=urn:pulumi:dev::do-k8s::pulumi:providers:kubernetes::do-k8s::80f36105-337f-451f-a191-5835823df9be]
      ~ spec: {
          ~ replicas: 5 =&gt; 7
        }
</code></pre>
<p>Agora você tem um cluster Kubernetes em plena operação e uma aplicação em funcionamento. Com a aplicação em funcionamento, você pode querer configurar um domínio personalizado para usar com ela. O próximo passo o guiará na configuração do DNS com o Pulumi.</p>

<h2 id="passo-5-—-criando-um-domínio-dns-opcional">Passo 5 — Criando um Domínio DNS (Opcional)</h2>

<p>Embora o cluster e a aplicação Kubernetes estejam em funcionamento, o endereço da aplicação é dependente dos caprichos da atribuição automática de endereços IP pelo seu cluster. Conforme você ajusta e reimplementa as coisas, esse endereço pode mudar. Neste passo, você verá como atribuir um nome DNS personalizado ao endereço IP do balanceador de carga, para que fique estável, mesmo que você altere sua infraestrutura posteriormente.</p>

<p><span class='note'><strong>Nota:</strong> Para concluir este passo, garanta que você possui um domínio usando os servidores de nomes DNS da DigitalOcean, <code>ns1.digitalocean.com</code>, <code>ns2.digitalocean.com</code> e <code>ns3.digitalocean.com</code>. Instruções para configurar isso estão disponíveis na seção Pré-requisitos.<br></span></p>

<p>Para configurar o DNS, abra o arquivo <code>index.ts</code> e acrescente o seguinte código ao final do arquivo:</p>
<div class="code-label " title="index.ts">index.ts</div><pre class="code-pre plain"><code langs="">...
const domain = new digitalocean.Domain("do-domain", {
    name: "<span class="highlight">seu_domínio</span>",
    ipAddress: ingressIp,
});
</code></pre>
<p>Este código cria uma nova entrada DNS com um registro A que se refere ao endereço IP do seu serviço Kubernetes. Substitua <code>seu_domínio</code> neste trecho pelo nome de domínio escolhido.</p>

<p>É comum querer subdomínios adicionais, como <code>www</code>, apontando para a aplicação web. É fácil conseguir isso usando um registro DNS da DigitalOcean. Para tornar este exemplo mais interessante, adicione também um registro <code>CNAME</code> que aponte <code>www.<span class="highlight">seu_domínio</span>.com</code> para <code><span class="highlight">seu_domínio</span>.com</code>:</p>
<div class="code-label " title="index.ts">index.ts</div><pre class="code-pre "><code class="code-highlight language-typescript">...
const cnameRecord = new digitalocean.DnsRecord("do-domain-cname", {
    domain: domain.name,
    type: "CNAME",
    name: "www",
    value: "@",
});
</code></pre>
<p>Salve e feche o arquivo depois de fazer essas alterações.</p>

<p>Por fim, execute <code>pulumi up</code> para fazer o deploy das alterações no DNS para apontar para a aplicação e o cluster existentes:</p>
<pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>Updating (dev):

     Type                             Name             Status
     pulumi:pulumi:Stack              do-k8s-dev
 +   ├─ digitalocean:index:Domain     do-domain        created
 +   └─ digitalocean:index:DnsRecord  do-domain-cname  created

Resources:
    + 2 created
    5 unchanged

Duration: 6s

Permalink: https://app.pulumi.com/.../do-k8s/dev/updates/3
</code></pre>
<p>Após a propagação das alterações no DNS, você poderá acessar seu conteúdo em seu domínio personalizado:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">curl www.<span class="highlight">seu_domínio</span>.com
</li></ul></code></pre>
<p>Você receberá uma saída semelhante à seguinte:</p>
<pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;title&gt;Welcome to nginx!&lt;/title&gt;
&lt;style&gt;
    body {
        width: 35em;
        margin: 0 auto;
        font-family: Tahoma, Verdana, Arial, sans-serif;
    }
&lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;
&lt;p&gt;If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.&lt;/p&gt;

&lt;p&gt;For online documentation and support please refer to
&lt;a href="http://nginx.org/"&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;
Commercial support is available at
&lt;a href="http://nginx.com/"&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<p>Com isso, você configurou com êxito um novo cluster Kubernetes na DigitalOcean, fez o deploy de uma aplicação Kubernetes com balanceamento de carga e deu ao balanceador de carga dessa aplicação um nome de domínio estável usando o DNS da DigitalOcean, tudo em 60 linhas de código e um comando <code>pulumi up</code> .</p>

<p>A próximo passo o guiará na remoção dos recursos, se você não precisar mais deles.</p>

<h2 id="passo-6-—-removendo-os-recursos-opcional">Passo 6 — Removendo os Recursos (Opcional)</h2>

<p>Antes de concluir o tutorial, você pode querer destruir todos os recursos criados acima. Isso garantirá que você não seja cobrado pelos recursos que não estão sendo usados. Se você preferir manter sua aplicação em funcionamento, fique à vontade para pular esta etapa.</p>

<p>Execute o seguinte comando para destruir os recursos. Cuidado ao usar isso, pois não pode ser desfeito!</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">pulumi destroy
</li></ul></code></pre>
<p>Assim como no comando <code>up</code>, <code>destroy</code> exibe uma visualização e um prompt antes de executar uma ação:</p>
<pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>Previewing destroy (dev):

     Type                                     Name             Plan
 -   pulumi:pulumi:Stack                      do-k8s-dev       delete
 -   ├─ digitalocean:index:DnsRecord          do-domain-cname  delete
 -   ├─ digitalocean:index:Domain             do-domain        delete
 -   ├─ kubernetes:core:Service               do-app-svc       delete
 -   ├─ kubernetes:apps:Deployment            do-app-dep       delete
 -   ├─ pulumi:providers:kubernetes           do-k8s           delete
 -   └─ digitalocean:index:KubernetesCluster  do-cluster       delete

Resources:
    - 7 to delete

Do you want to perform this destroy?
  yes
&gt; no
  details
</code></pre>
<p>Supondo que é isso que você deseja, selecione <code>yes</code> e observe as exclusões:</p>
<pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>Destroying (dev):

     Type                                     Name             Status
 -   pulumi:pulumi:Stack                      do-k8s-dev       deleted
 -   ├─ digitalocean:index:DnsRecord          do-domain-cname  deleted
 -   ├─ digitalocean:index:Domain             do-domain        deleted
 -   ├─ kubernetes:core:Service               do-app-svc       deleted
 -   ├─ kubernetes:apps:Deployment            do-app-dep       deleted
 -   ├─ pulumi:providers:kubernetes           do-k8s           deleted
 -   └─ digitalocean:index:KubernetesCluster  do-cluster       deleted

Resources:
    - 7 deleted

Duration: 7s

Permalink: https://app.pulumi.com/.../do-k8s/dev/updates/4
</code></pre>
<p>Nesse momento, nada mais resta: as entradas de DNS desaparecem e o cluster Kubernetes — juntamente com a aplicação em execução nele — também desaparece. O link permanente, permalink, ainda está disponível, para que você possa voltar e ver o histórico completo de atualizações para essa pilha. Isso pode ajudá-lo a se recuperar se a destruição for um erro, uma vez que o serviço mantém um histórico completo do estado de todos os recursos.</p>

<p>Se você gostaria de destruir o seu projeto na sua totalidade, remova a pilha:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">pulumi stack rm
</li></ul></code></pre>
<p>Você receberá uma saída pedindo para confirmar a exclusão digitando o nome da pilha:</p>
<pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>This will permanently remove the 'dev' stack!
Please confirm that this is what you'd like to do by typing ("dev"):
</code></pre>
<p>Ao contrário do comando destroy, que exclui os recursos de infraestrutura em nuvem, a remoção de uma pilha apaga totalmente o histórico completo da sua pilha do alcance do Pulumi.</p>

<h2 id="conclusão">Conclusão</h2>

<p>Neste tutorial, você fez o deploy dos recursos de infraestrutura na DigitalOcean — um cluster Kubernetes e um domínio DNS com registros A e CNAME — além da configuração da aplicação Kubernetes que usa esse cluster. Você fez isso usando infraestrutura como código escrita em uma linguagem de programação familiar, TypeScript, que trabalha com editores, ferramentas e bibliotecas existentes e aproveita as comunidades e pacotes existentes. Você fez tudo isso usando um único fluxo de trabalho de linha de comando para realizar deployments que abrangem sua aplicação e a infraestrutura.</p>

<p>A partir daqui, há uma série de próximos passos que você pode dar:</p>

<ul>
<li><a href="https://www.pulumi.com/docs/reference/pkg/nodejs/pulumi/digitalocean/">Explore o conjunto completo de recursos da DigitalOcean suportados pela Pulumi.</a></li>
<li><a href="https://www.pulumi.com/docs/reference/clouds/kubernetes/">Explore o suporte do Pulumi às aplicações Kubernetes, incluindo arquiteturas comuns.</a></li>
<li><a href="https://www.pulumi.com/docs/reference/cd/">Dispare deployments automaticamente com integrações de fluxo de trabalho de CI/CD e Git.</a></li>
<li><a href="https://www.pulumi.com/docs/reference/config/">Torne configuráveis certos elementos do seu programa</a> como o <a href="https://github.com/do-community/pulumi-kubernetes">exemplo faz</a>, para <a href="https://www.pulumi.com/docs/reference/organizing-stacks-projects/">facilitar projetos maiores e abordagens com várias pilhas</a> (como dev, test, staging, production).</li>
</ul>

<p>O exemplo completo deste tutorial está <a href="https://github.com/do-community/pulumi-kubernetes">disponível no GitHub</a>. Para obter maiores detalhes sobre como usar a infraestrutura como código do Pulumi em seus próprios projetos hoje, consulte a <a href="https://www.pulumi.com/docs">Documentação do Pulumi</a>, <a href="https://www.pulumi.com/docs/reference/tutorials">Tutorials</a>, ou os guias <a href="https://www.pulumi.com/docs/quickstart">Getting Started</a>. O Pulumi é open source e é livre para usar.</p>
