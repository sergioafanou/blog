---
layout: post
title: Настройка приложения Node.js для работы в среде Ubuntu 18.04
network: digitalocean
date: January 07, 2020 at 07:56PM
url: https://www.digitalocean.com/community/tutorials/how-to-set-up-a-node-js-application-for-production-on-ubuntu-18-04-ru
image: http://ifttt.com/images/no_image_card.png
tags: docker
feedtitle: DigitalOcean Community Tutorials
feedurl: https://www.digitalocean.com/community/tutorials
author: DigitalOcean
---
<h3 id="Введение">Введение</h3>

<p><a href="https://nodejs.org/en/">Node.js</a> — среда исполнения JavaScript с открытым исходным кодом, предназначенная для построения серверных и сетевых приложений. Данная платформа работает в операционных системах Linux, macOS, FreeBSD и Windows. Хотя вы можете запускать приложения Node.js через командную строку, этот обучающий модуль посвящен их запуску в качестве службы. Это означает, что они будут перезапускаться при перезагрузке системы или неисправности, и что их можно безопасно использовать в производственной среде.</p>

<p>В этом обучающем модуле вы научитесь создавать готовую производственную среду Node.js на одном сервере Ubuntu 18.04. Этот сервер будет выполнять приложение Node.js под управлением <a href="http://pm2.keymetrics.io/">PM2</a> и предоставлять пользователям безопасный доступ к приложению через обратный прокси-сервер Nginx. Сервер Nginx обеспечивает поддержку HTTPS с использованием бесплатного сертификата от <a href="https://letsencrypt.org/">Let&rsquo;s Encrypt</a>.</p>

<h2 id="Предварительные-требования">Предварительные требования</h2>

<p>Этот обучающий модуль предполагает, что у вас имеется следующее:</p>

<ul>
<li>Сервер Ubuntu 18.04, настроенный в соответствии с указаниями обучающего модуля <a href="https://www.digitalocean.com/community/tutorials/initial-server-setup-with-ubuntu-18-04">Начальная настройка сервера Ubuntu 18.04</a>. В системе должен быть задан пользователь без привилегий root с привилегиями sudo, а также должен быть включен брандмауэр.</li>
<li><a href="https://www.digitalocean.com/docs/networking/dns/quickstart/">Доменное имя, указывающее на публичный IP-адрес вашего сервера</a>. В этом обучающем модуле мы будем использовать доменное имя <strong>example.com</strong>.</li>
<li>Веб-сервер Nginx, установленный в соответствии с указаниями обучающего модуля <a href="https://www.digitalocean.com/community/tutorials/how-to-install-nginx-on-ubuntu-18-04">Установка Nginx в Ubuntu 18.04</a>.</li>
<li>Конфигурация Nginx с SSL с использованием сертификатом Let&rsquo;s Encrypt. <a href="https://www.digitalocean.com/community/tutorials/how-to-secure-nginx-with-let-s-encrypt-on-ubuntu-18-04">Защита веб-сервера Nginx сертификатом Let&rsquo;s Encrypt в Ubuntu 18.04</a> поможет вам выполнить необходимые настройки.</li>
</ul>

<p>Если предварительные требования выполнены, у вас должен быть сервер, обслуживающий используемую по умолчанию страницу назначения вашего домена по адресу <code>https://<span class="highlight">example.com</span>/</code>.</p>

<h2 id="Шаг-1-—-Установка-node-js">Шаг 1 — Установка Node.js</h2>

<p>Для начала мы установим самый быстрый выпуск LTS Node.js, используя архивы пакетов <a href="https://github.com/nodesource/distributions">NodeSource</a>.</p>

<p>Вначале мы установим NodeSource PPA, чтобы получить доступ к его содержимому. Перейдите в каталог home и используйте <code>curl</code> для получения скрипта установки архивов Node.js 8.x:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">cd ~
</li><li class="line" prefix="$">curl -sL https://deb.nodesource.com/setup_8.x -o nodesource_setup.sh
</li></ul></code></pre>
<p>Вы можете просмотреть содержимое скрипта с помощью <code>nano</code> или предпочитаемого текстового редактора:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">nano nodesource_setup.sh
</li></ul></code></pre>
<p>Завершив проверку скрипта, запустите его от имени пользователя <code>sudo</code>:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo bash nodesource_setup.sh
</li></ul></code></pre>
<p>Архив PPA будет добавлен в вашу конфигурацию и кэш локальных пакетов автоматически обновится. После запуска скрипта установки Nodesource вы можете установить пакет Node.js:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo apt install nodejs
</li></ul></code></pre>
<p>Чтобы проверить номер версии Node.js, установленной на начальном шаге, введите:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">nodejs -v
</li></ul></code></pre><pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>v8.11.3
</code></pre>
<p><span class='note'><strong>Примечание.</strong> При установке из NodeSource PPA исполняемый файл Node.js имеет имя <code>nodejs</code>, а не <code>node</code>.<br></span></p>

<p>Пакет <code>nodejs</code> содержит двоичный файл <code>nodejs</code>, а также диспетчер пакетов <a href="https://www.npmjs.com/"><code>npm</code></a> для модулей Node, так что отдельно устанавливать <code>npm</code> не нужно.</p>

<p><code>npm</code> использует файл конфигурации в домашнем каталоге, чтобы отслеживать обновления. Он создается при первом запуске <code>npm</code>. Выполните следующую команду, чтобы проверить установку <code>npm</code> и создать файл конфигурации:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">npm -v
</li></ul></code></pre><pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>5.6.0
</code></pre>
<p>Для работы некоторых пакетов <code>npm</code> (например, требующих компиляцию кода из источника) потребуется установить пакет <code>build-essential</code>:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo apt install build-essential
</li></ul></code></pre>
<p>Теперь у вас есть необходимые инструменты для работы с пакетами <code>npm</code>, которые требуют компиляции кода из источника.</p>

<p>Установив исполняемый модуль Node.js, мы можем перейти к написанию приложения Node.js.</p>

<h2 id="Шаг-2-—-Создание-приложения-node-js">Шаг 2 — Создание приложения Node.js</h2>

<p>Напишем приложение <em>Hello World</em>, возвращающее «Hello World» в ответ на любые запросы HTTP. Этот образец приложения поможет вам выполнить настройку Node.js. Вы можете заменить его собственным приложением, но при этом обязательно измените приложение для прослушивания подходящих IP-адресов и портов.</p>

<p>Вначале создадим образец приложения под именем <code>hello.js</code>:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">cd ~
</li><li class="line" prefix="$">nano hello.js
</li></ul></code></pre>
<p>Вставьте в файл следующий код:</p>
<div class="code-label " title="~/hello.js">~/hello.js</div><pre class="code-pre "><code class="code-highlight language-js">const http = require('http');

const hostname = 'localhost';
const port = 3000;

const server = http.createServer((req, res) =&gt; {
  res.statusCode = 200;
  res.setHeader('Content-Type', 'text/plain');
  res.end('Hello World!\n');
});

server.listen(port, hostname, () =&gt; {
  console.log(`Server running at http://${hostname}:${port}/`);
});
</code></pre>
<p>Сохраните файл и выйдите из редактора.</p>

<p>Это приложение Node.js прослушивает заданный адрес (<code>localhost</code>) и порт (<code>3000</code>) и возвращает текст «Hello World!» с кодом успешного выполнения a <code>200</code> HTTP. Поскольку мы прослушиваем <code>localhost</code>, удаленные клиенты не смогут подключиться к нашему приложению.</p>

<p>Чтобы протестировать приложение, введите:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">node hello.js
</li></ul></code></pre>
<p>Результат будет выглядеть следующим образом:</p>
<pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>Server running at http://localhost:3000/
</code></pre>
<p><span class='note'><strong>Примечание.</strong> Такой способ запуска приложения Node.js блокирует дополнительные команды, пока приложение не будет закрыто нажатием <code>CTRL+C</code>.<br></span></p>

<p>Чтобы протестировать приложение, откройте на сервере другой сеанс терминала и подключитесь к <code>localhost</code> с помощью команды <code>curl</code>:</p>
<pre class="code-pre command second-environment"><code langs=""><ul class="prefixed"><li class="line" prefix="$">curl http://localhost:<span class="highlight">3000</span>
</li></ul></code></pre>
<p>Если вы увидите следующий результат, приложение работает нормально и прослушивает правильные адрес и порт:</p>
<pre class="code-pre  second-environment"><code langs=""><div class="secondary-code-label " title="Output">Output</div>Hello World!
</code></pre>
<p>Если вы не видите ожидаемого результата, убедитесь, что ваше приложение Node.js запущено и настроено для прослушивание правильных адреса и порта.</p>

<p>Убедившись, что приложение работает, остановите его (если еще не сделали этого) нажатием <code>CTRL+C</code>.</p>

<h2 id="Шаг-3-—-Установка-pm2">Шаг 3 — Установка PM2</h2>

<p>Теперь установим диспетчер процессов PM2, предназначенный для приложений Node.js. PM2 позволяет преобразовывать приложения в демонов, чтобы они работали как службы в фоновом режиме.</p>

<p>Используйте <code>npm</code> для установки последней версии PM2 на своем сервере:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo npm install pm2@latest -g
</li></ul></code></pre>
<p>Опция <code>-g</code> указывает <code>npm</code> выполнить глобальную установку модуля, чтобы он был доступен <em>в масштабе всей системы</em>.</p>

<p>Вначале используем команду <code>pm2</code> для запуска вашего приложения <code>hello.js</code> в фоновом режиме:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">pm2 start <span class="highlight">hello.js</span>
</li></ul></code></pre>
<p>Также она добавит ваше приложение в список процессов PM2, которы йвыводится при каждом запуске приложения:</p>
<pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>[PM2] Spawning PM2 daemon with pm2_home=/home/sammy/.pm2
[PM2] PM2 Successfully daemonized
[PM2] Starting /home/sammy/hello.js in fork_mode (1 instance)
[PM2] Done.
┌──────────┬────┬──────┬──────┬────────┬─────────┬────────┬─────┬───────────┬───────┬──────────┐
│ App name │ id │ mode │ pid  │ status │ restart │ uptime │ cpu │ mem       │ user  │ watching │
├──────────┼────┼──────┼──────┼────────┼─────────┼────────┼─────┼───────────┼───────┼──────────┤
│ <span class="highlight">hello</span>    │ 0  │ fork │ 1338 │ online │ 0       │ 0s     │ 0%  │ 23.0 MB   │ sammy │ disabled │
└──────────┴────┴──────┴──────┴────────┴─────────┴────────┴─────┴───────────┴───────┴──────────┘
 Use `pm2 show &lt;id|name&gt;` to get more details about an app
</code></pre>
<p>Как видите, PM2 автоматически назначает <code>App name</code> (по имени файла, без расширения <code>.js</code> и идентификатор PM2 <code>id</code>. PM2 также обслуживает и другие данные, в том числе <code>PID</code> процесса, данные о текущем состоянии и использовании памяти.</p>

<p>Приложения, запускаемые через PM2, автоматически перезапускаются в случае сбоя или прекращения работы приложения, но мы можем выполнить дополнительный шаг, чтобы запускать приложение при запуске системы с помощью субкоманды <code>startup</code>. Эта субкоманда генерирует и настраивает скрипт запуска PM2 и управляемых им процессов при загрузке сервера:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">pm2 startup systemd
</li></ul></code></pre>
<p>Последняя строка результатов содержит команду, которую нужно запустить с привилегиями суперпользователя для настройки запуска PM2 при загрузке:</p>
<pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>[PM2] Init System found: systemd
[PM2] To setup the Startup Script, copy/paste the following command:
<span class="highlight">sudo env PATH=$PATH:/usr/bin /usr/lib/node_modules/pm2/bin/pm2 startup systemd -u sammy --hp /home/sammy</span>
</code></pre>
<p>Запустите команду из результатов, указав свое имя пользователя вместо <code><span class="highlight">sammy</span></code>:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo env PATH=$PATH:/usr/bin /usr/lib/node_modules/pm2/bin/pm2 startup systemd -u <span class="highlight">sammy</span> --hp /home/<span class="highlight">sammy</span>
</li></ul></code></pre>
<p>Дополнительно мы можем сохранить список процессов PM2 и соответствующие среды:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">pm2 save
</li></ul></code></pre>
<p>Теперь вы создали <em>блок</em> systemd, который запускает <code>pm2</code> для вашего пользователя при загрузке. Этот экземпляр <code>pm2</code> запускает <code>hello.js</code>.</p>

<p>Запустите службу с помощью команды <code>systemctl</code>:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo systemctl start pm2-<span class="highlight">sammy</span>
</li></ul></code></pre>
<p>Проверьте состояние блока systemd:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">systemctl status pm2-<span class="highlight">sammy</span>
</li></ul></code></pre>
<p>Подробный обзор systemd можно найти в документе <a href="https://www.digitalocean.com/community/tutorials/systemd-essentials-working-with-services-units-and-the-journal">«Основы работы с Systemd: работа со службами, блоками и журналом»</a>.</p>

<p>В дополнение к уже описанным субкомандам PM2 предоставляет много субкоманд, позволяющих управлять информацией о ваших приложениях и искать такую информацию.</p>

<p>Остановите приложение с помощью этой команды (укажите <code>имя приложения</code> PM2 или <code>id</code>):</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">pm2 stop <span class="highlight">app_name_or_id</span>
</li></ul></code></pre>
<p>Перезапустите приложение:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">pm2 restart <span class="highlight">app_name_or_id</span>
</li></ul></code></pre>
<p>Выведем список приложений, управление которыми осуществляет PM2:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">pm2 list
</li></ul></code></pre>
<p>Получим информацию об определенном приложении по <code>App name</code>:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">pm2 info <span class="highlight">app_name</span>
</li></ul></code></pre>
<p>Монитор процесса PM2 запускается с помощью субкоманды <code>monit</code>. При этом отображается состояние приложение, использование ресурсов ЦП и использование памяти:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">pm2 monit
</li></ul></code></pre>
<p>При запуске команды <code>pm2</code> без аргументов отображается страница справки с примерами использования.</p>

<p>Теперь ваше приложение Node.js запущено и управляется PM2, и мы можем настроить обратный прокси-сервер.</p>

<h2 id="Шаг-4-—-Настройка-nginx-в-качестве-обратного-прокси-сервера">Шаг 4 — Настройка Nginx в качестве обратного прокси-сервера</h2>

<p>Ваше приложение запущено и прослушивает <code>localhost</code>, но вам нужно дать пользователям возможность доступа к нему. Для этой цели мы настроим веб-сервер Nginx в качестве обратного прокси-сервера.</p>

<p>В предварительных обучающих модулях вы настроили конфигурацию Nginx в файле <code>/etc/nginx/sites-available/<span class="highlight">example.com</span></code>. Откройте этот файл для редактирования:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo nano /etc/nginx/sites-available/<span class="highlight">example.com</span>
</li></ul></code></pre>
<p>В блоке <code>server</code> должен содержаться блок <code>location /</code>. Замените содержимое этого блока следующей конфигурацией. Если ваше приложение настроено для прослушивания другого порта, измените номер порта в выделенной части на подходящий:</p>
<div class="code-label " title="/etc/nginx/sites-available/example.com">/etc/nginx/sites-available/example.com</div><pre class="code-pre "><code langs="">server {
...
    location / {
        proxy_pass http://localhost:<span class="highlight">3000</span>;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
...
}
</code></pre>
<p>Так сервер настраивается для ответа на запросы root. Если наш сервер доступен по адресу <code><span class="highlight">example.com</span></code>, при попытке доступа к <code>https://<span class="highlight">example.com</span>/</code> через браузер будет отправлен запрос <code>hello.js</code> с прослушиванием порта <code>3000</code> хоста <code>localhost</code>.</p>

<p>Вы можете добавить в этот же серверный блок дополнительные блоки <code>location</code>, чтобы предоставить другим приложениям доступ к этому же серверу. Например, если вы используете другое приложение Node.js на порту <code>3001</code>, вы сможете добавить следующий блок location, чтобы разрешить доступ к нему через <code>https://<span class="highlight">example.com</span>/<span class="highlight">app2</span></code>:</p>
<div class="code-label " title="/etc/nginx/sites-available/example.com — Optional">/etc/nginx/sites-available/example.com — Optional</div><pre class="code-pre "><code langs="">server {
...
    location /<span class="highlight">app2</span> {
        proxy_pass http://localhost:<span class="highlight">3001</span>;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
...
}
</code></pre>
<p>Завершив добавление блоков location для ваших приложений, сохраните файл и закройте редактор.</p>

<p>Убедитесь в отсутствии ошибок синтаксиса с помощью следующей команды:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo nginx -t
</li></ul></code></pre>
<p>Перезапустите Nginx:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo systemctl restart nginx
</li></ul></code></pre>
<p>Если ваше приложение Node.js запущено и конфигурации вашего приложения и Nginx настроены правильно, вы должны иметь возможность доступа к вашему приложению через обратный прокси-сервер Nginx. Попробуйте открыть URL вашего сервера (публичный IP-адрес или доменное имя).</p>

<h2 id="Заключение">Заключение</h2>

<p>Поздравляем! Теперь у вас есть приложение Node.js, работающее за обратным прокси-сервером Nginx на сервере Ubuntu 18.04. Настройка обратного прокси-сервера достаточно гибкая, чтобы предоставить вашим пользователям доступ к другим приложениям или статическому веб-контенту, который вы хотите опубликовать.</p>
