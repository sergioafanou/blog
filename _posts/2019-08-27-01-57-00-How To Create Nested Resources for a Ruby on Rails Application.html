---
layout: post
title: How To Create Nested Resources for a Ruby on Rails Application
network: digitalocean
date: August 27, 2019 at 01:57AM
url: https://www.digitalocean.com/community/tutorials/how-to-create-nested-resources-for-a-ruby-on-rails-application
image: https://assets.digitalocean.com/articles/rails_nested_resource/shark_post_landing_2.png
tags: docker
feedtitle: DigitalOcean Community Tutorials
feedurl: https://www.digitalocean.com/community/tutorials
author: DigitalOcean
---
<h3 id="introduction">Introduction</h3>

<p><a href="https://rubyonrails.org/">Ruby on Rails</a> is a web application framework written in <a href="https://www.digitalocean.com/community/tags/ruby">Ruby</a> that offers developers an opinionated approach to application development. Working with Rails gives developers:</p>

<ul>
<li>Conventions for handling things like routing, stateful data, and asset management.</li>
<li>A firm grounding in the <a href="https://en.wikipedia.org/wiki/Model%E2%80%93view%E2%80%93controller"><em>model-view-controller</em></a> (MCV) architectural pattern, which separates an application&rsquo;s logic, located in models, from the presentation and routing of application information.</li>
</ul>

<p>As you add complexity to your Rails applications, you will likely work with multiple models, which represent your application&rsquo;s business logic and interface with your database. Adding related models means establishing meaningful relationships between them, which then affect how information gets relayed through your application&rsquo;s controllers, and how it is captured and presented back to users through views. </p>

<p>In this tutorial, you will build on an existing Rails application that offers users facts about sharks. This application already has a model for handling shark data, but you will add a nested resource for posts about individual sharks. This will allow users to build out a wider body of thoughts and opinions about individual sharks. </p>

<h2 id="prerequisites">Prerequisites</h2>

<p>To follow this tutorial, you will need:</p>

<ul>
<li>A local machine or development server running Ubuntu 18.04. Your development machine should have a non-root user with administrative privileges and a firewall configured with <code>ufw</code>. For instructions on how to set this up, see our <a href="https://www.digitalocean.com/community/tutorials/initial-server-setup-with-ubuntu-18-04">Initial Server Setup with Ubuntu 18.04</a> tutorial.</li>
<li><a href="https://nodejs.org">Node.js</a> and <a href="https://www.npmjs.com/">npm</a> installed on your local machine or development server. This tutorial uses Node.js version <span class="highlight">10.16.3</span> and npm version <span class="highlight">6.9.0</span>. For guidance on installing Node.js and npm on Ubuntu 18.04, follow the instructions in the &ldquo;Installing Using a PPA&rdquo; section of <a href="https://www.digitalocean.com/community/tutorials/how-to-install-node-js-on-ubuntu-18-04#installing-using-a-ppa">How To Install Node.js on Ubuntu 18.04</a>. </li>
<li>Ruby, <a href="https://github.com/rbenv/rbenv">rbenv</a>, and Rails installed on your local machine or development server, following Steps 1-4 in <a href="https://www.digitalocean.com/community/tutorials/how-to-install-ruby-on-rails-with-rbenv-on-ubuntu-18-04">How To Install Ruby on Rails with rbenv on Ubuntu 18.04</a>. This tutorial uses Ruby <span class="highlight">2.5.1</span>, rbenv <span class="highlight">1.1.2</span>, and Rails <span class="highlight">5.2.3</span>.</li>
<li>SQLite installed, and a basic shark information application created, following the directions in <a href="https://www.digitalocean.com/community/tutorials/how-to-build-a-ruby-on-rails-application">How To Build a Ruby on Rails Application</a>.</li>
</ul>

<h2 id="step-1-—-scaffolding-the-nested-model">Step 1 — Scaffolding the Nested Model</h2>

<p>Our application will take advantage of Active Record <a href="https://guides.rubyonrails.org/association_basics.html"><em>associations</em></a> to build out a relationship between <code>Shark</code> and <code>Post</code> models: posts will belong to particular sharks, and each shark can have multiple posts. Our <code>Shark</code> and <code>Post</code> models will therefore be related through <a href="https://guides.rubyonrails.org/association_basics.html#the-belongs-to-association"><code>belongs_to</code></a> and <a href="https://guides.rubyonrails.org/association_basics.html#the-has-many-association"><code>has_many</code></a> associations. </p>

<p>The first step to building out the application in this way will be to create a <code>Post</code> model and related resources. To do this, we can use the <code>rails generate scaffold</code> command, which will give us a model, a <a href="https://guides.rubyonrails.org/active_record_migrations.html">database migration</a> to alter the database schema, a controller, a full set of views to manage standard <a href="https://en.wikipedia.org/wiki/">Create, Read, Update, and Delete</a> (CRUD) operations, and templates for partials, helpers, and tests. We will need to modify these resources, but using the <code>scaffold</code> command will save us some time and energy since it generates a structure we can use as a starting point.</p>

<p>First, make sure that you are in the <code>sharkapp</code> directory for the Rails project that you created in the prerequisites:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">cd sharkapp
</li></ul></code></pre>
<p>Create your <code>Post</code> resources with the following command:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">rails generate scaffold Post body:text shark:references
</li></ul></code></pre>
<p>With <code>body:text</code>, we&rsquo;re telling Rails to include a <code>body</code> field in the <code>posts</code> database table — the table that maps to the <code>Post</code> model. We&rsquo;re also including the <code>:references</code> keyword, which sets up an association between the <code>Shark</code> and <code>Post</code> models. Specifically, this will ensure that a <a href="https://en.wikipedia.org/wiki/Foreign_key">foreign key</a> representing each shark entry in the <code>sharks</code> database is added to the <code>posts</code> database.</p>

<p>Once you have run the command, you will see output confirming the resources that Rails has generated for the application. Before moving on, you can check your database migration file to look at the relationship that now exists between your models and database tables. Use the following command to look at the contents of the file, making sure to substitute the timestamp on your own migration file for what&rsquo;s shown here:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">cat db/migrate/<span class="highlight">20190805132506</span>_create_posts.rb
</li></ul></code></pre>
<p>You will see the following output:</p>
<pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>class CreatePosts &lt; ActiveRecord::Migration[5.2]
  def change
    create_table :posts do |t|
      t.text :body
      <span class="highlight">t.references :shark, foreign_key: true</span>

      t.timestamps
    end
  end
end
</code></pre>
<p>As you can see, the table includes a column for a shark foreign key. This key will take the form of <code><span class="highlight">model_name</span>_id</code> — in our case, <code><span class="highlight">shark</span>_id</code>.</p>

<p>Rails has established the relationship between the models elsewhere as well. Take a look at the newly generated <code>Post</code> model with the following command:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">cat app/models/post.rb
</li></ul></code></pre><pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>class Post &lt; ApplicationRecord
  belongs_to :shark
end
</code></pre>
<p>The <code>belongs_to</code> association sets up a relationship between models in which a single instance of the declaring model belongs to a single instance of the named model. In the case of our application, this means that a single post belongs to a single shark.</p>

<p>In addition to setting this relationship, the <code>rails generate scaffold</code> command also created routes and views for posts, as it did for our shark resources in <a href="https://www.digitalocean.com/community/tutorials/how-to-build-a-ruby-on-rails-application#step-3-%E2%80%94-scaffolding-the-application">Step 3</a> of <a href="https://www.digitalocean.com/community/tutorials/how-to-build-a-ruby-on-rails-application">How To Build a Ruby on Rails Application</a>. </p>

<p>This is a useful start, but we will need to configure some additional routing and solidify the Active Record association for the <code>Shark</code> model in order for the relationship between our models and routes to work as desired.</p>

<h2 id="step-2-—-specifying-nested-routes-and-associations-for-the-parent-model">Step 2 — Specifying Nested Routes and Associations for the Parent Model</h2>

<p>Rails has already set the <code>belongs_to</code> association in our <code>Post</code> model, thanks to the <code>:references</code> keyword in the <code>rails generate scaffold</code> command, but in order for that relationship to function properly we will need to specify a <code>has_many</code> association in our <code>Shark</code> model as well. We will also need to make changes to the default routing that Rails gave us in order to make post resources the children of shark resources.</p>

<p>To add the <code>has_many</code> association to the <code>Shark</code> model, open <code>app/models/shark.rb</code> using <code>nano</code> or your favorite editor:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">nano app/models/shark.rb
</li></ul></code></pre>
<p>Add the following line to the file to establish the relationship between sharks and posts:</p>
<div class="code-label " title="~/sharkapp/app/models/shark.rb">~/sharkapp/app/models/shark.rb</div><pre class="code-pre "><code langs="">class Shark &lt; ApplicationRecord
  <span class="highlight">has_many :posts</span>
  validates :name, presence: true, uniqueness: true
  validates :facts, presence: true
end
</code></pre>
<p>One thing that is worth thinking about here is what happens to posts once a particular shark is deleted. We likely do not want the posts associated with a deleted shark persisting in the database. To ensure that any posts associated with a given shark are eliminated when that shark is deleted, we can include the <code>dependent</code> option with the association.</p>

<p>Add the following code to the file to ensure that the <code>destroy</code> action on a given shark deletes any associated posts:</p>
<div class="code-label " title="~/sharkapp/app/models/post.rb">~/sharkapp/app/models/post.rb</div><pre class="code-pre "><code langs="">class Shark &lt; ApplicationRecord
  has_many :posts <span class="highlight">, dependent: :destroy</span>
  validates :name, presence: true, uniqueness: true
  validates :facts, presence: true
end
</code></pre>
<p>Once you have finished making these changes, save and close the file. If you are using <code>nano</code>, you can do this by pressing <code>CTRL+X</code>, <code>Y</code>, then <code>ENTER</code>.</p>

<p>Next, open your <code>config/routes.rb</code> file to modify the relationship between your resourceful routes:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">nano config/routes.rb
</li></ul></code></pre>
<p>Currently, the file looks like this:</p>
<div class="code-label " title="~/sharkapp/config/routes.rb">~/sharkapp/config/routes.rb</div><pre class="code-pre "><code langs="">Rails.application.routes.draw do
  resources :posts 
  resources :sharks

  root 'sharks#index'
  # For details on the DSL available within this file, see http://guides.rubyonrails.org/routing.html
end
</code></pre>
<p>The current code establishes an independent relationship between our routes, when what we would like to express is a <a href="https://guides.rubyonrails.org/routing.html#nested-resources">dependent relationship</a> between sharks and their associated posts. </p>

<p>Let&rsquo;s update our route declaration to make <code>:sharks</code> the parent of <code>:posts</code>. Update the code in the file to look like the following:</p>
<div class="code-label " title="~/sharkapp/config/routes.rb">~/sharkapp/config/routes.rb</div><pre class="code-pre "><code langs="">Rails.application.routes.draw do
  resources <span class="highlight">:sharks do</span>
    resources <span class="highlight">:posts</span>
  <span class="highlight">end</span>
  root 'sharks#index'
  # For details on the DSL available within this file, see http://guides.rubyonrails.org/routing.html
end
</code></pre>
<p>Save and close the file when you are finished editing.</p>

<p>With these changes in place, you can move on to updating your <code>posts</code> controller.</p>

<h2 id="step-3-—-updating-the-posts-controller">Step 3 — Updating the Posts Controller</h2>

<p>The association between our models gives us methods that we can use to create new post instances associated with particular sharks. To use these methods, we will need to add them our posts controller.</p>

<p>Open the posts controller file:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">nano app/controllers/posts_controller.rb
</li></ul></code></pre>
<p>Currently, the file looks like this:</p>
<div class="code-label " title="~/sharkapp/controllers/posts_controller.rb">~/sharkapp/controllers/posts_controller.rb</div><pre class="code-pre "><code langs="">class PostsController &lt; ApplicationController
  before_action :set_post, only: [:show, :edit, :update, :destroy]

  # GET /posts
  # GET /posts.json
  def index
    @posts = Post.all
  end

  # GET /posts/1
  # GET /posts/1.json
  def show
  end

  # GET /posts/new
  def new
    @post = Post.new
  end

  # GET /posts/1/edit
  def edit
  end

  # POST /posts
  # POST /posts.json
  def create
    @post = Post.new(post_params)

    respond_to do |format|
      if @post.save
        format.html { redirect_to @post, notice: 'Post was successfully created.' }
        format.json { render :show, status: :created, location: @post }
      else
        format.html { render :new }
        format.json { render json: @post.errors, status: :unprocessable_entity }
      end
    end
  end

  # PATCH/PUT /posts/1
  # PATCH/PUT /posts/1.json
  def update
    respond_to do |format|
      if @post.update(post_params)
        format.html { redirect_to @post, notice: 'Post was successfully updated.' }
        format.json { render :show, status: :ok, location: @post }
      else
        format.html { render :edit }
        format.json { render json: @post.errors, status: :unprocessable_entity }
      end
    end
  end

  # DELETE /posts/1
  # DELETE /posts/1.json
  def destroy
    @post.destroy
    respond_to do |format|
      format.html { redirect_to posts_url, notice: 'Post was successfully destroyed.' }
      format.json { head :no_content }
    end
  end

  private
    # Use callbacks to share common setup or constraints between actions.
    def set_post
      @post = Post.find(params[:id])
    end

    # Never trust parameters from the scary internet, only allow the white list through.
    def post_params
      params.require(:post).permit(:body, :shark_id)
    end
end
</code></pre>
<p>Like our sharks controller, this controller&rsquo;s methods work with instances of the associated <code>Post</code> class. For example, the <code>new</code> method creates a new instance of the <code>Post</code> class, the <code>index</code> method grabs all instances of the class, and the <code>set_post</code> method uses <code>find</code> and <code>params</code> to select a particular post by <code>id</code>. If, however, we want our post instances to be associated with particular shark instances,  then we will need to modify this code, since the <code>Post</code> class is currently operating as an independent entity.</p>

<p>Our modifications will make use of two things:</p>

<ul>
<li>The methods that became available to us when we added the <code>belongs_to</code> and <code>has_many</code> associations to our models. Specifically, we now have access to the <a href="https://api.rubyonrails.org/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_many"><code>build</code> method</a> thanks to the <code>has_many</code> association we defined in our <code>Shark</code> model. This method will allow us to create a collection of post objects associated with a particular shark object, using the <code>shark_id</code> foreign key that exists in our <code>posts</code> database.</li>
<li>The routes and routing helpers that became available when we created a nested <code>posts</code> route. For a full list of example routes that become available when you create nested relationships between resources, see the <a href="https://guides.rubyonrails.org/routing.html#nested-resources">Rails documentation</a>. For now, it will be enough for us to know that for each specific shark — say <code>sharks/<span class="highlight">1</span></code> — there will be an associated route for posts related to that shark: <code>sharks/<span class="highlight">1</span>/posts</code>. There will also be routing helpers like <code>shark_posts_path(@shark)</code> and <code>edit_sharks_posts_path(@shark)</code> that refer to these nested routes.</li>
</ul>

<p>In the file, we&rsquo;ll begin by writing a method, <code>get_shark</code>, that will run before each action in the controller. This method will create a local <code>@shark</code> instance variable by finding a shark instance by <code>shark_id</code>. With this variable available to us in the file, it will be possible to relate posts to a specific shark in the other methods.</p>

<p>Above the other <code>private</code> methods at the bottom of the file, add the following method:</p>
<div class="code-label " title="~/sharkapp/controllers/posts_controller.rb">~/sharkapp/controllers/posts_controller.rb</div><pre class="code-pre "><code langs="">. . . 
private
  <span class="highlight">def get_shark</span>
    <span class="highlight">@shark = Shark.find(params[:shark_id])</span>
  <span class="highlight">end</span>
  # Use callbacks to share common setup or constraints between actions.
. . . 
</code></pre>
<p>Next, add the corresponding filter to the <strong>top</strong> of the file, before the existing filter:</p>
<div class="code-label " title="~/sharkapp/controllers/posts_controller.rb">~/sharkapp/controllers/posts_controller.rb</div><pre class="code-pre "><code langs="">class PostsController &lt; ApplicationController
  <span class="highlight">before_action :get_shark</span>
</code></pre>
<p>This will ensure that <code>get_shark</code> runs before each action defined in the file. </p>

<p>Next, you can use this <code>@shark</code> instance to rewrite the <code>index</code> method. Instead of grabbing all instances of the <code>Post</code> class, we want this method to return all post instances associated with a particular shark instance.</p>

<p>Modify the <code>index</code> method to look like this:</p>
<div class="code-label " title="~/sharkapp/controllers/posts_controller.rb">~/sharkapp/controllers/posts_controller.rb</div><pre class="code-pre "><code langs="">. . .
  def index
    <a href="https://www.digitalocean.com/community/users/posts" class="username-tag">@posts</a> = <span class="highlight">@shark.posts</span>
  end
. . .
</code></pre>
<p>The <code>new</code> method will need a similar revision, since we want a new post instance to be associated with a particular shark. To achieve this, we can make use of the <code>build</code> method, along with our local <code>@shark</code> instance variable. </p>

<p>Change the <code>new</code> method to look like this:</p>
<div class="code-label " title="~/sharkapp/controllers/posts_controller.rb">~/sharkapp/controllers/posts_controller.rb</div><pre class="code-pre "><code langs="">. . . 
  def new
    <a href="https://www.digitalocean.com/community/users/post" class="username-tag">@post</a> = <span class="highlight">@shark.posts.build</span>
  end
. . . 
</code></pre>
<p>This method creates a post object that&rsquo;s associated with the specific shark instance from the <code>get_shark</code> method.</p>

<p>Next, we&rsquo;ll address the method that&rsquo;s most closely tied to <code>new</code>: <code>create</code>. The <code>create</code> method does two things: it builds a new post instance using the parameters that users have entered into the <code>new</code> form, and, if there are no errors, it saves that instance and uses a route helper to redirect users to where they can see the new post. In the case of errors, it renders the <code>new</code> template again.</p>

<p>Update the <code>create</code> method to look like this:</p>
<div class="code-label " title="~/sharkapp/controllers/posts_controller.rb">~/sharkapp/controllers/posts_controller.rb</div><pre class="code-pre "><code langs="">  def create
    <a href="https://www.digitalocean.com/community/users/post" class="username-tag">@post</a> = <span class="highlight">@shark.posts.build</span>(post_params)

        respond_to do |format|
         if <a href="https://www.digitalocean.com/community/users/post-save" class="username-tag">@post.save</a>  
            format.html { redirect_to <span class="highlight">shark_posts_path(@shark)</span>, notice: 'Post was successfully created.' }
            format.json { render :show, status: :created, location: @post }
         else
            format.html { render :new }
            format.json { render json: @post.errors, status: :unprocessable_entity }
      end
    end
  end
</code></pre>
<p>Next, take a look at the <code>update</code> method. This method uses a <code>@post</code> instance variable, which is not explicitly set in the method itself. Where does this variable come from?</p>

<p>Take a look at the filters at the top of the file. The second, auto-generated <code>before_action</code> filter provides an answer:</p>
<div class="code-label " title="~/sharkapp/controllers/posts_controller.rb">~/sharkapp/controllers/posts_controller.rb</div><pre class="code-pre "><code langs="">class PostsController &lt; ApplicationController
  before_action :get_shark
  before_action :set_post, only: [:show, :edit, :update, :destroy]
  . . .
</code></pre>
<p>The <code>update</code> method (like <code>show</code>, <code>edit</code>, and <code>destroy</code>) takes a <code>@post</code> variable from the <code>set_post</code> method. That method, listed under the <code>get_shark</code> method with our other <code>private</code> methods, currently looks like this:</p>
<div class="code-label " title="~/sharkapp/controllers/posts_controller.rb">~/sharkapp/controllers/posts_controller.rb</div><pre class="code-pre "><code langs="">. . . 
private
. . . 
  def set_post
    @post = Post.find(params[:id])
  end
. . .
</code></pre>
<p>In keeping with the methods we&rsquo;ve used elsewhere in the file, we will need to modify this method so that <code>@post</code> refers to a particular instance in the <strong>collection</strong> of posts that&rsquo;s associated with a particular shark. Keep the <code>build</code> method in mind here — thanks to the associations between our models, and the methods (like <code>build</code>) that are available to us by virtue of those associations, each of our post instances is part of a collection of objects that&rsquo;s associated with a particular shark. So it makes sense that when querying for a particular post, we would query the collection of posts associated with a particular shark.</p>

<p>Update <code>set_post</code> to look like this:</p>
<div class="code-label " title="~/sharkapp/controllers/posts_controller.rb">~/sharkapp/controllers/posts_controller.rb</div><pre class="code-pre "><code langs="">. . . 
private
. . . 
  def set_post
    <a href="https://www.digitalocean.com/community/users/post" class="username-tag">@post</a> = <span class="highlight">@shark.posts.find</span>(params[:id])
  end
. . .
</code></pre>
<p>Instead of finding a particular instance of the entire <code>Post</code> class by <code>id</code>, we instead search for a matching <code>id</code> in the collection of posts associated with a particular shark.</p>

<p>With that method updated, we can look at the <code>update</code> and <code>destroy</code> methods. </p>

<p>The <code>update</code> method makes use of the <code>@post</code> instance variable from <code>set_post</code>, and uses it with the <code>post_params</code> that the user has entered in the <code>edit</code> form. In the case of success, we want Rails to send the user back to the <code>index</code> view of the posts associated with a particular shark. In the case of errors, Rails will render the <code>edit</code> template again.</p>

<p>In this case, the only change we will need to make is to the <code>redirect_to</code> statement, to handle successful updates. Update it to redirect to <code>shark_post_path(@shark)</code>, which will redirect to the <code>index</code> view of the selected shark&rsquo;s posts:</p>
<div class="code-label " title="~/sharkapp/controllers/posts_controller.rb">~/sharkapp/controllers/posts_controller.rb</div><pre class="code-pre "><code langs="">. . . 
  def update
    respond_to do |format|
      if <a href="https://www.digitalocean.com/community/users/post-update" class="username-tag">@post.update</a>(post_params)
        format.html { redirect_to <span class="highlight">shark_post_path(@shark)</span>, notice: 'Post was successfully updated.' }
        format.json { render :show, status: :ok, location: @post }
      else
        format.html { render :edit }
        format.json { render json: @post.errors, status: :unprocessable_entity }
      end
    end
  end
. . .
</code></pre>
<p>Next, we will make a similar change to the <code>destroy</code> method. Update the <code>redirect_to</code> method to redirect requests to <code>shark_posts_path(@shark)</code> in the case of success:</p>
<div class="code-label " title="~/sharkapp/controllers/posts_controller.rb">~/sharkapp/controllers/posts_controller.rb</div><pre class="code-pre "><code langs="">. . . 
  def destroy
    <a href="https://www.digitalocean.com/community/users/post-destroy" class="username-tag">@post.destroy</a>
     respond_to do |format|
      format.html { redirect_to <span class="highlight">shark_posts_path(@shark)</span>, notice: 'Post was successfully destroyed.' }
      format.json { head :no_content }
    end
  end
. . .
</code></pre>
<p>This is the last change we will make. You now have a posts controller file that looks like this:</p>
<div class="code-label " title="~/sharkapp/controllers/posts_controller.rb">~/sharkapp/controllers/posts_controller.rb</div><pre class="code-pre "><code langs="">class PostsController &lt; ApplicationController
  before_action :get_shark
  before_action :set_post, only: [:show, :edit, :update, :destroy]

  # GET /posts
  # GET /posts.json
  def index
    @posts = @shark.posts
  end

  # GET /posts/1
  # GET /posts/1.json
  def show
  end

  # GET /posts/new
  def new
    @post = @shark.posts.build
  end

  # GET /posts/1/edit
  def edit
  end

  # POST /posts
  # POST /posts.json
  def create
    @post = @shark.posts.build(post_params)

        respond_to do |format|
         if @post.save  
            format.html { redirect_to shark_posts_path(@shark), notice: 'Post was successfully created.' }
            format.json { render :show, status: :created, location: @post }
         else
            format.html { render :new }
            format.json { render json: @post.errors, status: :unprocessable_entity }
      end
    end
  end

  # PATCH/PUT /posts/1
  # PATCH/PUT /posts/1.json
  def update
    respond_to do |format|
      if @post.update(post_params)
        format.html { redirect_to shark_post_path(@shark), notice: 'Post was successfully updated.' }
        format.json { render :show, status: :ok, location: @post }
      else
        format.html { render :edit }
        format.json { render json: @post.errors, status: :unprocessable_entity }
      end
    end
  end

  # DELETE /posts/1
  # DELETE /posts/1.json
  def destroy
    @post.destroy
    respond_to do |format|
      format.html { redirect_to shark_posts_path(@shark), notice: 'Post was successfully destroyed.' }
      format.json { head :no_content }
    end
  end

  private

   def get_shark
     @shark = Shark.find(params[:shark_id])
   end
    # Use callbacks to share common setup or constraints between actions.
    def set_post
      @post = @shark.posts.find(params[:id])
    end

    # Never trust parameters from the scary internet, only allow the white list through.
    def post_params
      params.require(:post).permit(:body, :shark_id)
    end
end
</code></pre>
<p>The controller manages how information is passed from the view templates to the database and vice versa. Our controller now reflects the relationship between our <code>Shark</code> and <code>Post</code> models, in which posts are associated with particular sharks. We can move on to modifying the view templates themselves, which are where users will pass in and modify post information about particular sharks.</p>

<h2 id="step-4-—-modifying-views">Step 4 — Modifying Views</h2>

<p>Our view template revisions will involve changing the templates that relate to posts, and also modifying our sharks <code>show</code> view, since we want users to see the posts associated with particular sharks.</p>

<p>Let&rsquo;s start with the foundational template for our posts: the <code>form</code> partial that is reused across multiple post templates. Open that form now:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">nano app/views/posts/_form.html.erb
</li></ul></code></pre>
<p>Rather than passing only the <code>post</code> model to the <code>form_with</code> form helper, we will pass both the <code>shark</code> and <code>post</code> models, with <code>post</code> set as a child resource. </p>

<p>Change the first line of the file to look like this, reflecting the relationship between our shark and post resources:</p>
<div class="code-label " title="~/sharkapp/views/posts/_form.html.erb">~/sharkapp/views/posts/_form.html.erb</div><pre class="code-pre "><code langs="">&lt;%= form_with(model: <span class="highlight">[@shark, post]</span>, local: true) do |form| %&gt;
. . . 
</code></pre>
<p>Next, <strong>delete</strong> the section that lists the <code>shark_id</code> of the related shark, since this is not essential information in the view. </p>

<p>The finished form, complete with our edits to the first line and without the deleted <code>shark_id</code> section, will look like this:</p>
<div class="code-label " title="~/sharkapp/views/posts/_form.html.erb">~/sharkapp/views/posts/_form.html.erb</div><pre class="code-pre "><code langs="">&lt;%= form_with(model: [@shark, post], local: true) do |form| %&gt;
  &lt;% if post.errors.any? %&gt;
    &lt;div id="error_explanation"&gt;
      &lt;h2&gt;&lt;%= pluralize(post.errors.count, "error") %&gt; prohibited this post from being saved:&lt;/h2&gt;

      &lt;ul&gt;
      &lt;% post.errors.full_messages.each do |message| %&gt;
        &lt;li&gt;&lt;%= message %&gt;&lt;/li&gt;
      &lt;% end %&gt;
      &lt;/ul&gt;
    &lt;/div&gt;
  &lt;% end %&gt;

  &lt;div class="field"&gt;
    &lt;%= form.label :body %&gt;
    &lt;%= form.text_area :body %&gt;
  &lt;/div&gt;

  &lt;div class="actions"&gt;
    &lt;%= form.submit %&gt;
  &lt;/div&gt;
&lt;% end %&gt;
</code></pre>
<p>Save and close the file when you are finished editing.</p>

<p>Next, open the <code>index</code> view, which will show the posts associated with a particular shark: </p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">nano app/views/posts/index.html.erb
</li></ul></code></pre>
<p>Thanks to the <code>rails generate scaffold</code> command, Rails has generated the better part of the template, complete with a table that shows the <code>body</code> field of each post and its associated <code>shark</code>.  </p>

<p>Much like the other code we have already modified, however, this template treats posts as independent entities, when we would like to make use of the associations between our models and the collections and helper methods that these associations give us.</p>

<p>In the body of the table, make the following updates:</p>

<p>First, update <code>post.shark</code> to <code>post.shark.name</code>, so that the table will include the name field of the associated shark, rather than identifying information about the shark object itself:</p>
<div class="code-label " title="~/sharkapp/app/views/posts/index.html.erb">~/sharkapp/app/views/posts/index.html.erb</div><pre class="code-pre "><code langs="">. . . 
  &lt;tbody&gt;
    &lt;% <a href="https://www.digitalocean.com/community/users/posts-each" class="username-tag">@posts.each</a> do |post| %&gt;
      &lt;tr&gt;
        &lt;td&gt;&lt;%= post.body %&gt;&lt;/td&gt;
        &lt;td&gt;&lt;%= post.shark<span class="highlight">.name</span> %&gt;&lt;/td&gt;
. . . 
</code></pre>
<p>Next, change the <code>Show</code> redirect to direct users to the <code>show</code> view for the associated shark, since they will most likely want a way to navigate back to the original shark. We can make use of the <code>@shark</code> instance variable that we set in the controller here, since Rails makes instance variables created in the controller available to all views. We&rsquo;ll also change the text for the link from <code>Show</code> to <code>Show Shark</code>, so that users will better understand its function.</p>

<p>Update the this line to the following:</p>
<div class="code-label " title="~/sharkapp/app/views/posts/index.html.erb">~/sharkapp/app/views/posts/index.html.erb</div><pre class="code-pre "><code langs="">. . . 
  &lt;tbody&gt;
    &lt;% <a href="https://www.digitalocean.com/community/users/posts-each" class="username-tag">@posts.each</a> do |post| %&gt;
      &lt;tr&gt;
        &lt;td&gt;&lt;%= post.body %&gt;&lt;/td&gt;
        &lt;td&gt;&lt;%= post.shark.name %&gt;&lt;/td&gt;
        &lt;td&gt;&lt;%= link_to 'Show <span class="highlight">Shark</span>', <span class="highlight">[@shark]</span> %&gt;&lt;/td&gt;
</code></pre>
<p>In the next line, we want to ensure that users are routed the right nested path when they go to edit a post. This means that rather than being directed to <code>posts/<span class="highlight">post_id</span>/edit</code>, users will be directed to <code>sharks/<span class="highlight">shark_id</span>/posts/<span class="highlight">post_id</span>/edit</code>. To do this, we&rsquo;ll use the <code>shark_post_path</code> routing helper and our models, which Rails will treat as URLs. We&rsquo;ll also update the link text to make its function clearer.</p>

<p>Update the <code>Edit</code> line to look like the following:</p>
<div class="code-label " title="~/sharkapp/app/views/posts/index.html.erb">~/sharkapp/app/views/posts/index.html.erb</div><pre class="code-pre "><code langs="">. . . 
  &lt;tbody&gt;
    &lt;% <a href="https://www.digitalocean.com/community/users/posts-each" class="username-tag">@posts.each</a> do |post| %&gt;
      &lt;tr&gt;
        &lt;td&gt;&lt;%= post.body %&gt;&lt;/td&gt;
        &lt;td&gt;&lt;%= post.shark.name %&gt;&lt;/td&gt;
        &lt;td&gt;&lt;%= link_to 'Show Shark', [@shark] %&gt;&lt;/td&gt;
        &lt;td&gt;&lt;%= link_to 'Edit <span class="highlight">Post</span>', <span class="highlight">edit_shark_post_path(@shark, post)</span> %&gt;&lt;/td&gt;
</code></pre>
<p>Next, let&rsquo;s add a similar change to the <code>Destroy</code> link, updating its function in the string, and adding our <code>shark</code> and <code>post</code> resources:</p>
<div class="code-label " title="~/sharkapp/app/views/posts/index.html.erb">~/sharkapp/app/views/posts/index.html.erb</div><pre class="code-pre "><code langs="">. . . 
  &lt;tbody&gt;
    &lt;% <a href="https://www.digitalocean.com/community/users/posts-each" class="username-tag">@posts.each</a> do |post| %&gt;
      &lt;tr&gt;
        &lt;td&gt;&lt;%= post.body %&gt;&lt;/td&gt;
        &lt;td&gt;&lt;%= post.shark.name %&gt;&lt;/td&gt;
        &lt;td&gt;&lt;%= link_to 'Show Shark', [@shark] %&gt;&lt;/td&gt;
        &lt;td&gt;&lt;%= link_to 'Edit Post', edit_shark_post_path(@shark, post) %&gt;&lt;/td&gt;
        &lt;td&gt;&lt;%= link_to 'Destroy <span class="highlight">Post</span>', <span class="highlight">[@shark, post]</span>, method: :delete, data: { confirm: 'Are you sure?' } %&gt;&lt;/td&gt;
</code></pre>
<p>Finally, at the bottom of the form, we will want to update the <code>New Post</code> path to take users to the appropriate nested path when they want to create a new post. Update the last line of the file to make use of the <code>new_shark_post_path(@shark)</code> routing helper:</p>
<div class="code-label " title="~/sharkapp/app/views/posts/index.html.erb">~/sharkapp/app/views/posts/index.html.erb</div><pre class="code-pre "><code langs="">. . . 
&lt;%= link_to 'New Post', <span class="highlight">new_shark_post_path(@shark)</span> %&gt;
</code></pre>
<p>The finished file will look like this:</p>
<div class="code-label " title="~/sharkapp/app/views/posts/index.html.erb">~/sharkapp/app/views/posts/index.html.erb</div><pre class="code-pre "><code langs="">&lt;p id="notice"&gt;&lt;%= notice %&gt;&lt;/p&gt;

&lt;h1&gt;Posts&lt;/h1&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;Body&lt;/th&gt;
      &lt;th&gt;Shark&lt;/th&gt;
      &lt;th colspan="3"&gt;&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;

  &lt;tbody&gt;
    &lt;% @posts.each do |post| %&gt;
      &lt;tr&gt;
        &lt;td&gt;&lt;%= post.body %&gt;&lt;/td&gt;
        &lt;td&gt;&lt;%= post.shark.name %&gt;&lt;/td&gt;
        &lt;td&gt;&lt;%= link_to 'Show Shark', [@shark] %&gt;&lt;/td&gt;
        &lt;td&gt;&lt;%= link_to 'Edit Post', edit_shark_post_path(@shark, post) %&gt;&lt;/td&gt;
        &lt;td&gt;&lt;%= link_to 'Destroy Post', [@shark, post], method: :delete, data: { confirm: 'Are you sure?' } %&gt;&lt;/td&gt;
      &lt;/tr&gt;
    &lt;% end %&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;br&gt;

&lt;%= link_to 'New Post', new_shark_post_path(@shark) %&gt;
</code></pre>
<p>Save and close the file when you are finished editing.</p>

<p>The other edits we will make to post views won&rsquo;t be as numerous, since our other views use the <code>form</code> partial we have already edited. However, we will want to update the <code>link_to</code> references in the other post templates to reflect the changes we have made to our <code>form</code> partial.</p>

<p>Open <code>app/views/posts/new.html.erb</code>:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">nano app/views/posts/new.html.erb
</li></ul></code></pre>
<p>Update the <code>link_to</code> reference at the bottom of the file to make use of the <code>shark_posts_path(@shark)</code> helper:</p>
<div class="code-label " title="~/sharkapp/app/views/posts/new.html.erb">~/sharkapp/app/views/posts/new.html.erb</div><pre class="code-pre "><code langs="">. . . 
&lt;%= link_to 'Back', <span class="highlight">shark_posts_path(@shark)</span> %&gt;
</code></pre>
<p>Save and close the file when you are finished making this change.</p>

<p>Next, open the <code>edit</code> template:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">nano app/views/posts/edit.html.erb
</li></ul></code></pre>
<p>In addition to the <code>Back</code> path, we&rsquo;ll update <code>Show</code> to reflect our nested resources. Change the last two lines of the file to look like this:</p>
<div class="code-label " title="~/sharkapp/app/views/posts/edit.html.erb">~/sharkapp/app/views/posts/edit.html.erb</div><pre class="code-pre "><code langs="">. . . 
&lt;%= link_to 'Show', <span class="highlight">[@shark, <a href="https://www.digitalocean.com/community/users/post" class="username-tag">@post</a>]</span> %&gt; |
&lt;%= link_to 'Back', <span class="highlight">shark_posts_path(@shark)</span> %&gt;
</code></pre>
<p>Save and close the file.</p>

<p>Next, open the <code>show</code> template:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">nano app/views/posts/show.html.erb
</li></ul></code></pre>
<p>Make the following edits to the <code>Edit</code> and <code>Back</code> paths at the bottom of the file:</p>
<div class="code-label " title="~/sharkapp/app/views/posts/edit.html.erb">~/sharkapp/app/views/posts/edit.html.erb</div><pre class="code-pre "><code langs="">. . .
&lt;%= link_to 'Edit', <span class="highlight">edit_shark_post_path(@shark, <a href="https://www.digitalocean.com/community/users/post" class="username-tag">@post</a>)</span> %&gt; |
&lt;%= link_to 'Back', <span class="highlight">shark_posts_path(@shark)</span> %&gt;
</code></pre>
<p>Save and close the file when you are finished. </p>

<p>As a final step, we will want to update the <code>show</code> view for our sharks so that posts are visible for individual sharks. Open that file now:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">nano app/views/sharks/show.html.erb
</li></ul></code></pre>
<p>Our edits here will include adding a <code>Posts</code> section to the form and an <code>Add Post</code> link at the bottom of the file. </p>

<p>Below the <code>Facts</code> for a given shark, we will add a new section that iterates through each instance in the collection of posts associated with this shark, outputting the <code>body</code> of each post. </p>

<p>Add the following code below the <code>Facts</code> section of the form, and above the redirects at the bottom of the file:</p>
<div class="code-label " title="~/sharkapp/app/views/sharks/show.html.erb">~/sharkapp/app/views/sharks/show.html.erb</div><pre class="code-pre "><code langs="">. . .
&lt;p&gt;
  &lt;strong&gt;Facts:&lt;/strong&gt;
  &lt;%= <a href="https://www.digitalocean.com/community/users/shark-facts" class="username-tag">@shark.facts</a> %&gt;
&lt;/p&gt;

<span class="highlight">&lt;h2&gt;Posts&lt;/h2&gt;</span>
<span class="highlight">&lt;% for post in <a href="https://www.digitalocean.com/community/users/shark-posts" class="username-tag">@shark.posts</a> %&gt;</span>
    <span class="highlight">&lt;ul&gt;</span>
      <span class="highlight">&lt;li&gt;&lt;%= post.body %&gt;&lt;/li&gt;</span>
  <span class="highlight">&lt;/ul&gt;</span>
<span class="highlight">&lt;% end %&gt;</span>

&lt;%= link_to 'Edit', edit_shark_path(@shark) %&gt; |
. . . 
</code></pre>
<p>Next, add a new redirect to allow users to add a new post for this particular shark:</p>
<div class="code-label " title="~/sharkapp/app/views/sharks/show.html.erb">~/sharkapp/app/views/sharks/show.html.erb</div><pre class="code-pre "><code langs="">. . .
&lt;%= link_to 'Edit', edit_shark_path(@shark) %&gt; |
<span class="highlight">&lt;%= link_to 'Add Post', shark_posts_path(@shark) %&gt; |</span>
&lt;%= link_to 'Back', sharks_path %&gt;
</code></pre>
<p>Save and close the file when you are finished editing.</p>

<p>You have now made changes to your application&rsquo;s models, controllers, and views to ensure that posts are always associated with a particular shark. As a final step, we can add some validations to our <code>Post</code> model to guarantee consistency in the data that&rsquo;s saved to the database.</p>

<h2 id="step-5-—-adding-validations-and-testing-the-application">Step 5 — Adding Validations and Testing the Application</h2>

<p>In <a href="https://www.digitalocean.com/community/tutorials/how-to-build-a-ruby-on-rails-application#step-5-%E2%80%94-adding-validations">Step 5</a> of <a href="https://www.digitalocean.com/community/tutorials/how-to-build-a-ruby-on-rails-application">How To Build a Ruby on Rails Application</a>, you added validations to your <code>Shark</code> model to ensure uniformity and consistency in the data that gets saved to the <code>sharks</code> database. We&rsquo;ll now take a similar step to ensure guarantees for the <code>posts</code> database as well.</p>

<p>Open the file where your <code>Post</code> model is defined:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">nano app/models/post.rb
</li></ul></code></pre>
<p>Here, we want to ensure that posts are not blank and that they don&rsquo;t duplicate content other users may have posted. To achieve this, add the following line to the file:</p>
<div class="code-label " title="~/sharkapp/app/models/post.rb">~/sharkapp/app/models/post.rb</div><pre class="code-pre "><code langs="">class Post &lt; ApplicationRecord
  belongs_to :shark
  <span class="highlight">validates :body, presence: true, uniqueness: true</span>
end
</code></pre>
<p>Save and close the file when you are finished editing.</p>

<p>With this last change in place, you are ready to run your migrations and test the application. </p>

<p>First, run your migrations:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">rails db:migrate
</li></ul></code></pre>
<p>Next, start your server. If you&rsquo;re working locally, you can do so by running:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">rails s
</li></ul></code></pre>
<p>If you are working on a development server, run the following command instead:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">rails s --binding=<span class="highlight">your_server_ip</span>
</li></ul></code></pre>
<p>Navigate to your application&rsquo;s root at <code>http://localhost:3000</code> or <code>http://<span class="highlight">your_server_ip</span>:3000</code>.</p>

<p>The prerequisite Rails project tutorial walked you through adding and editing a <strong>Great White</strong> shark entry. If you have not added any further sharks, the application landing page will look like this:</p>

<p><img src="https://assets.digitalocean.com/articles/rails_nested_resource/shark_post_landing_2.png" alt="Shark App Landing Page"> </p>

<p>Click on <strong>Show</strong> next to the <strong>Great White</strong>&rsquo;s name. This will take you to the <code>show</code> view for this shark. You will see the name of the shark and its facts, and a <strong>Posts</strong> header with no content. Let&rsquo;s add a post to populate this part of the form. </p>

<p>Click on <strong>Add Post</strong> below the <strong>Posts</strong> header. This will bring you to the post <code>index</code> view, where you will have the chance to select <strong>New Post</strong>:</p>

<p><img src="https://assets.digitalocean.com/articles/rails_nested_resource/new_post_landing.png" alt="Post Index View"></p>

<p>Thanks to the authentication mechanisms you put in place in <a href="https://www.digitalocean.com/community/tutorials/how-to-build-a-ruby-on-rails-application#step-6--%E2%80%94-adding-authentication">Step 6</a> of <a href="https://www.digitalocean.com/community/tutorials/how-to-build-a-ruby-on-rails-application">How To Build a Ruby on Rails Application</a>, you may be asked to authenticate with the username and password you created in that Step, depending on whether or not you have created a new session.</p>

<p>Click on <strong>New Post</strong>, which will bring you to your post <code>new</code> template:</p>

<p><img src="https://assets.digitalocean.com/articles/rails_nested_resource/new_post_form.png" alt="New Post"></p>

<p>In the <strong>Body</strong> field, type, &ldquo;These sharks are scary!&rdquo;</p>

<p><img src="https://assets.digitalocean.com/articles/rails_nested_resource/new_shark_post_2.png" alt="New Shark Post"></p>

<p>Click on <strong>Create Post</strong>. You will be redirected to the <code>index</code> view for all posts that belong to this shark:</p>

<p><img src="https://assets.digitalocean.com/articles/rails_nested_resource/post_success.png" alt="Post Success"></p>

<p>With our post resources working, we can now test our data validations to ensure that only desired data gets saved to the database. </p>

<p>From the <code>index</code> view, click on <strong>New Post</strong>. In the <strong>Body</strong> field of the new form, try entering &ldquo;These sharks are scary!&rdquo; again:</p>

<p><img src="https://assets.digitalocean.com/articles/rails_nested_resource/new_shark_post_2.png" alt="Repeat Shark Post"></p>

<p>Click on <strong>Create Post</strong>. You will see the following error:</p>

<p><img src="https://assets.digitalocean.com/articles/rails_nested_resource/post_unique_error.png" alt="Unique Post Error"></p>

<p>Click on <strong>Back</strong> to return to the main posts page. </p>

<p>To test our other validation, click on <strong>New Post</strong> again. Leave the post blank and click <strong>Create Post</strong>. You will see the following error:</p>

<p><img src="https://assets.digitalocean.com/articles/rails_nested_resource/post_blank_error.png" alt="Blank Post Error"></p>

<p>With your nested resources and validations working properly, you now have a working Rails application that you can use as a starting point for further development.</p>

<h2 id="conclusion">Conclusion</h2>

<p>With your Rails application in place, you can now work on things like styling and developing other front-end components. If you would like to learn more about routing and nested resources, the <a href="https://edgeguides.rubyonrails.org/routing.html">Rails documentation</a> is a great place to start.</p>

<p>To learn more about integrating front-end frameworks with your application, take a look at <a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-a-ruby-on-rails-project-with-a-react-frontend">How To Set Up a Ruby on Rails Project with a React Frontend</a>.</p>
