---
layout: post
title: How To Install Nagios 4 and Monitor Your Servers on Ubuntu 18.04
network: digitalocean
date: August 08, 2019 at 06:48PM
url: https://www.digitalocean.com/community/tutorials/how-to-install-nagios-4-and-monitor-your-servers-on-ubuntu-18-04
image: https://assets.digitalocean.com/articles/nagios1804/step5.png
tags: docker
feedtitle: DigitalOcean Community Tutorials
feedurl: https://www.digitalocean.com/community/tutorials
author: DigitalOcean
---
<p><em>The author selected <a href="https://www.brightfunds.org/organizations/open-source-initiative">the Open Source Initiative</a> to receive a donation as part of the <a href="https://do.co/w4do-cta">Write for DOnations</a> program.</em></p>

<h3 id="introduction">Introduction</h3>

<p><a href="https://www.nagios.org/">Nagios</a> is a popular open-source monitoring system. It keeps an inventory of your servers and monitors them so you know your critical services are up and running. Using a monitoring system like Nagios is an essential tool for any production environment, because by monitoring uptime, CPU usage, or disk space, you can head off problems before they occur, or before your users call you.</p>

<p>In this tutorial, you'll install Nagios 4 and configure it so you can monitor host resources via Nagios' web interface. You'll also set up the Nagios Remote Plugin Executor (NRPE), which runs as an agent on remote hosts so you can monitor their resources.</p>

<h2 id="prerequisites">Prerequisites</h2>

<p>To follow this tutorial, you will need:</p>

<ul>
<li>Two Ubuntu 18.04 servers set up by following our <a href="https://www.digitalocean.com/community/tutorials/initial-server-setup-with-ubuntu-18-04">Initial Server Setup Guide for Ubuntu 18.04</a>, including a non-root user with sudo privileges and a firewall configured with <code>ufw</code>. On one server, you will install Nagios; this tutorial will refer to this as the <strong>Nagios server</strong>. It will monitor your second server; this second server will be referred to as the <strong>second Ubuntu server</strong>.</li>
<li>The server that will run the Nagios server needs Apache and PHP installed. Follow <a href="https://www.digitalocean.com/community/tutorials/how-to-install-linux-apache-mysql-php-lamp-stack-ubuntu-18-04">this guide</a> to configure those on one of your servers. You can skip the MySQL steps in that tutorial.</li>
</ul>

<p>Typically, Nagios runs behind a hardware firewall or VPN. If your Nagios server is exposed to the public internet, you should secure the Nagios web interface by installing a TLS/SSL certificate. This is optional but <strong>strongly encouraged</strong>. You can follow the <a href="https://www.digitalocean.com/community/tutorials/how-to-secure-apache-with-let-s-encrypt-on-ubuntu-18-04">Let's Encrypt on Ubuntu 18.04</a> guide to obtain the free TLS/SSL certificate.</p>

<p>This tutorial assumes that your servers have <a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-and-use-digitalocean-private-networking">private networking</a> enabled so that monitoring happens on the private network rather than the public network. If you don't have private networking enabled, you can still follow this tutorial by replacing all the references to private IP addresses with public IP addresses.</p>

<h2 id="step-1-—-installing-nagios-4">Step 1 — Installing Nagios 4</h2>

<p>There are multiple ways to install Nagios, but you'll install Nagios and its components from source to ensure you get the latest features, security updates, and bug fixes.</p>

<p>Log in to your server that runs Apache. In this tutorial, we'll call this the <strong>Nagios server</strong>:</p>
<pre class="code-pre command local-environment"><code langs=""><ul class="prefixed"><li class="line" prefix="$">ssh <span class="highlight">sammy</span>@<span class="highlight">your_nagios_server_ip</span>
</li></ul></code></pre>
<p>Because you're building Nagios and its components from source, you must install a few development libraries to complete the build, including compilers, development headers, and OpenSSL.</p>

<p>Update your package lists to ensure you can download the latest versions of the prerequisites:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo apt update
</li></ul></code></pre>
<p>Then install the required packages:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo apt install autoconf gcc make unzip libgd-dev libmcrypt-dev libssl-dev dc snmp libnet-snmp-perl gettext
</li></ul></code></pre>
<p>With the prerequisites installed, you can install Nagios itself. Download the source code for the latest stable release of Nagios Core. Go to the <a href="http://www.nagios.org/download/core-stay-informed">Nagios downloads page</a>, and click the <strong>Skip to download</strong> link below the form. Copy the link address for the latest stable release so you can download it to your Nagios server.</p>

<p>Download the release to your home directory with the <code>curl</code> command:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">cd ~
</li><li class="line" prefix="$">curl -L -O https://github.com/NagiosEnterprises/nagioscore/archive/nagios-<span class="highlight">4.4.4</span>.tar.gz
</li></ul></code></pre>
<p>Extract the Nagios archive:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">tar zxf nagios-<span class="highlight">4.4.4</span>.tar.gz
</li></ul></code></pre>
<p>Then change to the extracted directory:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">cd nagioscore-nagios-<span class="highlight">4.4.4</span>
</li></ul></code></pre>
<p>Before building Nagios, run the <code>configure</code> script and specify the Apache configs directory:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">./configure --with-httpd-conf=<span class="highlight">/etc/apache2/sites-enabled</span>
</li></ul></code></pre>
<p><span class='note'><strong>Note:</strong> If you want Nagios to send emails using Postfix, you must <a href="https://www.digitalocean.com/community/tutorials/how-to-install-and-configure-postfix-on-ubuntu-18-04">install Postfix</a> and configure Nagios to use it by adding <code>--with-mail=/usr/sbin/sendmail</code> to the <code>configure</code> command. We won't cover Postfix in this tutorial, but if you choose to use Postfix and Nagios later, you'll need to reconfigure and reinstall Nagios to use Postfix support.<br></span></p>

<p>You'll see the following output from the <code>configure</code> command:</p>
<pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>*** Configuration summary for nagios 4.4.4 2019-07-29 ***:

 General Options:
 -------------------------
        Nagios executable:  nagios
        Nagios user/group:  nagios,nagios
       Command user/group:  nagios,nagios
             Event Broker:  yes
        Install ${prefix}:  /usr/local/nagios
    Install ${includedir}:  /usr/local/nagios/include/nagios
                Lock file:  /run/nagios.lock
   Check result directory:  /usr/local/nagios/var/spool/checkresults
           Init directory:  /lib/systemd/system
  Apache conf.d directory:  /etc/apache2/sites-enabled
             Mail program:  /bin/mail
                  Host OS:  linux-gnu
          IOBroker Method:  epoll

 Web Interface Options:
 ------------------------
                 HTML URL:  http://localhost/nagios/
                  CGI URL:  http://localhost/nagios/cgi-bin/
 Traceroute (used by WAP):


Review the options above for accuracy.  If they look okay,
type 'make all' to compile the main program and CGIs.
</code></pre>
<p>Now compile Nagios with this command:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">make all
</li></ul></code></pre>
<p>Next create a <strong>nagios</strong> user and <strong>nagios</strong> group. They will be used to run the Nagios process:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo make install-groups-users
</li></ul></code></pre>
<p>Now run these <code>make</code> commands to install Nagios binary files, service files, and its sample configuration files:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo make install
</li><li class="line" prefix="$">sudo make install-daemoninit
</li><li class="line" prefix="$">sudo make install-commandmode
</li><li class="line" prefix="$">sudo make install-config
</li></ul></code></pre>
<p>You'll use Apache to serve Nagios' web interface, so run the following to install the Apache configuration files and configure its settings:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo make install-webconf
</li></ul></code></pre>
<p>Enable the Apache <code>rewrite</code> and <code>cgi</code> modules with the <code>a2enmod</code> command:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo a2enmod rewrite
</li><li class="line" prefix="$">sudo a2enmod cgi
</li></ul></code></pre>
<p>In order to issue external commands via the web interface to Nagios, add the web server user, <strong>www-data</strong>, to the <strong>nagios</strong> group:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo usermod -a -G nagios <span class="highlight">www-data</span>
</li></ul></code></pre>
<p>Use the <code>htpasswd</code> command to create an admin user called <strong>nagiosadmin</strong> that can access the Nagios web interface:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo htpasswd -c /usr/local/nagios/etc/htpasswd.users <span class="highlight">nagiosadmin</span>
</li></ul></code></pre>
<p>Enter a password at the prompt. Remember this password, as you will need it to access the Nagios web interface.</p>

<p><span class='warning'><strong>Warning:</strong> If you create a user with a name other than <strong>nagiosadmin</strong>, you will need to edit <code>/usr/local/nagios/etc/cgi.cfg</code> and change all the <strong>nagiosadmin</strong> references to the user you created.<br></span></p>

<p>Restart Apache to load the new Apache configuration:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo systemctl restart apache2
</li></ul></code></pre>
<p>You've now installed Nagios. But for this to work, it is necessary to install the Nagios Plugins, which you'll cover in the next step.</p>

<h2 id="step-2-—-installing-the-nagios-plugins">Step 2 — Installing the Nagios Plugins</h2>

<p>Nagios needs plugins to operate properly. The official Nagios Plugins package contains over 50 plugins that allow you to monitor basic services such as uptime, disk usage, swap usage, NTP, and others.</p>

<p>Let's install the the plugins bundle.</p>

<p>You can find the latest version of the Nagios Plugins on the <a href="https://nagios-plugins.org/">official site</a>.</p>

<p>Download it to your home directory with <code>curl</code>:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">cd ~
</li><li class="line" prefix="$">curl -L -O https://nagios-plugins.org/download/nagios-plugins-<span class="highlight">2.2.1</span>.tar.gz
</li></ul></code></pre>
<p>Extract the NRPE archive and navigate into the extracted directory:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">tar zxf nagios-plugins-&lt;^&gt;2.2.1&lt;^.tar.gz
</li><li class="line" prefix="$">cd nagios-plugins-<span class="highlight">2.2.1</span>
</li></ul></code></pre>
<p>Next configure their installation:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">./configure
</li></ul></code></pre>
<p>Now build and install the plugins:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">make
</li><li class="line" prefix="$">sudo make install
</li></ul></code></pre>
<p>Now the plugins are installed, but you need one more plugin for monitoring remote servers. Let's install it next.</p>

<h2 id="step-3-—-installing-the-check_nrpe-plugin">Step 3 — Installing the check_nrpe Plugin</h2>

<p>Nagios monitors remote hosts using the Nagios Remote Plugin Executor, or NRPE. It consists of two pieces:</p>

<ul>
<li>The <code>check_nrpe</code> plugin that the Nagios server uses.</li>
<li>The NRPE daemon, which runs on the remote hosts and sends data to the Nagios server.</li>
</ul>

<p>Let's install the <code>check_nrpe</code> plugin on our Nagios server.</p>

<p>Find the download URL for the latest stable release of NRPE at the <a href="https://github.com/NagiosEnterprises/nrpe/releases">GitHub page</a>.</p>

<p>Download it to your home directory with <code>curl</code>:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">cd ~
</li><li class="line" prefix="$">curl -L -O https://github.com/NagiosEnterprises/nrpe/releases/download/<span class="highlight">nrpe-3.2.1/nrpe-3.2.1</span>.tar.gz
</li></ul></code></pre>
<p>Extract the NRPE archive:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">tar zxf nrpe-<span class="highlight">3.2.1</span>.tar.gz
</li></ul></code></pre>
<p>Then change to the extracted directory:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">cd nrpe-<span class="highlight">3.2.1</span>
</li></ul></code></pre>
<p>Configure the <code>check_nrpe</code> plugin:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">./configure
</li></ul></code></pre>
<p>Now build and install <code>check_nrpe</code> plugin:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">make check_nrpe
</li><li class="line" prefix="$">sudo make install-plugin
</li></ul></code></pre>
<p>Let's configure the Nagios server next.</p>

<h2 id="step-4-—-configuring-nagios">Step 4 — Configuring Nagios</h2>

<p>Now let's perform the initial Nagios configuration, which involves editing some configuration files. You only need to perform this section once on your Nagios server.</p>

<p>Open the main Nagios configuration file in your preferred text editor. Here, you'll use <code>nano</code>:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo nano /usr/local/nagios/etc/nagios.cfg
</li></ul></code></pre>
<p>Find this line in the file:</p>
<div class="code-label " title="/usr/local/nagios/etc/nagios.cfg">/usr/local/nagios/etc/nagios.cfg</div><pre class="code-pre "><code langs="">...
#cfg_dir=/usr/local/nagios/etc/servers
...
</code></pre>
<p>Uncomment this line by deleting the <code>#</code> character from the front of the line:</p>
<div class="code-label " title="/usr/local/nagios/etc/nagios.cfg">/usr/local/nagios/etc/nagios.cfg</div><pre class="code-pre "><code langs="">cfg_dir=/usr/local/nagios/etc/servers
</code></pre>
<p>Save and close <code>nagios.cfg</code> by pressing <code>CTRL+X</code>, followed by <code>Y</code>, and then <code>ENTER</code> (if you're using <code>nano</code>).</p>

<p>Now create the directory that will store the configuration file for each server that you will monitor:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo mkdir /usr/local/nagios/etc/servers
</li></ul></code></pre>
<p>Open the Nagios contacts configuration in your text editor:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo nano /usr/local/nagios/etc/objects/contacts.cfg
</li></ul></code></pre>
<p>Find the <code>email</code> directive and replace its value with your own email address:</p>
<div class="code-label " title="/usr/local/nagios/etc/objects/contacts.cfg">/usr/local/nagios/etc/objects/contacts.cfg</div><pre class="code-pre "><code langs="">...
define contact{
        contact_name                    nagiosadmin             ; Short name of user
        use                             generic-contact         ; Inherit default values from generic-contact template (defined above)
        alias                           Nagios Admin            ; Full name of user
        <span class="highlight">email</span>                           <span class="highlight">your_email@your_domain.com</span>        ; &lt;&lt;***** CHANGE THIS TO YOUR EMAIL ADDRESS ******
...

</code></pre>
<p>Save and exit the editor.</p>

<p>Next, add a new command to your Nagios configuration that lets you use  the <code>check_nrpe</code> command in Nagios service definitions. Open the file <code>/usr/local/nagios/etc/objects/commands.cfg</code> in your editor:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo nano /usr/local/nagios/etc/objects/commands.cfg
</li></ul></code></pre>
<p>Add the following to the end of the file to define a new command called <code>check_nrpe</code>:</p>
<div class="code-label " title="/usr/local/nagios/etc/objects/commands.cfg">/usr/local/nagios/etc/objects/commands.cfg</div><pre class="code-pre "><code langs="">...
define command{
        command_name check_nrpe
        command_line $USER1$/check_nrpe -H $HOSTADDRESS$ -c $ARG1$
}
</code></pre>
<p>This defines the name and specifies the command-line options to execute the plugin.</p>

<p>Save and exit the editor.</p>

<p>Then start Nagios and enable it to start when the server boots:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo systemctl start nagios
</li></ul></code></pre>
<p>Nagios is now running, so let's log in to its web interface.</p>

<h2 id="step-5-—-accessing-the-nagios-web-interface">Step 5 — Accessing the Nagios Web Interface</h2>

<p>Open your favorite web browser, and go to your Nagios server by visiting <code>http://<span class="highlight">nagios_server_public_ip</span>/nagios</code>.</p>

<p>Enter the login credentials for the web interface in the popup that appears.  Use <strong>nagiosadmin</strong> for the username, and the password you created for that user.</p>

<p>After authenticating, you will see the default Nagios home page. Click on the <strong>Hosts</strong> link in the left navigation bar to see which hosts Nagios is monitoring:</p>

<p><img src="https://assets.digitalocean.com/articles/nagios1804/step5.png" alt="Nagios Hosts Page"></p>

<p>As you can see, Nagios is monitoring only "localhost", or itself.</p>

<p>Let's monitor our other server with Nagios,</p>

<h2 id="step-6-—-installing-nagios-plugins-and-nrpe-daemon-on-a-host">Step 6 — Installing Nagios Plugins and NRPE Daemon on a Host</h2>

<p>Let's add a new host so Nagios can monitor it. You'll install the Nagios Remote Plugin Executor (NRPE) on the remote host, install some plugins, and then configure the Nagios server to monitor this host.</p>

<p>Log in to the second server, which we'll call the <strong>second Ubuntu server</strong>:</p>
<pre class="code-pre command local-environment"><code langs=""><ul class="prefixed"><li class="line" prefix="$">ssh sammy@<span class="highlight">your_monitored_server_ip</span>
</li></ul></code></pre>
<p>First create a <strong>nagios</strong> user  which will run the NRPE agent:</p>
<pre class="code-pre command second-environment"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo useradd <span class="highlight">nagios</span>
</li></ul></code></pre>
<p>You'll install NRPE from source, which means you'll need the same development libraries you installed on the Nagios server in Step 1. Update your package sources and install the NRPE prerequisites:</p>
<pre class="code-pre command second-environment"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo apt update
</li><li class="line" prefix="$">sudo apt install autoconf gcc libmcrypt-dev make libssl-dev wget dc build-essential gettext
</li></ul></code></pre>
<p>NRPE requires that <a href="https://nagios-plugins.org/">Nagios Plugins</a> is installed on the remote host. Let's install this package from source.</p>

<p>Find the latest release of Nagios Plugins from the <a href="https://nagios-plugins.org/downloads/">downloads</a> page.</p>

<p>Download Nagios Plugins to your home directory with <code>curl</code>:</p>
<pre class="code-pre command second-environment"><code langs=""><ul class="prefixed"><li class="line" prefix="$">cd ~
</li><li class="line" prefix="$">curl -L -O https://nagios-plugins.org/download/nagios-plugins-<span class="highlight">2.2.1</span>.tar.gz
</li></ul></code></pre>
<p>Extract the Nagios Plugins archive and change to the extracted directory:</p>
<pre class="code-pre command second-environment"><code langs=""><ul class="prefixed"><li class="line" prefix="$">tar zxf nagios-plugins-<span class="highlight">2.2.1</span>.tar.gz
</li><li class="line" prefix="$">cd nagios-plugins-<span class="highlight">2.2.1</span>
</li></ul></code></pre>
<p>Before building Nagios Plugins, configure them with the following command:</p>
<pre class="code-pre command second-environment"><code langs=""><ul class="prefixed"><li class="line" prefix="$">./configure
</li></ul></code></pre>
<p>Now compile the plugins:</p>
<pre class="code-pre command second-environment"><code langs=""><ul class="prefixed"><li class="line" prefix="$">make
</li></ul></code></pre>
<p>Then install them by running:</p>
<pre class="code-pre command second-environment"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo make install
</li></ul></code></pre>
<p>Next, install NRPE daemon. Find the download URL for the latest stable release of NRPE at the <a href="https://github.com/NagiosEnterprises/nrpe/releases">GitHub page</a> just like you did in Step 3. Download the latest stable release of NRPE to your monitored server's home directory with <code>curl</code>:</p>
<pre class="code-pre command second-environment"><code langs=""><ul class="prefixed"><li class="line" prefix="$">cd ~
</li><li class="line" prefix="$">curl -L -O https://github.com/NagiosEnterprises/nrpe/releases/download/<span class="highlight">nrpe-3.2.1/nrpe-3.2.1</span>.tar.gz
</li></ul></code></pre>
<p>Extract the NRPE archive with this command:</p>
<pre class="code-pre command second-environment"><code langs=""><ul class="prefixed"><li class="line" prefix="$">tar zxf nrpe-<span class="highlight">3.2.1</span>.tar.gz
</li></ul></code></pre>
<p>Then change to the extracted directory:</p>
<pre class="code-pre command second-environment"><code langs=""><ul class="prefixed"><li class="line" prefix="$">cd nrpe-<span class="highlight">3.2.1</span>
</li></ul></code></pre>
<p>Configure NRPE:</p>
<pre class="code-pre command second-environment"><code langs=""><ul class="prefixed"><li class="line" prefix="$">./configure
</li></ul></code></pre>
<p>Now build and install NRPE and its startup script with these commands:</p>
<pre class="code-pre command second-environment"><code langs=""><ul class="prefixed"><li class="line" prefix="$">make nrpe
</li><li class="line" prefix="$">sudo make install-daemon
</li><li class="line" prefix="$">sudo make install-config
</li><li class="line" prefix="$">sudo make install-init
</li></ul></code></pre>
<p>Now, let's update the NRPE configuration file and add some basic checks that Nagios can monitor.</p>

<p>First, let's monitor the disk usage of this server. Use the <code>df -h</code> command to look for the root filesystem. You'll use this filesystem name in the NRPE configuration:</p>
<pre class="code-pre command second-environment"><code langs=""><ul class="prefixed"><li class="line" prefix="$">df -h /
</li></ul></code></pre>
<p>You'll see output similar to this:</p>
<pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>Filesystem      Size  Used Avail Use% Mounted on
<span class="highlight">/dev/vda1        25G  1.4G   23G   6% /</span>
</code></pre>
<p>Now open <code>/usr/local/nagios/etc/nrpe.cfg</code> file in your editor:</p>
<pre class="code-pre command second-environment"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo nano /usr/local/nagios/etc/nrpe.cfg
</li></ul></code></pre>
<p>The NRPE configuration file is very long and full of comments. There are a few lines that you will need to find and modify:</p>

<ul>
<li><strong>server_address</strong>: Set to the private IP address of the monitored server.</li>
<li><strong>allowed_hosts</strong>: Add the private IP address of your Nagios server to the comma-delimited list.</li>
<li><strong>command[check_hda1]</strong>: Change <code>/dev/hda1</code> to whatever your root filesystem is called.</li>
</ul>

<p>Locate these settings and alter them appropriately:</p>
<div class="code-label " title="/usr/local/nagios/etc/nrpe.cfg">/usr/local/nagios/etc/nrpe.cfg</div><pre class="code-pre  second-environment"><code langs="">...
server_address=<span class="highlight">second_ubuntu_server_private_ip</span>
...
allowed_hosts=127.0.0.1,::1<span class="highlight">,your_nagios_server_private_ip</span>
...
command[<span class="highlight">check_vda1</span>]=/usr/local/nagios/libexec/check_disk -w 20% -c 10% -p <span class="highlight">/dev/vda1</span>
...
</code></pre>
<p>Save and exit the editor. Now you can start NRPE:</p>
<pre class="code-pre command second-environment"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo systemctl start nrpe.service
</li></ul></code></pre>
<p>Ensure that the service is running by checking its status:</p>
<pre class="code-pre command second-environment"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo systemctl status nrpe.service
</li></ul></code></pre>
<p>You'll see the following output:</p>
<pre class="code-pre  second-environment"><code langs=""><div class="secondary-code-label " title="Output">Output</div>...
Aug 01 06:28:31 client systemd[1]: Started Nagios Remote Plugin Executor.
Aug 01 06:28:31 client nrpe[8021]: Starting up daemon
Aug 01 06:28:31 client nrpe[8021]: Server listening on 0.0.0.0 port 5666.
Aug 01 06:28:31 client nrpe[8021]: Server listening on :: port 5666.
Aug 01 06:28:31 client nrpe[8021]: Listening for connections on port 5666
Aug 01 06:28:31 client nrpe[8021]: Allowing connections from: 127.0.0.1,::1,<span class="highlight">165.22.212.38</span>
</code></pre>
<p>Next, allow access to port <code>5666</code> through the firewall. If you are using UFW, configure it to allow TCP connections to port <code>5666</code> with the following command:</p>
<pre class="code-pre command second-environment"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo ufw allow 5666/tcp
</li></ul></code></pre>
<p>You can learn more about UFW in <a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-a-firewall-with-ufw-on-ubuntu-18-04">How To Set Up a Firewall with UFW on Ubuntu 18.04</a>.</p>

<p>Now you can check the communication with the remote NRPE server. Run the following command on the Nagios server:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">/usr/local/nagios/libexec/check_nrpe -H <span class="highlight">second_ubuntu_server_ip</span>
</li></ul></code></pre>
<p>You'll see the following output:</p>
<pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>NRPE v3.2.1
</code></pre>
<p>Repeat the steps in this section for each additional server you want to monitor.</p>

<p>Once you are done installing and configuring NRPE on the hosts that you want to monitor, you will have to add these hosts to your Nagios server configuration before it will start monitoring them. Let's do that next.</p>

<h2 id="step-7-—-monitoring-hosts-with-nagios">Step 7 — Monitoring Hosts with Nagios</h2>

<p>To monitor your hosts with Nagios, you'll add configuration files for each host specifying what you want to monitor. You can then view those hosts in the Nagios web interface.</p>

<p>On your Nagios server, create a new configuration file for each of the remote hosts that you want to monitor in <code>/usr/local/nagios/etc/servers/</code>. Replace the highlighted word, <code>monitored_server_host_name</code>  with the name of your host:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo nano /usr/local/nagios/etc/servers/<span class="highlight">your_monitored_server_host_name</span>.cfg
</li></ul></code></pre>
<p>Add the following host definition, replacing the <code>host_name</code> value with your remote hostname, the <code>alias</code> value with a description of the host, and the <code>address</code> value with the private IP address of the remote host:</p>
<div class="code-label " title="/usr/local/nagios/etc/servers/your_monitored_server_host_name.cfg">/usr/local/nagios/etc/servers/your_monitored_server_host_name.cfg</div><pre class="code-pre "><code langs="">define host {
        use                             linux-server
        host_name                       <span class="highlight">your_monitored_server_host_name</span>
        alias                           <span class="highlight">My client server</span>
        address                         <span class="highlight">your_monitored_server_private_ip</span>
        max_check_attempts              5
        check_period                    24x7
        notification_interval           30
        notification_period             24x7
}
</code></pre>
<p>With this configuration, Nagios will only tell you if the host is up or down. Let's add some services to monitor.</p>

<p>First, add this block to monitor load average:</p>
<div class="code-label " title="/usr/local/nagios/etc/servers/your_monitored_server_host_name.cfg">/usr/local/nagios/etc/servers/your_monitored_server_host_name.cfg</div><pre class="code-pre "><code langs="">define service {
        use                             generic-service
        host_name                       <span class="highlight">your_monitored_server_host_name</span>
        service_description             Load average
        check_command                   check_nrpe!check_load
}
</code></pre>
<p>The <code>use generic-service</code> directive tells Nagios to inherit the values of a service template called <strong>generic-service</strong>, which is predefined by Nagios.</p>

<p>Next, add this block to monitor disk usage:</p>
<div class="code-label " title="/usr/local/nagios/etc/servers/your_monitored_server_host_name.cfg">/usr/local/nagios/etc/servers/your_monitored_server_host_name.cfg</div><pre class="code-pre "><code langs="">define service {
        use                             generic-service
        host_name                       <span class="highlight">your_monitored_server_host_name</span>
        service_description             /dev/vda1 free space
        check_command                   check_nrpe!check_vda1
}
</code></pre>
<p>Now save and quit. Restart the Nagios service to put any changes into effect:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo systemctl restart nagios
</li></ul></code></pre>
<p>After several minutes, Nagios will check the new hosts and you'll see them in the Nagios web interface. Click on the <strong>Services</strong> link in the left navigation bar to see all of your monitored hosts and services.</p>

<p><img src="https://assets.digitalocean.com/articles/nagios1804/step7.png" alt="Nagios Services Page"></p>

<h2 id="conclusion">Conclusion</h2>

<p>You've installed Nagios on a server and configured it to monitor load average and disk usage of at least one remote machine.</p>

<p>Now that you're monitoring a host and some of its services, you can start using Nagios to monitor your mission-critical services. You can use Nagios to set up notifications for critical events. For example, you can receive an email when your disk utilization reaches a warning or critical threshold, or a notification when your main website is down. This way you can resolve the situation promptly, or even before a problem occurs.</p>
