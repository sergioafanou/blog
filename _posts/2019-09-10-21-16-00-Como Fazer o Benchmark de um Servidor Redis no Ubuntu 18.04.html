---
layout: post
title: Como Fazer o Benchmark de um Servidor Redis no Ubuntu 18.04
network: digitalocean
date: September 10, 2019 at 09:16PM
url: https://www.digitalocean.com/community/tutorials/como-fazer-o-benchmark-de-um-servidor-redis-no-ubuntu-18-04-pt
image: http://ifttt.com/images/no_image_card.png
tags: docker
feedtitle: DigitalOcean Community Tutorials
feedurl: https://www.digitalocean.com/community/tutorials
author: DigitalOcean
---
<h3 id="introdução">Introdução</h3>

<p>O Benchmarking é uma prática importante quando se trata de analisar o desempenho geral dos servidores de banco de dados. É útil para identificar gargalos e oportunidades de melhoria nesses sistemas.</p>

<p>O <a href="https://redis.io/">Redis</a> é um armazenamento de estrutura dados em memória que pode ser usado como banco de dados, cache e intermediador de mensagens ou message broker. Ele suporta desde estruturas de dados simples a complexas, incluindo hashes, strings, conjuntos classificados, bitmaps, dados geoespaciais, entre outros tipos. Neste guia, demonstraremos como fazer o benchmark de um servidor Redis em execução no Ubuntu 18.04, usando algumas ferramentas e métodos distintos.</p>

<h2 id="pré-requisitos">Pré-requisitos</h2>

<p>Para seguir este guia, você precisará de:</p>

<ul>
<li>Um servidor Ubuntu 18.04 com um usuário não-root e um firewall básico configurado. Para configurar isso, você pode seguir nosso guia de <a href="https://www.digitalocean.com/community/tutorials/configuracao-inicial-de-servidor-com-ubuntu-18-04-pt">Configuração Inicial de servidor com Ubuntu 18.04</a>.<br></li>
<li>O Redis instalado em seu servidor, conforme explicado em nosso guia <a href="https://www.digitalocean.com/community/tutorials/how-to-install-and-secure-redis-on-ubuntu-18-04">How to Install and Secure Redis on Ubuntu 18.04</a>. </li>
</ul>

<p><span class='note'><strong>Nota:</strong> Os comandos demonstrados neste tutorial foram executados em um servidor Redis dedicado rodando em um Droplet da DigitalOcean de 4 GB. <br></span></p>

<h2 id="usando-a-ferramenta-incluída-redis-benchmark">Usando a ferramenta incluída <code>redis-benchmark</code></h2>

<p>O Redis vem com uma ferramenta de benchmark chamada <code>redis-benchmark</code>. Este programa pode ser usado para simular um número arbitrário de clientes se conectando ao mesmo tempo e executando ações no servidor, medindo quanto tempo leva para que as solicitações sejam concluídas. Os dados resultantes vão lhe fornecer uma ideia do número médio de solicitações que o seu servidor Redis é capaz de processar por segundo.</p>

<p>A lista a seguir detalha algumas das opções de comando comuns usadas com o  <code>redis-benchmark</code>:</p>

<ul>
<li><code>-h</code>: Host do Redis. O padrão é <code>127.0.0.1</code>.</li>
<li><code>-p</code>: Porta do Redis. O padrão é <code>6379</code>.</li>
<li><code>-a</code>: Se o seu servidor exigir autenticação, você poderá usar esta opção para fornecer a senha.</li>
<li><code>-c</code>: Número de clientes (conexões paralelas) a serem simulados. O valor padrão é 50.</li>
<li><code>-n</code>: Quantas requisições a fazer. O padrão é 100000.</li>
<li><code>-d</code>: Tamanho dos dados para os valores de <code>SET</code> e <code>GET</code>, medidos em bytes. O padrão é 3.</li>
<li><code>-t</code>: Execute apenas um subconjunto de testes. Por exemplo, você pode usar <code>-t get,set</code> para fazer o benchmark dos comandos <code>GET</code> e <code>SET</code>.</li>
<li><code>-q</code>: Modo silencioso, mostra apenas a informação sobre média de <em>requisições por segundo</em>.</li>
</ul>

<p>Por exemplo, se você deseja verificar o número médio de solicitações por segundo que o seu servidor Redis local pode suportar, você pode usar:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">redis-benchmark -q 
</li></ul></code></pre>
<p>Você obterá resultados semelhantes a este, mas com números diferentes:</p>
<pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>PING_INLINE: 85178.88 requests per second
PING_BULK: 83056.48 requests per second
SET: 72202.16 requests per second
GET: 94607.38 requests per second
INCR: 84961.77 requests per second
LPUSH: 78988.94 requests per second
RPUSH: 88652.48 requests per second
LPOP: 87950.75 requests per second
RPOP: 80971.66 requests per second
SADD: 80192.46 requests per second
HSET: 84317.03 requests per second
SPOP: 78125.00 requests per second
LPUSH (needed to benchmark LRANGE): 84175.09 requests per second
LRANGE_100 (first 100 elements): 52383.45 requests per second
LRANGE_300 (first 300 elements): 21547.08 requests per second
LRANGE_500 (first 450 elements): 14471.78 requests per second
LRANGE_600 (first 600 elements): 9383.50 requests per second
MSET (10 keys): 71225.07 requests per second

</code></pre>
<p>Você também pode limitar os testes a um subconjunto de comandos de sua escolha usando o parâmetro <code>-t</code>. O comando a seguir mostra as médias apenas dos comandos <code>GET</code> e<code>SET</code>:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">redis-benchmark <span class="highlight">-t set,get</span> -q
</li></ul></code></pre><pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>SET: 76687.12 requests per second
GET: 82576.38 requests per second
</code></pre>
<p>As opções padrão usarão 50 conexões paralelas para criar 100000 requisições ao servidor Redis. Se você deseja aumentar o número de conexões paralelas para simular um pico de uso, pode usar a opção <code>-c</code> para isso:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">redis-benchmark -t set,get -q <span class="highlight">-c 1000</span>
</li></ul></code></pre>
<p>Como isso usará 1000 conexões simultâneas em vez das 50 padrão, você deve esperar uma diminuição no desempenho:</p>
<pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>SET: 69444.45 requests per second
GET: 70821.53 requests per second
</code></pre>
<p>Se você quiser informações detalhadas na saída, poderá remover a opção <code>-q</code>. O comando a seguir usará 100 conexões paralelas para executar 1000000 requisições SET no servidor:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">redis-benchmark -t set -c 100 -n 1000000
</li></ul></code></pre>
<p>Você obterá uma saída semelhante a esta:</p>
<pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>====== SET ======
  1000000 requests completed in 11.29 seconds
  100 parallel clients
  3 bytes payload
  keep alive: 1

95.22% &lt;= 1 milliseconds
98.97% &lt;= 2 milliseconds
99.86% &lt;= 3 milliseconds
99.95% &lt;= 4 milliseconds
99.99% &lt;= 5 milliseconds
99.99% &lt;= 6 milliseconds
100.00% &lt;= 7 milliseconds
100.00% &lt;= 8 milliseconds
100.00% &lt;= 8 milliseconds
88605.35 requests per second

</code></pre>
<p>As configurações padrão usam 3 bytes para valores de chave. Você pode mudar isso com a opção <code>-d</code>. O comando a seguir fará o benchmark dos comandos <code>GET</code> e <code>SET</code> usando valores de chave de 1 MB:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">redis-benchmark -t set,get <span class="highlight">-d 1000000</span> -n 1000 -q
</li></ul></code></pre>
<p>Como o servidor está trabalhando com um payload muito maior dessa vez, espera-se uma diminuição significativa do desempenho:</p>
<pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>SET: 1642.04 requests per second
GET: 822.37 requests per second
</code></pre>
<p>É importante perceber que, embora esses números sejam úteis como uma maneira rápida de avaliar o desempenho de uma instância Redis, eles não representam a taxa de transferência máxima que uma instância Redis pode suportar. Usando <em><a href="https://redis.io/topics/pipelining">pipelining</a></em>, as aplicações podem enviar vários comandos ao mesmo tempo para melhorar o número de requisições por segundo que o servidor pode manipular. Com o <code>redis-benchmark</code>, você pode usar a opção <code>-P</code> para simular aplicações do mundo real que fazem uso desse recurso do Redis.</p>

<p>Para comparar a diferença, primeiro execute o comando <code>redis-benchmark</code> com valores padrão e sem pipelining, para os testes <code>GET</code> e <code>SET</code>:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">redis-benchmark -t get,set -q
</li></ul></code></pre><pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>SET: 86281.27 requests per second
GET: 89847.26 requests per second
</code></pre>
<p>O próximo comando executará os mesmos testes, mas fará o pipeline de 8 comandos juntos:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">redis-benchmark -t get,set -q <span class="highlight">-P 8</span>
</li></ul></code></pre><pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>SET: 653594.81 requests per second
GET: 793650.75 requests per second
</code></pre>
<p>Como você pode ver na saída, há uma melhoria substancial no desempenho com o uso de pipelining.</p>

<h2 id="checando-a-latência-com-redis-cli">Checando a Latência com <code>redis-cli</code></h2>

<p>Se você deseja uma medição simples do tempo médio que uma requisição leva para receber uma resposta, você pode usar o cliente Redis para verificar a latência média do servidor. No contexto do Redis, latência é uma medida de quanto tempo um comando <code>ping</code> leva para receber uma resposta do servidor.</p>

<p>O comando a seguir mostrará estatísticas de latência em tempo real para seu servidor Redis:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">redis-cli --latency
</li></ul></code></pre>
<p>Você obterá uma saída semelhante a esta, mostrando um número crescente de amostras e uma latência média variável:</p>
<pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>min: 0, max: 1, avg: 0.18 (970 samples)
</code></pre>
<p>Este comando continuará sendo executado indefinidamente. Você pode pará-lo com um <code>CTRL+C</code>.</p>

<p>Para monitorar a latência por um determinado período, você pode usar:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">redis-cli --latency-history
</li></ul></code></pre>
<p>Isso irá acompanhar as médias de latência ao longo do tempo, com um intervalo configurável definido como 15 segundos por padrão. Você obterá uma saída semelhante a esta:</p>
<pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>min: 0, max: 1, avg: 0.18 (1449 samples) -- 15.01 seconds range
min: 0, max: 1, avg: 0.16 (1449 samples) -- 15.00 seconds range
min: 0, max: 1, avg: 0.17 (1449 samples) -- 15.00 seconds range
min: 0, max: 1, avg: 0.17 (1444 samples) -- 15.01 seconds range
min: 0, max: 1, avg: 0.17 (1446 samples) -- 15.01 seconds range
min: 0, max: 1, avg: 0.17 (1449 samples) -- 15.00 seconds range
min: 0, max: 1, avg: 0.16 (1444 samples) -- 15.00 seconds range
min: 0, max: 1, avg: 0.17 (1445 samples) -- 15.01 seconds range
min: 0, max: 1, avg: 0.16 (1445 samples) -- 15.01 seconds range
&hellip;
</code></pre>
<p>Como o servidor Redis em nosso exemplo está ocioso, não há muita variação entre as amostras de latência. Se você tem um pico de uso, no entanto, isso deve ser refletido como um aumento na latência dentro dos resultados.</p>

<p>Se você deseja medir apenas a latência do <em>sistema</em>, pode usar <code>--intrinsic-latency</code> para isso. A latência intrínseca é inerente ao ambiente, dependendo de fatores como hardware, kernel, vizinhança do servidor e outros fatores que não são controlados pelo Redis.</p>

<p>Você pode ver a latência intrínseca como uma linha de base para o desempenho geral do Redis. O comando a seguir verificará a latência intrínseca do sistema, executando um teste por 30 segundos:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">redis-cli --intrinsic-latency 30
</li></ul></code></pre>
<p>Você deve obter uma saída semelhante a esta:</p>
<pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>&hellip;

498723744 total runs (avg latency: 0.0602 microseconds / 60.15 nanoseconds per run).
Worst run took 22975x longer than the average latency.
</code></pre>
<p>Comparar os dois testes de latência pode ser útil para identificar gargalos de hardware ou sistema que podem afetar o desempenho do seu servidor Redis. Considerando que a latência total de uma requisição para o nosso servidor de exemplo tem uma média de 0,18 microssegundos para concluir, uma latência intrínseca de 0,06 microssegundos significa que um terço do tempo total da requisição é gasto pelo sistema em processos que não são controlados pelo Redis.</p>

<h2 id="usando-a-ferramenta-memtier-benchmark">Usando a Ferramenta Memtier Benchmark</h2>

<p>O <a href="https://github.com/RedisLabs/memtier_benchmark">Memtier</a> é uma ferramenta de benchmark de alto rendimento para Redis e <a href="https://memcached.org/">Memcached</a> criada pelo Redis Labs. Embora muito parecido com o <code>redis-benchmark</code> em vários aspectos, o Memtier possui várias opções de configuração que podem ser ajustadas para emular melhor o tipo de carga que você pode esperar no seu servidor Redis, além de oferecer suporte a cluster.</p>

<p>Para instalar o Memtier em seu servidor, você precisará compilar o software a partir do código-fonte. Primeiro, instale as dependências necessárias para compilar o código:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo apt-get install build-essential autoconf automake libpcre3-dev libevent-dev pkg-config zlib1g-dev
</li></ul></code></pre>
<p>Em seguida, vá para o seu diretório home e clone o projeto <code>memtier_benchmark</code> do <a href="https://github.com/RedisLabs/memtier_benchmark">repositório Github</a>:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">cd
</li><li class="line" prefix="$">git clone https://github.com/RedisLabs/memtier_benchmark.git
</li></ul></code></pre>
<p>Navegue para o diretório do projeto e execute o comando <code>autoreconf</code> para gerar os scripts de configuração do aplicativo:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">cd memtier_benchmark
</li><li class="line" prefix="$">autoreconf -ivf
</li></ul></code></pre>
<p>Execute o script <code>configure</code> para gerar os artefatos do aplicativo necessários para a compilação:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">./configure
</li></ul></code></pre>
<p>Agora execute <code>make</code> para compilar o aplicativo:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">make
</li></ul></code></pre>
<p>Após a conclusão da compilação, você pode testar o executável com:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">./memtier_benchmark --version
</li></ul></code></pre>
<p>Isso lhe fornecerá a seguinte saída:</p>
<pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>memtier_benchmark 1.2.17
Copyright (C) 2011-2017 Redis Labs Ltd.
This is free software.  You may redistribute copies of it under the terms of
the GNU General Public License &lt;http://www.gnu.org/licenses/gpl.html&gt;.
There is NO WARRANTY, to the extent permitted by law.
</code></pre>
<p>A lista a seguir contém algumas das opções mais comuns usadas com o comando <code>memtier_benchmark</code>:</p>

<ul>
<li><code>-s</code>: Host do Servidor. O padrão é <strong>localhost</strong>.</li>
<li><code>-p</code>: Porta do Servidor. O padrão é <code>6379</code>.</li>
<li><code>-a</code>: Autentica requisições usando a senha fornecida.</li>
<li><code>-n</code>: Número de requisições por cliente (o padrão é 10000).</li>
<li><code>-c</code>: Número de clientes (o padrão é 50).</li>
<li><code>-t</code>: Número de threads (o padrão é 4).</li>
<li><code>--pipeline</code>: Ativar pipelining.</li>
<li><code>--ratio</code>: Relação entre os comandos <code>SET</code> e <code>GET</code>, o padrão é 1:10.</li>
<li><code>--hide-histogram</code>: Oculta informações detalhadas de saída.</li>
</ul>

<p>A maioria dessas opções é muito semelhante às opções presentes no <code>redis-benchmark</code>, mas o Memtier testa o desempenho de uma maneira diferente. Para simular melhor os ambientes comuns do mundo real, o benchmark padrão realizado pelo <code>memtier_benchmark</code> testará apenas as solicitações <code>GET</code> e <code>SET</code>, na proporção de 1 a 10. Com 10 operações GET para cada operação SET no teste, esse arranjo é mais representativo de uma aplicação web comum usando o Redis como banco de dados ou cache. Você pode ajustar o valor da taxa com a opção <code>--ratio</code>.</p>

<p>O comando a seguir executa o <code>memtier_benchmark</code> com as configurações padrão, fornecendo apenas informações de saída de alto nível:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">./memtier_benchmark --hide-histogram
</li></ul></code></pre>
<span class='note'><p>
<strong>Nota</strong>: se você configurou seu servidor Redis para exigir autenticação, você deve fornecer a opção <code>-a</code> junto com sua senha Redis ao comando <code>memtier_benchmark</code>:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">./memtier_benchmark --hide-histogram -a <span class="highlight">sua_senha_redis</span>
</li></ul></code></pre>
<p></p></span>

<p>Você verá resultados semelhantes a este:</p>
<pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>&hellip;

4         Threads
50        Connections per thread
10000     Requests per client


ALL STATS
=========================================================================
Type         Ops/sec     Hits/sec   Misses/sec      Latency       KB/sec 
-------------------------------------------------------------------------
Sets         8258.50          ---          ---      2.19800       636.05 
Gets        82494.28     41483.10     41011.18      2.19800      4590.88 
Waits           0.00          ---          ---      0.00000          --- 
Totals      90752.78     41483.10     41011.18      2.19800      5226.93 
</code></pre>
<p>De acordo com esta execução do <code>memtier_benchmark</code>, nosso servidor Redis pode executar cerca de 90 mil operações por segundo na proporção 1:10 <code>SET</code>/<code>GET</code>.</p>

<p>É importante observar que cada ferramenta de benchmark possui seu próprio algoritmo para teste de desempenho e apresentação de dados. Por esse motivo, é normal ter resultados ligeiramente diferentes no mesmo servidor, mesmo utilizando configurações semelhantes.</p>

<h2 id="conclusão">Conclusão</h2>

<p>Neste guia, demonstramos como executar testes de benchmark em um servidor Redis usando duas ferramentas distintas: o <code>redis-benchmark</code> incluído e a ferramenta <code>memtier_benchmark</code> desenvolvida pelo Redis Labs. Também vimos como verificar a latência do servidor usando <code>redis-cli</code>. Com base nos dados obtidos com esses testes, você entenderá melhor o que esperar do servidor Redis em termos de desempenho e quais são os gargalos da sua configuração atual.</p>
