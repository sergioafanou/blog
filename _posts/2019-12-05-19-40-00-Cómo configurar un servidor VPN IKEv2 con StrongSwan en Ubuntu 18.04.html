---
layout: post
title: Cómo configurar un servidor VPN IKEv2 con StrongSwan en Ubuntu 18.04
network: digitalocean
date: December 05, 2019 at 07:40PM
url: https://www.digitalocean.com/community/tutorials/como-configurar-un-servidor-vpn-ikev2-con-strongswan-en-ubuntu-18-04-es
image: https://assets.digitalocean.com/articles/ikevpn_ubuntu_1604/4PN0vT6.png
tags: docker
feedtitle: DigitalOcean Community Tutorials
feedurl: https://www.digitalocean.com/community/tutorials
author: DigitalOcean
---
<h3 id="introducción">Introducción</h3>

<p>Un red virtual privad,(VPN, por sus siglas en inglés) le permite cifrar de forma segura el tráfico mientras tiene lugar a través de redes no confiables, como las de una cafetería, una sala de conferencias o un aeropuerto.</p>

<p><a href="https://en.wikipedia.org/wiki/Internet_Key_Exchange">IKEv2</a>, o Internet Key Exchange v2, es un protocolo que permite la implementación directa de túneles de IPSec entre el servidor y los clientes. En las implementaciones de VPN IKEv2, IPSec proporciona cifrado para el tráfico de red. IKEv2 es compatible de forma nativa con algunas plataformas (OS X 10.11+, iOS 9.1+ y Windows 10) sin necesidad de aplicaciones adicionales y maneja los picos de los clientes sin problemas.</p>

<p>A través de este tutorial, configurará un servidor VPN IKEv2 con ayuda <a href="https://www.strongswan.org/">de StrongSwan</a> en un servidor Ubuntu 18.04 y se conectará a este desde clientes de Windows, macOS, Ubuntu, iOS y Android.</p>

<h2 id="requisitos-previos">Requisitos previos</h2>

<p>Para completar este tutorial, necesitará lo siguiente:</p>

<ul>
<li>Un servidor de <a href="https://www.digitalocean.com/community/tutorials/initial-server-setup-with-ubuntu-18-04">Ubuntu 18.04 configurado conforme a la</a>guía de configuración inicial para servidores de Ubuntu 18.04, incluidos un usuario <code>sudo</code> no root y un firewall.</li>
</ul>

<h2 id="paso-1-instalar-strongswan">Paso 1: Instalar StrongSwan</h2>

<p>Primero, instalaremos StrongSwan, un demonio IPSec de código abierto que configuraremos para que funcione como nuestro servidor VPN. De igual modo, instalaremos el componente de infraestructura de clave pública que nos permita crear una autoridad de certificación para proporcionar las credenciales destinadas a nuestra infraestructura.</p>

<p>Actualice la caché del paquete local e instale el software escribiendo lo siguiente:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo apt update
</li><li class="line" prefix="$">sudo apt install strongswan strongswan-pki
</li></ul></code></pre>
<p>Ahora que se instaló todo, crearemos nuestros certificados.</p>

<h2 id="paso-2-crear-una-autoridad-de-certificación">Paso 2: Crear una autoridad de certificación</h2>

<p>Un servidor IKEv2 requiere un certificado para identificarse ante los clientes. Para que podamos crear el certificado requerido, el paquete <code>strongswan-pki</code> incluye una utilidad para generar una autoridad de certificación y certificados de servidor. Para comenzar, crearemos algunos directorios para almacenar todos los activos en los que trabajaremos. La estructura de directorios coincide con algunos de los directorios de <code>/etc/ipsec.d</code>, a donde moveremos todos los elementos que creemos en algún momento. Bloquearemos los permisos para que otros usuarios no puedan ver nuestros archivos privados:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">mkdir -p ~/pki/{cacerts,certs,private}
</li><li class="line" prefix="$">chmod 700 ~/pki
</li></ul></code></pre>
<p>Ahora que disponemos de una estructura de directorios para almacenar todo, podemos generar una clave de root. Será una clave RSA de 4096 bits que se usará para firmar nuestra autoridad de certificación de root.</p>

<p>Ejecute estos comandos para generar la clave:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">ipsec pki --gen --type rsa --size 4096 --outform pem &gt; ~/pki/private/ca-key.pem
</li></ul></code></pre>
<p>Ahora que contamos con una clave, podemos crear nuestra autoridad de certificación de root usando la clave para firmar nuestro certificado de root:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">ipsec pki --self --ca --lifetime 3650 --in ~/pki/private/ca-key.pem \
</li><li class="line" prefix="$">    --type rsa --dn "CN=VPN root CA" --outform pem &gt; ~/pki/cacerts/ca-cert.pem
</li></ul></code></pre>
<p>Puede cambiar los valores de *nombre distinguido *(DN) por otra cosa si lo desea. El nombre común aquí es únicamente el indicador, de modo que no tiene que coincidir con nada en su infraestructura.</p>

<p>Ahora que nuestra autoridad de certificación de root está lista, podemos crear un certificado que usará el servidor de VPN.</p>

<h2 id="paso-3-generar-un-certificado-para-el-servidor-de-vpn">Paso 3: Generar un certificado para el servidor de VPN</h2>

<p>Ahora, crearemos un certificado y la contraseña para el servidor de VPN. Esta certificación permitirá a los clientes verificar la autenticidad del servidor usando la certificación de CA que acabamos de generar.</p>

<p>Primero, cree una clave privada para el servidor de VPN con el siguiente comando:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">ipsec pki --gen --type rsa --size 4096 --outform pem &gt; ~/pki/private/server-key.pem
</li></ul></code></pre>
<p>Ahora, cree y firme el certificado del servidor de VPN con la clave de la autoridad de certificación que creó en el paso anterior. Ejecute el siguiente comando, pero cambie los campos de nombre común (CN) y nombre alternativo de sujeto (SAN) por el nombre de DNS o la dirección IP de su servidor de VPN:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">ipsec pki --pub --in ~/pki/private/server-key.pem --type rsa \
</li><li class="line" prefix="$">    | ipsec pki --issue --lifetime 1825 \
</li><li class="line" prefix="$">        --cacert ~/pki/cacerts/ca-cert.pem \
</li><li class="line" prefix="$">        --cakey ~/pki/private/ca-key.pem \
</li><li class="line" prefix="$">        --dn "CN=<span class="highlight">server_domain_or_IP</span>" --san "<span class="highlight">server_domain_or_IP</span>" \
</li><li class="line" prefix="$">        --flag serverAuth --flag ikeIntermediate --outform pem \
</li><li class="line" prefix="$">    &gt;  ~/pki/certs/server-cert.pem
</li></ul></code></pre>
<p>Ahora que generamos todos los archivos TLS/SSL que necesita StrongSwan, podemos moverlos a su lugar en el directorio <code>/etc/ipsec.d</code> escribiendo lo siguiente:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo cp -r ~/pki/* /etc/ipsec.d/
</li></ul></code></pre>
<p>En este paso, creamos un par de certificados que podrían usarse para proteger las comunicaciones entre el cliente y el servidor. También, firmamos los certificados con la clave de CA, para que el cliente pueda verificar la autenticidad del servidor de VPN usando el certificado de CA. Ahora que tenemos listos todos los certificados listos, configuraremos el software.</p>

<h2 id="paso-4-configurar-strongswan">Paso 4: Configurar StrongSwan</h2>

<p>StrongSwan tiene un archivo de configuración predeterminado con algunos ejemplos, pero tendremos que hacer la mayor parte de la configuración por nuestra cuenta. Haremos una copia de seguridad del archivo a modo de referencia antes de empezar de cero:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo mv /etc/ipsec.conf{,.original}
</li></ul></code></pre>
<p>Cree y abra un nuevo archivo de configuración vacío escribiendo lo siguiente:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo nano /etc/ipsec.conf
</li></ul></code></pre>
<p>Primero, le diremos a StrongSwan que registre los estados de los demonios para depurar y permitir conexiones duplicadas. Añada estas líneas al archivo:</p>
<div class="code-label " title="/etc/ipsec.conf">/etc/ipsec.conf</div><pre class="code-pre "><code langs="">config setup
    charondebug="ike 1, knl 1, cfg 0"
    uniqueids=no
</code></pre>
<p>Luego, crearemos una sección de configuración para nuestra VPN. También le indicaremos a StrongSwan que cree túneles de VPN IKEv2 y cargue de forma automática esta sección de configuración cuando se inicie. Agregue las siguientes líneas al archivo:</p>
<div class="code-label " title="/etc/ipsec.conf">/etc/ipsec.conf</div><pre class="code-pre "><code langs="">. . .
conn ikev2-vpn
    auto=add
    compress=no
    type=tunnel
    keyexchange=ikev2
    fragmentation=yes
    forceencaps=yes
</code></pre>
<p>También configuraremos la detección de pares inactivos para eliminar cualquier conexión “pendiente” en caso de que el cliente se desconecte de forma inesperada. Agregue estas líneas:</p>
<div class="code-label " title="/etc/ipsec.conf">/etc/ipsec.conf</div><pre class="code-pre "><code langs="">. . .
conn ikev2-vpn
    . . .
    dpdaction=clear
    dpddelay=300s
    rekey=no
</code></pre>
<p>Luego, configuraremos los parámetros IPSec del lado (izquierdo) del servidor. Agregue esto al archivo:</p>
<div class="code-label " title="/etc/ipsec.conf">/etc/ipsec.conf</div><pre class="code-pre "><code langs="">. . .
conn ikev2-vpn
    . . .
    left=%any
    leftid=<span class="highlight">@server_domain_or_IP</span>
    leftcert=server-cert.pem
    leftsendcert=always
    leftsubnet=0.0.0.0/0
</code></pre>
<span class='note'><p>
<strong>Nota</strong>: Cuando configure el ID del servidor (<code>leftid</code>), solo incluya el carácter <code>@</code> si su servidor de VPN se identificará por un nombre de dominio:</p>
<pre class="code-pre "><code langs="">    leftid=<span class="highlight">@vpn.example.com</span>
</code></pre>
<p>Si el servidor se identifica por su dirección IP, simplemente introdúzcala:</p>
<pre class="code-pre "><code langs="">    leftid=<span class="highlight">203.0.113.7</span>
</code></pre>
<p></p></span>

<p>A continuación, podemos configurar los parámetros de IPSec del lado (derecho) del cliente, como los rangos de direcciones IP privadas y los servidores DNS que se usarán:</p>
<div class="code-label " title="/etc/ipsec.conf">/etc/ipsec.conf</div><pre class="code-pre "><code langs="">. . .
conn ikev2-vpn
    . . .
    right=%any
    rightid=%any
    rightauth=eap-mschapv2
    rightsourceip=10.10.10.0/24
    rightdns=8.8.8.8,8.8.4.4
    rightsendcert=never
</code></pre>
<p>Por último, indicaremos a StrongSwan que solicite a los clientes las credenciales de los usuarios cuando se conecten:</p>
<div class="code-label " title="/etc/ipsec.conf">/etc/ipsec.conf</div><pre class="code-pre "><code langs="">. . .
conn ikev2-vpn
    . . .
    eap_identity=%identity
</code></pre>
<p>El archivo de configuración debe tener el siguiente aspecto:</p>
<div class="code-label " title="/etc/ipsec.conf">/etc/ipsec.conf</div><pre class="code-pre "><code langs="">config setup
    charondebug="ike 1, knl 1, cfg 0"
    uniqueids=no

conn ikev2-vpn
    auto=add
    compress=no
    type=tunnel
    keyexchange=ikev2
    fragmentation=yes
    forceencaps=yes
    dpdaction=clear
    dpddelay=300s
    rekey=no
    left=%any
    leftid=<span class="highlight">@server_domain_or_IP</span>
    leftcert=server-cert.pem
    leftsendcert=always
    leftsubnet=0.0.0.0/0
    right=%any
    rightid=%any
    rightauth=eap-mschapv2
    rightsourceip=10.10.10.0/24
    rightdns=8.8.8.8,8.8.4.4
    rightsendcert=never
    eap_identity=%identity
</code></pre>
<p>Guarde y cierre el archivo una vez que haya verificado que realizó la configuración como se indica.</p>

<p>Ahora que configuramos los parámetros de VPN, crearemos una cuenta para que nuestros usuarios puedan conectarse al servidor.</p>

<h2 id="paso-5-configurar-la-autenticación-de-vpn">Paso 5: Configurar la autenticación de VPN</h2>

<p>Nuestro servidor de VPN ahora está configurado para aceptar conexiones de clientes, pero aún no establecimos credenciales. Tendremos que  realizar algunas configuraciones en un archivo de configuración especial llamado <code>ipsec.secrets</code>:</p>

<ul>
<li>Debemos indicar a StrongSwan dónde encontrar la clave privada para el certificado de nuestro servidor, de modo que este últio pueda autenticar a los clientes.</li>
<li>También, tendremos que configurar una lista de usuarios a quienes se les permitirá conectarse al VPN.</li>
</ul>

<p>Abramos el archivos de secretos para editarlo:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo nano /etc/ipsec.secrets
</li></ul></code></pre>
<p>Primero, le indicaremos a StrongSwan dónde encontrar nuestra clave privada:</p>
<div class="code-label " title="/etc/ipsec.secrets">/etc/ipsec.secrets</div><pre class="code-pre "><code langs="">: RSA "server-key.pem"
</code></pre>
<p>Luego, definiremos las credenciales de los usuarios. Puede crear cualquier combinación de nombre de usuario o contraseña que desee:</p>
<div class="code-label " title="/etc/ipsec.secrets">/etc/ipsec.secrets</div><pre class="code-pre "><code langs=""><span class="highlight">your_username</span> : EAP <span class="highlight">"your_password"</span>
</code></pre>
<p>Guarde y cierre el archivo. Ahora que terminamos de trabajar con los parámetros de VPN, reiniciaremos el servicio de VPN para que se aplique nuestra configuración:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo systemctl restart strongswan
</li></ul></code></pre>
<p>Ahora que el servidor de VPN quedó totalmente configurado, tanto con opciones de servidor como con las credenciales de usuarios, es el momento de proseguir con la configuración de la parte más importante: el firewall.</p>

<h2 id="paso-6-configurar-el-firewall-y-el-reenvío-de-ip-de-kernel">Paso 6: Configurar el firewall y el reenvío de IP de kernel</h2>

<p>Una vez completada la configuración de StrongSwan, debemos configurar el firewall para reenviar y permitir el tráfico de VPN.</p>

<p>Si siguió el tutorial de los requisitos previos, debería tener habilitado un firewall UFW muy básico. Si aún no tiene configurado UFW, puede crear una configuración referencial y habilitarla escribiendo lo siguiente:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo ufw allow OpenSSH
</li><li class="line" prefix="$">sudo ufw enable
</li></ul></code></pre>
<p>Ahora, agregue una regla para permitir el tráfico UDP a los puertos IPSec estándares 500 y 4500:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo ufw allow 500,4500/udp
</li></ul></code></pre>
<p>A continuación, abriremos uno de los archivos de configuración de UFW para agregar algunas políticas de bajo nivel a fin de dirigir y reenviar paquetes IPSec. Antes de hacerlo, debemos determinar la interfaz de red de nuestro servidor que se usa para acceder a Internet. Podemos encontrarlo consultando la interfaz asociada a la ruta predeterminada:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">ip route | grep default
</li></ul></code></pre>
<p>Su interfaz pública debe ir después de la palabra “dev”. Por ejemplo, este resultado muestra la interfaz llamada <code>eth0</code>, que se resalta a continuación:</p>
<pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>default via 203.0.113.7 dev <span class="highlight">eth0</span> proto static
</code></pre>
<p>Cuando tenga una interfaz de red pública, abra el archivo <code>/etc/ufw/before.rules</code> en su editor de texto:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo nano /etc/ufw/before.rules
</li></ul></code></pre>
<p>Cerca de la parte superior del archivo (antes de la línea <code>*filter</code>), agregue el siguiente bloque de configuración:</p>
<div class="code-label " title="/etc/ufw/before.rules">/etc/ufw/before.rules</div><pre class="code-pre "><code langs=""><span class="highlight">*nat</span>
<span class="highlight">-A POSTROUTING -s 10.10.10.0/24 -o eth0 -m policy --pol ipsec --dir out -j ACCEPT</span>
<span class="highlight">-A POSTROUTING -s 10.10.10.0/24 -o eth0 -j MASQUERADE</span>
<span class="highlight">COMMIT</span>

<span class="highlight">*mangle</span>
<span class="highlight">-A FORWARD --match policy --pol ipsec --dir in -s 10.10.10.0/24 -o eth0 -p tcp -m tcp --tcp-flags SYN,RST SYN -m tcpmss --mss 1361:1536 -j TCPMSS --set-mss 1360</span>
<span class="highlight">COMMIT</span>

*filter
:ufw-before-input - [0:0]
:ufw-before-output - [0:0]
:ufw-before-forward - [0:0]
:ufw-not-local - [0:0]
. . .
</code></pre>
<p>Cambie cada instancia de <code>eth0</code> en la configuración superior para que coincida con el nombre de interfaz que encontró con <code>ip route</code>. Las líneas <code>*nat</code> crean reglas para que el firewall pueda dirigir y manipular de forma correcta el tráfico entre los clientes de VPN e Internet. La línea <code>*mangle</code> ajusta el tamaño máximo del segmento de paquete para evitar problemas potenciales con determinados clientes de VPN.</p>

<p>A continuación, después de las líneas <code>*filter</code> y de definición de cadenas, agregue un bloque más de configuración:</p>
<div class="code-label " title="/etc/ufw/before.rules">/etc/ufw/before.rules</div><pre class="code-pre "><code langs="">. . .
*filter
:ufw-before-input - [0:0]
:ufw-before-output - [0:0]
:ufw-before-forward - [0:0]
:ufw-not-local - [0:0]

<span class="highlight">-A ufw-before-forward --match policy --pol ipsec --dir in --proto esp -s 10.10.10.0/24 -j ACCEPT</span>
<span class="highlight">-A ufw-before-forward --match policy --pol ipsec --dir out --proto esp -d 10.10.10.0/24 -j ACCEPT</span>
</code></pre>
<p>Estas líneas solicitan al firewall que reenvíe el tráfico <a href="https://wiki.wireshark.org/ESP">de carga de seguridad</a> encapsuladora (ESP), para que los clientes de VPN puedan conectarse. ESP proporciona seguridad adicional para nuestros paquetes de VPN a medida que circulan por redes no confiables.</p>

<p>Cuando termine, guarde y cierre el archivo.</p>

<p>Antes de reiniciar el firewall, cambiaremos algunos parámetros de kernel de red para permitir el enrutamiento de una interfaz a otra. Abra el archivo de configuración de parámetros de kernel de UFW.</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo nano /etc/ufw/sysctl.conf
</li></ul></code></pre>
<p>Tendremos que realizar algunas configuraciones aquí:</p>

<ul>
<li>Primero, habilitaremos el reenvío de paquetes IPv4.</li>
<li>Inhabilitaremos la detección de MTU de ruta para evitar problemas de fragmentación de paquetes.</li>
<li>Tampoco aceptaremos redireccionamientos de ICMP ni enviaremos redireccionamientos de ICMP para prevenir la presencia de <a href="https://en.wikipedia.org/wiki/Man-in-the-middle_attack">atacantes desconocidos</a>.</li>
</ul>

<p>Los cambios que debe hacer en el archivo están resaltados en el siguiente código:</p>
<div class="code-label " title="/etc/ufw/sysctl.conf">/etc/ufw/sysctl.conf</div><pre class="code-pre "><code langs="">
. . .

# Enable forwarding
# Uncomment the following line
<span class="highlight">net/ipv4/ip_forward=1</span>

. . .

# Do not accept ICMP redirects (prevent MITM attacks)
# Ensure the following line is set
<span class="highlight">net/ipv4/conf/all/accept_redirects=0</span>

# Do not send ICMP redirects (we are not a router)
# Add the following lines
<span class="highlight">net/ipv4/conf/all/send_redirects=0</span>
<span class="highlight">net/ipv4/ip_no_pmtu_disc=1</span>
</code></pre>
<p>Guarde el archivo cuando termine. UFW aplicará estos cambios la próxima vez que se inicie.</p>

<p>Ahora podemos activar todos nuestros cambios desactivando y reactivando el firewall:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo ufw disable
</li><li class="line" prefix="$">sudo ufw enable
</li></ul></code></pre>
<p>Se le solicitará confirmar el proceso. Escriba <code>Y</code> para activar UFW nuevamente con las configuraciones nuevas.</p>

<h2 id="paso-7-probar-la-conexión-de-vpn-en-windows-ios-y-macos">Paso 7: Probar la conexión de VPN en Windows, iOS y macOS</h2>

<p>Ahora que todo está configurado, es hora de probarlo. Primero, deberá copiar el certificado de CA que creó e instalarlo en sus dispositivos clientes que se conectarán a la VPN. La forma más sencilla de hacerlo es iniciar sesión en su servidor y mostrar el contenido del archivo de certificado:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">cat /etc/ipsec.d/cacerts/ca-cert.pem
</li></ul></code></pre>
<p>Verá un resultado similar a este:</p>
<pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>-----BEGIN CERTIFICATE-----
MIIFQjCCAyqgAwIBAgIIFkQGvkH4ej0wDQYJKoZIhvcNAQEMBQAwPzELMAkGA1UE

. . .

EwbVLOXcNduWK2TPbk/+82GRMtjftran6hKbpKGghBVDPVFGFT6Z0OfubpkQ9RsQ
BayqOb/Q
-----END CERTIFICATE-----
</code></pre>
<p>Copie este resultado a su computadora, incluidas las líneas <code>-----BEGIN CERTIFICATE-----</code> y <code>-----END CERTIFICATE-----</code>, y guárdelo en un archivo con un nombre que pueda reconocer, como <code>ca-cert.pem</code>. Asegúrese de que el archivo que cree tenga la extensión <code>.pem</code>.</p>

<p>De forma alternativa, <a href="https://www.digitalocean.com/community/tutorials/how-to-use-sftp-to-securely-transfer-files-with-a-remote-server">use SFTP para transferir el archivo a su computadora</a>.</p>

<p>Una vez que descargue el archivo <code>ca-cert.pem</code> a su computadora, podrá configurar la conexión a la VPN.</p>

<h3 id="establecer-conexión-desde-windows">Establecer conexión desde Windows</h3>

<p>Primero, importe el certificado de root siguiendo estos pasos:</p>

<ol>
<li>Pulse <code>WINDOWS+R</code> para abrir el diálogo <strong>Ejecutar</strong> e ingrese <code>mmc.exe</code> para iniciar la Consola de administración de Windows.</li>
<li>En el menú <strong>Archivo</strong>, diríjase a <strong>Agregar o quitar complemento</strong>, seleccione <strong>Certificados</strong> en la lista de complementos disponibles y haga clic en <strong>Agregar</strong>.</li>
<li>Nuestro propósito es que la VPN funcione con cualquier usuario. Por ello, debe seleccionar <strong>Cuenta de equipo</strong> y hacer clic en <strong>Siguiente</strong>.</li>
<li>Realizaremos algunas configuraciones en la computadora local. Seleccione <strong>Equipo local</strong> y luego haga clic en <strong>Finalizar</strong>.</li>
<li><p>Debajo del nodo <strong>Raíz de consola</strong>, expanda la entrada <strong>Certificados (equipo local)</strong>, expanda <strong>Entidades de certificación raíz de confianza</strong>, y seleccione la entrada <strong>Certificados</strong>: <img src="https://assets.digitalocean.com/articles/ikevpn_ubuntu_1604/4PN0vT6.png" alt="Vista de certificados">.</p></li>
<li><p>En el menú <strong>Acción</strong>, seleccione <strong>Todas las tareas</strong> y haga clic en <strong>Importar&hellip;</strong> para visualizar el Asistente para importación de certificados. Haga clic en <strong>Siguiente</strong> para pasar la introducción.</p></li>
<li><p>En la pantalla <strong>Archivo para importar</strong>, presione el botón <strong>Examinar&hellip;</strong> y seleccione el archivo de certificado que guardó. Luego haga clic en <strong>Siguiente</strong>.</p></li>
<li><p>Asegúrese de que el valor de <strong>Almacén de certificados</strong> sea <strong>Entidades de certificación raíz de confianza</strong> y haga clic en <strong>Siguiente</strong>.</p></li>
<li><p>Haga clic en <strong>Finalizar</strong> para importar el certificado.</p></li>
</ol>

<p>Luego, configure la VPN siguiendo estos pasos:</p>

<ol>
<li>Inicie el <strong>Panel de control</strong> y diríjase a <strong>Centro de redes y recursos compartidos</strong>.</li>
<li>Haga clic en <strong>Configurar una nueva conexión o red</strong> y luego seleccione <strong>Conectarse a un área de trabajo</strong>.</li>
<li>Seleccione <strong>Usar mi conexión a Internet (VPN)</strong>.</li>
<li>Ingrese la información del servidor VPN. Ingrese el nombre del dominio o la dirección IP del servidor en el campo <strong>Dirección de Internet</strong> y luego complete <strong>Nombre de destino</strong> con algo que describa su conexión de VPN. Luego haga clic en <strong>Conectar</strong>.</li>
</ol>

<p>Se podrá ver su nueva conexión de VPN en la lista de redes. Seleccione la VPN y haga clic en <strong>Conectar</strong>. Se le solicitará su nombre de usuario y contraseña. Escríbalos y haga clic ****en Aceptar. Con esto, establecerá la conexión.</p>

<h3 id="establecer-conexión-desde-macos">Establecer conexión desde macOS</h3>

<p>Siga estos pasos para importar el certificado:</p>

<ol>
<li>Haga doble clic en el archivo de certificado.<strong>Acceso a Llaveros</strong> aparecerá con el diálogo “Acceso a Llaveros está intentando modificar el sistema de administración de contraseñas. Ingrese su contraseña para autorizarlo”.</li>
<li>Ingrese su contraseña y haga clic en <strong>Modificar llavero</strong>.</li>
<li>Haga clic en el certificado de VPN recién importado. Con esto, se abrirá abre una pequeña ventana de propiedades en la que podrá especificar los niveles de confianza. Fije <strong>Seguridad de IP (IPSec)</strong> en <strong>Confiar siempre</strong>. Se solicitará que ingrese su contraseña nuevamente. Esta configuración guarda de forma automática la contraseña una vez que se ingresa.</li>
</ol>

<p>Ahora que el certificado es importante y confiable, configure la conexión de VPN siguiendo estos pasos:</p>

<ol>
<li>Diríjase a <strong>Preferencias del Sistema</strong> y seleccione <strong>Red</strong>.</li>
<li>Haga clic en el botón pequeño de “adición” en la parte inferior izquierda de la lista de redes.</li>
<li>En la ventana emergente que aparecerá, fije el valor de <strong>Interfaz</strong> en <strong>VPN</strong> y el de <strong>Tipo de VPN</strong> en <strong>IKEv2</strong>, y asigne un nombre a la conexión.</li>
<li>En los campos <strong>Servidor</strong> y <strong>ID remoto</strong>, ingrese el nombre de dominio o la dirección IP del servidor. Deje <strong>ID local</strong> en blanco.</li>
<li>Haga clic en <strong>Ajustes de autenticación</strong>, seleccione <strong>Nombre del usuario</strong>, e ingrese el nombre de usuario y la contraseña que configuró para su usuario de VPN. Luego haga clic en <strong>Aceptar</strong>.</li>
</ol>

<p>Por último, haga clic en <strong>Conectar</strong> para conectarse a la VPN. Con esto, debería establecer la conexión con la VPN.</p>

<h3 id="establecer-conexión-desde-ubuntu">Establecer conexión desde Ubuntu</h3>

<p>Para conectarse desde un equipo con Ubuntu, puede configurar y administrar StrongSwan como un servicio o usar un comando único cada vez que desee conectarse. Se proporcionan instrucciones para ambas alternativas.</p>

<h4 id="administrar-strongswan-como-un-servicio">Administrar StrongSwan como un servicio</h4>

<ol>
<li>Actualice la cache de su paquete local: <code>sudo apt update</code>.</li>
<li>Instale StrongSwan y el software relacionado: <code>libcharon sudo apt install</code>.</li>
<li>Copie el certificado CA al directorio <code>/etc/ipsec.d/cacerts</code>: <code>sudo cp <span class="highlight">/tmp/ca-cert.pem</span> /etc/ipsec.d/cacerts</code>.</li>
<li>Inhabilite StrongSwan para que la VPN no se inicie de forma automática: <code>sudo systemctl disable --now strongswan</code>.</li>
<li>Configure su nombre de usuario y contraseña de VPN en el archivo <code>/etc/ipsec.secrets</code>: <code><span class="highlight">your_username: EAP </span>“your_password”&lt;^&gt;</code>.</li>
<li>Edite el archivo <code>/etc/ipsec.conf</code> para definir su configuración.</li>
</ol>
<div class="code-label " title="/etc/ipsec.conf">/etc/ipsec.conf</div><pre class="code-pre "><code langs="">config setup

conn ikev2-rw
    right=<span class="highlight">server_domain_or_IP</span>
    # This should match the `leftid` value on your server's configuration
    rightid=<span class="highlight">server_domain_or_IP</span>
    rightsubnet=0.0.0.0/0
    rightauth=pubkey
    leftsourceip=%config
    leftid=<span class="highlight">username</span>
    leftauth=eap-mschapv2
    eap_identity=%identity
    auto=start
</code></pre>
<p>Para conectarse a la VPN, escriba lo siguiente:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo systemctl start strongswan
</li></ul></code></pre>
<p>Para desconectarse nuevamente, escriba lo siguiente:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo systemctl stop strongswan
</li></ul></code></pre>
<h4 id="utilizar-un-cliente-simple-para-conexiones-únicas">Utilizar un cliente simple para conexiones únicas</h4>

<ol>
<li>Actualice la caché de su paquete local: <code>sudo apt update</code>.</li>
<li>Instale <code>charon-cmd</code> y el software relacionado: <code>sudo apt install charon-cmd</code>.</li>
<li>Vaya al directorio al que copió el certificado de CA: <code>cd <span class="highlight">/path/to/ca-cert.pem</span></code>.</li>
<li>Conéctese al servidor de VPN con <code>charon-cmd</code> usando el certificado de CA del servidor, la dirección IP del servidor de VPN y el usuario que configuró: <code>sudo charon-cmd --cert ca-cert.pem --host <span class="highlight">vpn_domain_or_IP</span> --identity <span class="highlight">your_username</span></code>.</li>
<li>Cuando se le solicite, brinde la contraseña del usuario de la VPN.</li>
</ol>

<p>Con esto, debería establecer la conexión con la VPN. Para desconectarse, pulse <code>CTRL+C</code> y espere que la conexión se cierre.</p>

<h3 id="establecer-conexión-desde-ios">Establecer conexión desde iOS</h3>

<p>Para configurar la conexión de VPN en un dispositivo iOS, siga estos pasos:</p>

<ol>
<li>Envíese un correo electrónico con el certificado de root adjunto.</li>
<li>Abra el correo electrónico en su dispositivo iOS, toque el archivo del certificado adjunto y luego seleccione <strong>Instalar</strong> e ingrese su código de acceso. Una vez que se instale, pulse <strong>Listo</strong>.</li>
<li>Diríjase a <strong>Configuración</strong>, <strong>General</strong>, <strong>VPN</strong> y toque <strong>Agregar configuración de VPN</strong>. Con esto, se mostrará la pantalla de configuración de la conexión de la VPN.</li>
<li>Toque <strong>Tipo</strong> y seleccione <strong>IKEv2</strong>.</li>
<li>En el campo <strong>Descripción</strong>, ingrese un nombre corto para la conexión de VPN. Puede ser el que desee.</li>
<li>En los campos <strong>Servidor</strong> e <strong>ID remoto</strong>, ingrese el nombre de dominio o la dirección IP del servidor. Puede dejar el campo <strong>ID local</strong> vacío.</li>
<li>Ingrese su nombre de usuario y contraseña en la sección <strong>Autenticación</strong> y toque <strong>Listo</strong>.</li>
<li>Seleccione la conexión de VPN que acaba de crear y toque el conmutador en la parte superior de la página. Con esto, se conectará.</li>
</ol>

<h3 id="establecer-conexión-desde-android">Establecer conexión desde Android</h3>

<p>Siga estos pasos para importar el certificado:</p>

<ol>
<li>Envíese un correo electrónico con el certificado de CA adjunto. Guarde el certificado CA en su carpeta de descargas.</li>
<li>Descargue <a href="https://play.google.com/store/apps/details?id=org.strongswan.android&amp;hl=en_US">strongSwan VPN Client</a> de Play Store.</li>
<li>Abra la aplicación. Toque el <strong>ícono “más”</strong> en la esquina superior derecha (ícono de tres puntos) y seleccione <strong>certificados de CA</strong>.</li>
<li>Toque nuevamente el <strong>ícono “más”</strong> en la esquina superior derecha. Seleccione <strong>Importar certificado</strong>.</li>
<li>Busque el archivo del certificado de CA en su carpeta de descargas y selecciónelo para importarlo a la aplicación.</li>
</ol>

<p>Ahora que se importó el certificado a la aplicación strongSwan, puede configurar la conexión de VPN con los siguientes pasos:</p>

<ol>
<li>En la aplicación, toque <strong>ADD VPN PROFILE</strong> en la parte superior.</li>
<li>Complete el *<em>campo Server *</em>con el nombre de dominio o la dirección IP pública de su servidor de VPN.</li>
<li>Asegúrese de seleccionar <strong>IKEv2 EAP (Username/Password)</strong> en la categoría “Type” para la VPN.</li>
<li>Complete los campos <strong>Username</strong> y <strong>Password</strong> con las credenciales que definió en el servidor.</li>
<li>Anule la selección de** Select automatically <strong>en la sección</strong> CA certificate** y haga clic en  <strong>Select CA certificate</strong> .</li>
<li>Toque la pestaña <strong>IMPORTED</strong> en la parte superior de la pantalla y elija la CA que importó (recibirá el nombre “CA rootVPN” si no cambió “DN” previamente).</li>
<li>Si desea, complete el campo <strong>Profile name (optional)</strong> con un nombre más descriptivo.</li>
</ol>

<p>Cuando desee conectarse a la VPN, haga clic en el perfil que acaba de crear en la aplicación strongSwan.</p>

<h3 id="solución-de-problemas-en-conexiones">Solución de problemas en conexiones</h3>

<p>Si no puede importar el certificado, asegúrese de que el archivo contenga la extensión <code>.pem</code> en lugar <code>.pem.txt</code>.</p>

<p>Si no puede conectarse a la VPN, verifique el nombre o la dirección IP del servidor que usó. El nombre de dominio o la dirección IP del servidor debe coincidir con lo que configuró como nombre común (CN) al crear el certificado. Si no coinciden, la conexión de VPN no funcionará. Si configura un certificado con el CN de <code>vpn.example.com</code>, <em>debe</em> usar <code>vpn.example.com</code> cuando ingrese la información del servidor de VPN. Verifique bien el comando que usó para generar el certificado y los valores que empleó al crear su conexión de VPN.</p>

<p>Por último, verifique la configuración de VPN para garantizar que el valor <code>leftid</code> esté configurado con el símbolo <code>@</code> si usa un nombre de dominio:</p>
<pre class="code-pre "><code langs="">    leftid=<span class="highlight">@</span>vpn.example.com
</code></pre>
<p>Y si usa una dirección IP, asegúrese de que se omita el símbolo <code>@</code>.</p>

<h2 id="conclusión">Conclusión</h2>

<p>A través de este tutorial, creó un servidor de VPN que usa el protocolo IKEv2. Ahora tendrá la seguridad de que sus actividades en línea permanecerán protegidas sin importar a dónde se dirija.</p>

<p>Para agregar o eliminar usuarios, simplemente repase el paso 5. Cada línea es para un usuario. Esto permite agregar o eliminar usuarios con solo editar el archivo.</p>

<p>A partir de este punto, es posible que desee configurar un analizador de archivos de registro, ya que strongSwan vuelca sus registros en syslog. Encontrará más información sobre cómo realizar esta configuración en el tutorial <a href="https://www.digitalocean.com/community/tutorials/how-to-install-and-use-logwatch-log-analyzer-and-reporter-on-a-vps">Cómo instalar y usar Logwatch Log Analyzer and Reporter en un VPS.</a></p>

<p>Puede interesarle también <a href="https://www.eff.org/wp/effs-top-12-ways-protect-your-online-privacy">esta guía de EFF sobre privacidad en línea</a>.</p>
