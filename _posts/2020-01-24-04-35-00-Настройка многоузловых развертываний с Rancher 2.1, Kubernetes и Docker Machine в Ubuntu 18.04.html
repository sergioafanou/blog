---
layout: post
title: Настройка многоузловых развертываний с Rancher 2.1, Kubernetes и Docker Machine в Ubuntu 18.04
network: digitalocean
date: January 24, 2020 at 04:35AM
url: https://www.digitalocean.com/community/tutorials/how-to-set-up-multi-node-deployments-with-rancher-2-1-kubernetes-and-docker-machine-on-ubuntu-18-04-ru
image: https://assets.digitalocean.com/articles/multirancher_1804/step1a.png
tags: docker
feedtitle: DigitalOcean Community Tutorials
feedurl: https://www.digitalocean.com/community/tutorials
author: DigitalOcean
---
<p><em>Автор выбрал <a href="https://www.brightfunds.org/organizations/code-org">Code Org</a> для получения пожертвования в рамках программы <a href="https://do.co/w4do-cta">Write for DOnations</a>.</em></p>

<h3 id="Введение">Введение</h3>

<p><a href="https://rancher.com/">Rancher</a> — это популярная платформа управления контейнерами с открытым исходным кодом. Выпущенная в начале 2018 года версия Rancher 2.X работает на <a href="https://kubernetes.io/">Kubernetes</a> и включает новые инструменты, такие как управление несколькими кластерами и встроенные CI конвейеры. Помимо повышенной безопасности, масштабируемости и простых инструментов развертывания, уже имеющихся в Kubernetes, Rancher предлагает графический пользовательский интерфейс, упрощающий управление контейнерами. Благодаря графическому интерфейсу Rancher пользователи смогут управлять секретами, безопасно обрабатывать роли и разрешения, масштабировать узлы и поды, а также выполнять настройку средств распределения нагрузки и томов без необходимости использования инструментов командной строки или сложных файлов YAML.</p>

<p>В этом руководстве мы будем разворачивать многоузловой сервер Rancher 2.1 с помощью Docker Machine в Ubuntu 18.04. По окончании руководства вы сможете предоставить новые дроплеты DigitalOcean и поды контейнеров через пользовательский интерфейс Rancher для быстрого расширения или сокращения вашей среды хостинга.</p>

<h2 id="Предварительные-требования">Предварительные требования</h2>

<p>Перед прохождением этого обучающего руководства <a href="https://cloud.digitalocean.com/registrations/new">вам потребуется учетная запись DigitalOcean</a>, а также следующее:</p>

<ul>
<li><p>Маркер персонального доступа DigitalOcean, который вы можете создать в соответствии с указаниями <a href="https://www.digitalocean.com/community/tutorials/how-to-use-the-digitalocean-api-v2#how-to-generate-a-personal-access-token">этого руководства</a>. Этот маркер позволит Rancher получить через API доступ к учетной записи DigitalOcean.</p></li>
<li><p>Полное зарегистрированное доменное имя с записью A, которая указывает на IP-адрес дроплета, создаваемый на шаге 1. Вы можете узнать, как привязывать домены к дроплетам DigitalOcean, ознакомившись с <a href="https://www.digitalocean.com/docs/networking/dns/">документацией по доменам и DNS</a> DigitalOcean. В данном руководстве замените <code><span class="highlight">example.com</span></code> на ваш домен.</p></li>
</ul>

<h2 id="Шаг-1-—-Создание-дроплета-с-установленным-docker">Шаг 1 — Создание дроплета с установленным Docker</h2>

<p>Чтобы запустить и настроить Rancher, вам нужно будет создать новый дроплет с установленным Docker. Для этого нужно использовать образ Docker DigitalOcean.</p>

<p>Войдите в учетную запись DigitalOcean и выберите <strong>Create Droplet</strong> (Создать дроплет). Затем в разделе <strong>Choose an Image</strong> (Выбрать образ) выберите вкладку <strong>Marketplace</strong> (Магазин). Выберите <strong>Docker 18.06.1~ce~3 on 18.04</strong>.</p>

<p><img src="https://assets.digitalocean.com/articles/multirancher_1804/step1a.png" alt="Выберите образ Docker 18.06 в меню доступных одним нажатием приложений"></p>

<p>Далее выберите дроплет размером не менее <strong>2 ГБ</strong> и укажите регион центра обработки данных для вашего дроплета.</p>

<p>После этого добавьте ключи SSH, укажите имя хоста для дроплета и нажмите <strong>Create</strong> (Создать).</p>

<p>Может потребоваться несколько минут для организации работы сервера и загрузки Docker. После успешного развертывания дроплета вы можете запустить Rancher в новом контейнере Docker.</p>

<h2 id="Шаг-2-—-Запуск-и-настройка-rancher">Шаг 2 — Запуск и настройка Rancher</h2>

<p>Дроплет, созданный на шаге 1, будет запускать Rancher в контейнере Docker. На этом шаге вы запустите контейнер Rancher и убедитесь, что у него есть сертификат SSL от <a href="https://letsencrypt.org/">Let&rsquo;s Encrypt</a> для получения защищенного доступа к панели администратора Rancher. Let’s Encrypt — это автоматизированный издатель сертификатов с открытым исходным кодом, позволяющий разработчикам получать действующие в течение 90 дней сертификаты SSL бесплатно.</p>

<p>Выполните вход в новый дроплет:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">ssh root@<span class="highlight">your_server_ip</span>
</li></ul></code></pre>
<p>Чтобы убедиться, что Docker запущен, введите:</p>
<pre class="code-pre super_user"><code langs=""><ul class="prefixed"><li class="line" prefix="#">docker -v
</li></ul></code></pre>
<p>Проверьте, что указанная версия Docker соответствует вашим ожиданиям. Вы можете запустить Rancher с <a href="https://rancher.com/docs/rancher/v2.x/en/installation/single-node/#2-choose-an-ssl-option-and-install-rancher">уже установленным сертификатом Let&rsquo;s Encrypt</a> с помощью следующей команды:</p>
<pre class="code-pre super_user"><code langs=""><ul class="prefixed"><li class="line" prefix="#">docker run -d --restart=unless-stopped -p 80:80 -p 443:443 -v /host/rancher:/var/lib/rancher rancher/rancher --acme-domain <span class="highlight">example.com</span>
</li></ul></code></pre>
<p>Параметр <code>--acme-domain</code> устанавливает сертификат SSL от Let&rsquo;s Encrypt для обеспечения того, что администратор Rancher обслуживается через HTTPS. Этот скрипт также указывает дроплету выполнить выборку <a href="https://hub.docker.com/r/rancher/rancher/">образа Docker <code>rancher/rancher</code></a> и запускать экземпляр Rancher в контейнере, который автоматически перезапускается в случае аварийного завершения работы. Для облегчения восстановления в случае потери данных скрипт монтирует том на компьютер хоста (в <code>/host/rancher</code>), который содержит данные Rancher.</p>

<p>Для просмотра всех запущенных контейнеров введите:</p>
<pre class="code-pre super_user"><code langs=""><ul class="prefixed"><li class="line" prefix="#">docker ps
</li></ul></code></pre>
<p>Вы увидите примерно следующий вывод (с уникальным идентификатором и именем контейнера):</p>
<pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS                                      NAMES
<span class="highlight">7b2afed0a599</span>        rancher/rancher     "entrypoint.sh"     12 seconds ago      Up 11 seconds       0.0.0.0:80-&gt;80/tcp, 0.0.0.0:443-&gt;443/tcp   <span class="highlight">wizardly_fermat</span>
</code></pre>
<p>Если контейнер не запущен, вы можете снова запустить команду <code>docker run</code>.</p>

<p>Прежде чем вы сможете получить доступ к панели администратора Rancher, вам нужно будет задать пароль администратора и URL-адрес сервера Rancher. Интерфейс администратора Rancher позволит вам получить доступ ко всем запущенным узлам, подам и секретам, поэтому важно использовать надежный пароль.</p>

<p>Перейдите к доменному имени, которое указывает на ваш новый дроплет, в браузере. При первом посещении этого адреса Rancher попросит задать пароль:</p>

<p><img src="https://assets.digitalocean.com/articles/multirancher_1804/step3a.png" alt="Установка пароля Rancher с помощью диалогового окна"></p>

<p>При запросе <strong>URL-адреса сервера Rancher</strong> используйте доменное имя, указывающее на ваш дроплет.</p>

<p>Теперь, когда вы выполнили настройку сервера Rancher, вы увидите домашний экран администратора Rancher:</p>

<p><img src="https://assets.digitalocean.com/articles/multirancher_1804/step3b.png" alt="Домашний экран администратора Rancher"></p>

<p>Вы можете перейти к настройке кластера Rancher.</p>

<h2 id="Шаг-3-—-Настройка-кластера-с-одним-узлом">Шаг 3 — Настройка кластера с одним узлом</h2>

<p>Для использования Rancher вам потребуется создать <em>кластер</em> с как минимум одним <em>узлом</em>. Кластер — это группа с одним или несколькими узлами. В <a href="https://www.digitalocean.com/community/tutorials/an-introduction-to-kubernetes">этом руководстве</a> вы найдете более подробную информацию об архитектуре Kubernetes. В настоящем руководстве узлы соответствуют дроплетам, которыми управляет Rancher. <em>Поды</em> представляют собой группу запущенных контейнеров Docker внутри дроплета. Каждый узел может запускать множество подов. В пользовательском интерфейсе Rancher вы можете настроить кластеры и узлы в лежащей в его основе среде Kubernetes.</p>

<p>К концу этого шага у вас должен быть настроенный кластер с одним узлом, готовый к запуску первого пода.</p>

<p>В Rancher нажмите <strong>Add Cluster</strong> (Добавить кластер) и выберите <strong>DigitalOcean</strong> в качестве <strong>поставщика инфраструктуры</strong>.</p>

<p><img src="https://assets.digitalocean.com/articles/multirancher_1804/step4a.png" alt="Выбор DigitalOcean из включенных в список поставщиков инфраструктуры"></p>

<p>Откройте меню <strong>Cluster Name</strong> (Имя кластера) и прокрутите до раздела <strong>Node Pools</strong> (Пулы узлов). Введите <strong>Name Prefix</strong> (Префикс имени), оставьте значение <strong>1</strong> для параметра <strong>Count</strong> (Счетчик) и проверьте <strong>etcd</strong>, <strong>Control Plane</strong> (Уровень управления) и <strong>Worker</strong> (Рабочее приложение).</p>

<ul>
<li><strong><a href="https://kubernetes.io/docs/concepts/overview/components/#etcd">etcd</a></strong> — это система хранения значения ключа Kubernetes для сохранения состояния вашей среды. Для обеспечения высокой доступности вам нужно запустить три или пять узлов etcd, чтобы, если один из узлов перестанет работать, ваша среда оставалась под контролем.</li>
<li><strong><a href="https://kubernetes.io/docs/concepts/#kubernetes-control-plane">Control Plane</a></strong> (Уровень управления) проверяет все объекты Kubernetes, например поды, в вашей среде и поддерживает их соответствие конфигурации, которую вы задаете в интерфейсе администратора Rancher.</li>
<li><strong><a href="https://kubernetes.io/docs/concepts/architecture/nodes/">Workers</a></strong> (Рабочие приложения) запускают действующие рабочие нагрузки и агенты мониторинга, которые обеспечивают, что ваши контейнеры будут работать и останутся подключены к сети. Рабочие узлы — это место, где ваши поды будут запускать программное обеспечение, которое вы разворачиваете.</li>
</ul>

<p><img src="https://assets.digitalocean.com/articles/multirancher_1804/step4b.png" alt="Создание пула узлов с одним узлом"></p>

<p>Перед созданием кластера нажмите <strong>Add Template Node</strong> (Добавить шаблон узла) для настройки конкретных параметров вашего нового узла.</p>

<p>Введите персональный маркер доступа DigitalOcean в поле ввода <strong>Access Token</strong> (Маркер доступа) и нажмите <strong>Next: Configure Droplet</strong> (Далее: настройка дроплета).</p>

<p>Далее выберите тот же <strong>Region</strong> (Регион) и <strong>Droplet Size</strong> (Размер дроплета), что и в шаге 1. Для <strong>Image</strong> (Образ) выберите <strong>Ubuntu 16.04.5 x64</strong>, так как в настоящее время существует <a href="https://github.com/rancher/rancher/issues/13888">проблема совместимости Rancher с Ubuntu 18.04</a>. Нажмите <strong>Create</strong> (Создать) для сохранения шаблона.</p>

<p>После этого нажмите <strong>Create</strong> (Создать) на странице <strong>Add Cluster</strong> (Добавить кластера) для завершения процесса предоставления. Rancher потребуется несколько минут на выполнение этого шага, но после завершения работы вы увидите новый дроплет в <a href="https://cloud.digitalocean.com/droplets">панели управления дроплетов DigitalOcean</a>.</p>

<p>На этом шаге вы создали новый кластер и узел, где вы будете разворачивать рабочую нагрузку в следующем разделе.</p>

<h2 id="Шаг-4-—-Развертывание-рабочей-нагрузки-веб-приложения">Шаг 4 — Развертывание рабочей нагрузки веб-приложения</h2>

<p>Когда новый кластер и узел будут готовы, вы можете развернуть ваш первый <em>под</em> в <em>рабочей нагрузке</em>. <a href="https://kubernetes.io/docs/concepts/workloads/pods/pod-overview/">Под Kubernetes</a> — это самая маленькая часть работы, доступная в Kubernetes и расширении Rancher. Рабочие нагрузки описывают одну группу подов, которые вы разворачиваете вместе. Например, вы можете запустить несколько подов вашего веб-сервера в одной рабочей нагрузке, чтобы убедиться, что, если один под замедляется при получении конкретного запроса, другие экземпляры могут обрабатывать входящие запросы. В этом разделе вы должны будете развернуть <a href="https://hub.docker.com/r/nginxdemos/hello/">образ Nginx Hello World</a> в одном поде.</p>

<p>Наведите курсор на <strong>Global</strong> (Глобально) в заголовке и выберите <strong>Default</strong> (По умолчанию). В результате будет отображена панель проекта <strong>по умолчанию</strong>. В этом руководстве вы будете работать над развертыванием отдельного проекта, но в этой панели управления вы также можете создать несколько проектов для получения сред для изолированных контейнеров.</p>

<p>Для начала настройки первого пода нажмите <strong>Deploy</strong> (Развернуть).</p>

<p>Откройте <strong>Name</strong> (Имя) и введите <code>nginxdemos/hello</code> в поле <strong>Docker Image</strong> (Образ Docker). Затем разметьте порт <strong>80</strong> в контейнере для порта <strong>30000</strong> на узлах хоста. Это позволит гарантировать, что поды, которые вы разворачивайте, будут доступны на каждом узле порта 30000. Вы можете оставить для параметра <strong>Protocol</strong> (Протокол) значение <strong>TCP</strong>, а в следующем выпадающем списке укажите <strong>NodePort</strong>.</p>

<p><span class='note'><strong>Примечание.</strong> Хотя этот метод запуска узла на порте каждого узла легче использовать, Rancher также включает <a href="https://rancher.com/docs/rancher/v2.x/en/k8s-in-rancher/load-balancers-and-ingress/ingress/">Ingress</a> для распределения нагрузки и прекращения работы SSL для использования в продакшене.<br></span></p>

<p><img src="https://assets.digitalocean.com/articles/multirancher_1804/step5b.png" alt="Форма ввода для развертывания рабочей нагрузки"></p>

<p>Для запуска пода прокрутите до самого низа и нажмите <strong>Launch</strong> (Запустить).</p>

<p>Rancher вернет вас на домашнюю страницу проекта по умолчанию, а в течение нескольких секунд ваш под будет готов. Нажмите ссылку <strong>30000/tcp</strong> под именем рабочей нагрузки, и Rancher откроет новую вкладку с информацией о среде запущенного контейнера.</p>

<p><img src="https://assets.digitalocean.com/articles/multirancher_1804/step5c.png" alt="Адрес сервера, имя сервера и другие результаты работы запущенного контейнера NGINX"></p>

<p><strong>Адрес сервера</strong> и порт, которые вы видите на этой странице, повторяют данные внутренней сети Docker, а не являются публичным IP-адресом, который вы видите в браузере. Это означает, что Rancher работает и перенаправляет трафик с <code>http://<span class="highlight">first_node_ip</span>:30000/</code> на рабочую нагрузку, как и ожидалось.</p>

<p>В данный момент вы успешно развернули вашу первую рабочую нагрузку одного пода на отдельном узле Rancher. Далее вы узнаете, как можно расширить вашу среду Rancher.</p>

<h2 id="Шаг-5-—-Масштабирование-узлов-и-подов">Шаг 5 — Масштабирование узлов и подов</h2>

<p>Rancher предоставляет два способа масштабирования ресурсов хостинга: увеличение числа подов в вашей рабочей нагрузке или увеличение числа узлов вашего кластера.</p>

<p>Добавление подов в вашу рабочую нагрузку будет предоставлять вашему приложению большее количество запущенных процессов. Это позволит ему обрабатывать больше трафика и добиться развертываний без остановки работы приложений, но каждый узел сможет обрабатывать только ограниченное количество подов. Когда все ваши узлы достигнут лимита на количество подов, вам нужно будет увеличить количество узлов, если вы захотите продолжить масштабирование вашего приложения.</p>

<p>Еще одним соображением, которое нужно учитывать, является тот факт, что, хотя увеличение количества подов выполняется бесплатно, вам придется платить за каждый узел, добавляемый в вашу среду. На этом шаге вы сможете расширить количество узлов и подов, а также добавить дополнительный узел в ваш кластер Rancher.</p>

<p><span class='note'><strong>Примечание.</strong> В этой части руководства будет предоставлен новый дроплет DigitalOcean автоматически через API, поэтому вы должны учитывать, что запуск второго узла будет сопровождаться дополнительными расходами.<br></span></p>

<p>Перейдите на домашнюю страницу кластера установки Rancher, выбрав <strong>Cluster: <span class="highlight">your-cluster-name</span></strong> в верхней панели навигации. Далее нажмите <strong>Nodes</strong> (Узлы) в верхней панели навигации.</p>

<p><img src="https://assets.digitalocean.com/articles/multirancher_1804/step6a.png" alt="Использование выпадающего меню верхней панели для выбора кластера"></p>

<p>Эта страница показывает, что у вас в кластере есть один запущенный узел. Для добавления дополнительных узлов нажмите <strong>Edit Cluster</strong> (Изменить кластер) и прокрутите до раздела <strong>Node Pools</strong> (Пулы узлов) внизу страницы. Нажмите <strong>Add Node Pool</strong> (Добавить пул узлов), введите префикс и проверьте поле <strong>Worker</strong> (Рабочее приложение). Нажмите <strong>Save</strong> (Сохранить) для обновления кластера.</p>

<p><img src="https://assets.digitalocean.com/articles/multirancher_1804/step6b.png" alt="Добавление пула узла в качестве единого рабочего приложения"></p>

<p>В течение 2–5 минут Rancher предоставит второй дроплет и отметит узел как <strong>Active</strong> (Активный) в панели управления кластера. Этот второй узел — только рабочее приложение, что означает, что он не будет использовать etcd Rancher или контейнеры панели управления. Это предоставляет рабочему приложению больше возможностей для запуска рабочих нагрузок.</p>

<p><span class='note'><strong>Примечание.</strong> При наличии нечетного числа узлов etcd будет гарантировано, что всегда можно будет достичь кворума (или консенсуса). Если у вас есть только один узел etcd, вы сталкиваетесь с риском того, что ваш кластер может стать недоступным, если этот один узел прекратит работу. В продакшен-среде лучше использовать три или пять узлов etcd.<br></span></p>

<p>Когда второй узел будет готов, вы сможете увидеть рабочую нагрузку, которую вы развернули на предыдущем шаге, на этом узле, если перейдете на <code>http://<span class="highlight">send_node_ip</span>:30000/</code> в браузере.</p>

<p>Масштабирование узлов позволяет вам использовать больше дроплетов для распределения ваших рабочих нагрузок, но вы также можете использовать несколько экземпляров каждого пода внутри рабочей нагрузки. Для добавления дополнительных подов вернитесь на страницу проекта <strong>по умолчанию</strong>, нажмите стрелку слева от рабочей нагрузки <code><span class="highlight">hello-world</span></code> и нажмите <strong>+</strong> два раза для добавления двух новых подов.</p>

<p><img src="https://assets.digitalocean.com/articles/multirancher_1804/step6c.png" alt="Запуск трех подов Hello World в рабочую нагрузку"></p>

<p>Rancher автоматически развернет несколько подов и распределит запущенные контейнеры на каждом узле, в зависимости от доступности.</p>

<p>Теперь вы можете масштабировать ваши узлы и поды согласно требованиям вашего приложения.</p>

<h2 id="Заключение">Заключение</h2>

<p>Вы выполнили развертывание нескольких узлов с помощью Rancher 2.1 в Ubuntu 18.04, а также расширили вашу конфигурацию до двух запущенных узлов и нескольких подов внутри рабочей нагрузки. Вы можете использовать эту стратегию для размещения и масштабирования любых контейнеров Docker, которые вам нужно запускать в вашем приложении, и использовать панель управления и оповещения Rancher для максимального повышения производительности ваших рабочих нагрузок и узлов внутри кластера.</p>
