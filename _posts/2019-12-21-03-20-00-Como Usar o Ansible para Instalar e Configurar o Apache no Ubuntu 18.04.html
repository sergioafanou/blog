---
layout: post
title: Como Usar o Ansible para Instalar e Configurar o Apache no Ubuntu 18.04
network: digitalocean
date: December 21, 2019 at 03:20AM
url: https://www.digitalocean.com/community/tutorials/how-to-use-ansible-to-install-and-set-up-apache-on-ubuntu-18-04-pt
image: https://assets.digitalocean.com/articles/apache_virtual_hosts_ubuntu/vhost_your_domain.png
tags: docker
feedtitle: DigitalOcean Community Tutorials
feedurl: https://www.digitalocean.com/community/tutorials
author: DigitalOcean
---
<h3 id="introdução">Introdução</h3>

<p>A automação de servidores desempenha agora um papel essencial na administração de sistemas, devido à natureza descartável dos ambientes das aplicações modernas. Ferramentas de <a href="https://www.digitalocean.com/community/tutorial_series/getting-started-with-configuration-management">Gerenciamento de configuração</a> tais como o <a href="https://ansible.com">Ansible</a> são normalmente usadas para otimizar o processo de automatização da configuração do servidor, estabelecendo procedimentos padrão para novos servidores e reduzindo também o erro humano associado às configurações manuais.</p>

<p>O Ansible oferece uma arquitetura simples que não requer a instalação de software especial nos nodes. Ele também fornece um conjunto robusto de recursos e módulos internos que facilitam a criação de scripts de automação.</p>

<p>Este guia explica como usar o Ansible para automatizar os passos contidos em nosso guia <a href="https://www.digitalocean.com/community/tutorials/how-to-install-the-apache-web-server-on-ubuntu-18-04-pt">Como Instalar o Servidor Web Apache no Ubuntu 18.04</a>. O servidor HTTP Apache é o servidor web mais utilizado no mundo. Ele fornece muitos recursos poderosos, incluindo módulos dinamicamente carregáveis, suporte robusto à mídia e ampla integração com outros softwares populares.</p>

<h2 id="pré-requisitos">Pré-requisitos</h2>

<p>Para executar a configuração automatizada fornecida pelo playbook que estamos discutindo neste guia, você precisará de:</p>

<ul>
<li><strong>Um node de controle Ansible</strong>: uma máquina Ubuntu 18.04 com o Ansible instalado e configurado para conectar aos seus hosts Ansible usando chaves SSH. Certifique-se de que o node de controle possui um usuário regular com permissões sudo e um firewall ativado, conforme explicado em nosso guia <a href="https://www.digitalocean.com/community/tutorials/configuracao-inicial-de-servidor-com-ubuntu-18-04-pt">Configuração Inicial de servidor</a>. Para configurar o Ansible, siga nosso guia em <a href="https://www.digitalocean.com/community/tutorials/como-instalar-e-configurar-o-ansible-no-ubuntu-18-04-pt">Como instalar e configurar o Ansible no Ubuntu 18.04</a>.</li>
<li><strong>Um ou mais Hosts Ansible</strong>: um ou mais servidores remotos Ubuntu 18.04 previamente configurados, seguindo o guia <a href="https://www.digitalocean.com/community/tutorials/how-to-use-ansible-to-automate-initial-server-setup-on-ubuntu-18-04">How to Use Ansible to Automate Initial Server Setup on Ubuntu 18.04</a>.</li>
</ul>

<p><span class='note'>Antes de continuar, primeiro você precisa garantir que o node de controle do Ansible possa conectar e executar comandos no(s) host(s) Ansible. Para um teste de conexão, verifique o passo 3 de <a href="https://www.digitalocean.com/community/tutorials/como-instalar-e-configurar-o-ansible-no-ubuntu-18-04-pt">Como instalar e configurar o Ansible no Ubuntu 18.04</a>.<br></span></p>

<h2 id="o-que-este-playbook-faz">O que Este Playbook Faz?</h2>

<p>Este Playbook Ansible fornece uma alternativa à execução manual do procedimento descrito em nosso guia sobre <a href="https://www.digitalocean.com/community/tutorials/how-to-install-the-apache-web-server-on-ubuntu-18-04-pt">Como Instalar o Servidor Web Apache no Ubuntu 18.04</a>.</p>

<p>A execução deste playbook executará as seguintes ações nos hosts Ansible:</p>

<ol>
<li>Instalar o <code>aptitude</code>, que é preferido pelo Ansible como uma alternativa ao gerenciador de pacotes <code>apt</code>.</li>
<li>Instalar o Apache.</li>
<li>Criar uma pasta raiz de documentos personalizada para o novo VirtualHost do Apache e configurar uma página de teste.</li>
<li>Ativar o novo VirtualHost do Apache.</li>
<li>Desativar o site padrão do Apache quando a variável <code>disable_default</code> é definida para <code>true</code>.</li>
<li>Configurar o UFW para permitir o tráfego HTTP na porta configurada (<code>80</code> por padrão).</li>
</ol>

<p>Quando o playbook terminar de ser executado, você terá um servidor web em execução no seu node de destino, com base nas opções que você definiu nas variáveis de configuração.</p>

<h2 id="como-usar-este-playbook">Como Usar Este Playbook</h2>

<p>A primeira coisa que precisamos fazer é obter o playbook do Apache e suas dependências no repositório <a href="https://github.com/do-community/ansible-playbooks">do-community/ansible-playbooks</a>. Precisamos clonar esse repositório em uma pasta local dentro do Node de Controle Ansible </p>

<p>Caso você tenha clonado este repositório antes, enquanto seguia um guia diferente, acesse sua cópia existente do <code>ansible-playbooks</code> e execute um comando <code>git pull</code> para garantir que você tenha conteúdo atualizado:</p>
<pre class="code-pre command local-environment"><code langs=""><ul class="prefixed"><li class="line" prefix="$">cd ~/ansible-playbooks
</li><li class="line" prefix="$">git pull
</li></ul></code></pre>
<p>Se esta é sua primeira vez usando o repositório <code>do-community/ansible-playbooks</code>, você deve começar clonando o repositório na sua pasta home com:</p>
<pre class="code-pre command local-environment"><code langs=""><ul class="prefixed"><li class="line" prefix="$">cd ~
</li><li class="line" prefix="$">git clone https://github.com/do-community/ansible-playbooks.git
</li><li class="line" prefix="$">cd ansible-playbooks
</li></ul></code></pre>
<p>Os arquivos em que estamos interessados estão localizados dentro da pasta <code>apache_ubuntu1804</code>, que possui a seguinte estrutura:</p>
<pre class="code-pre "><code langs="">apache_ubuntu1804
├── files
│   ├── apache.conf.j2
│   └── index.html.j2
├── vars
│   └── default.yml
├── playbook.yml
└── readme.md
</code></pre>
<p>Aqui está o que cada um desses arquivos representa:</p>

<ul>
<li><code>files/apache.conf.j2</code>: Arquivo de modelo para configurar o VirtualHost no Apache.</li>
<li><code>files/index.html.j2</code>: Arquivo de modelo para configurar uma página de teste no diretório raiz do servidor web. </li>
<li><code>vars/default.yml</code>: Arquivo de variáveis para personalizar as configurações do playbook.</li>
<li><code>playbook.yml</code>: O arquivo do playbook, contendo as tarefas a serem executadas nos servidores remotos.</li>
<li><code>readme.md</code>: Um arquivo de texto contendo informações sobre este playbook.</li>
</ul>

<p>Editaremos o arquivo de variáveis do playbook para personalizar algumas opções. Acesse o diretório <code>apache_ubuntu1804</code> e abra o arquivo <code>vars/default.yml</code> usando o editor de linha de comando de sua escolha:</p>
<pre class="code-pre command local-environment"><code langs=""><ul class="prefixed"><li class="line" prefix="$">cd apache_ubuntu1804
</li><li class="line" prefix="$">nano vars/default.yml
</li></ul></code></pre>
<p>Este arquivo contém algumas variáveis que requerem sua atenção:</p>
<div class="code-label " title="vars/default.yml">vars/default.yml</div><pre class="code-pre yaml local-environment"><code langs="">---
app_user: "<span class="highlight">sammy</span>"
http_host: "<span class="highlight">your_domain</span>"
http_conf: "<span class="highlight">your_domain</span>.conf"
http_port: "<span class="highlight">80</span>"
disable_default: <span class="highlight">true</span>
</code></pre>
<p>A lista a seguir contém uma breve explicação de cada uma dessas variáveis e como você pode alterá-las:</p>

<ul>
<li><code>app_user</code>: Um usuário remoto não-root no host Ansible que será definido como o proprietário dos arquivos da aplicação.</li>
<li><code>http_host</code>: O seu nome de domínio.</li>
<li><code>http_conf</code>: O nome do arquivo de configuração que será criado no Apache.</li>
<li><code>http_port</code>: Porta HTTP para este virtual host, onde <code>80</code> é o padrão. </li>
<li><code>disable_default</code>: Desativar ou não o site padrão que acompanha o Apache.</li>
</ul>

<p>Quando terminar de atualizar as variáveis dentro de <code>vars/default.yml</code>, salve e feche este arquivo. Se você usou o <code>nano</code>, faça isso pressionando <code>CTRL + X</code>, <code>Y</code> e, em seguida,<code>ENTER</code>.</p>

<p>Agora você está pronto para executar este playbook em um ou mais servidores. A maioria dos playbooks está configurada para ser executada em todos os servidores do seu inventário, por padrão. Podemos usar a flag <code>-l</code> para garantir que apenas um subconjunto de servidores ou um único servidor seja afetado pelo playbook. Também podemos usar a flag <code>-u</code> para especificar qual usuário no servidor remoto que estamos usando para conectar e executar os comandos do playbook nos hosts remotos.</p>

<p>Para executar o playbook apenas no servidor <code><span class="highlight">server1</span></code>, conectando-se como <code><span class="highlight">sammy</span></code>, você pode usar o seguinte comando:</p>
<pre class="code-pre command local-environment"><code langs=""><ul class="prefixed"><li class="line" prefix="$">ansible-playbook playbook.yml -l <span class="highlight">server1</span> -u <span class="highlight">sammy</span>
</li></ul></code></pre>
<p>Você obterá uma saída semelhante a esta:</p>
<pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>
PLAY [all] *****************************************************************************************************************************

TASK [Gathering Facts] *****************************************************************************************************************
ok: [server1]

TASK [Install prerequisites] ***********************************************************************************************************
ok: [server1] =&gt; (item=aptitude)

TASK [Install Apache] ******************************************************************************************************************
changed: [server1]

TASK [Create document root] ************************************************************************************************************
changed: [server1]

TASK [Copy index test page] ************************************************************************************************************
changed: [server1]

TASK [Set up Apache virtualhost] *******************************************************************************************************
changed: [server1]

TASK [Enable new site] *****************************************************************************************************************
changed: [server1]

TASK [Disable default Apache site] *****************************************************************************************************
changed: [server1]

TASK [UFW - Allow HTTP on port 80] *****************************************************************************************************
changed: [server1]

RUNNING HANDLER [Reload Apache] ********************************************************************************************************
changed: [server1]

PLAY RECAP *****************************************************************************************************************************
server1            : ok=10   changed=8    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   



</code></pre>
<p><span class='note'><strong>Nota</strong>: Para obter mais informações sobre como executar os playbooks Ansible, consulte nosso guia de referência <a href="https://www.digitalocean.com/community/tutorials/how-to-use-ansible-cheat-sheet-guide">Ansible Cheat Sheet Guide</a>.<br></span></p>

<p>Quando o playbook terminar de ser executado, abra seu navegador web e acesse o host ou o endereço IP do servidor, conforme configurado nas variáveis do playbook:</p>
<pre class="code-pre "><code langs="">http://<span class="highlight">host_ou_ip_do_servidor</span>
</code></pre>
<p>Você verá uma página como esta:</p>

<p><img src="https://assets.digitalocean.com/articles/apache_virtual_hosts_ubuntu/vhost_your_domain.png" alt="it works page"></p>

<p>Isso significa que a automação foi totalmente executada em seu servidor e o Apache agora está pronto para servir páginas HTML estáticas e ativos colocados no diretório raiz de documentos que você definiu nas variáveis de configuração do playbook.</p>

<h2 id="o-conteúdo-do-playbook">O Conteúdo do Playbook</h2>

<p>Você pode encontrar a configuração do servidor Apache apresentada neste tutorial na página <a href="https://github.com/do-community/ansible-playbooks/tree/master/apache_ubuntu1804"><code>apache_ubuntu1804</code></a> dentro do repositório <a href="https://github.com/do-community/ansible-playbooks">DigitalOcean Community Playbooks</a>. Para copiar ou baixar o conteúdo do script diretamente, clique no botão <strong>Raw</strong> na parte superior de cada script.</p>

<p>O conteúdo completo do playbook, bem como os arquivos associados, também estão incluídos aqui para sua conveniência.</p>

<h3 id="vars-default-yml">vars/default.yml</h3>

<p>O arquivo de variáveis <code>default.yml</code> contém valores que serão usados nas tarefas do playbook, como a porta HTTP e o nome do domínio a serem configurados no VirtualHost do Apache.</p>
<div class="code-label " title="vars/default.yml">vars/default.yml</div><pre class="code-pre yaml local-environment"><code langs="">---
app_user: "<span class="highlight">sammy</span>"
http_host: "<span class="highlight">your_domain</span>"
http_conf: "<span class="highlight">your_domain</span>.conf"
http_port: "<span class="highlight">80</span>"
disable_default: <span class="highlight">true</span>
</code></pre>
<h3 id="files-apache-conf-j2">files/apache.conf.j2</h3>

<p>O arquivo <code>apache.conf.j2</code> é um template ou modelo <a href="https://jinja.palletsprojects.com/en/2.10.x/">Jinja 2</a> que configura um novo VirtualHost no Apache. As variáveis usadas neste modelo são definidas no arquivo de variáveis <code>vars/default.yml</code>.</p>
<div class="code-label " title="files/apache.conf.j2">files/apache.conf.j2</div><pre class="code-pre  local-environment"><code langs="">&lt;VirtualHost *:{{ http_port }}&gt;
   ServerAdmin webmaster@localhost
   ServerName {{ http_host }}
   ServerAlias www.{{ http_host }}
   DocumentRoot /var/www/{{ http_host }}
   ErrorLog ${APACHE_LOG_DIR}/error.log
   CustomLog ${APACHE_LOG_DIR}/access.log combined
&lt;/VirtualHost&gt;
</code></pre>
<h3 id="files-index-html-j2">files/index.html.j2</h3>

<p>O arquivo <code>index.html.j2</code> é outro modelo Jinja, usado para configurar uma página HTML de teste na raiz de documentos do servidor Apache recém-configurado.</p>
<div class="code-label " title="files/index.html.j2">files/index.html.j2</div><pre class="code-pre  local-environment"><code langs="">&lt;html&gt;
   &lt;head&gt;
       &lt;title&gt;Welcome to {{ http_host }} !&lt;/title&gt;
   &lt;/head&gt;
   &lt;body&gt;
       &lt;h1&gt;Success! The {{ http_host }} virtual host is working!&lt;/h1&gt;
   &lt;/body&gt;
&lt;/html&gt;
</code></pre>
<h3 id="playbook-yml">playbook.yml</h3>

<p>O arquivo <code>playbook.yml</code> é onde todas as tarefas desta configuração são definidas. Ele começa definindo o grupo de servidores que deve ser o alvo dessa configuração (<code>all</code>), após o qual ele usa <code>become: true</code> para definir que as tarefas devem ser executadas com escalação de privilégios (<code>sudo</code>) por padrão. Em seguida, inclui o arquivo de variáveis <code>vars/default.yml</code> para carregar as opções de configuração.</p>
<div class="code-label " title="playbook.yml">playbook.yml</div><pre class="code-pre yaml local-environment"><code langs="">---
- hosts: all
  become: true
  vars_files:
    - vars/default.yml

  tasks:
    - name: Install prerequisites
      apt: name={{ item }} update_cache=yes state=latest force_apt_get=yes
      loop: [ 'aptitude' ]

    - name: Install Apache
      apt: name=apache2 update_cache=yes state=latest

    - name: Create document root
      file:
        path: "/var/www/{{ http_host }}"
        state: directory
        owner: "{{ app_user }}"
        mode: '0755'

    - name: Copy index test page
      template:
        src: "files/index.html.j2"
        dest: "/var/www/{{ http_host }}/index.html"

    - name: Set up Apache virtuahHost
      template:
        src: "files/apache.conf.j2"
        dest: "/etc/apache2/sites-available/{{ http_conf }}"

    - name: Enable new site
      shell: /usr/sbin/a2ensite {{ http_conf }}
      notify: Reload Apache

    - name: Disable default Apache site
      shell: /usr/sbin/a2dissite 000-default.conf
      when: disable_default
      notify: Reload Apache

    - name: "UFW - Allow HTTP on port {{ http_port }}"
      ufw:
        rule: allow
        port: "{{ http_port }}"
        proto: tcp

  handlers:
    - name: Reload Apache
      service:
        name: apache2
        state: reloaded

    - name: Restart Apache
      service:
        name: apache2
        state: restarted
</code></pre>
<p>Sinta-se à vontade para modificar este playbook para melhor atender às suas necessidades individuais dentro do seu próprio fluxo de trabalho.</p>

<h2 id="conclusão">Conclusão</h2>

<p>Neste guia, usamos o Ansible para automatizar o processo de instalação e configuração do Apache no Ubuntu 18.04.</p>

<p>Se você deseja incluir outras tarefas neste playbook para personalizar ainda mais sua configuração inicial de servidor, consulte nosso guia introdutório de Ansible em <a href="https://www.digitalocean.com/community/tutorials/configuration-management-101-writing-ansible-playbooks">Configuration Management 101: Writing Ansible Playbooks</a>.</p>
