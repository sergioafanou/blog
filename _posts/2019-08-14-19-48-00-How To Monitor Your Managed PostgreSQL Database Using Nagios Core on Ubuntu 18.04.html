---
layout: post
title: How To Monitor Your Managed PostgreSQL Database Using Nagios Core on Ubuntu 18.04
network: digitalocean
date: August 14, 2019 at 07:48PM
url: https://www.digitalocean.com/community/tutorials/how-to-monitor-your-managed-postgresql-database-using-nagios-core-on-ubuntu-18-04
image: https://assets.digitalocean.com/articles/postgres_managed_nagios/step3.png
tags: docker
feedtitle: DigitalOcean Community Tutorials
feedurl: https://www.digitalocean.com/community/tutorials
author: DigitalOcean
---
<p><em>The author selected the <a href="https://www.brightfunds.org/funds/foss-nonprofits">Free and Open Source Fund</a> to receive a donation as part of the <a href="https://do.co/w4do-cta">Write for DOnations</a> program.</em></p>

<h3 id="introduction">Introduction</h3>

<p>Database monitoring is key to understanding how a database performs over time. It can help you uncover hidden usage problems and bottlenecks happening in your database. Implementing database monitoring systems can quickly turn out to be a long-term advantage, which will positively influence your infrastructure management process. You'll be able to swiftly react to status changes of your database and will quickly be notified when monitored services return to normal functioning.</p>

<p><a href="https://www.nagios.org/projects/nagios-core/">Nagios Core</a> is a popular monitoring system that you can use to monitor your managed database. The benefits of using Nagios for this task are its versatility—it's easy to configure and use—a large repository of <a href="https://www.nagios.org/projects/nagios-plugins/">available plugins</a>, and most importantly, integrated alerting.</p>

<p>In this tutorial, you will set up PostgreSQL database monitoring in <a href="https://www.nagios.org/projects/nagios-core/">Nagios Core</a> using the <a href="https://exchange.nagios.org/directory/Plugins/Databases/PostgresQL/check_postgres/details"><code>check_postgres</code></a> Nagios plugin and set up Slack-based alerting. In the end, you'll have a monitoring system in place for your managed PostgreSQL database, and will be notified of status changes of various functionality immediately.</p>

<h2 id="prerequisites">Prerequisites</h2>

<ul>
<li><p>An Ubuntu 18.04 server with root privileges, and a secondary, non-root account. You can set this up by following <a href="https://www.digitalocean.com/community/tutorials/initial-server-setup-with-ubuntu-18-04">this initial server setup guide</a>. For this tutorial the non-root user is <code><span class="highlight">sammy</span></code>.</p></li>
<li><p>Nagios Core installed on your server. To achieve this, complete the first five steps of the <a href="https://www.digitalocean.com/community/tutorials/how-to-install-nagios-4-and-monitor-your-servers-on-ubuntu-18-04">How To Install Nagios 4 and Monitor Your Servers on Ubuntu 18.04</a> tutorial.</p></li>
<li><p>A DigitalOcean account and a <a href="https://www.digitalocean.com/products/managed-databases/">PostgreSQL managed database</a> provisioned from DigitalOcean with connection information available. Make sure that your server's IP address is on the whitelist. To learn more about DigitalOcean Managed Databases, visit the <a href="https://www.digitalocean.com/docs/databases/overview/">product docs</a>.</p></li>
<li><p>A <a href="https://slack.com/">Slack</a> account with full access, added to a workspace where you'll want to receive status updates.</p></li>
</ul>

<h2 id="step-1-—-installing-check_postgres">Step 1 — Installing check_postgres</h2>

<p>In this section, you'll download the latest version of the <code>check_postgres</code> plugin from Github and make it available to Nagios Core. You'll also install the PostgreSQL client (<code>psql</code>), so that <code>check_postgres</code> will be able to connect to your managed database.</p>

<p>Start off by installing the PostgreSQL client by running the following command:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo apt install postgresql-client
</li></ul></code></pre>
<p>Next, you'll download <code>check_postgres</code> to your home directory. First, navigate to it:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">cd ~
</li></ul></code></pre>
<p>Head over to the <a href="https://github.com/bucardo/check_postgres/releases">Github releases</a> page and copy the link of the latest version of the plugin. At the time of writing, the latest version of <code>check_postgres</code> was <code>2.24.0</code>; keep in mind that this will update, and where possible it's best practice to use the latest version.</p>

<p>Now download it using curl:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">curl -LO https://github.com/bucardo/check_postgres/releases/download/2.24.0/check_postgres-<span class="highlight">2.24.0</span>.tar.gz
</li></ul></code></pre>
<p>Extract it using the following command:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">tar xvf check_postgres-*.tar.gz
</li></ul></code></pre>
<p>This will create a directory with the same name as the file you have downloaded. That folder contains the <code>check_postgres</code> executable, which you'll need to copy to the directory where Nagios stores its plugins (usually <code>/usr/local/nagios/libexec/</code>). Copy it by running the following command:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo cp check_postgres-*/check_postgres.pl /usr/local/nagios/libexec/
</li></ul></code></pre>
<p>Next, you'll need to give the <code>nagios</code> user ownership of it, so that it can be run from Nagios:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo chown nagios:nagios /usr/local/nagios/libexec/check_postgres.pl
</li></ul></code></pre>
<p><code>check_postgres</code> is now available to Nagios and can be used from it. However, it provides a lot of commands pertaining to different aspects of PostgreSQL, and for better service maintainability, it's better to break them up so that they can be called separately. You'll achieve this by creating a symlink to every <code>check_postgres</code> command in the plugin directory.</p>

<p>Navigate to the directory where Nagios stores plugins by running the following command:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">cd /usr/local/nagios/libexec
</li></ul></code></pre>
<p>Then, create the symlinks with:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo perl check_postgres.pl --symlinks
</li></ul></code></pre>
<p>The output will look like this:</p>
<pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>Created "check_postgres_archive_ready"
Created "check_postgres_autovac_freeze"
Created "check_postgres_backends"
Created "check_postgres_bloat"
Created "check_postgres_checkpoint"
Created "check_postgres_cluster_id"
Created "check_postgres_commitratio"
Created "check_postgres_connection"
Created "check_postgres_custom_query"
Created "check_postgres_database_size"
Created "check_postgres_dbstats"
Created "check_postgres_disabled_triggers"
Created "check_postgres_disk_space"
Created "check_postgres_fsm_pages"
Created "check_postgres_fsm_relations"
Created "check_postgres_hitratio"
Created "check_postgres_hot_standby_delay"
Created "check_postgres_index_size"
Created "check_postgres_indexes_size"
Created "check_postgres_last_analyze"
Created "check_postgres_last_autoanalyze"
Created "check_postgres_last_autovacuum"
Created "check_postgres_last_vacuum"
Created "check_postgres_listener"
Created "check_postgres_locks"
Created "check_postgres_logfile"
Created "check_postgres_new_version_bc"
Created "check_postgres_new_version_box"
Created "check_postgres_new_version_cp"
Created "check_postgres_new_version_pg"
Created "check_postgres_new_version_tnm"
Created "check_postgres_pgagent_jobs"
Created "check_postgres_pgb_pool_cl_active"
Created "check_postgres_pgb_pool_cl_waiting"
Created "check_postgres_pgb_pool_maxwait"
Created "check_postgres_pgb_pool_sv_active"
Created "check_postgres_pgb_pool_sv_idle"
Created "check_postgres_pgb_pool_sv_login"
Created "check_postgres_pgb_pool_sv_tested"
Created "check_postgres_pgb_pool_sv_used"
Created "check_postgres_pgbouncer_backends"
Created "check_postgres_pgbouncer_checksum"
Created "check_postgres_prepared_txns"
Created "check_postgres_query_runtime"
Created "check_postgres_query_time"
Created "check_postgres_relation_size"
Created "check_postgres_replicate_row"
Created "check_postgres_replication_slots"
Created "check_postgres_same_schema"
Created "check_postgres_sequence"
Created "check_postgres_settings_checksum"
Created "check_postgres_slony_status"
Created "check_postgres_table_size"
Created "check_postgres_timesync"
Created "check_postgres_total_relation_size"
Created "check_postgres_txn_idle"
Created "check_postgres_txn_time"
Created "check_postgres_txn_wraparound"
Created "check_postgres_version"
Created "check_postgres_wal_files"
</code></pre>
<p>Perl listed all the functions it created a symlink for. These can now be executed from the command line as usual.</p>

<p>You've downloaded and installed the <code>check_postgres</code> plugin. You have also created symlinks to all the commands of the plugin, so that they can be used individually from Nagios. In the next step, you'll create a connection service file, which <code>check_postgres</code> will use to connect to your managed database.</p>

<h2 id="step-2-—-configuring-your-database">Step 2 — Configuring Your Database</h2>

<p>In this section, you will create a PostgreSQL connection service file containing the connection information of your database. Then, you will test the connection data by invoking <code>check_postgres</code> on it.</p>

<p>The connection service file is by convention called <code>pg_service.conf</code>, and must be located under <code>/etc/postgresql-common/</code>. Create it for editing with your favorite editor (for example, nano):</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo nano /etc/postgresql-common/pg_service.conf
</li></ul></code></pre>
<p>Add the following lines, replacing the highlighted placeholders with the actual values shown in your Managed Database Control Panel under the section <strong>Connection Details</strong>:</p>
<div class="code-label " title="/etc/postgresql-common/pg_service.conf">/etc/postgresql-common/pg_service.conf</div><pre class="code-pre "><code langs="">[managed-db]
host=<span class="highlight">host</span>
port=<span class="highlight">port</span>
user=<span class="highlight">username</span>
password=<span class="highlight">password</span>
dbname=defaultdb
sslmode=require
</code></pre>
<p>The connection service file can house multiple database connection info groups. The beginning of a group is signaled by putting its name in square brackets. After that comes the connection parameters (<code>host</code>, <code>port</code>, <code>user</code>, <code>password</code>, and so on), separated by new lines, which must be given a value.</p>

<p>Save and close the file when you are finished.</p>

<p>You'll now test the validity of the configuration by connecting to the database via <code>check_postgres</code> by running the following command:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">./check_postgres.pl --dbservice=managed-db --action=connection
</li></ul></code></pre>
<p>Here, you tell <code>check_postgres</code> which database connection info group to use with the parameter <code>--dbservice</code>, and also specify that it should only try to connect to it by specifying <code>connection</code> as the action.</p>

<p>Your output will look similar to this:</p>
<pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>POSTGRES_CONNECTION OK: service=managed-db version 11.4 | time=0.10s
</code></pre>
<p>This means that <code>check_postgres</code> succeeded in connecting to the database, according to the parameters from <code>pg_service.conf</code>. If you get an error, double check what you have just entered in that config file.</p>

<p>You've created and filled out a PostgreSQL connection service file, which works as a <a href="https://en.wikipedia.org/wiki/Connection_string">connection string</a>. You have also tested the connection data by running <code>check_postgres</code> on it and observing the output. In the next step, you will configure Nagios to monitor various parts of your database.</p>

<h2 id="step-3-—-creating-monitoring-services-in-nagios">Step 3 — Creating Monitoring Services in Nagios</h2>

<p>Now you will configure Nagios to watch over various metrics of your database by defining a host and multiple services, which will call the <code>check_postgres</code> plugin and its symlinks.</p>

<p>Nagios stores your custom configuration files under <code>/usr/local/nagios/etc/objects</code>. New files you add there must be manually enabled in the central Nagios config file, located at <code>/usr/local/nagios/etc/nagios.cfg</code>. You'll now define commands, a host, and multiple services, which you'll use to monitor your managed database in Nagios.</p>

<p>First, create a folder under <code>/usr/local/nagios/etc/objects</code> to store your PostgreSQL related configuration by running the following command:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo mkdir /usr/local/nagios/etc/objects/postgresql
</li></ul></code></pre>
<p>You'll store Nagios commands for <code>check_nagios</code> in a file named <code>commands.cfg</code>. Create it for editing:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo nano /usr/local/nagios/etc/objects/postgresql/commands.cfg
</li></ul></code></pre>
<p>Add the following lines:</p>
<div class="code-label " title="/usr/local/nagios/etc/objects/postgresql/commands.cfg">/usr/local/nagios/etc/objects/postgresql/commands.cfg</div><pre class="code-pre "><code langs="">define command {
    command_name           check_postgres_connection
    command_line           /usr/local/nagios/libexec/check_postgres_connection --dbservice=$ARG1$
}

define command {
    command_name           check_postgres_database_size
    command_line           /usr/local/nagios/libexec/check_postgres_database_size --dbservice=$ARG1$ --critical='$ARG2$'
}

define command {
    command_name           check_postgres_locks
    command_line           /usr/local/nagios/libexec/check_postgres_locks --dbservice=$ARG1$
}

define command {
    command_name           check_postgres_backends
    command_line           /usr/local/nagios/libexec/check_postgres_backends --dbservice=$ARG1$
}
</code></pre>
<p>Save and close the file.</p>

<p>In this file, you define four Nagios commands that call different parts of the <code>check_postgres</code> plugin (checking connectivity, getting the number of locks and connections, and the size of the whole database). They all accept an argument that is passed to the <code>--dbservice</code> parameter, and specify which of the databases defined in <code>pg_service.conf</code> to connect to.</p>

<p>The <code>check_postgres_database_size</code> command accepts a second argument that gets passed to the <code>--critical</code> parameter, which specifies the point at which the database storage is becoming full. Accepted values include <code>1 KB</code> for a kilobyte, <code>1 MB</code> for a megabyte, and so on, up to exabytes (<code>EB</code>). A number without a capacity unit is treated as being expressed in bytes.</p>

<p>Now that the necessary commands are defined, you'll define the host (essentially, the database) and its monitoring services in a file named <code>services.cfg</code>. Create it using your favorite editor:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo nano /usr/local/nagios/etc/objects/postgresql/services.cfg
</li></ul></code></pre>
<p>Add the following lines, replacing <code><span class="highlight">db_max_storage_size</span></code> with a value pertaining to the available storage of your database. It is recommended to set it to 90 percent of the storage size you have allocated to it:</p>
<div class="code-label " title="/usr/local/nagios/etc/objects/postgresql/services.cfg">/usr/local/nagios/etc/objects/postgresql/services.cfg</div><pre class="code-pre "><code langs="">define host {
      use                    linux-server
      host_name              postgres
      check_command          check_postgres_connection!managed-db
}

define service {
      use                    generic-service
      host_name              postgres
      service_description    PostgreSQL Connection
      check_command          check_postgres_connection!managed-db
      notification_options   w,u,c,r,f,s
}

define service {
      use                    generic-service
      host_name              postgres
      service_description    PostgreSQL Database Size
      check_command          check_postgres_database_size!managed-db!<span class="highlight">db_max_storage_size</span>
      notification_options   w,u,c,r,f,s
}

define service {
      use                    generic-service
      host_name              postgres
      service_description    PostgreSQL Locks
      check_command          check_postgres_locks!managed-db
      notification_options   w,u,c,r,f,s
}

define service {
      use                    generic-service
      host_name              postgres
      service_description    PostgreSQL Backends
      check_command          check_postgres_backends!managed-db
      notification_options   w,u,c,r,f,s
}
</code></pre>
<p>You first define a host, so that Nagios will know what entity the services relate to. Then, you create four services, which call the commands you just defined. Each one passes <code>managed-db</code> as the argument, detailing that the <code>managed-db</code> you defined in Step 2 should be monitored.</p>

<p>Regarding notification options, each service specifies that notifications should be sent out when the service state becomes <code>WARNING</code>, <code>UNKNOWN</code>, <code>CRITICAL</code>, <code>OK</code> (when it recovers from downtime), when the service starts <a href="https://assets.nagios.com/downloads/nagioscore/docs/nagioscore/3/en/flapping.html">flapping</a>, or when scheduled downtime starts or ends. Without explicitly giving this option a value, no notifications would be sent out (to available contacts) at all, except if triggered manually.</p>

<p>Save and close the file.</p>

<p>Next, you'll need to explicitly tell Nagios to read config files from this new directory, by editing the general Nagios config file. Open it for editing by running the following command:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo nano /usr/local/nagios/etc/nagios.cfg
</li></ul></code></pre>
<p>Find this highlighted line in the file:</p>
<div class="code-label " title="/usr/local/nagios/etc/nagios.cfg">/usr/local/nagios/etc/nagios.cfg</div><pre class="code-pre "><code langs="">...
# directive as shown below:

<span class="highlight">cfg_dir=/usr/local/nagios/etc/servers</span>
#cfg_dir=/usr/local/nagios/etc/printers
...
</code></pre>
<p>Above it, add the following highlighted line:</p>
<div class="code-label " title="/usr/local/nagios/etc/nagios.cfg">/usr/local/nagios/etc/nagios.cfg</div><pre class="code-pre "><code langs="">...
<span class="highlight">cfg_dir=/usr/local/nagios/etc/objects/postgresql</span>
cfg_dir=/usr/local/nagios/etc/servers
...
</code></pre>
<p>Save and close the file. This line tells Nagios to load all config files from the <code>/usr/local/nagios/etc/objects/postgresql</code> directory, where your configuration files are located.</p>

<p>Before restarting Nagios, check the validity of the configuration by running the following command:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo /usr/local/nagios/bin/nagios -v /usr/local/nagios/etc/nagios.cfg
</li></ul></code></pre>
<p>The end of the output will look similar to this:</p>
<pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>Total Warnings: 0
Total Errors:   0

Things look okay - No serious problems were detected during the pre-flight check
</code></pre>
<p>This means that Nagios found no errors in the configuration. If it shows you an error, you'll also see a hint as to what went wrong, so you'll be able to fix the error more easily.</p>

<p>To make Nagios reload its configuration, restart its service by running the following command:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo systemctl restart nagios
</li></ul></code></pre>
<p>You can now navigate to Nagios in your browser. Once it loads, press on the <strong>Services</strong> option from the left-hand menu. You'll see the <code>postgres</code> host and a list of services, along with their current statuses:</p>

<p><img src="https://assets.digitalocean.com/articles/postgres_managed_nagios/step3.png" alt="PostgreSQL Monitoring Services - Pending"></p>

<p>They will all soon turn to green and show an <code>OK</code> status. You'll see the command output under the <strong>Status Information</strong> column. You can click on the service name and see detailed information about its status and availability.</p>

<p>You've added <code>check_postgres</code> commands, a host, and multiple services to your Nagios installation to monitor your database. You've also checked that the services are working properly by examining them via the Nagios web interface. In the next step, you will configure Slack-based alerting.</p>

<h2 id="step-4-—-configuring-slack-alerting">Step 4 — Configuring Slack Alerting</h2>

<p>In this section, you will configure Nagios to alert you about events via Slack, by posting them into desired channels in your workspace.</p>

<p>Before you start, log in to your desired workspace on Slack and create two channels where you'll want to receive status messages from Nagios: one for host, and the other one for service notifications. If you wish, you can create only one channel where you'll receive both kinds of alerts.</p>

<p>Then, head over to the <a href="https://slack.com/apps/A0F81R747-nagios">Nagios app</a> in the Slack App Directory and press on <strong>Add Configuration</strong>. You'll see a page for adding the Nagios Integration.</p>

<p><img src="https://assets.digitalocean.com/articles/postgres_managed_nagios/step4a.png" alt="Slack - Add Nagios Integration"></p>

<p>Press on <strong>Add Nagios Integration</strong>. When the page loads, scroll down and take note of the token, because you'll need it further on.</p>

<p><img src="https://assets.digitalocean.com/articles/postgres_managed_nagios/step4bnew.png" alt="Slack - Integration Token"></p>

<p>You'll now install and configure the Slack plugin (written in Perl) for Nagios on your server. First, install the required Perl prerequisites by running the following command:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo apt install libwww-perl libcrypt-ssleay-perl -y
</li></ul></code></pre>
<p>Then, download the plugin to your Nagios plugin directory:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo curl https://raw.githubusercontent.com/tinyspeck/services-examples/master/nagios.pl -o slack.pl
</li></ul></code></pre>
<p>Make it executable by running the following command:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo chmod +x slack.pl
</li></ul></code></pre>
<p>Now, you'll need to edit it to connect to your workspace using the token you got from Slack. Open it for editing:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo nano slack.pl
</li></ul></code></pre>
<p>Find the following lines in the file:</p>
<div class="code-label " title="/usr/local/nagios/libexec/slack.pl">/usr/local/nagios/libexec/slack.pl</div><pre class="code-pre "><code langs="">...
my $opt_domain = "<span class="highlight">foo</span>.slack.com"; # Your team's domain
my $opt_token = "<span class="highlight">your_token</span>"; # The token from your Nagios services page
...
</code></pre>
<p>Replace <code><span class="highlight">foo</span>.slack.com</code> with your workspace domain and <code><span class="highlight">your_token</span></code> with your Nagios app integration token, then save and close the file. The script will now be able to send proper requests to Slack, which you'll now test by running the following command:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">./slack.pl -field slack_channel=#<span class="highlight">your_channel_name</span> -field HOSTALIAS="Test Host" -field HOSTSTATE="UP" -field HOSTOUTPUT="Host is UP" -field NOTIFICATIONTYPE="RECOVERY"
</li></ul></code></pre>
<p>Replace <code><span class="highlight">your_channel_name</span></code> with the name of the channel where you'll want to receive status alerts. The script will output information about the HTTP request it made to Slack, and if everything went through correctly, the last line of the output will be <code>ok</code>. If you get an error, double check if the Slack channel you specified exists in the workspace.</p>

<p>You can now head over to your Slack workspace and select the channel you specified. You'll see a test message coming from Nagios.</p>

<p><img src="https://assets.digitalocean.com/articles/postgres_managed_nagios/step4c.png" alt="Slack - Nagios Test Message"></p>

<p>This confirms that you have properly configured the Slack script. You'll now move on to configuring Nagios to alert you via Slack using this script.</p>

<p>You'll need to create a contact for Slack and two commands that will send messages to it. You'll store this config in a file named <code>slack.cfg</code>, in the same folder as the previous config files. Create it for editing by running the following command:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo nano /usr/local/nagios/etc/objects/postgresql/slack.cfg
</li></ul></code></pre>
<p>Add the following lines:</p>
<div class="code-label " title="/usr/local/nagios/etc/objects/postgresql/slack.cfg">/usr/local/nagios/etc/objects/postgresql/slack.cfg</div><pre class="code-pre "><code langs="">define contact {
      contact_name                             slack
      alias                                    Slack
      service_notification_period              24x7
      host_notification_period                 24x7
      service_notification_options             w,u,c,f,s,r
      host_notification_options                d,u,r,f,s
      service_notification_commands            notify-service-by-slack
      host_notification_commands               notify-host-by-slack
}

define command {
      command_name     notify-service-by-slack
      command_line     /usr/local/nagios/libexec/slack.pl -field slack_channel=#<span class="highlight">service_alerts_channel</span>
}

define command {
      command_name     notify-host-by-slack
      command_line     /usr/local/nagios/libexec/slack.pl -field slack_channel=#<span class="highlight">host_alerts_channel</span>
}
</code></pre>
<p>Here you define a contact named <code>slack</code>, state that it can be contacted anytime and specify which commands to use for notifying service and host related events. Those two commands are defined after it and call the script you have just configured. You'll need to replace <code><span class="highlight">service_alerts_channel</span></code> and <code><span class="highlight">host_alerts_channel</span></code> with the names of the channels where you want to receive service and host messages, respectively. If preferred, you can use the same channel names.</p>

<p>Similarly to the service creation in the last step, setting service and host notification options on the contact is crucial, because it governs what kind of alerts the contact will receive. Omitting those options would result in sending out notifications only when manually triggered from the web interface.</p>

<p>When you are done with editing, save and close the file.</p>

<p>To enable alerting via the <code>slack</code> contact you just defined, you'll need to add it to the <code>admin</code> contact group, defined in the <code>contacts.cfg</code> config file, located under <code>/usr/local/nagios/etc/objects/</code>. Open it for editing by running the following command:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo nano /usr/local/nagios/etc/objects/contacts.cfg
</li></ul></code></pre>
<p>Find the config block that looks like this:</p>
<div class="code-label " title="/usr/local/nagios/etc/objects/contacts.cfg">/usr/local/nagios/etc/objects/contacts.cfg</div><pre class="code-pre "><code langs="">define contactgroup {

    contactgroup_name       admins
    alias                   Nagios Administrators
    members                 nagiosadmin
}
</code></pre>
<p>Add <code>slack</code> to the list of members, like so:</p>
<div class="code-label " title="/usr/local/nagios/etc/objects/contacts.cfg">/usr/local/nagios/etc/objects/contacts.cfg</div><pre class="code-pre "><code langs="">define contactgroup {

    contactgroup_name       admins
    alias                   Nagios Administrators
    members                 nagiosadmin<span class="highlight">,slack</span>
}
</code></pre>
<p>Save and close the file.</p>

<p>By default when running scripts, Nagios does not make host and service information available via environment variables, which is what the Slack script requires in order to send meaningful messages. To remedy this, you'll need to set the <code>enable_environment_macros</code> setting in <code>nagios.cfg</code> to <code>1</code>. Open it for editing by running the following command:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo nano /usr/local/nagios/etc/nagios.cfg
</li></ul></code></pre>
<p>Find the line that looks like this:</p>
<div class="code-label " title="/usr/local/nagios/etc/nagios.cfg">/usr/local/nagios/etc/nagios.cfg</div><pre class="code-pre "><code langs="">enable_environment_macros=0
</code></pre>
<p>Change the value to <code>1</code>, like so:</p>
<div class="code-label " title="/usr/local/nagios/etc/nagios.cfg">/usr/local/nagios/etc/nagios.cfg</div><pre class="code-pre "><code langs="">enable_environment_macros=<span class="highlight">1</span>
</code></pre>
<p>Save and close the file.</p>

<p>Test the validity of the Nagios configuration by running the following command:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo /usr/local/nagios/bin/nagios -v /usr/local/nagios/etc/nagios.cfg
</li></ul></code></pre>
<p>The end of the output will look like:</p>
<pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>Total Warnings: 0
Total Errors:   0

Things look okay - No serious problems were detected during the pre-flight check
</code></pre>
<p>Proceed to restart Nagios by running the following command:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo systemctl restart nagios
</li></ul></code></pre>
<p>To test the Slack integration, you'll send out a custom notification via the web interface. Reload the Nagios <strong>Services</strong> status page in your browser. Press on the <strong>PostgreSQL Backends</strong> service and press on <strong>Send custom service notification</strong> on the right when the page loads.</p>

<p><img src="https://assets.digitalocean.com/articles/postgres_managed_nagios/step4d.png" alt="Nagios - Custom Service Notification"></p>

<p>Type in a comment of your choice and press on <strong>Commit</strong>, and then press on <strong>Done</strong>. You'll immediately receive a new message in Slack.</p>

<p><img src="https://assets.digitalocean.com/articles/postgres_managed_nagios/step4e.png" alt="Slack - Status Alert From Nagios"></p>

<p>You have now integrated Slack with Nagios, so you'll receive messages about critical events and status changes immediately. You've also tested the integration by manually triggering an event from within Nagios.</p>

<h2 id="conclusion">Conclusion</h2>

<p>You now have Nagios Core configured to watch over your managed PostgreSQL database and report any status changes and events to Slack, so you'll always be in the loop of what is happening to your database. This will allow you to swiftly react in case of an emergency, because you'll be getting the status feed in real time.</p>

<p>If you'd like to learn more about the features of <code>check_postgres</code>, check out its <a href="https://bucardo.org/check_postgres/check_postgres.pl.html#actions">docs</a>, where you'll find a lot more commands that you can possibly use.</p>

<p>For more information about what you can do with your PostgreSQL Managed Database, visit the <a href="https://www.digitalocean.com/docs/databases/">product docs</a>.</p>
