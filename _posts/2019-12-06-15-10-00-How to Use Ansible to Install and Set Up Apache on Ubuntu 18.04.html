---
layout: post
title: How to Use Ansible to Install and Set Up Apache on Ubuntu 18.04
network: digitalocean
date: December 06, 2019 at 03:10PM
url: https://www.digitalocean.com/community/tutorials/how-to-use-ansible-to-install-and-set-up-apache-on-ubuntu-18-04
image: https://assets.digitalocean.com/articles/apache_virtual_hosts_ubuntu/vhost_your_domain.png
tags: docker
feedtitle: DigitalOcean Community Tutorials
feedurl: https://www.digitalocean.com/community/tutorials
author: DigitalOcean
---
<h3 id="introduction">Introduction</h3>

<p>Server automation now plays an essential role in systems administration, due to the disposable nature of modern application environments. <a href="https://www.digitalocean.com/community/tutorial_series/getting-started-with-configuration-management">Configuration management</a> tools such as <a href="https://ansible.com">Ansible</a> are typically used to streamline the process of automating server setup by establishing standard procedures for new servers while also reducing human error associated with manual setups.</p>

<p>Ansible offers a simple architecture that doesn&rsquo;t require special software to be installed on nodes. It also provides a robust set of features and built-in modules which facilitate writing automation scripts.</p>

<p>This guide explains how to use Ansible to automate the steps contained in our guide on <a href="https://www.digitalocean.com/community/tutorials/how-to-install-the-apache-web-server-on-ubuntu-18-04">How To Install the Apache Web Server on Ubuntu 18.04</a>. The Apache HTTP server is the most widely-used web server in the world. It provides many powerful features including dynamically loadable modules, robust media support, and extensive integration with other popular software.</p>

<h2 id="prerequisites">Prerequisites</h2>

<p>In order to execute the automated setup provided by the playbook we&rsquo;re discussing in this guide, you&rsquo;ll need:</p>

<ul>
<li><strong>One Ansible control node</strong>: an Ubuntu 18.04 machine with Ansible installed and configured to connect to your Ansible hosts using SSH keys. Make sure the control node has a regular user with sudo permissions and a firewall enabled, as explained in our <a href="https://www.digitalocean.com/community/tutorials/initial-server-setup-with-ubuntu-18-04">Initial Server Setup</a> guide. To set up Ansible, please follow our guide on <a href="https://www.digitalocean.com/community/tutorials/how-to-install-and-configure-ansible-on-ubuntu-18-04">How to Install and Configure Ansible on Ubuntu 18.04</a>.</li>
<li><strong>One or more Ansible Hosts</strong>: one or more remote Ubuntu 18.04 servers previously set up following the guide on <a href="https://www.digitalocean.com/community/tutorials/how-to-use-ansible-to-automate-initial-server-setup-on-ubuntu-18-04">How to Use Ansible to Automate Initial Server Setup on Ubuntu 18.04</a>.</li>
</ul>

<p><span class='note'>Before proceeding, you first need to make sure your Ansible control node is able to connect and execute commands on your Ansible host(s). For a connection test, please check step 3 of <a href="https://www.digitalocean.com/community/tutorials/how-to-install-and-configure-ansible-on-ubuntu-18-04#step-3-%E2%80%94-testing-connection">How to Install and Configure Ansible on Ubuntu 18.04</a>.<br></span></p>

<h2 id="what-does-this-playbook-do">What Does this Playbook Do?</h2>

<p>This Ansible playbook provides an alternative to manually running through the procedure outlined in our guide on <a href="https://www.digitalocean.com/community/tutorials/how-to-install-the-apache-web-server-on-ubuntu-18-04">How To Install the Apache Web Server on Ubuntu 18.04</a>.</p>

<p>Running this playbook will perform the following actions on your Ansible hosts:</p>

<ol>
<li>Install <code>aptitude</code>, which is preferred by Ansible as an alternative to the <code>apt</code> package manager.</li>
<li>Install Apache.</li>
<li>Create a custom document root folder for the new Apache VirtualHost and set up a test page.</li>
<li>Enable the new Apache VirtualHost.</li>
<li>Disable the default Apache website when the variable <code>disable_default</code> is set to <code>true</code>.</li>
<li>Set up UFW to allow HTTP traffic on the configured port (<code>80</code> by default).</li>
</ol>

<p>Once the playbook has finished running, you will have a web server running on your target node, based on the options you defined within your configuration variables.</p>

<h2 id="how-to-use-this-playbook">How to Use this Playbook</h2>

<p>The first thing we need to do is obtain the Apache playbook and its dependencies from the <a href="https://github.com/do-community/ansible-playbooks">do-community/ansible-playbooks</a> repository. We need to clone this repository to a local folder inside the Ansible Control Node.</p>

<p>In case you have cloned this repository before while following a different guide, access your existing <code>ansible-playbooks</code> copy and run a <code>git pull</code> command to make sure you have updated contents:</p>
<pre class="code-pre command local-environment"><code langs=""><ul class="prefixed"><li class="line" prefix="$">cd ~/ansible-playbooks
</li><li class="line" prefix="$">git pull
</li></ul></code></pre>
<p>If this is your first time using the <code>do-community/ansible-playbooks</code> repository, you should start by cloning the repository to your home folder with:</p>
<pre class="code-pre command local-environment"><code langs=""><ul class="prefixed"><li class="line" prefix="$">cd ~
</li><li class="line" prefix="$">git clone https://github.com/do-community/ansible-playbooks.git
</li><li class="line" prefix="$">cd ansible-playbooks
</li></ul></code></pre>
<p>The files we&rsquo;re interested in are located inside the <code>apache_ubuntu1804</code> folder, which has the following structure:</p>
<pre class="code-pre "><code langs="">apache_ubuntu1804
├── files
│   ├── apache.conf.j2
│   └── index.html.j2
├── vars
│   └── default.yml
├── playbook.yml
└── readme.md
</code></pre>
<p>Here is what each of these files are:</p>

<ul>
<li><code>files/apache.conf.j2</code>: Template file for setting up the Apache Virtual Host.</li>
<li><code>files/index.html.j2</code>: Template file for setting up a test page on the web server&rsquo;s root directory. </li>
<li><code>vars/default.yml</code>: Variable file for customizing playbook settings.</li>
<li><code>playbook.yml</code>: The playbook file, containing the tasks to be executed on the remote server(s).</li>
<li><code>readme.md</code>: A text file containing information about this playbook.</li>
</ul>

<p>We&rsquo;ll edit the playbook&rsquo;s variable file to customize a few options. Access the <code>apache_ubuntu1804</code> directory and open the <code>vars/default.yml</code> file using your command line editor of choice:</p>
<pre class="code-pre command local-environment"><code langs=""><ul class="prefixed"><li class="line" prefix="$">cd apache_ubuntu1804
</li><li class="line" prefix="$">nano vars/default.yml
</li></ul></code></pre>
<p>This file contains a few variables that require your attention:</p>
<div class="code-label " title="vars/default.yml">vars/default.yml</div><pre class="code-pre yaml local-environment"><code langs="">---
app_user: "<span class="highlight">sammy</span>"
http_host: "<span class="highlight">your_domain</span>"
http_conf: "<span class="highlight">your_domain</span>.conf"
http_port: "<span class="highlight">80</span>"
disable_default: <span class="highlight">true</span>
</code></pre>
<p>The following list contains a brief explanation of each of these variables and how you might want to change them:</p>

<ul>
<li><code>app_user</code>: A remote non-root user on the Ansible host that will be set as the owner of the application files. </li>
<li><code>http_host</code>: Your domain name.</li>
<li><code>http_conf</code>: The name of the configuration file that will be created within Apache.</li>
<li><code>http_port</code>: HTTP port for this virtual host, where <code>80</code> is the default. </li>
<li><code>disable_default</code>: Whether or not to disable the default website that comes with Apache.</li>
</ul>

<p>Once you&rsquo;re done updating the variables inside <code>vars/default.yml</code>, save and close this file. If you used <code>nano</code>, do so by pressing <code>CTRL + X</code>, <code>Y</code>, then <code>ENTER</code>.</p>

<p>You&rsquo;re now ready to run this playbook on one or more servers. Most playbooks are configured to be executed on every server in your inventory, by default. We can use the <code>-l</code> flag to make sure that only a subset of servers, or a single server, is affected by the playbook. We can also use the <code>-u</code> flag to specify which user on the remote server we&rsquo;re using to connect and execute the playbook commands on the remote hosts.</p>

<p>To execute the playbook only on <code><span class="highlight">server1</span></code>, connecting as <code><span class="highlight">root</span></code>, you can use the following command:</p>
<pre class="code-pre command local-environment"><code langs=""><ul class="prefixed"><li class="line" prefix="$">ansible-playbook playbook.yml -l <span class="highlight">server1</span> -u <span class="highlight">root</span>
</li></ul></code></pre>
<p>You will get output similar to this:</p>
<pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>
PLAY [all] *****************************************************************************************************************************

TASK [Gathering Facts] *****************************************************************************************************************
ok: [server1]

TASK [Install prerequisites] ***********************************************************************************************************
ok: [server1] =&gt; (item=aptitude)

TASK [Install Apache] ******************************************************************************************************************
changed: [server1]

TASK [Create document root] ************************************************************************************************************
changed: [server1]

TASK [Copy index test page] ************************************************************************************************************
changed: [server1]

TASK [Set up Apache virtualhost] *******************************************************************************************************
changed: [server1]

TASK [Enable new site] *****************************************************************************************************************
changed: [server1]

TASK [Disable default Apache site] *****************************************************************************************************
changed: [server1]

TASK [UFW - Allow HTTP on port 80] *****************************************************************************************************
changed: [server1]

RUNNING HANDLER [Reload Apache] ********************************************************************************************************
changed: [server1]

PLAY RECAP *****************************************************************************************************************************
server1            : ok=10   changed=8    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   



</code></pre>
<p><span class='note'><strong>Note</strong>: For more information on how to run Ansible playbooks, check our <a href="https://www.digitalocean.com/community/tutorials/how-to-use-ansible-cheat-sheet-guide">Ansible Cheat Sheet Guide</a>.<br></span></p>

<p>When the playbook is finished running, go to your web browser and access the host or IP address of the server, as configured in the playbook variables:</p>
<pre class="code-pre "><code langs="">http://<span class="highlight">server_host_or_IP</span>
</code></pre>
<p>You will see a page like this:</p>

<p><img src="https://assets.digitalocean.com/articles/apache_virtual_hosts_ubuntu/vhost_your_domain.png" alt="it works page"></p>

<p>That means the automation was fully executed on your server, and Apache is now ready to serve static HTML pages and assets placed in the document root directory that you&rsquo;ve set up within the playbook configuration variables.</p>

<h2 id="the-playbook-contents">The Playbook Contents</h2>

<p>You can find the Apache server setup featured in this tutorial in the <a href="https://github.com/do-community/ansible-playbooks/tree/master/apache_ubuntu1804"><code>apache_ubuntu1804</code></a> folder inside the <a href="https://github.com/do-community/ansible-playbooks">DigitalOcean Community Playbooks</a> repository. To copy or download the script contents directly, click the <strong>Raw</strong> button towards the top of each script.</p>

<p>The full contents of the playbook as well as its associated files are also included here for your convenience.</p>

<h3 id="vars-default-yml">vars/default.yml</h3>

<p>The <code>default.yml</code> variable file contains values that will be used within the playbook tasks, such as the HTTP port and domain name to configure within your Apache VirtualHost.</p>
<div class="code-label " title="vars/default.yml">vars/default.yml</div><pre class="code-pre yaml local-environment"><code langs="">---
app_user: "<span class="highlight">sammy</span>"
http_host: "<span class="highlight">your_domain</span>"
http_conf: "<span class="highlight">your_domain</span>.conf"
http_port: "<span class="highlight">80</span>"
disable_default: <span class="highlight">true</span>
</code></pre>
<h3 id="files-apache-conf-j2">files/apache.conf.j2</h3>

<p>The <code>apache.conf.j2</code> file is a <a href="https://jinja.palletsprojects.com/en/2.10.x/">Jinja 2</a> template file that configures a new Apache VirtualHost. The variables used within this template are defined in the <code>vars/default.yml</code> variable file.</p>
<div class="code-label " title="files/apache.conf.j2">files/apache.conf.j2</div><pre class="code-pre  local-environment"><code langs="">&lt;VirtualHost *:{{ http_port }}&gt;
   ServerAdmin webmaster@localhost
   ServerName {{ http_host }}
   ServerAlias www.{{ http_host }}
   DocumentRoot /var/www/{{ http_host }}
   ErrorLog ${APACHE_LOG_DIR}/error.log
   CustomLog ${APACHE_LOG_DIR}/access.log combined
&lt;/VirtualHost&gt;
</code></pre>
<h3 id="files-index-html-j2">files/index.html.j2</h3>

<p>The <code>index.html.j2</code> file is another Jinja template, used to set up a test HTML page in the document root of the newly configured Apache server.</p>
<div class="code-label " title="files/index.html.j2">files/index.html.j2</div><pre class="code-pre  local-environment"><code langs="">&lt;html&gt;
   &lt;head&gt;
       &lt;title&gt;Welcome to {{ http_host }} !&lt;/title&gt;
   &lt;/head&gt;
   &lt;body&gt;
       &lt;h1&gt;Success! The {{ http_host }} virtual host is working!&lt;/h1&gt;
   &lt;/body&gt;
&lt;/html&gt;
</code></pre>
<h3 id="playbook-yml">playbook.yml</h3>

<p>The <code>playbook.yml</code> file is where all tasks from this setup are defined. It starts by defining the group of servers that should be the target of this setup (<code>all</code>), after which it uses <code>become: true</code> to define that tasks should be executed with privilege escalation (<code>sudo</code>) by default. Then, it includes the <code>vars/default.yml</code> variable file to load configuration options.</p>
<div class="code-label " title="playbook.yml">playbook.yml</div><pre class="code-pre yaml local-environment"><code langs="">---
- hosts: all
  become: true
  vars_files:
    - vars/default.yml

  tasks:
    - name: Install prerequisites
      apt: name={{ item }} update_cache=yes state=latest force_apt_get=yes
      loop: [ 'aptitude' ]

    - name: Install Apache
      apt: name=apache2 update_cache=yes state=latest

    - name: Create document root
      file:
        path: "/var/www/{{ http_host }}"
        state: directory
        owner: "{{ app_user }}"
        mode: '0755'

    - name: Copy index test page
      template:
        src: "files/index.html.j2"
        dest: "/var/www/{{ http_host }}/index.html"

    - name: Set up Apache virtuahHost
      template:
        src: "files/apache.conf.j2"
        dest: "/etc/apache2/sites-available/{{ http_conf }}"

    - name: Enable new site
      shell: /usr/sbin/a2ensite {{ http_conf }}
      notify: Reload Apache

    - name: Disable default Apache site
      shell: /usr/sbin/a2dissite 000-default.conf
      when: disable_default
      notify: Reload Apache

    - name: "UFW - Allow HTTP on port {{ http_port }}"
      ufw:
        rule: allow
        port: "{{ http_port }}"
        proto: tcp

  handlers:
    - name: Reload Apache
      service:
        name: apache2
        state: reloaded

    - name: Restart Apache
      service:
        name: apache2
        state: restarted
</code></pre>
<p>Feel free to modify these files to best suit your individual needs within your own workflow. </p>

<h2 id="conclusion">Conclusion</h2>

<p>In this guide, we used Ansible to automate the process of installing and configuring Apache on Ubuntu 18.04.</p>

<p>If you&rsquo;d like to include other tasks in this playbook to further customize your server setup, please refer to our introductory Ansible guide <a href="https://www.digitalocean.com/community/tutorials/configuration-management-101-writing-ansible-playbooks">Configuration Management 101: Writing Ansible Playbooks</a>. </p>
