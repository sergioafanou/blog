---
layout: post
title: Создание приложения Node.js с помощью Docker
network: digitalocean
date: January 07, 2020 at 07:21PM
url: https://www.digitalocean.com/community/tutorials/how-to-build-a-node-js-application-with-docker-ru
image: https://assets.digitalocean.com/articles/docker_node_image/landing_page.png
tags: docker
feedtitle: DigitalOcean Community Tutorials
feedurl: https://www.digitalocean.com/community/tutorials
author: DigitalOcean
---
<h3 id="Введение">Введение</h3>

<p>Платформа <a href="https://www.docker.com/">Docker</a> позволяет разработчикам упаковывать и запускать приложения как <em>контейнеры</em>. Контейнер — это изолированный процесс, выполняемый в общей операционной системе, и представляющий из себя облегченную альтернативу виртуальным машинам. Хотя концепция контейнеров существует уже давно, обеспечиваемые ими преимущества изоляции процессов и стандартизации среды становятся все более важными по мере того, как все больше разработчиков начинают использовать распределенные архитектуры приложений.</p>

<p>При создании и масштабировании приложений Docker вначале обычно создается образ приложения, который можно запустить в контейнере. Образ включает код приложения, библиотеки, файлы конфигурации, переменные среды и исполняемый модуль. Благодаря использованию образа среда в контейнере стандартизирована и содержит только то, что необходимо для сборки и выполнения приложения.</p>

<p>В этом обучающем модуле вы создадите образ приложения для статического сайта, использующего систему <a href="https://expressjs.com/">Express</a> и <a href="https://getbootstrap.com/">Bootstrap</a>. Затем вы построите контейнер с этим образом и разместите его в <a href="https://hub.docker.com/">Docker Hub</a> для будущего использования. Наконец, вы извлечете сохраненный образ из хранилища Docker Hub и построите другой контейнер, продемонстрировав возможность воссоздания и масштабирования вашего приложения.</p>

<h2 id="Предварительные-требования">Предварительные требования</h2>

<p>Для данного обучающего модуля вам потребуется следующее:</p>

<ul>
<li>Один сервер Ubuntu 18.04, <a href="https://www.digitalocean.com/community/tutorials/initial-server-setup-with-ubuntu-18-04">настроенный в соответствии с руководством «Начальная настройка сервера»</a>.</li>
<li>Система <a href="https://www.digitalocean.com/community/tutorials/how-to-install-and-use-docker-on-ubuntu-18-04">Docker, установленная на сервере в соответствии с шагами 1 и 2 руководства «Установка и использование Docker в Ubuntu 18.04»</a>.</li>
<li>Node.js и npm, установленные в соответствии с <a href="https://www.digitalocean.com/community/tutorials/how-to-install-node-js-on-ubuntu-18-04#installing-using-a-ppa">инструкциями по установке с PPA под управлением NodeSource</a>.</li>
<li>Учетная запись Docker Hub. Обзорную информацию по настройке можно найти во <a href="https://docs.docker.com/docker-hub/">введении</a> к началу работы с Docker Hub.</li>
</ul>

<h2 id="Шаг-1-—-Установка-зависимостей-вашего-приложения">Шаг 1 — Установка зависимостей вашего приложения</h2>

<p>Чтобы создать образ, нужно сначала выполнить сборку файлов приложения, а затем скопировать их в контейнер. Эти файлы будут включать статический контент, код и зависимости вашего приложения.</p>

<p>Создайте для вашего проекта каталог в начальном каталоге пользователя, не являющегося пользователем root. Мы назовем наш проект <code><span class="highlight">node_project</span></code>, но вы можете заменить это название на другое:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">mkdir <span class="highlight">node_project</span>
</li></ul></code></pre>
<p>Перейдите в этот каталог:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">cd <span class="highlight">node_project</span>
</li></ul></code></pre>
<p>Это будет корневой каталог проекта.</p>

<p>Далее создайте файл <a href="https://docs.npmjs.com/files/package.json"><code>package.json</code></a> с зависимостями пакета и другой идентификационной информацией. Откройте файл с помощью <code>nano</code> или своего любимого редактора:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">nano package.json
</li></ul></code></pre>
<p>Добавьте следующую информацию по проекту, включая его название, автора, лицензию, входную точку и зависимости. Обязательно замените данные автора собственным именем и контактными данными:</p>
<div class="code-label " title="~/node_project/package.json">~/node_project/package.json</div><pre class="code-pre "><code langs="">{
  "name": "<span class="highlight">nodejs-image-demo</span>",
  "version": "1.0.0",
  "description": "nodejs image demo",
  "author": "<span class="highlight">Sammy the Shark &lt;sammy@example.com&gt;</span>",
  "license": "MIT",
  "main": "app.js",
  "keywords": [
    "nodejs",
    "bootstrap",
    "express"
  ],
  "dependencies": {
    "express": "^4.16.4"
  }
}
</code></pre>
<p>Файл содержит название проекта, автора и лицензию, по которой он распространяется. Npm <a href="https://docs.npmjs.com/files/package.json#name">рекомендует использовать</a> краткие  и содержательные названия проектов и избегать использования дубликатов в <a href="https://www.npmjs.com/">реестре npm</a>. Мы указали <a href="https://opensource.org/licenses/MIT">лицензию MIT</a> в поле license, что дает нам право на свободное использование и распространение кода приложения.</p>

<p>Кроме того в файле указано следующее:</p>

<ul>
<li><code>"main"</code>: точка входа приложения, <code>app.js</code>. Затем вы создадите этот файл.</li>
<li><code>"dependencies"</code>: зависимости проекта — в данном случае, Express 4.16.4 или более поздняя версия.</li>
</ul>

<p>Хотя этот файл не указан в <a href="https://docs.npmjs.com/files/package.json#repository">хранилище, вы можете добавить его в соответствии со следующими указаниями по добавлению хранилища в файл <code>package.json</code></a>. Это хорошее дополнение, если вы задаете версии своего приложения.</p>

<p>Сохраните и закройте файл, когда закончите вносить изменения.</p>

<p>Чтобы установить зависимости проекта, выполните следующую команду:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">npm install
</li></ul></code></pre>
<p>Пакеты, перечисленные вами в файле <code>package.json</code>, будут установлены в каталог вашего проекта.</p>

<p>Теперь можно перейти к сборке файлов приложения.</p>

<h2 id="Шаг-2-—-Создание-файлов-приложения">Шаг 2 — Создание файлов приложения</h2>

<p>Мы создадим сайт, который предоставляет пользователям данные об акулах. В нашем приложении будет основная точка входа, <code>app.js</code>, и каталог <code>views</code>, где будут находиться статичные активы проекта. Начальная страница <code>index.html</code> будет предоставлять пользователям предварительную информацию и ссылку на страницу с более подробной информацией об акулах, <code>sharks.html</code>. В каталоге <code>views</code> мы создадим начальную страницу и файл <code>sharks.html</code>.</p>

<p>Вначале откройте файл <code>app.js</code> в главном каталоге проекта, чтобы определить маршруты проекта:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">nano app.js
</li></ul></code></pre>
<p>Первая часть файла будет создавать приложение Express и объекты Router, а также определять базовый каталог и порт как постоянные величины:</p>
<div class="code-label " title="~/node_project/app.js">~/node_project/app.js</div><pre class="code-pre "><code langs="">const express = require('express');
const app = express();
const router = express.Router();

const path = __dirname + '/views/';
const port = 8080;
</code></pre>
<p>Функция <code>require</code> загружает модуль <code>express</code>, который мы используем для создания объектов <code>app</code> и <code>router</code>. Объект <code>router</code> будет выполнять функцию маршрутизации в приложении. Определяя маршруты методов HTTP, мы будем добавлять их в этот объект, чтобы определить, как наше приложение будет обрабатывать запросы.</p>

<p>В этом разделе файла также содержатся две константы, <code>path</code> и <code>port</code>:</p>

<ul>
<li><code>path</code>: определяет базовый каталог, в данном случае подкаталог <code>views</code> в каталоге текущего проекта.</li>
<li><code>port</code>: указывает приложению прослушивать и выполнить привязку к порту <code>8080</code>.</li>
</ul>

<p>Затем настройте маршруты для приложения с помощью объекта <code>router</code>:</p>
<div class="code-label " title="~/node_project/app.js">~/node_project/app.js</div><pre class="code-pre "><code langs="">...

router.use(function (req,res,next) {
  console.log('/' + req.method);
  next();
});

router.get('/', function(req,res){
  res.sendFile(path + 'index.html');
});

router.get('/sharks', function(req,res){
  res.sendFile(path + 'sharks.html');
});
</code></pre>
<p>Функция <code>router.use</code> загружает <a href="https://expressjs.com/en/guide/writing-middleware.html">промежуточную функцию</a>, которая будет регистрировать запросы маршрутизатора и передавать их на маршруты приложения. Они определяются в последующих функциях, который указывают, что запрос GET базового URL проекта должен возвращать страницу <code>index.html</code>, а запрос GET для маршрута <code>/sharks</code> должен возвращать страницу <code>sharks.html</code>.</p>

<p>Наконец, смонтируйте промежуточный уровень <code>router</code> и статичные ресурсы приложения и укажите приложению прослушивать порт <code>8080</code>:</p>
<div class="code-label " title="~/node_project/app.js">~/node_project/app.js</div><pre class="code-pre "><code langs="">...

app.use(express.static(path));
app.use('/', router);

app.listen(port, function () {
  console.log('Example app listening on port 8080!')
})
</code></pre>
<p>Готовый файл <code>app.js</code> будет выглядеть примерно так:</p>
<div class="code-label " title="~/node_project/app.js">~/node_project/app.js</div><pre class="code-pre "><code langs="">const express = require('express');
const app = express();
const router = express.Router();

const path = __dirname + '/views/';
const port = 8080;

router.use(function (req,res,next) {
  console.log('/' + req.method);
  next();
});

router.get('/', function(req,res){
  res.sendFile(path + 'index.html');
});

router.get('/sharks', function(req,res){
  res.sendFile(path + 'sharks.html');
});

app.use(express.static(path));
app.use('/', router);

app.listen(port, function () {
  console.log('Example app listening on port 8080!')
})
</code></pre>
<p>Сохраните файл и закройте его после завершения.</p>

<p>Далее добавим в приложение статичный контент. Вначале создадим каталог <code>views</code>:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">mkdir views
</li></ul></code></pre>
<p>Откройте файл начальной страницы, <code>index.html</code>:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">nano views/index.html
</li></ul></code></pre>
<p>Добавьте в файл следующий код, который импортирует Boostrap и создаст компонент <a href="https://getbootstrap.com/docs/4.0/components/jumbotron/">jumbotron</a> со ссылкой на страницу подробной информации о <code>sharks.html</code>:</p>
<div class="code-label " title="~/node_project/views/index.html">~/node_project/views/index.html</div><pre class="code-pre "><code langs="">&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;

&lt;head&gt;
    &lt;title&gt;About Sharks&lt;/title&gt;
    &lt;meta charset="utf-8"&gt;
    &lt;meta name="viewport" content="width=device-width, initial-scale=1"&gt;
    &lt;link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous"&gt;
    &lt;link href="css/styles.css" rel="stylesheet"&gt;
    &lt;link href="https://fonts.googleapis.com/css?family=Merriweather:400,700" rel="stylesheet" type="text/css"&gt;
&lt;/head&gt;

&lt;body&gt;
    &lt;nav class="navbar navbar-dark bg-dark navbar-static-top navbar-expand-md"&gt;
        &lt;div class="container"&gt;
            &lt;button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false"&gt; &lt;span class="sr-only"&gt;Toggle navigation&lt;/span&gt;
            &lt;/button&gt; &lt;a class="navbar-brand" href="#"&gt;Everything Sharks&lt;/a&gt;
            &lt;div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1"&gt;
                &lt;ul class="nav navbar-nav mr-auto"&gt;
                    &lt;li class="active nav-item"&gt;&lt;a href="/" class="nav-link"&gt;Home&lt;/a&gt;
                    &lt;/li&gt;
                    &lt;li class="nav-item"&gt;&lt;a href="/sharks" class="nav-link"&gt;Sharks&lt;/a&gt;
                    &lt;/li&gt;
                &lt;/ul&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/nav&gt;
    &lt;div class="jumbotron"&gt;
        &lt;div class="container"&gt;
            &lt;h1&gt;Want to Learn About Sharks?&lt;/h1&gt;
            &lt;p&gt;Are you ready to learn about sharks?&lt;/p&gt;
            &lt;br&gt;
            &lt;p&gt;&lt;a class="btn btn-primary btn-lg" href="/sharks" role="button"&gt;Get Shark Info&lt;/a&gt;
            &lt;/p&gt;
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="container"&gt;
        &lt;div class="row"&gt;
            &lt;div class="col-lg-6"&gt;
                &lt;h3&gt;Not all sharks are alike&lt;/h3&gt;
                &lt;p&gt;Though some are dangerous, sharks generally do not attack humans. Out of the 500 species known to researchers, only 30 have been known to attack humans.
                &lt;/p&gt;
            &lt;/div&gt;
            &lt;div class="col-lg-6"&gt;
                &lt;h3&gt;Sharks are ancient&lt;/h3&gt;
                &lt;p&gt;There is evidence to suggest that sharks lived up to 400 million years ago.
                &lt;/p&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/body&gt;

&lt;/html&gt;
</code></pre>
<p><a href="https://getbootstrap.com/docs/4.0/components/navbar/">Навигационная панель</a> верхнего уровня позволяет пользователям переключаться между страницами <strong>Home</strong> и <strong>Sharks</strong>. В субкомпоненте <code>navbar-nav</code> мы используем <code>active</code> класс Bootstrap, чтобы указать пользователю текущую страницу. Также мы указали маршруты наших статичных страниц, что соответствует маршрутам, определенным в файле <code>app.js</code>:</p>
<div class="code-label " title="~/node_project/views/index.html">~/node_project/views/index.html</div><pre class="code-pre "><code langs="">...
&lt;div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1"&gt;
   &lt;ul class="nav navbar-nav mr-auto"&gt;
      &lt;li class="active nav-item"&gt;&lt;a href="/" class="nav-link"&gt;Home&lt;/a&gt;
      &lt;/li&gt;
      &lt;li class="nav-item"&gt;&lt;a href="/sharks" class="nav-link"&gt;Sharks&lt;/a&gt;
      &lt;/li&gt;
   &lt;/ul&gt;
&lt;/div&gt;
...
</code></pre>
<p>Кроме того, мы создали ссылку на страницу с информацией об акулах в нашей кнопке jumbotron:</p>
<div class="code-label " title="~/node_project/views/index.html">~/node_project/views/index.html</div><pre class="code-pre "><code langs="">...
&lt;div class="jumbotron"&gt;
   &lt;div class="container"&gt;
      &lt;h1&gt;Want to Learn About Sharks?&lt;/h1&gt;
      &lt;p&gt;Are you ready to learn about sharks?&lt;/p&gt;
      &lt;br&gt;
      &lt;p&gt;&lt;a class="btn btn-primary btn-lg" href="/sharks" role="button"&gt;Get Shark Info&lt;/a&gt;
      &lt;/p&gt;
   &lt;/div&gt;
&lt;/div&gt;
...
</code></pre>
<p>Также в заголовке имеется ссылка на пользовательскую таблицу стилей:</p>
<div class="code-label " title="~/node_project/views/index.html">~/node_project/views/index.html</div><pre class="code-pre "><code langs="">...
&lt;link href="css/styles.css" rel="stylesheet"&gt;
...
</code></pre>
<p>Мы создадим эту таблицу стилей в конце данного шага.</p>

<p>Сохраните файл и закройте его после завершения.</p>

<p>Подготовив начальную страницу приложения, мы можем создать страницу с информацией об акулах, <code>sharks.html</code>, где заинтересованные пользователи смогут получить больше информации об акулах.</p>

<p>Откройте файл:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">nano views/sharks.html
</li></ul></code></pre>
<p>Добавьте следующий код, который импортирует Bootstrap и пользовательскую таблицу стилей и предлагает пользователям подробную информацию об определенных акулах:</p>
<div class="code-label " title="~/node_project/views/sharks.html">~/node_project/views/sharks.html</div><pre class="code-pre "><code langs="">&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;

&lt;head&gt;
    &lt;title&gt;About Sharks&lt;/title&gt;
    &lt;meta charset="utf-8"&gt;
    &lt;meta name="viewport" content="width=device-width, initial-scale=1"&gt;
    &lt;link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous"&gt;
    &lt;link href="css/styles.css" rel="stylesheet"&gt;
    &lt;link href="https://fonts.googleapis.com/css?family=Merriweather:400,700" rel="stylesheet" type="text/css"&gt;
&lt;/head&gt;
&lt;nav class="navbar navbar-dark bg-dark navbar-static-top navbar-expand-md"&gt;
    &lt;div class="container"&gt;
        &lt;button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false"&gt; &lt;span class="sr-only"&gt;Toggle navigation&lt;/span&gt;
        &lt;/button&gt; &lt;a class="navbar-brand" href="/"&gt;Everything Sharks&lt;/a&gt;
        &lt;div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1"&gt;
            &lt;ul class="nav navbar-nav mr-auto"&gt;
                &lt;li class="nav-item"&gt;&lt;a href="/" class="nav-link"&gt;Home&lt;/a&gt;
                &lt;/li&gt;
                &lt;li class="active nav-item"&gt;&lt;a href="/sharks" class="nav-link"&gt;Sharks&lt;/a&gt;
                &lt;/li&gt;
            &lt;/ul&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/nav&gt;
&lt;div class="jumbotron text-center"&gt;
    &lt;h1&gt;Shark Info&lt;/h1&gt;
&lt;/div&gt;
&lt;div class="container"&gt;
    &lt;div class="row"&gt;
        &lt;div class="col-lg-6"&gt;
            &lt;p&gt;
                &lt;div class="caption"&gt;Some sharks are known to be dangerous to humans, though many more are not. The sawshark, for example, is not considered a threat to humans.
                &lt;/div&gt;
                &lt;img src="https://assets.digitalocean.com/articles/docker_node_image/sawshark.jpg" alt="Sawshark"&gt;
            &lt;/p&gt;
        &lt;/div&gt;
        &lt;div class="col-lg-6"&gt;
            &lt;p&gt;
                &lt;div class="caption"&gt;Other sharks are known to be friendly and welcoming!&lt;/div&gt;
                &lt;img src="https://assets.digitalocean.com/articles/docker_node_image/sammy.png" alt="Sammy the Shark"&gt;
            &lt;/p&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;

&lt;/html&gt;
</code></pre>
<p>В этом файле мы снова используем <code>active</code> класс для индикации текущей страницы.</p>

<p>Сохраните файл и закройте его после завершения.</p>

<p>Наконец, создайте пользовательскую таблицу стилей CSS, на которую вы разместили ссылки в файлах <code>index.html</code> и <code>sharks.html</code>. Для этого вначале создайте папку <code>css</code> в каталоге <code>views</code>:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">mkdir views/css
</li></ul></code></pre>
<p>Откройте таблицу стилей:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">nano views/css/styles.css
</li></ul></code></pre>
<p>Добавьте следующий код, который задаст желаемые цвет и шрифт для наших страниц:</p>
<div class="code-label " title="~/node_project/views/css/styles.css">~/node_project/views/css/styles.css</div><pre class="code-pre "><code langs="">.navbar {
    margin-bottom: 0;
}

body {
    background: #020A1B;
    color: #ffffff;
    font-family: 'Merriweather', sans-serif;
}

h1,
h2 {
    font-weight: bold;
}

p {
    font-size: 16px;
    color: #ffffff;
}

.jumbotron {
    background: #0048CD;
    color: white;
    text-align: center;
}

.jumbotron p {
    color: white;
    font-size: 26px;
}

.btn-primary {
    color: #fff;
    text-color: #000000;
    border-color: white;
    margin-bottom: 5px;
}

img,
video,
audio {
    margin-top: 20px;
    max-width: 80%;
}

div.caption: {
    float: left;
    clear: both;
}
</code></pre>
<p>В дополнение к настройке шрифта и цвета этот файл также ограничивает размер изображений, указывая <code>max-width</code> 80%. Благодаря этому они не будут занимать больше места на странице, чем нам бы хотелось.</p>

<p>Сохраните файл и закройте его после завершения.</p>

<p>Теперь, когда файлы приложения готовы, а зависимости проекта установлены, вы готовы к запуску приложения.</p>

<p>Если вы следовали указаниям руководства по первоначальной настройке сервера, указанного в предварительных условиях, у вас установлен активный брандмауэр, на котором разрешен только трафик SSH. Чтобы разрешить трафик на порт <code>8080</code>, выполните команду:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo ufw allow 8080
</li></ul></code></pre>
<p>Чтобы запустить приложение, перейдите в каталог root вашего проекта:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">cd ~/<span class="highlight">node_project</span>
</li></ul></code></pre>
<p>Запустите приложение с <code>node app.js</code>:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">node app.js
</li></ul></code></pre>
<p>Откройте в браузере адрес <code>http://your_server_ip:8080</code>. Вы увидите следующую начальную страницу:</p>

<p><img src="https://assets.digitalocean.com/articles/docker_node_image/landing_page.png" alt="Начальная страница приложения"></p>

<p>Нажмите кнопку <strong>Get Shark Info (Получить информацию об акулах)</strong>. Вы увидите следующую информационную страницу:</p>

<p><img src="https://assets.digitalocean.com/articles/docker_node_image/sharks.png" alt="Страница информации об акулах"></p>

<p>Ваше приложение запущено и работает. Когда вы будете готовы, покиньте сервер, нажав <code>CTRL+C</code>. Теперь мы можем перейти к созданию файла Dockerfile, который позволит нам воссоздать и масштабировать это приложение, когда это потребуется.</p>

<h2 id="Шаг-3-—-Создание-файла-dockerfile">Шаг 3 — Создание файла Dockerfile</h2>

<p>Ваш файл Dockerfile указывает, что будет включено в контейнер приложения при его выполнении. Использование Dockerfile позволяет определить среду контейнера и избежать расхождений с зависимостями и версиями модуля исполнения.</p>

<p>В соответствии с <a href="https://www.digitalocean.com/community/tutorials/building-optimized-containers-for-kubernetes">этими указаниями по построению оптимизированных контейнеров</a>, мы сделаем наше изображение максимально эффективным, минимизируем количество слоев образа и воссоздадим файлы нашего приложения и статичный контент.</p>

<p>Создайте файл Dockerfile в каталоге root вашего проекта:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">nano Dockerfile
</li></ul></code></pre>
<p>Образы Docker создаются с использованием последовательности многослойных образов, накладывающихся друг поверх друга. Вначале мы добавим <em>базовый образ</em> нашего приложения, который станет начальной точкой сборки приложения.</p>

<p>Мы будем использовать <a href="https://hub.docker.com/_/node/">образ <code>node:10-alpine</code></a>, поскольку на момент написания это <a href="https://nodejs.org/en/">рекомендуемая версия LTS Node.js</a>. Образ <code>alpine</code> является производным проекта <a href="https://alpinelinux.org/">Alpine Linux</a>, и это помогает уменьшить размер образа. Дополнительную информацию о том, стоит ли использовать образ <code>alpine</code> в вашем проекте, можно получить в полном обсуждении в разделе *<em>Image Variants *</em>(Варианты образов) на <a href="https://hub.docker.com/_/node/">странице образов Docker Hub Node</a>.</p>

<p>Добавьте следующую команду <code>FROM</code>, чтобы задать базовый образ приложения:</p>
<div class="code-label " title="~/node_project/Dockerfile">~/node_project/Dockerfile</div><pre class="code-pre "><code langs="">FROM node:<span class="highlight">10-alpine</span>
</code></pre>
<p>Этот образ включает Node.js и npm. Каждый Dockerfile должен начинаться с команды <code>FROM</code>.</p>

<p>По умолчанию образ Docker Node включает пользователя <strong>node</strong>, не являющегося пользователем root, которого вы можете использовать, чтобы контейнер вашего приложения не запускался как <strong>root</strong>. Для безопасности рекомендуется не запускать контейнеры как пользователь <strong>root</strong> и <a href="https://docs.docker.com/engine/security/security/#linux-kernel-capabilities">ограничить возможности контейнера</a> теми, которые необходимы для запуска его процессов. Мы используем домашний каталог пользователя <strong>node</strong> как рабочий каталог нашего приложения и зададим его как пользователя внутри контейнера. Дополнительную информацию об оптимальной практике работы с образом Docker Node можно найти <a href="https://github.com/nodejs/docker-node/blob/master/docs/BestPractices.md">в этом руководстве по передовым практикам</a>.</p>

<p>Для тонкой настройки разрешений кода приложения в контейнере создадим подкаталог <code>node_modules</code> в каталоге <code>/home/node</code> вместе с каталогом <code>app</code>. Создание этих каталогов обеспечит наличие желаемых разрешений, что будет важно при создании локальных модулей узла в контейнере с помощью команды <code>npm install</code>. В дополнение к созданию этих каталогов мы зададим пользователя <strong>node</strong> как их владельца:</p>
<div class="code-label " title="~/node_project/Dockerfile">~/node_project/Dockerfile</div><pre class="code-pre "><code langs="">...
RUN mkdir -p /home/node/app/node_modules &amp;&amp; chown -R node:node /home/node/app
</code></pre>
<p>Дополнительную информацию о полезности консолидации команд <code>RUN</code> можно найти в этой <a href="https://www.digitalocean.com/community/tutorials/building-optimized-containers-for-kubernetes#managing-container-layers">дискуссии об управлении слоями контейнеров</a>.</p>

<p>Далее установите рабочий каталог приложения <code>/home/node/app</code>:</p>
<div class="code-label " title="~/node_project/Dockerfile">~/node_project/Dockerfile</div><pre class="code-pre "><code langs="">...
WORKDIR /home/node/app
</code></pre>
<p>Если <code>WORKDIR</code> не задан, Docker создаст рабочий каталог по умолчанию, и поэтому лучше явно задать его.</p>

<p>Далее скопируйте файлы <code>package.json</code> и <code>package-lock.json</code> (для npm 5+):</p>
<div class="code-label " title="~/node_project/Dockerfile">~/node_project/Dockerfile</div><pre class="code-pre "><code langs="">...
COPY package*.json ./
</code></pre>
<p>Добавление этой команды <code>COPY</code> перед запуском <code>npm install</code> или копированием кода приложения позволяет использовать механизм кэширования Docker. На каждом этапе сборки Docker проверяет наличие кэшированного слоя для этой конкретной команды. Если мы изменим файл <code>package.json</code>, этот слой будет построен заново, но если мы не будем его менять, данная команда позволит Docker использовать существующий слой образа и пропустить повторную установку модулей узла.</p>

<p>Чтобы все файлы приложения принадлежали пользователю <strong>node</strong>, не являющемуся пользователем root, включая содержимое каталога <code>node_modules</code>, переключитесь на пользователя *<em>node *</em>перед запуском <code>npm install</code>:</p>
<div class="code-label " title="~/node_project/Dockerfile">~/node_project/Dockerfile</div><pre class="code-pre "><code langs="">...
USER node
</code></pre>
<p>После копирования зависимостей проекта и переключения пользователя можно запустить <code>npm install</code>:</p>
<div class="code-label " title="~/node_project/Dockerfile">~/node_project/Dockerfile</div><pre class="code-pre "><code langs="">...
RUN npm install
</code></pre>
<p>Затем скопируйте код приложения с надлежащими разрешениями в каталог приложения в контейнере:</p>
<div class="code-label " title="~/node_project/Dockerfile">~/node_project/Dockerfile</div><pre class="code-pre "><code langs="">...
COPY --chown=node:node . .
</code></pre>
<p>В этом случае файлы приложения будут принадлежать пользователю <strong>node</strong>, не являющемуся пользователем root.</p>

<p>Наконец, откройте порт <code>8080</code> в контейнере и запустите приложение:</p>
<div class="code-label " title="~/node_project/Dockerfile">~/node_project/Dockerfile</div><pre class="code-pre "><code langs="">...
EXPOSE 8080

CMD [ "node", "app.js" ]
</code></pre>
<p>Команда <code>EXPOSE</code> не публикует порт, но служит для документирования портов контейнера, которые будут публиковаться во время исполнения. <code>CMD</code> выполняет команду пуска приложения, в данном случае <a href="https://github.com/nodejs/docker-node/blob/master/docs/BestPractices.md#cmd"><code>node app.js</code></a>. Обратите винмание, что в каждом файле Dockerfile должна быть только одна команда <code>CMD</code>. Если вы включите несколько команд, действовать будет только последняя.</p>

<p>С помощью Dockerfile можно сделать много разных вещей. Полный список команд можно найти в <a href="https://docs.docker.com/engine/reference/builder/">справочной документации по Dockerfile</a>.</p>

<p>Полный файл Dockerfile выглядит следующим образом:</p>
<div class="code-label " title="~/node_project/Dockerfile">~/node_project/Dockerfile</div><pre class="code-pre "><code langs="">
FROM node:10-alpine

RUN mkdir -p /home/node/app/node_modules &amp;&amp; chown -R node:node /home/node/app

WORKDIR /home/node/app

COPY package*.json ./

USER node

RUN npm install

COPY --chown=node:node . .

EXPOSE 8080

CMD [ "node", "app.js" ]
</code></pre>
<p>Сохраните и закройте файл после завершения редактирования.</p>

<p>Прежде чем строить образ приложения, добавим файл <a href="https://docs.docker.com/engine/reference/builder/#dockerignore-file"><code>.dockerignore</code></a>. Работая аналогично файлу <a href="https://git-scm.com/docs/gitignore"><code>.gitignore</code></a>, файл <code>.dockerignore</code> указывает, какие файлы и каталоги в каталоге проекта не следует копировать в контейнер.</p>

<p>Откройте файл <code>.dockerignore</code>:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">nano .dockerignore
</li></ul></code></pre>
<p>Внутри файла добавьте модули локального узла, журналы npm, файл Dockerfile и файл <code>.dockerignore</code>:</p>
<div class="code-label " title="~/node_project/.dockerignore">~/node_project/.dockerignore</div><pre class="code-pre "><code langs="">node_modules
npm-debug.log
Dockerfile
.dockerignore
</code></pre>
<p>Если вы работаете с <a href="https://git-scm.com/">Git</a>, также следует добавить каталог <code>.git</code> и файл <code>.gitignore</code>.</p>

<p>Сохраните файл и закройте его после завершения.</p>

<p>Теперь вы готовы к созданию образа прложения с помощью команды <a href="https://docs.docker.com/engine/reference/commandline/build/"><code>docker build</code></a>. Использование флага <code>-t</code> с командой <code>docker build</code> позволяет присвоить образу метку с запоминающимся названием. Поскольку мы планируем размещать образ в Docker Hub, добавим в метку имя пользователя Docker Hub. Мы пометим образ меткой <code><span class="highlight">nodejs-image-demo</span></code>, но вы можете использовать любое другое название на свое усмотрение. Также замените <code><span class="highlight">your_dockerhub_username</span></code> своим именем пользователя Docker Hub:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">docker build -t <span class="highlight">your_dockerhub_username</span>/<span class="highlight">nodejs-image-demo</span> .
</li></ul></code></pre>
<p>Символ <code>.</code> указывает, что контекст команды build — текущий каталог.</p>

<p>Создание образа займет одну или две минуты. После завершения проверьте образы:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">docker images
</li></ul></code></pre>
<p>Результат будет выглядеть следующим образом:</p>
<pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>REPOSITORY                                         TAG                 IMAGE ID            CREATED             SIZE
<span class="highlight">your_dockerhub_username</span>/<span class="highlight">nodejs-image-demo</span>          latest              1c723fb2ef12        8 seconds ago       73MB
node                                               10-alpine           f09e7c96b6de        3 weeks ago        70.7MB
</code></pre>
<p>Теперь вы можете создать контейнер с этим образом, используя команду <a href="https://docs.docker.com/engine/reference/commandline/run/"><code>docker run</code></a>. Мы добавим к этой команде три флага:</p>

<ul>
<li><code>-p</code>: публикует порт контейнера и сопоставляет его с портом хоста. Мы используем порт <code>80</code> на нашем хосте, но вы можете использовать любой другой порт, если этот порт занят каким-то другим процессом. Дополнительную информацию по принципам <a href="https://docs.docker.com/v17.09/engine/userguide/networking/default_network/binding/">привязки портов</a> можно найти в соответствующей документации Docker.</li>
<li><code>-d</code>: запускает контейнер в фоновом режиме.</li>
<li><code>--name</code>: позволяет присвоить контейнеру запоминающееся имя.</li>
</ul>

<p>Запустите следующую команду для построения контейнера:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">docker run --name <span class="highlight">nodejs-image-demo</span> -p <span class="highlight">80</span>:8080 -d <span class="highlight">your_dockerhub_username</span>/<span class="highlight">nodejs-image-demo</span>
</li></ul></code></pre>
<p>После запуска контейнера вы можете проверить список запущенных контейнеров с помощью команды <a href="https://docs.docker.com/engine/reference/commandline/ps/"><code>docker ps</code></a>:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">docker ps
</li></ul></code></pre>
<p>Результат будет выглядеть следующим образом:</p>
<pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>CONTAINER ID        IMAGE                                                   COMMAND             CREATED             STATUS              PORTS                  NAMES
e50ad27074a7        <span class="highlight">your_dockerhub_username</span>/<span class="highlight">nodejs-image-demo</span>               "node app.js"       8 seconds ago       Up 7 seconds        0.0.0.0:80-&gt;8080/tcp   nodejs-image-demo
</code></pre>
<p>Во время работы контейнера вы можете открыть свое приложение, указав в браузере адрес <code>http://<span class="highlight">your_server_ip</span></code>. После этого откроется начальная страница вашего приложения:</p>

<p><img src="https://assets.digitalocean.com/articles/docker_node_image/landing_page.png" alt="Начальная страница приложения"></p>

<p>Вы создали образ приложения, и теперь можете опубликовать его в Docker Hub для будущего использования.</p>

<h2 id="Шаг-4-—-Использование-хранилища-для-работы-с-образами">Шаг 4 — Использование хранилища для работы с образами</h2>

<p>При публикации образа приложения в таком реестре как Docker Hub вы делаете его доступным для последующего использования при построении и масштабировании контейнеров. Для примера мы покажем, как разместить образ приложения в хранилище и использовать его для воссоздания контейнера.</p>

<p>Прежде всего необходимо войти в учетную запись Docker Hub, созданную в соответствии с предварительными требованиями:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">docker login -u <span class="highlight">your_dockerhub_username</span>
</li></ul></code></pre>
<p>Введите пароль учетной записи Docker Hub в соответствующем диалоговом окне. При входе в каталоге home вашего пользователя будет создан файл <code>~/.docker/config.json</code> с вашими учетными данными Docker Hub.</p>

<p>Теперь вы можете записать образ приложения в Docker Hub, используя ранее созданную метку <code><span class="highlight">your_dockerhub_username/nodejs-image-demo</span></code>:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">docker push <span class="highlight">your_dockerhub_username</span>/<span class="highlight">nodejs-image-demo</span>
</li></ul></code></pre>
<p>Давайте проверим использование реестра образов. Для этого уничтожим текущий контейнер приложения и образ и воссоздадим их на основе образа из хранилища.</p>

<p>Вначале перечислите запущенные контейнеры:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">docker ps
</li></ul></code></pre>
<p>Результат будет выглядеть следующим образом:</p>
<pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>CONTAINER ID        IMAGE                                       COMMAND             CREATED             STATUS              PORTS                  NAMES
<span class="highlight">e50ad27074a7</span>        <span class="highlight">your_dockerhub_username</span>/<span class="highlight">nodejs-image-demo</span>   "node app.js"       3 minutes ago       Up 3 minutes        0.0.0.0:80-&gt;8080/tcp   nodejs-image-demo
</code></pre>
<p>Остановите запущенный контейнер приложения, используя идентификатор <code>CONTAINER ID</code>, показанный в результатах. Обязательно замените выделенный ниже идентификатор собственным идентификатором <code>CONTAINER ID</code>:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">docker stop <span class="highlight">e50ad27074a7</span>
</li></ul></code></pre>
<p>Перечислите все образы, используя флаг <code>-a</code>:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">docker images -a
</li></ul></code></pre>
<p>Вы увидите следующие результаты с именем образа <code>your_dockerhub_username/nodejs-image-demo</code>, а также образом <code>узла</code> и другими образами из вашей сборки:</p>
<pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>REPOSITORY                                           TAG                 IMAGE ID            CREATED             SIZE
<span class="highlight">your_dockerhub_username</span>/<span class="highlight">nodejs-image-demo</span>            latest              1c723fb2ef12        7 minutes ago       73MB
&lt;none&gt;                                               &lt;none&gt;              2e3267d9ac02        4 minutes ago       72.9MB
&lt;none&gt;                                               &lt;none&gt;              8352b41730b9        4 minutes ago       73MB
&lt;none&gt;                                               &lt;none&gt;              5d58b92823cb        4 minutes ago       73MB
&lt;none&gt;                                               &lt;none&gt;              3f1e35d7062a        4 minutes ago       73MB
&lt;none&gt;                                               &lt;none&gt;              02176311e4d0        4 minutes ago       73MB
&lt;none&gt;                                               &lt;none&gt;              8e84b33edcda        4 minutes ago       70.7MB
&lt;none&gt;                                               &lt;none&gt;              6a5ed70f86f2        4 minutes ago       70.7MB
&lt;none&gt;                                               &lt;none&gt;              776b2637d3c1        4 minutes ago       70.7MB
node                                                 10-alpine           f09e7c96b6de        3 weeks ago         70.7MB

</code></pre>
<p>Удалите остановленный контейнер и все образы, включая неиспользуемые или недействительные образы, с помощью следующей команды:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">docker system prune -a
</li></ul></code></pre>
<p>Введите <code>y</code> в диалоговом окне, чтобы подтвердить удаление остановленного контейнера и образов. Помните, что при этом также будет удален кэш вашей сборки.</p>

<p>Теперь вы удалили контейнер с образом приложения и сам образ. Дополнительную информацию об удалении контейнеров Docker, образов и томов можно найти в документе <a href="https://www.digitalocean.com/community/tutorials/how-to-remove-docker-images-containers-and-volumes">«Удаление образов, контейнеров и томов Docker»</a>.</p>

<p>Удалив все образы и контейнеры, вы можете извлечь образ приложения из Docker Hub:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">docker pull <span class="highlight">your_dockerhub_username</span>/<span class="highlight">nodejs-image-demo</span>
</li></ul></code></pre>
<p>Еще раз перечислите образы:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">docker images
</li></ul></code></pre>
<p>Вы увидите образ вашего приложения:</p>
<pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>REPOSITORY                                     TAG                 IMAGE ID            CREATED             SIZE
<span class="highlight">your_dockerhub_username</span>/<span class="highlight">nodejs-image-demo</span>      latest              1c723fb2ef12        11 minutes ago      73MB
</code></pre>
<p>Теперь вы можете воссоздать свой контейнер, используя команду из шага 3:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">docker run --name <span class="highlight">nodejs-image-demo</span> -p <span class="highlight">80</span>:8080 -d <span class="highlight">your_dockerhub_username</span>/<span class="highlight">nodejs-image-demo</span>
</li></ul></code></pre>
<p>Перечислите запущенные контейнеры:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">docker ps
</li></ul></code></pre><pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>CONTAINER ID        IMAGE                                                   COMMAND             CREATED             STATUS              PORTS                  NAMES
f6bc2f50dff6        <span class="highlight">your_dockerhub_username</span>/<span class="highlight">nodejs-image-demo</span>               "node app.js"       4 seconds ago       Up 3 seconds        0.0.0.0:80-&gt;8080/tcp   nodejs-image-demo
</code></pre>
<p>Посетите <code>http://your_server_ip</code> еще раз, чтобы просмотреть запущенное приложение.</p>

<h2 id="Заключение">Заключение</h2>

<p>В этом обучающем руководстве вы создали статическое веб-приложение с Express и Bootstrap, а также образ Docker для этого приложения. Вы использовали этот образ для создания контейнера и разместили его в Docker Hub. Затем вы смогли уничтожить образ и контейнер и воссоздать их с помощью хранилища Docker Hub.</p>

<p>Если вы хотите узнать больше о работе с такими инструментами, как Docker Compose и Docker Machine для создания мультиконтейнерных систем, вы можете ознакомиться со следующими руководствами:</p>

<ul>
<li><a href="https://www.digitalocean.com/community/tutorials/how-to-install-docker-compose-on-ubuntu-18-04">Установка Docker Compose в Ubuntu 18.04</a>.</li>
<li><a href="https://www.digitalocean.com/community/tutorials/how-to-provision-and-manage-remote-docker-hosts-with-docker-machine-on-ubuntu-18-04">Выделение ресурсов и управление дистанционными хостами Docker с Docker Machine в Ubuntu 18.04</a>.</li>
</ul>

<p>Общие советы по работе с данными контейнера можно найти здесь:</p>

<ul>
<li><a href="https://www.digitalocean.com/community/tutorials/how-to-share-data-between-docker-containers">Общий доступ к данным контейнеров Docker</a></li>
<li><a href="https://www.digitalocean.com/community/tutorials/how-to-share-data-between-the-docker-container-and-the-host">Обеспечение общего доступа к данным контейнера и хоста Docker</a>.</li>
</ul>

<p>Если вы интересуетесь другими темами по Docker, ознакомьтесь с нашей полной библиотекой <a href="https://www.digitalocean.com/community/tags/docker/tutorials">обучающих пособий по Docker</a>.</p>
