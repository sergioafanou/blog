---
layout: post
title: Как настроить сервер IKEv2 VPN с StrongSwan в Ubuntu 18.04
network: digitalocean
date: January 07, 2020 at 08:01PM
url: https://www.digitalocean.com/community/tutorials/how-to-set-up-an-ikev2-vpn-server-with-strongswan-on-ubuntu-18-04-2-ru
image: https://assets.digitalocean.com/articles/ikevpn_ubuntu_1604/4PN0vT6.png
tags: docker
feedtitle: DigitalOcean Community Tutorials
feedurl: https://www.digitalocean.com/community/tutorials
author: DigitalOcean
---
<h3 id="Введение">Введение</h3>

<p>Виртуальная частная сеть (VPN) позволяет выполнять защищенное шифрование трафика, передаваемого через незащищенные сети, например, в кафе, на конференции или в аэропорту.</p>

<p><a href="https://en.wikipedia.org/wiki/Internet_Key_Exchange">Протокол IKEv2</a> или Internet Key Exchange v2 позволяет создавать прямые туннели IPSec между сервером и клиентом. IPSec обеспечивает шифрование сетевого трафика в виртуальных частных сетях IKEv2. IKEv2 изначально поддерживается на ряде платформ OS X 10.11+, iOS 9.1+, Windows 10) без дополнительных приложений и легко решает проблемы с подключением клиентов.</p>

<p>В этом обучающем модуле мы выполним настройку сервера IKEv2 VPN с помощью <a href="https://www.strongswan.org/">StrongSwan</a> на сервере Ubuntu 18.04 и подключимся к нему с клиентов Windows, macOS, Ubuntu, iOS и Android.</p>

<h2 id="Предварительные-требования">Предварительные требования</h2>

<p>Для данного обучающего руководства вам потребуется следующее:</p>

<ul>
<li>Один сервер Ubuntu 18.04, настроенный в соответствии с <a href="https://www.digitalocean.com/community/tutorials/initial-server-setup-with-ubuntu-18-04">руководством по начальной настройке сервера Ubuntu</a> 18.04, включая брандмауэр и пользователя <code>sudo</code> без привилегий root.</li>
</ul>

<h2 id="Шаг-1-—-Установка-strongswan">Шаг 1 — Установка StrongSwan</h2>

<p>Вначале мы установим StrongSwan, демона IPSec с открытым исходным кодом, а затем настроим его как наш сервер VPN. Также мы установим компонент инфраструктуры открытых ключей, чтобы создать центр сертификации, который будет предоставлять учетные данные для нашей инфраструктуры.</p>

<p>Обновите кэш локальных пакетов и установите программное обеспечение с помощью следующей команды:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo apt update
</li><li class="line" prefix="$">sudo apt install strongswan strongswan-pki
</li></ul></code></pre>
<p>После завершения установки перейдем к созданию сертификатов.</p>

<h2 id="Шаг-2-—-Создание-центра-сертификации">Шаг 2 — Создание центра сертификации</h2>

<p>Для идентификации на клиентских системах серверу IKEv2 требуется сертификат. Пакет <code>strongswan-pki</code> включает утилиту, которая может сгенерировать центр сертификации и сертификаты сервера. Для начала создадим несколько каталогов для хранения всех активо, с которыми мы будем работать. Структура каталогов соответствует некоторым каталогам в <code>/etc/ipsec.d</code>, куда мы постепенно переместим все создаваемые элементы. Мы заблокируем разрешения, чтобы другие пользователи не могли видеть наши частные файлы:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">mkdir -p ~/pki/{cacerts,certs,private}
</li><li class="line" prefix="$">chmod 700 ~/pki
</li></ul></code></pre>
<p>Располагая структурой каталогов для хранения всех элементов, мы можем сгенерировать ключ root. Это будет 4096-битный ключ RSA, который будет использоваться для подписи корневого центра сертификации.</p>

<p>Запустите следующие команды, чтобы сгенерировать ключ:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">ipsec pki --gen --type rsa --size 4096 --outform pem &gt; ~/pki/private/ca-key.pem
</li></ul></code></pre>
<p>Получив ключ, мы можем перейти к созданию корневого центра сертификации, используя ключ для подписания сертификата root:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">ipsec pki --self --ca --lifetime 3650 --in ~/pki/private/ca-key.pem \
</li><li class="line" prefix="$">    --type rsa --dn "CN=VPN root CA" --outform pem &gt; ~/pki/cacerts/ca-cert.pem
</li></ul></code></pre>
<p>Вы можете изменить значение <em>distinguished name (DN) на любое другое имя</em> по своему желанию. Используемое здесь имя common приведено просто для примера, имя не должно соответствовать какому-либо элементу вашей инфраструктуры.</p>

<p>Настроив и запустив корневой центр сертификации, мы можем создать сертификат, который будет использоваться сервером VPN.</p>

<h2 id="Шаг-3-—-Генерирование-сертификата-для-сервера-vpn">Шаг 3 — Генерирование сертификата для сервера VPN</h2>

<p>Теперь мы создадим сертификат и ключ для сервера VPN. Этот сертификат позволит клиентам проверять подлинность сервера, используя только что сгенерированный нами сертификат CA.</p>

<p>Вначале создайте закрытый ключ сервера VPN с помощью следующей команды:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">ipsec pki --gen --type rsa --size 4096 --outform pem &gt; ~/pki/private/server-key.pem
</li></ul></code></pre>
<p>Затем создайте и подпишите сертификат сервера VPN, используя ключ центра сертификации, созданный на предыдущем шаге. Запустите следующую команду, но измените поля Common Name (CN) и Subject Alternate Name (SAN) на имя DNS или IP-адрес вашего сервера VPN:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">ipsec pki --pub --in ~/pki/private/server-key.pem --type rsa \
</li><li class="line" prefix="$">    | ipsec pki --issue --lifetime 1825 \
</li><li class="line" prefix="$">        --cacert ~/pki/cacerts/ca-cert.pem \
</li><li class="line" prefix="$">        --cakey ~/pki/private/ca-key.pem \
</li><li class="line" prefix="$">        --dn "CN=<span class="highlight">server_domain_or_IP</span>" --san "<span class="highlight">server_domain_or_IP</span>" \
</li><li class="line" prefix="$">        --flag serverAuth --flag ikeIntermediate --outform pem \
</li><li class="line" prefix="$">    &gt;  ~/pki/certs/server-cert.pem
</li></ul></code></pre>
<p>Теперь мы сгенерировали все файлы TLS/SSL, необходимые StrongSwan, и можем переместить их в каталог <code>/etc/ipsec.d</code> следующим образом:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo cp -r ~/pki/* /etc/ipsec.d/
</li></ul></code></pre>
<p>На этом шаге мы создали пару сертификатов, которые можно будет использовать для защиты связи между клиентом и сервером. Также мы подписали сертификаты ключом CA, и теперь клиент сможет проверять подлинность сервера VPN, используя сертификат CA. Подготовив все сертификаты, мы можем перейти к настройке программного обеспечения.</p>

<h2 id="Шаг-4-—-Настройка-strongswan">Шаг 4 — Настройка StrongSwan</h2>

<p>StrongSwan имеет файл конфигурации по умолчанию с несколькими образцами, но большинство настроек нужно будет выполнить самостоятельно. Прежде чем начинать, создадим резервную копию файла для справки:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo mv /etc/ipsec.conf{,.original}
</li></ul></code></pre>
<p>Создайте и откройте новый пустой файл конфигурации, введя следующую команду:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo nano /etc/ipsec.conf
</li></ul></code></pre>
<p>Вначале мы укажем StrongSwan регистрировать состояния демонов для целей отладки и разрешить дублирующиеся соединения. Добавьте в файл следующие строки:</p>
<div class="code-label " title="/etc/ipsec.conf">/etc/ipsec.conf</div><pre class="code-pre "><code langs="">config setup
    charondebug="ike 1, knl 1, cfg 0"
    uniqueids=no
</code></pre>
<p>Затем мы создадим раздел конфигурации для сервера VPN. Также мы укажем StrongSwan создать туннели IKEv2 VPN и автоматически загружать этот раздел конфигурации при запуске. Добавьте в файл следующие строки:</p>
<div class="code-label " title="/etc/ipsec.conf">/etc/ipsec.conf</div><pre class="code-pre "><code langs="">. . .
conn ikev2-vpn
    auto=add
    compress=no
    type=tunnel
    keyexchange=ikev2
    fragmentation=yes
    forceencaps=yes
</code></pre>
<p>Также мы настроем обнаружение отсутствующих узлов, чтобы закрывать неиспользуемые соединения при непредвиденном отключении клиента. Добавьте следующие строки:</p>
<div class="code-label " title="/etc/ipsec.conf">/etc/ipsec.conf</div><pre class="code-pre "><code langs="">. . .
conn ikev2-vpn
    . . .
    dpdaction=clear
    dpddelay=300s
    rekey=no
</code></pre>
<p>Теперь мы настроим параметры IPSec нашего сервера (слева). Добавьте в файл следующее:</p>
<div class="code-label " title="/etc/ipsec.conf">/etc/ipsec.conf</div><pre class="code-pre "><code langs="">. . .
conn ikev2-vpn
    . . .
    left=%any
    leftid=<span class="highlight">@server_domain_or_IP</span>
    leftcert=server-cert.pem
    leftsendcert=always
    leftsubnet=0.0.0.0/0
</code></pre>
<span class='note'><p>
<strong>Примечание.</strong> При настройке идентификатора сервера (<code>leftid</code>) символ <code>@</code> нужно указывать только в случае, если ваш сервер VPN будет идентифицироваться по доменному имени:</p>
<pre class="code-pre "><code langs="">    leftid=<span class="highlight">@vpn.example.com</span>
</code></pre>
<p>Если сервер будет идентифицироваться по IP-адресу, просто укажите IP-адрес:</p>
<pre class="code-pre "><code langs="">    leftid=<span class="highlight">203.0.113.7</span>
</code></pre>
<p></p></span>

<p>Теперь мы можем настроить параметры IPSec на стороне клиента (справа) как диапазоны частных IP-адресов и серверы DNS, которые нужно будет использовать:</p>
<div class="code-label " title="/etc/ipsec.conf">/etc/ipsec.conf</div><pre class="code-pre "><code langs="">. . .
conn ikev2-vpn
    . . .
    right=%any
    rightid=%any
    rightauth=eap-mschapv2
    rightsourceip=10.10.10.0/24
    rightdns=8.8.8.8,8.8.4.4
    rightsendcert=never
</code></pre>
<p>Наконец, мы укажем StrongSwan запрашивать у клиента учетные данные пользователя при подключении:</p>
<div class="code-label " title="/etc/ipsec.conf">/etc/ipsec.conf</div><pre class="code-pre "><code langs="">. . .
conn ikev2-vpn
    . . .
    eap_identity=%identity
</code></pre>
<p>Файл конфигурации должен выглядеть следующим образом:</p>
<div class="code-label " title="/etc/ipsec.conf">/etc/ipsec.conf</div><pre class="code-pre "><code langs="">config setup
    charondebug="ike 1, knl 1, cfg 0"
    uniqueids=no

conn ikev2-vpn
    auto=add
    compress=no
    type=tunnel
    keyexchange=ikev2
    fragmentation=yes
    forceencaps=yes
    dpdaction=clear
    dpddelay=300s
    rekey=no
    left=%any
    leftid=<span class="highlight">@server_domain_or_IP</span>
    leftcert=server-cert.pem
    leftsendcert=always
    leftsubnet=0.0.0.0/0
    right=%any
    rightid=%any
    rightauth=eap-mschapv2
    rightsourceip=10.10.10.0/24
    rightdns=8.8.8.8,8.8.4.4
    rightsendcert=never
    eap_identity=%identity
</code></pre>
<p>Когда вы убедитесь, что конфигурация соответствует показанной, сохраните и закройте файл.</p>

<p>Теперь мы настроили параметры VPN и можем перейти к созданию учетной записи, чтобы наши пользователи могли подключаться к серверу.</p>

<h2 id="Шаг-5-—-Настройка-аутентификации-vpn">Шаг 5 — Настройка аутентификации VPN</h2>

<p>Теперь наш сервер VPN настроен на принятие подключений клиентов, но мы еще не настроили учетные данные. Нам нужно задать пару настроек в специальном файле конфигурации с именем <code>ipsec.secrets</code>:</p>

<ul>
<li>Нам нужно указать StrongSwan, где можно найти закрытый ключ для нашего сертификата сервера, чтобы сервер мог пройти аутентификацию на стороне клиента.</li>
<li>Также нам потребуется список пользователей, которым будет разрешено подключаться к VPN.</li>
</ul>

<p>Откроем для редактирования файл secrets</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo nano /etc/ipsec.secrets
</li></ul></code></pre>
<p>Вначале мы укажем StrongSwan, где можно найти закрытый ключ:</p>
<div class="code-label " title="/etc/ipsec.secrets">/etc/ipsec.secrets</div><pre class="code-pre "><code langs="">: RSA "server-key.pem"
</code></pre>
<p>Затем мы зададим учетные данные пользователя. Вы можете создать любую комбинацию имени пользователя и пароля:</p>
<div class="code-label " title="/etc/ipsec.secrets">/etc/ipsec.secrets</div><pre class="code-pre "><code langs=""><span class="highlight">your_username</span> : EAP <span class="highlight">"your_password"</span>
</code></pre>
<p>Сохраните и закройте файл. Мы завершили настройку параметров VPN и теперь можем перезапустить службу VPN, чтобы применить новую конфигурацию:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo systemctl restart strongswan
</li></ul></code></pre>
<p>Мы полностью настроили параметры сервера и учетные данные пользователя на сервере VPN и теперь можем перейти к самой важной части: настройке брандмауэра.</p>

<h2 id="Шаг-6-—-Настройка-брандмауэра-и-переадресации-ip-ядра">Шаг 6 — Настройка брандмауэра и переадресации IP ядра</h2>

<p>После настройки конфигурации StrongSwan нам нужно настроить брандмауэр, чтобы он разрешал трафик VPN и перенаправлял его.</p>

<p>Если вы выполнили указания предварительных обучающих модулей, у вас должен быть включен базовый брандмауэр UFW. Если вы еще не настроили UFW, вы можете базовую конфигурацию и включить ее с помощью следующей команды:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo ufw allow OpenSSH
</li><li class="line" prefix="$">sudo ufw enable
</li></ul></code></pre>
<p>Теперь добавьте правило, которое будет разрешать трафик UDP на стандартных портах IPSec, 500 и 4500:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo ufw allow 500,4500/udp
</li></ul></code></pre>
<p>Затем мы откроем один из файлов конфигурации UFW, чтобы добавить несколько политик нижнего уровня для маршрутизации и перенаправления пакетов IPSec. Перед этим нам нужно будет определить, какой сетевой интерфейс нашего сервера будет использоваться для доступа к интернету. Для этого мы можем отправить запрос интерфейса, связанного с маршрутом по умолчанию:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">ip route | grep default
</li></ul></code></pre>
<p>Ваш публичный интерфейс должен содержать слово «dev». Например, в этом результате показан интерфейс с именем <code>eth0</code>, который выделен ниже:</p>
<pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>default via 203.0.113.7 dev <span class="highlight">eth0</span> proto static
</code></pre>
<p>Определив интерфейс публичной сети, откройте файл правил <code>/etc/ufw/before.rules</code> в своем текстовом редакторе:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo nano /etc/ufw/before.rules
</li></ul></code></pre>
<p>Добавьте в верхнюю часть файла (перед строкой <code>*filter</code>) следующий блок конфигурации:</p>
<div class="code-label " title="/etc/ufw/before.rules">/etc/ufw/before.rules</div><pre class="code-pre "><code langs=""><span class="highlight">*nat</span>
<span class="highlight">-A POSTROUTING -s 10.10.10.0/24 -o eth0 -m policy --pol ipsec --dir out -j ACCEPT</span>
<span class="highlight">-A POSTROUTING -s 10.10.10.0/24 -o eth0 -j MASQUERADE</span>
<span class="highlight">COMMIT</span>

<span class="highlight">*mangle</span>
<span class="highlight">-A FORWARD --match policy --pol ipsec --dir in -s 10.10.10.0/24 -o eth0 -p tcp -m tcp --tcp-flags SYN,RST SYN -m tcpmss --mss 1361:1536 -j TCPMSS --set-mss 1360</span>
<span class="highlight">COMMIT</span>

*filter
:ufw-before-input - [0:0]
:ufw-before-output - [0:0]
:ufw-before-forward - [0:0]
:ufw-not-local - [0:0]
. . .
</code></pre>
<p>Измените каждый экземпляр <code>eth0</code> в конфигурации выше для соответствия имени интерфейса, которое вы определили с помощью <code>ip route</code>. Строки <code>*nat</code> создают правила, благодаря которым брандмауэр может обеспечивать маршрутизацию и управление трафиком между клиентами VPN и интернетом. Строка <code>*mangle</code> позволяет настроить максимальный размер сегмента пакета, чтобы предотвратить возможные проблемы с некоторыми клиентами VPN.</p>

<p>После строки <code>*filter</code> и строк определения цепочки нужно добавить еще один блок конфигурации:</p>
<div class="code-label " title="/etc/ufw/before.rules">/etc/ufw/before.rules</div><pre class="code-pre "><code langs="">. . .
*filter
:ufw-before-input - [0:0]
:ufw-before-output - [0:0]
:ufw-before-forward - [0:0]
:ufw-not-local - [0:0]

<span class="highlight">-A ufw-before-forward --match policy --pol ipsec --dir in --proto esp -s 10.10.10.0/24 -j ACCEPT</span>
<span class="highlight">-A ufw-before-forward --match policy --pol ipsec --dir out --proto esp -d 10.10.10.0/24 -j ACCEPT</span>
</code></pre>
<p>Эти строки указывают брандмауэру перенаправлять трафик <a href="https://wiki.wireshark.org/ESP">ESP</a> (защищенная инкапсуляция полезной нагрузки), чтобы дать клиентам VPN возможность подключения. ESP обеспечивает дополнительную защиту пакетов VPN, когда они проходят через ненадежные сети.</p>

<p>Завершив редактирование, сохраните и закройте файл.</p>

<p>Прежде чем перезапустить брандмауэр, нам нужно изменить некоторые параметры ядра сети, чтобы разрешить маршрутизацию с одного интерфейса на другой. Откройте файл конфигурации параметров ядра UFW:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo nano /etc/ufw/sysctl.conf
</li></ul></code></pre>
<p>Нам нужно настроить несколько параметров:</p>

<ul>
<li>Прежде всего, мы активируем перенаправление пакетов PIv4.</li>
<li>Мы отключим обнаружение путей MTU, чтобы предотвратить проблемы с фрагментацией пакетов.</li>
<li>Также мы запретим перенаправление ICMP и отправку перенаправлений ICMP, чтобы предотвратить атаки через <a href="https://en.wikipedia.org/wiki/Man-in-the-middle_attack">посредников</a>.</li>
</ul>

<p>Внесенные в файл изменения выделены в приведенном ниже фрагменте кода:</p>
<div class="code-label " title="/etc/ufw/sysctl.conf">/etc/ufw/sysctl.conf</div><pre class="code-pre "><code langs="">
. . .

# Enable forwarding
# Uncomment the following line
<span class="highlight">net/ipv4/ip_forward=1</span>

. . .

# Do not accept ICMP redirects (prevent MITM attacks)
# Ensure the following line is set
<span class="highlight">net/ipv4/conf/all/accept_redirects=0</span>

# Do not send ICMP redirects (we are not a router)
# Add the following lines
<span class="highlight">net/ipv4/conf/all/send_redirects=0</span>
<span class="highlight">net/ipv4/ip_no_pmtu_disc=1</span>
</code></pre>
<p>Завершив изменения, сохраните файл. UFW применит эти изменения при следующем запуске.</p>

<p>Теперь мы можем активировать все изменения, отключив и снова включив брандмауэр:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo ufw disable
</li><li class="line" prefix="$">sudo ufw enable
</li></ul></code></pre>
<p>Вам будет предложено подтвердить процесс. Введите <code>Y</code>, чтобы активировать UFW с новыми настройками.</p>

<h2 id="Шаг-7-—-Тестирование-подключения-в-в-windows-ios-и-macos">Шаг 7 — Тестирование подключения в в Windows, iOS и macOS</h2>

<p>Мы завершили подготовку, и пришло время для тестирования. Вначале нужно скопировать созданный вами сертификат CA и установить его на клиентские устройства, которые будут подключаться к VPN. Для этого удобнее всего выполнить вход на ваш сервер и вывести содержимое файла сертификата:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">cat /etc/ipsec.d/cacerts/ca-cert.pem
</li></ul></code></pre>
<p>Вывод будет выглядеть следующим образом:</p>
<pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>-----BEGIN CERTIFICATE-----
MIIFQjCCAyqgAwIBAgIIFkQGvkH4ej0wDQYJKoZIhvcNAQEMBQAwPzELMAkGA1UE

. . .

EwbVLOXcNduWK2TPbk/+82GRMtjftran6hKbpKGghBVDPVFGFT6Z0OfubpkQ9RsQ
BayqOb/Q
-----END CERTIFICATE-----
</code></pre>
<p>Скопируйте эти данные на свой компьютер, включая строки <code>-----BEGIN CERTIFICATE-----</code> и <code>-----END CERTIFICATE-----</code>, и сохраните их в файл с понятным именем, например, <code>ca-cert.pem</code>. Созданный файл должен иметь расширение <code>.pem</code>.</p>

<p>Также вы <a href="https://www.digitalocean.com/community/tutorials/how-to-use-sftp-to-securely-transfer-files-with-a-remote-server">можете использовать SFTP, чтобы перенести файл на свой компьютер</a>.</p>

<p>Когда файл <code>ca-cert.pem</code> будет загружен на ваш компьютер, вы можете настроить подключение к VPN.</p>

<h3 id="Подключение-из-windows">Подключение из Windows</h3>

<p>Вначале импортировать сертификат root, выполнив следующие шаги:</p>

<ol>
<li>Нажмите <code>WINDOWS+R</code>, чтобы открыть диалоговое окно <strong>Выполнить</strong> и введите <code>mmc.exe</code>, чтобы открыть консоль управления Windows.</li>
<li>Из меню <strong>Файл</strong> перейдите в раздел <strong>Добавить или удалить оснастку</strong>, выберите <strong>Сертификаты</strong> из списка доступных оснасток и нажмите <strong>Добавить</strong>.</li>
<li>Чтобы разрешить VPN работать для любых пользователей, выберите <strong>Учетная запись</strong> компьютера и нажмите <strong>Далее</strong>.</li>
<li>Поскольку мы выполняем настройку на локальном компьютере, выберите пункт <strong>Локальный компьютер</strong> и нажмите <strong>Готово</strong>.</li>
<li><p>Под узлом <strong>Корень консоли</strong> откройте запись <strong>Сертификаты (локальный компьютер)</strong>, раскройте <strong>Доверенные корневые центры сертификации</strong> и выберите запись <strong>Сертификаты:</strong> <img src="https://assets.digitalocean.com/articles/ikevpn_ubuntu_1604/4PN0vT6.png" alt="Просмотр сертификатов"></p></li>
<li><p>В меню <strong>Действие</strong> выберите пункт <strong>Все задачи</strong> и нажмите <strong>Импорт</strong>, чтобы открыть мастер импорта сертификатов. Нажмите <strong>Далее</strong>, чтобы пролистать вводное окно.</p></li>
<li><p>На экране <strong>Импортируемый файл</strong> нажмите кнопку <strong>Обзор</strong> и выберите сохраненный файл сертификата. Затем нажмите <strong>Далее</strong>.</p></li>
<li><p>Убедитесь, что <strong>Хранилище сертификатов</strong> имеет значение <strong>Доверенные корневые центры сертификации</strong> и нажмите <strong>Далее</strong>.</p></li>
<li><p>Нажмите <strong>Готово</strong>, чтобы импортировать сертификат.</p></li>
</ol>

<p>Затем выполните следующие шаги по настройке VPN:</p>

<ol>
<li>Откройте <strong>Панель управления</strong> и перейдите в <strong>Центр управления сетями и общим доступом</strong>.</li>
<li>Нажмите <strong>Создание и настройка нового подключения или сети</strong> и выберите пункт <strong>Подключение к рабочем месту</strong>.</li>
<li>Выберите пункт <strong>Использовать мое подключение к Интернету (VPN)</strong>.</li>
<li>Введите данные сервера VPN. Введите доменное имя сервера или IP-адрес в поле <strong>Адрес в Интернете</strong>, затем введите в поле <strong>Имя пункта назначения</strong> описание своего соединения VPN. Затем нажмите <strong>Готово</strong>.</li>
</ol>

<p>Ваше новое подключение VPN появится в списке сетей. Выберите VPN и нажмите <strong>Подключиться</strong>. Вам будет предложено ввести свои имя пользователя и пароль. Введите эти данные, нажмите <strong>OK</strong>, и подключение будет установлено.</p>

<h3 id="Подключение-из-macos">Подключение из macOS</h3>

<p>Выполните следующие шаги по импорту сертификата:</p>

<ol>
<li>Дважды щелкните файл сертификата. Откроется экран <strong>«Keychain Access»</strong> с диалоговым окном, где будет указано: «Keychain Access is trying to modify the system keychain. Enter your password to allow this».</li>
<li>Введите свой пароль и нажмите <strong>Modify Keychain</strong></li>
<li>Дважды щелкните импортированный сертификат VPN. После этого откроется небольшое окно свойств, где вы сможете указать уровни доверия. Укажите для параметра <strong>IP Security (IPSec)</strong> значение <strong>Always Trust (всегда доверять)</strong>, после чего вам нужно будет снова ввести пароль. Настройка будет сохранена автоматически после ввода пароля.</li>
</ol>

<p>Теперь сертификат импортирован и настроен как доверенный, и вы можете настроить соединение VPN:</p>

<ol>
<li>Откройте раздел <strong>System Preferences (настройки системы)</strong> и выберите пункт <strong>Network (сеть)</strong>.</li>
<li>Нажмите небольшую кнопку «плюс» в нижнем левом углу списка сетей.</li>
<li>В открывшемся всплывающем окне установите для параметра <strong>Interface (интерфейс)</strong> значение <strong>VPN</strong>, установите для параметра <strong>VPN Type (тип VPN)</strong> значение <strong>IKEv2</strong> и присвойте имя соединению.</li>
<li>В поле <strong>Server (сервер)</strong> и <strong>Remote ID (удаленный идентификатор)</strong> введите доменное имя или IP-адрес сервера. Оставьте поле <strong>Local ID (локальный идентификатор)</strong> пустым.</li>
<li>Нажмите <strong>Authentication Settings (настройки аутентификации)</strong>, выберите пункт <strong>Username (имя пользователя)</strong> и введите имя пользователя и пароль, которые вы настроили для своего пользователя VPN. Затем нажмите <strong>OK</strong>.</li>
</ol>

<p>Наконец, нажмите кнопку <strong>Connect (подключение)</strong> для подключения к VPN. Теперь вы должны быть подключены к VPN.</p>

<h3 id="Подключение-из-ubuntu">Подключение из Ubuntu</h3>

<p>Чтобы подключиться с компьютера под управлением Ubuntu, вы должны настроить и управлять StrongSwan как службой или использовать разовую команду при каждой попытке подключения. Далее приводятся инструкции для обоих случаев.</p>

<h4 id="Управление-strongswan-как-службой">Управление StrongSwan как службой</h4>

<ol>
<li>Обновите кэш локальных пакетов: <code>sudo apt update</code></li>
<li>Установите StrongSwan и связанное программное обеспечение: <code>sudo apt install strongswan libcharon-extra-plugins</code></li>
<li>Скопируйте сертификат CA в каталог <code>/etc/ipsec.d/cacerts</code>: <code>sudo cp <span class="highlight">/tmp/ca-cert.pem</span> /etc/ipsec.d/cacerts</code></li>
<li>Отключите StrongSwan для отключения автоматического запуска VPN: <code>sudo systemctl disable --now strongswan</code></li>
<li>Настройте имя пользователя и пароль для VPN в файле <code>/etc/ipsec.secrets</code>: <code><span class="highlight">your_username</span> : EAP <span class="highlight">"your_password"</span></code></li>
<li>Отредактируйте файл <code>/etc/ipsec.conf</code>, чтобы определить конфигурацию.</li>
</ol>
<div class="code-label " title="/etc/ipsec.conf">/etc/ipsec.conf</div><pre class="code-pre "><code langs="">config setup

conn ikev2-rw
    right=<span class="highlight">server_domain_or_IP</span>
    # This should match the `leftid` value on your server's configuration
    rightid=<span class="highlight">server_domain_or_IP</span>
    rightsubnet=0.0.0.0/0
    rightauth=pubkey
    leftsourceip=%config
    leftid=<span class="highlight">username</span>
    leftauth=eap-mschapv2
    eap_identity=%identity
    auto=start
</code></pre>
<p>Чтобы подключиться к VPN, введите:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo systemctl start strongswan
</li></ul></code></pre>
<p>Чтобы снова отключиться, введите:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo systemctl stop strongswan
</li></ul></code></pre>
<h4 id="Использование-простого-клиента-для-разовых-подключений">Использование простого клиента для разовых подключений</h4>

<ol>
<li>Обновите кэш локальных пакетов: <code>sudo apt update</code></li>
<li>Установите <code>charon-cmd</code> и связанное программное обеспечение: <code>sudo apt install charon-cmd libcharon-extra-plugins</code></li>
<li>Перейдите в каталог, куда вы скопировали сертификат CA: <code>cd &lt;^&gt;/path/to/ca-cert.pem</code></li>
<li>Подключитесь к серверу VPN с помощью <code>charon-cmd</code>, используя сертификат CA сервера, IP-адрес сервера VPN и настроенное имя пользователя:<code>sudo charon-cmd --cert ca-cert.pem --host <span class="highlight">vpn_domain_or_IP</span> --identity <span class="highlight">your_username</span></code></li>
<li>Укажите пароль пользователя VPN, когда он будет запрошен.</li>
</ol>

<p>Теперь вы должны быть подключены к VPN. Чтобы отключиться, нажмите <code>CTRL+C</code> и дождитесь, пока соединение не будет закрыто.</p>

<h3 id="Подключение-из-ios">Подключение из iOS</h3>

<p>Чтобы настроить соединение VPN на устройстве iOS, выполните следующие действия:</p>

<ol>
<li>Отправьте себе электронное письмо с прикрепленным корневым сертификатом.</li>
<li>Откройте электронное письмо на устройстве iOS, нажмите на вложенный файл сертификата, затем нажмите <strong>Установить</strong> и введите код доступа. После установки нажмите <strong>Готово</strong>.</li>
<li>Откройте <strong>Настройки</strong>, <strong>Общие</strong>, <strong>VPN</strong> и нажмите <strong>Добавить конфигурацию VPN</strong>. После этого откроется экран конфигурации подключения VPN.</li>
<li>Нажмите <strong>Тип</strong> и выберите <strong>IKEv2</strong>.</li>
<li>В поле <strong>Описание</strong> введите короткое имя подключения VPN. Вы можете выбрать все, что угодно.</li>
<li>В поле <strong>Server (сервер)</strong> и <strong>Remote ID (удаленный идентификатор)</strong> введите доменное имя или IP-адрес сервера. Поле <strong>Local ID (локальный идентификатор)</strong> нельзя оставлять пустым.</li>
<li>Введите имя пользователя и пароль в разделе <strong>Аутентификация</strong>, а затем нажмите <strong>Готово</strong>.</li>
<li>Выберите соединение VPN, которое вы только что создали, нажмите переключатель вверху страницы, и подключение будет установлено.</li>
</ol>

<h3 id="Подключение-из-android">Подключение из Android</h3>

<p>Выполните следующие шаги по импорту сертификата:</p>

<ol>
<li>Отправьте себе электронное письмо с прикрепленным сертификатом CA. Сохраните сертификат CA в папку «Загрузки».</li>
<li>Загрузите <a href="https://play.google.com/store/apps/details?id=org.strongswan.android&amp;hl=en_US">клиент StrongSwan VPN</a> из магазина Play Store.</li>
<li>Откройте приложение. Нажмите <strong>значок «подробнее»</strong> в правом верхнем углу (три точки) и выберите пункт <strong>Сертификаты CA</strong>.</li>
<li>Снова нажмите <strong>значок «Подробнее»</strong> в правом верхнем углу. Выберите пункт <strong>Импорт сертификата</strong>.</li>
<li>Найдите файл сертификата CA в папке «Загрузки» и выберите его для импорта в приложение.</li>
</ol>

<p>Теперь сертификат импортирован в приложение StrongSwan, и вы можете настроить соединение VPN следующим образом:</p>

<ol>
<li>В приложении нажмите <strong>ADD VPN PROFILE (добавить профиль VPN)</strong> сверху.</li>
<li>Введите в поле <strong>Server (сервер)</strong> доменное имя или публичный IP-адрес вашего сервера VPN.</li>
<li>Обязательно выберите тип VPN: <strong>IKEv2 EAP (Username/Password)</strong>.</li>
<li>Введите поля <strong>Username (имя пользователя)</strong> и <strong>Password (пароль)</strong> учетные данные, определенные на сервере.</li>
<li>Уберите флажок <strong>Select automatically (выбирать автоматически)</strong> в разделе <strong>CA certificate (сертификат CA)</strong> и нажмите <strong>Select CA certificate (выбрать сертификат CA)</strong>.</li>
<li>Откройте вкладку <strong>IMPORTED (импортированные)</strong> вверху экрана и выберите импортированный CA (он будет иметь имя «VPN root CA», если вы до этого не изменяли значение «DN»).</li>
<li>Если хотите, можете ввести в поле <strong>Profile name (optional) (имя профиля, необязательно)</strong> более понятное имя.</li>
</ol>

<p>Когда вы захотите подключится к VPN, нажмите на профиль, созданный в приложении StrongSwan.</p>

<h3 id="Диагностика-и-устранение-неисправностей-подключения">Диагностика и устранение неисправностей подключения</h3>

<p>Если вы не сможете импортировать сертификат, убедитесь, что файл имеет расширение <code>.pem</code>, а не <code>.pem.txt</code>.</p>

<p>Если вы не можете подключиться к VPN, проверьте используемые имя сервера и IP-адрес. Доменное имя или IP-адрес сервера должны соответствовать настроенным как общее имя (CN) при создании сертификата. Если они не совпадают, соединение VPN не будет работать. Если вы настроили сертификат с CN <code>vpn.example.com</code>, вы <em>должны</em> использовать <code>vpn.example.com</code> при вводе данных сервера VPN. Еще раз проверьте команду, которую вы использовали для генерирования сертификата и значения, которые использовали при создании соединения VPN.</p>

<p>Наконец, проверьте конфигурацию VPN и убедитесь, что значение <code>leftid</code> настроено с символом <code>@</code>, если вы используете доменное имя:</p>
<pre class="code-pre "><code langs="">    leftid=<span class="highlight">@</span>vpn.example.com
</code></pre>
<p>Если вы используете IP-адрес, убедитесь, что символ <code>@</code> опущен.</p>

<h2 id="Заключение">Заключение</h2>

<p>В этом обучающем модуле вы создали сервер VPN, использующий протокол IKEv2. Теперь вы можете быть уверены, что ваши действия в сети будут защищены!</p>

<p>Чтобы добавить или удалить пользователей, еще раз изучите шаг 5. Каждая строка предназначена для одного пользователя, и поэтому для добавления или удаления пользователей достаточно просто отредактировать файл.</p>

<p>Также вы можете захотеть использовать анализатор файлов журнала, потому что StrongSwan отправляет дампы своих журналов в syslog. В обучающем модуле <a href="https://www.digitalocean.com/community/tutorials/how-to-install-and-use-logwatch-log-analyzer-and-reporter-on-a-vps">Установка и использование инструмента Logwatch Log Analyzer and Reporter с VPS</a> можно найти дополнительную информацию по этой процедуре.</p>

<p>Вы также можете заинтересовать <a href="https://www.eff.org/wp/effs-top-12-ways-protect-your-online-privacy">это руководство EFF по конфиденциальности в режиме онлайн</a>.</p>
