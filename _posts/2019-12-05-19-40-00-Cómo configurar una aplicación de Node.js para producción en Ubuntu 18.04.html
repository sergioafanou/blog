---
layout: post
title: Cómo configurar una aplicación de Node.js para producción en Ubuntu 18.04
network: digitalocean
date: December 05, 2019 at 07:40PM
url: https://www.digitalocean.com/community/tutorials/como-configurar-una-aplicacion-de-node-js-para-produccion-en-ubuntu-18-04-es
image: http://ifttt.com/images/no_image_card.png
tags: docker
feedtitle: DigitalOcean Community Tutorials
feedurl: https://www.digitalocean.com/community/tutorials
author: DigitalOcean
---
<h3 id="introducción">Introducción</h3>

<p><a href="https://nodejs.org/en/">Node.js</a> es un entorno de tiempo de ejecución de código abierto basado en JavaScript que use usa para crear aplicaciones de redes. La plataforma funciona en Linux, macOS, FreeBSD y Windows. Aunque puede ejecutar aplicaciones de Node.js en la línea de comandos, en este tutorial se pondrá el foco en su ejecución como un servicio. Esto significa que se reiniciarán durante el inicio o ante una falla y que pueden usarse de forma segura en un entorno de producción.</p>

<p>A través de este tutorial, configurará un entorno de Node.js listo para producción en un servidor único de Ubuntu 18.04. Este servidor ejecutará una aplicación de Node.js administrada por <a href="http://pm2.keymetrics.io/">PM2</a> y brindará a los usuarios acceso seguro a la aplicación mediante un proxy inverso de Nginx. El servidor de Nginx brindará HTTPS usando un certificado gratuito proporcionado por <a href="https://letsencrypt.org/">Let&rsquo;s Encrypt</a>.</p>

<h2 id="requisitos-previos">Requisitos previos</h2>

<p>Para esta guía, se supone cuenta con lo siguiente:</p>

<ul>
<li>Un servidor de Ubuntu 18.04 configurado siguiendo la descripción de la <a href="https://www.digitalocean.com/community/tutorials/initial-server-setup-with-ubuntu-18-04">guía de configuración inicial para servidores de Ubuntu 18.04</a>. Debe disponer de usuario no root con privilegios sudo y un firewall activo.</li>
<li>Un <a href="https://www.digitalocean.com/docs/networking/dns/quickstart/">nombre de dominio que apunte a la IP pública de su servidor</a>. En este tutorial se usará el nombre de dominio <strong>example.com</strong> en todo momento.</li>
<li>Nginx instalado, como se señala en <a href="https://www.digitalocean.com/community/tutorials/how-to-install-nginx-on-ubuntu-18-04">Cómo instalar Nginx en Ubuntu 18.04</a>.</li>
<li>Nginx configurado con SSL mediante certificados de Let&rsquo;s Encrypt. <a href="https://www.digitalocean.com/community/tutorials/how-to-secure-nginx-with-let-s-encrypt-on-ubuntu-18-04">Cómo proteger Nginx con Let&rsquo;s Encrypt en Ubuntu 18.04</a> le servirá como guía en el proceso.</li>
</ul>

<p>Una vez que cumpla con los requisitos previos, dispondrá de un servidor en el que funcionará la página de marcador de posición predeterminada de su dominio en <code>https:<span class="highlight">//example.com</span>/</code>.</p>

<h2 id="paso-1-instalar-node-js">Paso 1: Instalar Node.js</h2>

<p>Comencemos instalando la versión más reciente de LTS de Node.js con los archivos de paquete de <a href="https://github.com/nodesource/distributions">NodeSource</a>.</p>

<p>Primero, instale el PPA de NodeSource para poder acceder a su contenido. Asegúrese de estar posicionado en su directorio de inicio y use <code>curl</code> para recuperar la secuencia de instalación para los archivos de Node.js 8.x:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">cd ~
</li><li class="line" prefix="$">curl -sL https://deb.nodesource.com/setup_8.x -o nodesource_setup.sh
</li></ul></code></pre>
<p>Puede inspeccionar el contenido de esta secuencia de comandos con <code>nano</code> o su editor de texto preferido:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">nano nodesource_setup.sh
</li></ul></code></pre>
<p>Cuando termine de inspeccionar la secuencia, ejecútela con <code>sudo</code>:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo bash nodesource_setup.sh
</li></ul></code></pre>
<p>El PPA se agregará a su configuración y su caché de paquetes locales se actualizará de forma automática. Después de ejecutar la secuencia de comandos de configuración de Nodesource, puede instalar el paquete de Node.js.</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo apt install nodejs
</li></ul></code></pre>
<p>Para comprobar la versión de Node.js que instaló después de estos pasos iniciales, escriba lo siguiente:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">nodejs -v
</li></ul></code></pre><pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>v8.11.3
</code></pre>
<p><span class='note'><strong>Nota:</strong> Cuando la instalación se realiza a partir del PPA de NodeSource, el ejecutable de Node.js se llama <code>nodejs</code>, en lugar de <code>node</code>.<br></span></p>

<p>El paquete <code>nodejs</code> contiene el binario <code>nodejs</code> y <a href="https://www.npmjs.com/"><code>npm</code></a>, un administrador de paquetes para módulos de Node, por lo que no tendrá que instalar <code>npm</code> por separado.</p>

<p><code>npm</code> usa un archivo de configuración en su directorio de inicio para hacer un seguimiento de las actualizaciones. Se creará la primera vez que ejecute <code>npm</code>. Ejecute este comando para verificar que <code>npm</code> esté instalado y crear el archivo de configuración:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">npm -v
</li></ul></code></pre><pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>5.6.0
</code></pre>
<p>Para que algunos paquetes de <code>npm</code> funcionen (por ejemplo, aquellos para los cuales se seba compilar código de una fuente), deberá instalar el paquete <code>build-essential</code>:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo apt install build-essential
</li></ul></code></pre>
<p>Ahora dispondrá de las herramientas necesarias para trabajar con paquetes <code>npm</code> para los que se deba compilar código de la fuente.</p>

<p>Ahora que está instalado el tiempo de ejecución de Node.js, escribiremos una la aplicación de Node.js.</p>

<h2 id="paso-2-crear-una-aplicación-de-node-js">Paso 2: Crear una aplicación de Node.js</h2>

<p>Escribiremos una aplicación <em>Hello World</em> que responda “Hello World” a cualquier solicitud de HTTP. Con esta aplicación de ejemplo, podrá a configurar Node.js. Puede reemplazarla por su propia aplicación; solo debe asegurarse de modificar su aplicación para escuchar en las direcciones IP y los puertos apropiados.</p>

<p>Primero, crearemos una aplicación de ejemplo llamada <code>hello.js</code>:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">cd ~
</li><li class="line" prefix="$">nano hello.js
</li></ul></code></pre>
<p>Inserte el siguiente código en el archivo:</p>
<div class="code-label " title="~/hello.js">~/hello.js</div><pre class="code-pre "><code class="code-highlight language-js">const http = require('http');

const hostname = 'localhost';
const port = 3000;

const server = http.createServer((req, res) =&gt; {
  res.statusCode = 200;
  res.setHeader('Content-Type', 'text/plain');
  res.end('Hello World!\n');
});

server.listen(port, hostname, () =&gt; {
  console.log(`Server running at http://${hostname}:${port}/`);
});
</code></pre>
<p>Guarde el archivo y salga del editor.</p>

<p>La aplicación Node.js escucha la dirección (<code>localhost</code>) y el puerto (<code>3000</code>) especificados, y responde “Hello World!” con un código de éxito HTTP <code>200</code>. Debido a que escucharemos en <code>localhost</code>, los clientes remotos no podrán conectarse a nuestra aplicación.</p>

<p>Para probar su aplicación, escriba lo siguiente:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">node hello.js
</li></ul></code></pre>
<p>Verá el siguiente resultado:</p>
<pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>Server running at http://localhost:3000/
</code></pre>
<p><span class='note'><strong>Nota:</strong> Ejecutar una aplicación de Node.js de esta manera bloqueará comandos adicionales hasta que esta se detenga pulsando <code>CTRL+C</code>.<br></span></p>

<p>Para probar la aplicación, abra otra sesión de terminal en su servidor y conéctese a <code>localhost</code> con <code>curl</code>:</p>
<pre class="code-pre command second-environment"><code langs=""><ul class="prefixed"><li class="line" prefix="$">curl http://localhost:<span class="highlight">3000</span>
</li></ul></code></pre>
<p>Si ve el siguiente resultado, significa que la aplicación funciona de forma adecuada y escucha en las direcciones y los puertos correctos.</p>
<pre class="code-pre  second-environment"><code langs=""><div class="secondary-code-label " title="Output">Output</div>Hello World!
</code></pre>
<p>Si no ve el resultado esperado, asegúrese de que su aplicación de Node.js funcione y esté configurada para escuchar en la dirección y el puerto apropiados.</p>

<p>Una vez que esté seguro de que funciona, deténgala (si aún no lo hizo) presionando <code>CTRL+C</code>.</p>

<h2 id="paso-3-instalar-pm2">Paso 3: Instalar PM2</h2>

<p>A continuación, instalaremos PM2, un administrador de procesos para aplicaciones de Node.js. PM2 permite implementar demonios en aplicaciones para que puedan funcionar en segundo plano como servicios.</p>

<p>Use <code>npm</code> para instalar la última versión de PM2 en su servidor:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo npm install pm2@latest -g
</li></ul></code></pre>
<p>La opción <code>-g</code> indica a <code>npm</code> que instale el módulo <em>de forma global</em>, de modo que esté disponible en todo el sistema.</p>

<p>Primero, usaremos el comando <code>pm2 start</code> para ejecutar su aplicación, <code>hello.js</code>, en segundo plano:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">pm2 start <span class="highlight">hello.js</span>
</li></ul></code></pre>
<p>Con esto, también se agrega su aplicación a la lista de procesos de PM2, que se emite cada vez que se inicia una aplicación:</p>
<pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>[PM2] Spawning PM2 daemon with pm2_home=/home/sammy/.pm2
[PM2] PM2 Successfully daemonized
[PM2] Starting /home/sammy/hello.js in fork_mode (1 instance)
[PM2] Done.
┌──────────┬────┬──────┬──────┬────────┬─────────┬────────┬─────┬───────────┬───────┬──────────┐
│ App name │ id │ mode │ pid  │ status │ restart │ uptime │ cpu │ mem       │ user  │ watching │
├──────────┼────┼──────┼──────┼────────┼─────────┼────────┼─────┼───────────┼───────┼──────────┤
│ <span class="highlight">hello</span>    │ 0  │ fork │ 1338 │ online │ 0       │ 0s     │ 0%  │ 23.0 MB   │ sammy │ disabled │
└──────────┴────┴──────┴──────┴────────┴─────────┴────────┴─────┴───────────┴───────┴──────────┘
 Use `pm2 show &lt;id|name&gt;` to get more details about an app
</code></pre>
<p>Como puede ver, PM2 asigna automáticamente un <code>App name</code> (según el nombre del archivo, sin la extensión <code>.js</code>) y un <code>id</code> de PM2. También conversa otra información, como el <code>PID</code> de los procesos, su estado actual y su uso de memoria.</p>

<p>Las aplicaciones que se ejecutan en PM2 se reiniciarán de forma automática si la aplicación se bloquea o se detiene, pero podemos dar un paso adicional para que se cargue en el inicio del sistema usando el subcomando <code>startup</code>. Este subcomando genera y configura una secuencia de comandos de inicio para iniciar PM2 y sus procesos administrados al iniciarse el servidor:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">pm2 startup systemd
</li></ul></code></pre>
<p>En la última línea del resultado obtenido se incluirá un comando que se ejecutará con privilegios de superusuario a fin de configurar PM2 para que se cargue en el inicio:</p>
<pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>[PM2] Init System found: systemd
[PM2] To setup the Startup Script, copy/paste the following command:
<span class="highlight">sudo env PATH=$PATH:/usr/bin /usr/lib/node_modules/pm2/bin/pm2 startup systemd -u sammy --hp /home/sammy</span>
</code></pre>
<p>Ejecute el comando del resultado, con su nombre de usuario en lugar de <code>sammy</code>:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo env PATH=$PATH:/usr/bin /usr/lib/node_modules/pm2/bin/pm2 startup systemd -u <span class="highlight">sammy</span> --hp /home/<span class="highlight">sammy</span>
</li></ul></code></pre>
<p>Como paso adicional, podemos guardar la lista de procesos de PM2 y los entornos correspondientes:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">pm2 save
</li></ul></code></pre>
<p>De esta manera, habrá creado una <em>unidad</em> de systemd que ejecuta <code>pm2</code> para su usuario en el inicio. Esta instancia de <code>pm2</code>, a su vez, ejecuta <code>hello.js</code>.</p>

<p>Inicie el servicio con <code>systemctl</code>:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo systemctl start pm2-<span class="highlight">sammy</span>
</li></ul></code></pre>
<p>Compruebe el estado de la unidad de systemd:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">systemctl status pm2-<span class="highlight">sammy</span>
</li></ul></code></pre>
<p>Para hallar una descripción detallada de systemd, consulte <a href="https://www.digitalocean.com/community/tutorials/systemd-essentials-working-with-services-units-and-the-journal">Aspectos básicos de systemd: trabajar con servicios, unidades y el componente de diario</a>.</p>

<p>Además de los subcomandos que ya abarcamos, PM2 proporciona muchos que le permiten administrar o buscar información sobre sus aplicaciones.</p>

<p>Detenga una aplicación con este comando (especifique <code>App name</code> o <code>id</code> de PM2):</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">pm2 stop <span class="highlight">app_name_or_id</span>
</li></ul></code></pre>
<p>Reinicie una aplicación:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">pm2 restart <span class="highlight">app_name_or_id</span>
</li></ul></code></pre>
<p>Liste las aplicaciones actualmente administradas por PM2:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">pm2 list
</li></ul></code></pre>
<p>Obtenga información sobre una aplicación específica usando su <code>App name</code>:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">pm2 info <span class="highlight">app_name</span>
</li></ul></code></pre>
<p>El monitor de procesos de PM2 se puede extraer con el subcomando <code>monit</code>. Con esto, se muestra el estado y el uso de CPU y memoria de la aplicación:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">pm2 monit
</li></ul></code></pre>
<p>Tenga en cuenta que si se ejecuta <code>pm2</code> sin argumentos, también se mostrará una página de ayuda con uso de ejemplos.</p>

<p>Ahora que su aplicación de Node.js funciona y PM2 la administra, configuraremos el proxy inverso.</p>

<h2 id="paso-4-configurar-nginx-como-servidor-proxy-inverso">Paso 4: Configurar Nginx como servidor proxy inverso</h2>

<p>Su aplicación está en ejecución y escucha en <code>localhost</code>, pero necesita configurar una alternativa para que sus usuarios accedan a ella. Configuraremos el servidor web de Nginx como un proxy inverso para este propósito.</p>

<p>En el tutorial de los requisitos previos, configuró sus ajustes de Nginx en el archivo <code>/etc/nginx/sites-available/<span class="highlight">example.com</span></code>. Abra este archivo para editarlo:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo nano /etc/nginx/sites-available/<span class="highlight">example.com</span>
</li></ul></code></pre>
<p>En el bloque <code>server</code>, debería disponer de un bloque <code>location /</code>. Sustituya el contenido de dicho bloque por la siguiente configuración. Si su aplicación está configurada para escuchar en un puerto diferente, actualice la parte resaltada con el número de puerto correcto:</p>
<div class="code-label " title="/etc/nginx/sites-available/example.com">/etc/nginx/sites-available/example.com</div><pre class="code-pre "><code langs="">server {
...
    location / {
        proxy_pass http://localhost:<span class="highlight">3000</span>;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
...
}
</code></pre>
<p>Con esto, se configurará el servidor para que responda las solicitudes en su root. Suponiendo que nuestro servidor esté disponible en <code><span class="highlight">example.com</span></code>, al acceder a <code>https://<span class="highlight">example.com</span>/</code> a través de un navegador web se enviaría la solicitud a <code>hello.js</code> y la escucha se realizaría en el puerto <code>3000</code> en <code>localhost</code>.</p>

<p>Puede agregar bloques <code>location</code> al mismo bloque de servidor para proporcionar acceso a otras aplicaciones en el mismo servidor. Por ejemplo, si también contaba con otra aplicación Node.js en el puerto <code>3001</code>, podría agregar este bloque de ubicación para permitir el acceso a él a través de <code>https://<span class="highlight">example.com</span>/<span class="highlight">app2</span></code>:</p>
<div class="code-label " title="/etc/nginx/sites-available/example.com — Optional">/etc/nginx/sites-available/example.com — Optional</div><pre class="code-pre "><code langs="">server {
...
    location /<span class="highlight">app2</span> {
        proxy_pass http://localhost:<span class="highlight">3001</span>;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
...
}
</code></pre>
<p>Una vez que termine de agregar los bloques de ubicación a sus aplicaciones, guarde el archivo y cierre el editor.</p>

<p>Asegúrese de no haber introducido errores de sintaxis escribiendo lo siguiente:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo nginx -t
</li></ul></code></pre>
<p>Reinicie Nginx:</p>
<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo systemctl restart nginx
</li></ul></code></pre>
<p>Suponiendo que su aplicación Node.js está en ejecución, y que su aplicación y las configuraciones de Nginx son correctas, ahora debería poder acceder a su aplicación a través del proxy inverso de Nginx. Pruébelo accediendo a la URL de su servidor (su dirección IP pública o nombre de dominio).</p>

<h2 id="conclusión">Conclusión</h2>

<p>¡Felicitaciones! De esta manera, habrá logrado hacer funcionar su aplicación de Node.js detrás de un proxy inverso de Nginx en un servidor de Ubuntu 18.04. Esta configuración de proxy inverso es suficientemente flexible como para proporcionar a sus usuarios acceso a otras aplicaciones o a contenido web estático que desee compartir.</p>
